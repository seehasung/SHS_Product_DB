{% extends "base.html" %}
{% block title %}상품 관리{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* 배경 및 전체 레이아웃 */
    body {
        background: #f5f6fa;
        min-height: 100vh;
    }
    
    /* 페이지 타이틀 */
    .page-title {
        background: white;
        padding: 20px 30px;
        margin-bottom: 25px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .page-title h1 {
        font-size: 1.8rem;
        font-weight: 600;
        color: #2d3436;
        margin: 0;
    }
    
    /* 페이지 타이틀 우측 액션 그룹 */
    .title-actions {
        color: #9770f1ff;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    /* 검색 섹션 - 수정됨 */
    .search-section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        position: relative;
    }
    
    .search-container {
        position: relative;
    }
    
    /* 검색창을 더 길게 수정 */
    .search-input-group {
        position: relative;
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .search-input-wrapper {
        position: relative;
        flex: 1;  /* 검색창이 남은 공간을 모두 차지하도록 */
        max-width: calc(100% - 240px); /* 버튼들 공간 확보 */
    }
    
    .search-input {
        width: 100%;  /* 전체 너비 사용 */
        padding: 12px 20px 12px 45px;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .search-input:focus {
        outline: none;
        border-color: rgba(74, 144, 226, 1);
        box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1);
    }
    
    .search-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #adb5bd;
        font-size: 1.2rem;
        pointer-events: none;  /* 아이콘 클릭 방지 */
    }
    
    .search-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;  /* 버튼 텍스트 줄바꿈 방지 */
    }
    
    .search-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(74, 144, 226, 0.3);
    }
    
    /* 초기화 버튼 */
    .reset-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, #636e72 0%, #2d3436 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
    }
    
    .reset-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(45, 52, 54, 0.3);
    }
    
    /* 자동완성 드롭다운 */
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        margin-top: 5px;
        max-height: 400px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    
    .autocomplete-dropdown.show {
        display: block;
    }
    
    .autocomplete-item {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        cursor: pointer;
        transition: background 0.2s ease;
    }
    
    .autocomplete-item:hover {
        background: #f8f9fa;
    }
    
    .autocomplete-thumbnail {
        width: 45px;
        height: 45px;
        border-radius: 8px;
        object-fit: cover;
        margin-right: 15px;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
    }
    
    .autocomplete-info {
        flex: 1;
    }
    
    .autocomplete-name {
        font-weight: 600;
        color: #2d3436;
    }
    
    .autocomplete-code {
        font-size: 0.85rem;
        color: #adb5bd;
    }
    
    /* 형광펜 효과 - 진한 노란색 */
    .highlight {
        background: #ffeb3b;
        padding: 2px 4px;
        font-weight: 700;
        border-radius: 2px;
        color: #000;
    }
    
    /* 상품 테이블 */
    .products-table-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        overflow-x: auto;  /* 테이블이 넘치면 가로 스크롤 */
    }
    
    .products-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 1200px;  /* 테이블 최소 너비 설정 */
    }
    
    .products-table thead th {
        background: #f8f9fa;
        color: #636e72;
        font-weight: 600;
        padding: 15px 10px;
        text-align: left;
        font-size: 0.9rem;
        border-bottom: 2px solid #e9ecef;
        white-space: nowrap;  /* 헤더 텍스트 줄바꿈 방지 */
    }
    
    /* 각 컬럼별 최소 너비 설정 */
    .products-table th:nth-child(1),
    .products-table td:nth-child(1) { min-width: 100px; } /* 상품코드 */
    
    .products-table th:nth-child(2),
    .products-table td:nth-child(2) { min-width: 80px; }  /* 썸네일 */
    
    .products-table th:nth-child(3),
    .products-table td:nth-child(3) { min-width: 200px; } /* 상품명 */
    
    .products-table th:nth-child(4),
    .products-table td:nth-child(4) { min-width: 90px; }  /* 가격 */
    
    .products-table th:nth-child(5),
    .products-table td:nth-child(5) { min-width: 90px; }  /* 신고가 */
    
    .products-table th:nth-child(6),
    .products-table td:nth-child(6) { min-width: 60px; text-align: center; }  /* 경동 */
    
    .products-table th:nth-child(7),
    .products-table td:nth-child(7) { min-width: 60px; text-align: center; }  /* 관세 */
    
    .products-table th:nth-child(8),
    .products-table td:nth-child(8) { min-width: 90px; }  /* 쿠팡 */
    
    .products-table th:nth-child(9),
    .products-table td:nth-child(9) { min-width: 90px; }  /* 네이버 */
    
    .products-table th:nth-child(10),
    .products-table td:nth-child(10) { min-width: 100px; } /* 타오바오 */
    
    .products-table th:nth-child(11),
    .products-table td:nth-child(11) { min-width: 90px; }  /* 관리 */
    
    .products-table tbody tr {
        transition: background 0.2s ease;
        border-bottom: 1px solid #f0f1f3;
    }
    
    .products-table tbody tr:hover {
        background: #f8f9fa;
    }
    
    .products-table td {
        padding: 15px 10px;
        vertical-align: middle;
        white-space: nowrap;  /* 셀 텍스트 줄바꿈 방지 */
    }
    
    /* 상품명만 줄바꿈 허용 */
    .products-table td:nth-child(3) {
        white-space: normal;
        word-break: keep-all;  /* 단어 단위로만 줄바꿈 */
    }
    
    /* 상품명 링크 스타일 */
    .product-name-link {
        text-decoration: none;
        color: #2d3436;
        font-weight: 600;
        transition: color 0.2s ease;
    }
    
    .product-name-link:hover {
        color: #4A90E2;
    }
    
    /* 썸네일 스타일 */
    .product-thumbnail {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }
    
    .no-thumbnail {
        width: 60px;
        height: 60px;
        background: #f8f9fa;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #adb5bd;
        font-size: 1.5rem;
    }
    
    /* 체크박스 스타일 - 진한 초록색으로 변경 */
    .check-small {
        width: 22px;
        height: 22px;
        cursor: not-allowed;
        -webkit-appearance: none;
        appearance: none;
        background: white;
        border: 2px solid #dee2e6;
        border-radius: 4px;
        position: relative;
        transition: all 0.3s;
    }
    
    /* 체크된 체크박스만 진한 초록색 */
    .check-small:checked {
    background: #00c73c !important;
    border-color: #00c73c !important;
    box-shadow: 0 0 0 2px rgba(0, 199, 60, 0.2),  /* 이중 그림자 */
                0 0 15px rgba(0, 199, 60, 0.4) !important;
}

    /* 비활성화 상태에서도 선명하게 */
    .check-small:disabled:checked {
        opacity: 1 !important;
    }

    .check-small:checked::after {
        content: "✓";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 16px;
        font-weight: bold;
    }
    
    /* 체크박스 컨테이너 */
    td input[type="checkbox"] {
        display: inline-block;
        vertical-align: middle;
        position: relative;
    }
    
    /* 체크되지 않은 체크박스는 기본 색상 */
    .check-small:not(:checked) {
        opacity: 0.6;
    }
    
    /* 링크 버튼 */
    .link-btn {
        padding: 6px 12px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s ease;
        display: inline-block;
        white-space: nowrap;
    }
    
    .link-btn-coupang {
        background: #0984e3;  /* 파란색으로 변경 */
        color: white;
    }
    
    .link-btn-coupang:hover {
        background: #0652DD;  /* 진한 파란색 */
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 3px 10px rgba(9, 132, 227, 0.3);
    }
    
    .link-btn-naver {
        background: #00c73c;
        color: white;
    }
    
    .link-btn-naver:hover {
        background: #00a832;
        transform: translateY(-2px);
    }
    
    .link-btn-taobao {
        background: #ff6b00;
        color: white;
    }
    
    .link-btn-taobao:hover {
        background: #e55a00;
        transform: translateY(-2px);
    }
    
    /* 액션 버튼 */
    .action-buttons {
        display: flex;
        gap: 5px;
    }
    
    .btn-action {
        background: #4A90E2;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.9rem;
    }
    
    .btn-action:hover {
        background: #5a67d8;
        transform: translateY(-2px);
    }
    
    .btn-action.delete {
        background: #e74c3c;
    }
    
    .btn-action.delete:hover {
        background: #c0392b;
    }
    
    /* 표시 개수 선택 */
    .items-per-page-select {
        padding: 10px 15px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        font-size: 0.9rem;
        font-weight: 500;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .items-per-page-select:focus {
        outline: none;
        border-color: white;
        background: rgba(255, 255, 255, 0.3);
    }
    
    .items-per-page-select option {
        background: #4A90E2;
        color: white;
    }
    
    /* 페이지네이션 */
    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 25px;
        padding: 15px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .pagination {
        display: flex;
        gap: 5px;
    }
    
    .page-btn {
        padding: 8px 14px;
        border: 1px solid #e9ecef;
        background: white;
        color: #636e72;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.9rem;
    }
    
    .page-btn:hover:not(:disabled) {
        background: #4A90E2;
        color: white;
        border-color: #4A90E2;
    }
    
    .page-btn.active {
        background: #4A90E2;
        color: white;
        border-color: #4A90E2;
    }
    
    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .page-info {
        color: #636e72;
        font-size: 0.9rem;
    }
    
    /* 상품 추가 버튼 */
    .btn-add-product {
        background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
        color: white;
        padding: 10px 20px;
        border-radius: 10px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-add-product:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(74, 144, 226, 0.3);
    }
    
    /* 반응형 디자인 */
    @media (max-width: 768px) {
        .page-title {
            flex-direction: column;
            align-items: stretch;
        }
        
        .title-actions {
            flex-direction: column;
            gap: 10px;
        }
        
        .search-input-wrapper {
            max-width: 100%;
        }
        
        .search-input-group {
            flex-wrap: wrap;
        }
        
        .pagination-container {
            flex-direction: column;
            gap: 15px;
        }
    }

    /* 자동완성 드롭다운 내 버튼 스타일 개선 */
    .autocomplete-dropdown button.btn {
        transition: all 0.3s ease;
        border: 2px solid rgba(74, 144, 226, 0.3);
    }

    .autocomplete-dropdown button.btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(74, 144, 226, 0.3);
        border-color: #4A90E2;
    }

    /* 자동완성 드롭다운 스크롤바 스타일 */
    .autocomplete-dropdown::-webkit-scrollbar {
        width: 8px;
    }

    .autocomplete-dropdown::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .autocomplete-dropdown::-webkit-scrollbar-thumb {
        background: #4A90E2;
        border-radius: 10px;
    }

    .autocomplete-dropdown::-webkit-scrollbar-thumb:hover {
        background: #3A7BC8;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="padding: 20px;">
    <!-- 페이지 타이틀 -->
    <div class="page-title">
        <div style="display: flex; align-items: center; gap: 20px;">
            <!-- 홈 버튼 추가 -->
            <a href="/" class="btn-home" title="홈으로">
                <i class="bi bi-house-door-fill"></i>
            </a>
            <h1><i class="bi bi-box-seam"></i> 상품 관리</h1>
        </div>
        <div class="title-actions">
            <select class="items-per-page-select" id="itemsPerPageSelect" onchange="changeItemsPerPage(this.value)">
                <option value="10">10개씩</option>
                <option value="20" selected>20개씩</option>
                <option value="50">50개씩</option>
                <option value="100">100개씩</option>
                <option value="all">전체</option>
            </select>
            <a href="/products/add" class="btn-add-product">
                <i class="bi bi-plus-circle"></i> 새 상품 추가
            </a>
        </div>
    </div>

    <!-- 검색 섹션 - 수정됨 -->
    <div class="search-section">
        <div class="search-container">
            <div class="search-input-group">
                <div class="search-input-wrapper">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" 
                           id="searchInput" 
                           class="search-input" 
                           placeholder="상품명 또는 상품코드로 검색..." 
                           autocomplete="off">
                </div>
                <button class="search-btn" onclick="executeSearch()">
                    <i class="bi bi-search"></i> 검색
                </button>
                <button class="reset-btn" onclick="resetSearch()">
                    <i class="bi bi-arrow-clockwise"></i> 초기화
                </button>
            </div>
            <div id="autocompleteDropdown" class="autocomplete-dropdown"></div>
        </div>
    </div>

    <!-- 상품 테이블 -->
    <div class="products-table-container">
        <table class="products-table">
            <thead>
                <tr>
                    <th>상품코드</th>
                    <th>썸네일</th>
                    <th>상품명</th>
                    <th>가격</th>
                    <th>신고가</th>
                    <th>경동</th>
                    <th>관세</th>
                    <th>쿠팡</th>
                    <th>네이버</th>
                    <th>타오바오</th>
                    <th>관리</th>
                </tr>
            </thead>
            <tbody id="productTableBody">
                <!-- JavaScript로 동적 생성 -->
            </tbody>
        </table>
    </div>

    <!-- 페이지네이션 -->
    <div class="pagination-container">
        <div class="page-info">
            <span id="productInfo">0-0 / 전체 0개</span>
        </div>
        <div class="pagination">
            <!-- JavaScript로 동적 생성 -->
        </div>
    </div>
</div>

<script>
// 전체 상품 데이터
let allProducts = {{ products | tojson | safe }};
let filteredProducts = [...allProducts];
let currentPage = 1;
let itemsPerPage = 20;
let currentSearchTerm = '';  // 현재 검색어 저장

let currentAutocompleteResults = [];
let autocompleteDisplayLimit = 10;

// 검색 요소들
const searchInput = document.getElementById('searchInput');
const autocompleteDropdown = document.getElementById('autocompleteDropdown');

// URL 파라미터에서 페이지 상태 복원
function restorePageState() {
    const urlParams = new URLSearchParams(window.location.search);
    const page = urlParams.get('page');
    const keyword = urlParams.get('keyword');
    const perPage = urlParams.get('per_page');
    
    // 검색어 복원
    if (keyword) {
        searchInput.value = keyword;
        currentSearchTerm = keyword;
        
        // 검색어로 필터링
        filteredProducts = allProducts.filter(product => {
            const name = (product.name || '').toLowerCase();
            const code = (product.product_code || '').toLowerCase();
            return name.includes(keyword.toLowerCase()) || code.includes(keyword.toLowerCase());
        });
    }
    
    // 페이지당 표시 개수 복원
    if (perPage) {
        itemsPerPage = perPage === 'all' ? 'all' : parseInt(perPage);
        document.getElementById('itemsPerPageSelect').value = perPage;
    }
    
    // 페이지 번호 복원
    if (page) {
        currentPage = parseInt(page);
    }
    
    displayProducts(currentPage);
}

// URL 업데이트 함수
function updateURL() {
    const params = new URLSearchParams();
    
    if (currentPage > 1) {
        params.set('page', currentPage);
    }
    
    if (currentSearchTerm) {
        params.set('keyword', currentSearchTerm);
    }
    
    if (itemsPerPage !== 20) {
        params.set('per_page', itemsPerPage);
    }
    
    const newURL = params.toString() ? 
        `${window.location.pathname}?${params.toString()}` : 
        window.location.pathname;
    
    // URL 업데이트 (페이지 새로고침 없이)
    window.history.replaceState({}, '', newURL);
}

// 검색 실행 - 필터링 후 하이라이트
function executeSearch() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    currentSearchTerm = searchTerm;  // 현재 검색어 저장
    
    if (!searchTerm) {
        // 검색어가 없으면 전체 표시
        filteredProducts = [...allProducts];
    } else {
        // 검색어가 있으면 필터링
        filteredProducts = allProducts.filter(product => {
            const name = (product.name || '').toLowerCase();
            const code = (product.product_code || '').toLowerCase();
            return name.includes(searchTerm) || code.includes(searchTerm);
        });
    }
    
    currentPage = 1;
    displayProducts(currentPage);
    updateURL();
    autocompleteDropdown.classList.remove('show');
}

// 검색 초기화
function resetSearch() {
    searchInput.value = '';
    currentSearchTerm = '';
    filteredProducts = [...allProducts];
    currentPage = 1;
    autocompleteDisplayLimit = 10;
    displayProducts(currentPage);
    updateURL();
    autocompleteDropdown.classList.remove('show');
}

// 검색 입력 시 자동완성
searchInput.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase().trim();
    
    // 검색어가 변경되면 limit 초기화
    autocompleteDisplayLimit = 10;
    
    if (searchTerm.length < 1) {
        autocompleteDropdown.classList.remove('show');
        currentAutocompleteResults = [];
        return;
    }
    
    // 검색어와 일치하는 상품 찾기
    const matchingProducts = allProducts.filter(product => {
        const name = (product.name || '').toLowerCase();
        const code = (product.product_code || '').toLowerCase();
        return name.includes(searchTerm) || code.includes(searchTerm);
    });
    
    currentAutocompleteResults = matchingProducts;
    
    if (matchingProducts.length === 0) {
        autocompleteDropdown.innerHTML = `
            <div style="padding: 30px; text-align: center; color: #adb5bd;">
                <i class="bi bi-search" style="font-size: 2.5rem; color: #dee2e6;"></i>
                <p style="margin-top: 15px; font-weight: 500;">검색 결과가 없습니다</p>
                <p style="font-size: 0.9rem; color: #adb5bd;">다른 키워드로 검색해보세요</p>
            </div>
        `;
        autocompleteDropdown.classList.add('show');
        return;
    }
    
    renderAutocompleteResults(matchingProducts, searchTerm, autocompleteDisplayLimit);
});

// 자동완성 결과 렌더링 함수
function renderAutocompleteResults(products, searchTerm, limit) {
    let html = '';
    const displayProducts = products.slice(0, limit);
    
    displayProducts.forEach(product => {
        const highlightedName = highlightText(product.name, searchTerm);
        const highlightedCode = highlightText(product.product_code || '-', searchTerm);
        
        html += `
            <div class="autocomplete-item" onclick="goToProductDetail(${product.id})">
                ${product.thumbnail ? 
                    `<img src="${product.thumbnail}" class="autocomplete-thumbnail">` :
                    `<div class="autocomplete-thumbnail"><i class="bi bi-image"></i></div>`
                }
                <div class="autocomplete-info">
                    <div class="autocomplete-name">${highlightedName}</div>
                    <div class="autocomplete-code">코드: ${highlightedCode}</div>
                </div>
            </div>
        `;
    });
    
    // 더 많은 결과가 있으면 더보기 버튼 표시
    if (products.length > limit) {
        const remaining = products.length - limit;
        html += `
            <div style="padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); 
                        text-align: center; border-top: 2px solid #e9ecef;">
                <button onclick="loadMoreAutocomplete('${searchTerm}')" 
                        class="btn btn-outline-primary btn-sm"
                        style="width: 100%; max-width: 300px; font-weight: 600; border-radius: 10px; padding: 10px 20px;">
                    <i class="bi bi-chevron-down"></i>
                    ${remaining}개 더보기
                </button>
            </div>
        `;
    } else if (products.length > 10) {
        html += `
            <div style="padding: 12px; background: #f8f9fa; text-align: center; 
                        color: #636e72; font-size: 0.9rem; border-top: 1px solid #e9ecef;">
                <i class="bi bi-check-circle"></i> 전체 ${products.length}개 결과
            </div>
        `;
    }
    
    // 엔터키 안내 추가
    html += `
        <div style="padding: 10px 15px; background: #f0f2f5; border-top: 1px solid #e9ecef; 
                    text-align: center; font-size: 0.85rem; color: #6c757d;">
            <i class="bi bi-info-circle"></i> 클릭 시 상품 상세 페이지로 이동 | Enter 키로 필터링
        </div>
    `;
    
    autocompleteDropdown.innerHTML = html;
    autocompleteDropdown.classList.add('show');
    selectedIndex = -1;
}

// 자동완성 더보기 버튼 클릭
function loadMoreAutocomplete(searchTerm) {
    autocompleteDisplayLimit += 20;
    renderAutocompleteResults(currentAutocompleteResults, searchTerm, autocompleteDisplayLimit);
    
    setTimeout(() => {
        autocompleteDropdown.scrollTo({
            top: autocompleteDropdown.scrollHeight,
            behavior: 'smooth'
        });
    }, 50);
}

// 텍스트 하이라이트
function highlightText(text, searchTerm) {
    if (!searchTerm || !text) return text;
    
    const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
}

// 상품 상세 페이지로 이동 (현재 상태 저장)
function goToProductDetail(productId) {
    const params = new URLSearchParams();
    params.set('return_page', currentPage);
    if (currentSearchTerm) params.set('return_keyword', currentSearchTerm);
    if (itemsPerPage !== 20) params.set('return_per_page', itemsPerPage);
    
    window.location.href = `/products/${productId}?${params.toString()}`;
}

// 클릭 외부 영역 시 드롭다운 닫기
document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
        autocompleteDropdown.classList.remove('show');
    }
});

// 키보드 네비게이션
let selectedIndex = -1;
searchInput.addEventListener('keydown', function(e) {
    const items = autocompleteDropdown.querySelectorAll('.autocomplete-item');
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
        updateSelection(items);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, -1);
        updateSelection(items);
    } else if (e.key === 'Enter') {
        e.preventDefault();
        if (selectedIndex >= 0 && items[selectedIndex]) {
            items[selectedIndex].click();
        } else {
            executeSearch();
        }
    } else if (e.key === 'Escape') {
        autocompleteDropdown.classList.remove('show');
        selectedIndex = -1;
    }
});

function updateSelection(items) {
    items.forEach((item, index) => {
        if (index === selectedIndex) {
            item.style.background = '#f8f9fa';
            item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        } else {
            item.style.background = '';
        }
    });
}

// 상품 편집 - 현재 상태 저장
function editProduct(productId) {
    const params = new URLSearchParams();
    params.set('return_page', currentPage);
    if (currentSearchTerm) params.set('return_keyword', currentSearchTerm);
    if (itemsPerPage !== 20) params.set('return_per_page', itemsPerPage);
    
    window.location.href = `/products/edit/${productId}?${params.toString()}`;
}

// 상품 삭제
function deleteProduct(productId) {
    if (confirm('정말로 이 상품을 삭제하시겠습니까?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/products/delete/${productId}`;
        
        // 현재 페이지 정보 추가
        const pageInput = document.createElement('input');
        pageInput.type = 'hidden';
        pageInput.name = 'return_page';
        pageInput.value = currentPage;
        form.appendChild(pageInput);
        
        if (currentSearchTerm) {
            const keywordInput = document.createElement('input');
            keywordInput.type = 'hidden';
            keywordInput.name = 'return_keyword';
            keywordInput.value = currentSearchTerm;
            form.appendChild(keywordInput);
        }
        
        if (itemsPerPage !== 20) {
            const perPageInput = document.createElement('input');
            perPageInput.type = 'hidden';
            perPageInput.name = 'return_per_page';
            perPageInput.value = itemsPerPage;
            form.appendChild(perPageInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}

// 페이지네이션 함수들
function displayProducts(page = 1) {
    const tbody = document.getElementById('productTableBody');
    
    let start, end, pageProducts;
    if (itemsPerPage === 'all') {
        start = 0;
        end = filteredProducts.length;
        pageProducts = filteredProducts;
    } else {
        start = (page - 1) * itemsPerPage;
        end = start + itemsPerPage;
        pageProducts = filteredProducts.slice(start, end);
    }
    
    tbody.innerHTML = pageProducts.map(product => {
        const productName = currentSearchTerm ? 
            highlightText(product.name, currentSearchTerm) : product.name;
        const productCode = currentSearchTerm ? 
            highlightText(product.product_code || '-', currentSearchTerm) : (product.product_code || '-');
        
        return `
            <tr data-product-id="${product.id}">
                <td>${productCode}</td>
                <td>
                    ${product.thumbnail ? 
                        `<img src="${product.thumbnail}" alt="${product.name}" class="product-thumbnail">` :
                        `<div class="no-thumbnail"><i class="bi bi-image"></i></div>`
                    }
                </td>
                <td>
                    <a href="#" onclick="event.preventDefault(); goToProductDetail(${product.id});" class="product-name-link">
                        ${productName}
                    </a>
                </td>
                <td>${product.price ? `₩${product.price.toLocaleString()}` : '-'}</td>
                <td>${product.customs_cost ? `¥${product.customs_cost.toLocaleString()}` : '-'}</td>
                <td>
                    <input type="checkbox" class="check-small" 
                           ${product.kd_paid ? 'checked' : ''} 
                           disabled>
                </td>
                <td>
                    <input type="checkbox" class="check-small" 
                           ${product.customs_paid ? 'checked' : ''}
                           disabled>
                </td>
                <td>
                    ${product.coupang_link ? 
                        `<a href="${product.coupang_link}" target="_blank" class="link-btn link-btn-coupang">바로가기</a>` : 
                        '-'
                    }
                </td>
                <td>
                    ${product.naver_link ? 
                        `<a href="${product.naver_link}" target="_blank" class="link-btn link-btn-naver">바로가기</a>` : 
                        '-'
                    }
                </td>
                <td>
                    ${product.taobao_link ? 
                        `<a href="${product.taobao_link}" target="_blank" class="link-btn link-btn-taobao">바로가기</a>` : 
                        '-'
                    }
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-action" onclick="editProduct(${product.id})" title="수정">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn-action delete" onclick="deleteProduct(${product.id})" title="삭제">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    updatePagination();
    
    const startNum = filteredProducts.length > 0 ? start + 1 : 0;
    const endNum = itemsPerPage === 'all' ? filteredProducts.length : Math.min(end, filteredProducts.length);
    document.getElementById('productInfo').textContent = 
        `${startNum}-${endNum} / 전체 ${filteredProducts.length}개`;
}

function updatePagination() {
    const pagination = document.querySelector('.pagination');
    
    if (itemsPerPage === 'all') {
        pagination.innerHTML = '';
        return;
    }
    
    const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
    
    let paginationHTML = `
        <button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
            <i class="bi bi-chevron-left"></i>
        </button>
    `;
    
    let startPage = Math.max(1, currentPage - 4);
    let endPage = Math.min(totalPages, startPage + 9);
    
    if (endPage - startPage < 9) {
        startPage = Math.max(1, endPage - 9);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                ${i}
            </button>
        `;
    }
    
    paginationHTML += `
        <button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
            <i class="bi bi-chevron-right"></i>
        </button>
    `;
    
    pagination.innerHTML = paginationHTML;
}

function goToPage(page) {
    if (itemsPerPage === 'all') return;
    
    const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    displayProducts(currentPage);
    updateURL();
    
    // 페이지 상단으로 스크롤
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// 페이지당 표시 개수 변경
function changeItemsPerPage(value) {
    if (value === 'all') {
        itemsPerPage = 'all';
    } else {
        itemsPerPage = parseInt(value);
    }
    currentPage = 1;
    displayProducts(currentPage);
    updateURL();
}

// 페이지 로드 시 초기 표시
document.addEventListener('DOMContentLoaded', function() {
    console.log(`총 상품 수: ${allProducts.length}개`);
    
    // URL에서 페이지 상태 복원
    restorePageState();
});
</script>
{% endblock %}