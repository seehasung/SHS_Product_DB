<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µê´€ ê´€ë¦¬</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    
    <!-- âœ… í†µê´€ íƒ€ì„ë¼ì¸ ìŠ¤íƒ€ì¼ ì¶”ê°€ -->
    <style>
        /* í†µê´€ íƒ€ì„ë¼ì¸ ìŠ¤íƒ€ì¼ */
        .customs-timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline-item {
            display: flex;
            margin-bottom: 20px;
            position: relative;
        }

        .timeline-item:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 15px;
            top: 35px;
            bottom: -20px;
            width: 2px;
            background: #dee2e6;
        }

        .timeline-marker {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
            z-index: 1;
        }

        .timeline-content {
            margin-left: 20px;
            flex-grow: 1;
        }

        .timeline-date {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .timeline-title {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .timeline-location {
            color: #6c757d;
            font-size: 0.9em;
        }

        .timeline-remark {
            color: #28a745;
            font-size: 0.85em;
            margin-top: 3px;
        }

        .customs-info h4 {
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <h1>ì£¼ë¬¸ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</h1>
        
        <!-- ê¸°ì¡´ ì£¼ë¬¸ ëª©ë¡ í…Œì´ë¸” -->
        <div class="card mt-4">
            <div class="card-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ì£¼ë¬¸ë²ˆí˜¸</th>
                            <th>êµ¬ë§¤ì</th>
                            <th>ìˆ˜ì·¨ì¸</th>
                            <th>ì†¡ì¥ë²ˆí˜¸</th>
                            <th>íƒë°°ì‚¬</th>
                            <th>ìƒíƒœ</th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td>{{ order.order_number }}</td>
                            <td>{{ order.buyer_name }}</td>
                            <td>{{ order.recipient_name }}</td>
                            <td>{{ order.tracking_number }}</td>
                            <td>{{ order.courier_company }}</td>
                            <td>{{ order.status }}</td>
                            <td>
                                <!-- ë°°ì†¡ ì¡°íšŒ ë²„íŠ¼ -->
                                <button onclick="viewTracking({{ order.id }})" 
                                        class="btn btn-sm btn-primary">
                                    <i class="fas fa-truck"></i> ë°°ì†¡ì¡°íšŒ
                                </button>
                                
                                <!-- âœ… í†µê´€ ì¡°íšŒ ë²„íŠ¼ ì¶”ê°€ -->
                                {% if order.tracking_number or order.master_bl %}
                                <button onclick="viewCustoms({{ order.id }})" 
                                        class="btn btn-sm btn-info ml-2">
                                    <i class="fas fa-plane"></i> í†µê´€ì¡°íšŒ
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- âœ… í†µê´€ ì¡°íšŒ ì„¹ì…˜ ì¶”ê°€ -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-search"></i> í†µê´€ ì§„í–‰ì •ë³´ ì¡°íšŒ
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <strong>ğŸ’¡ ì¡°íšŒ ë°©ë²•:</strong>
                    <ul class="mb-0">
                        <li><strong>êµ­ì œíŠ¹ì†¡ (EMS, DHL ë“±)</strong>: ì†¡ì¥ë²ˆí˜¸ë§Œ ì…ë ¥</li>
                        <li><strong>ì¼ë°˜ ìˆ˜ì…í™”ë¬¼</strong>: ë§ˆìŠ¤í„° B/L ì…ë ¥ (í•˜ìš°ìŠ¤ B/L ì„ íƒ)</li>
                    </ul>
                </div>
                
                <form id="customsSearchForm" onsubmit="searchCustoms(event)">
                    <!-- ì†¡ì¥ë²ˆí˜¸ ì…ë ¥ -->
                    <div class="form-group">
                        <label><i class="fas fa-barcode"></i> ì†¡ì¥ë²ˆí˜¸ (êµ­ì œíŠ¹ì†¡)</label>
                        <input type="text" class="form-control" id="trackingNumberInput" 
                               placeholder="ì˜ˆ: EZ123456789KR">
                    </div>
                    
                    <div class="text-center my-3">
                        <strong>ë˜ëŠ”</strong>
                    </div>
                    
                    <!-- B/L ë²ˆí˜¸ ì…ë ¥ -->
                    <div class="form-row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-ship"></i> ë§ˆìŠ¤í„° B/L (ì¼ë°˜í™”ë¬¼)</label>
                                <input type="text" class="form-control" id="masterBlInput" 
                                       placeholder="ì˜ˆ: ABCD1234567">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-box"></i> í•˜ìš°ìŠ¤ B/L (ì„ íƒ)</label>
                                <input type="text" class="form-control" id="houseBlInput" 
                                       placeholder="ì„ íƒì‚¬í•­">
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block btn-lg">
                        <i class="fas fa-search"></i> í†µê´€ ì¡°íšŒ
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- âœ… í†µê´€ ì¡°íšŒ ëª¨ë‹¬ ì¶”ê°€ -->
    <div class="modal fade" id="customsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-clipboard-check"></i> í†µê´€ ì§„í–‰ì •ë³´
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="customsContent">
                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> ë‹«ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- âœ… ë¡œë”© ì˜¤ë²„ë ˆì´ ì¶”ê°€ -->
    <div id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <div class="text-light mt-3">
                <h5>í†µê´€ ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</h5>
            </div>
        </div>
    </div>

    <!-- jQuery, Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- âœ… í†µê´€ ì¡°íšŒ JavaScript ì¶”ê°€ -->
    <script>
        // ë¡œë”© í‘œì‹œ/ìˆ¨ê¹€
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // ì£¼ë¬¸ IDë¡œ í†µê´€ ì¡°íšŒ
        async function viewCustoms(orderId) {
            try {
                console.log('=== í†µê´€ ì¡°íšŒ ì‹œì‘ ===');
                console.log('Order ID:', orderId);
                
                showLoading();
                
                const response = await fetch(`/orders/api/customs/${orderId}`);
                const data = await response.json();
                
                console.log('í†µê´€ ì¡°íšŒ ì‘ë‹µ:', data);
                
                hideLoading();
                
                if (data.success) {
                    displayCustomsModal(data);
                } else {
                    alert(data.message || 'í†µê´€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('í†µê´€ ì¡°íšŒ ì˜¤ë¥˜:', error);
                hideLoading();
                alert('í†µê´€ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì†¡ì¥ë²ˆí˜¸/B/Lë¡œ ì§ì ‘ ì¡°íšŒ
        async function searchCustoms(event) {
            event.preventDefault();
            
            const trackingNumber = document.getElementById('trackingNumberInput').value.trim();
            const masterBl = document.getElementById('masterBlInput').value.trim();
            const houseBl = document.getElementById('houseBlInput').value.trim();
            
            // ì…ë ¥ ê²€ì¦
            if (!trackingNumber && !masterBl) {
                alert('ì†¡ì¥ë²ˆí˜¸ ë˜ëŠ” ë§ˆìŠ¤í„° B/Lì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            try {
                showLoading();
                
                let url = '';
                let params = new URLSearchParams();
                
                // ì†¡ì¥ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ íŠ¹ì†¡í™”ë¬¼ ì¡°íšŒ
                if (trackingNumber) {
                    url = '/orders/api/customs/search/tracking';
                    params.append('tracking_number', trackingNumber);
                } 
                // ë§ˆìŠ¤í„° B/Lì´ ìˆìœ¼ë©´ ì¼ë°˜í™”ë¬¼ ì¡°íšŒ
                else if (masterBl) {
                    url = '/orders/api/customs/search';
                    params.append('master_bl', masterBl);
                    if (houseBl) {
                        params.append('house_bl', houseBl);
                    }
                }
                
                const response = await fetch(`${url}?${params.toString()}`);
                const data = await response.json();
                
                console.log('í†µê´€ ì¡°íšŒ ì‘ë‹µ:', data);
                
                hideLoading();
                
                if (data.success) {
                    displayCustomsModal(data);
                    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                    document.getElementById('customsSearchForm').reset();
                } else {
                    alert(data.message || 'í†µê´€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('í†µê´€ ì¡°íšŒ ì˜¤ë¥˜:', error);
                hideLoading();
                alert('í†µê´€ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í†µê´€ ì •ë³´ ëª¨ë‹¬ í‘œì‹œ
        function displayCustomsModal(data) {
            const modal = document.getElementById('customsModal');
            const content = document.getElementById('customsContent');
            
            let html = `
                <div class="customs-info">
                    <h4><i class="fas fa-info-circle"></i> ì¡°íšŒ ì •ë³´</h4>
                    <table class="table table-bordered">
                        <tr>
            `;
            
            // íŠ¹ì†¡í™”ë¬¼ì¸ ê²½ìš°
            if (data.query_type === 'express') {
                html += `
                    <th width="20%">ì†¡ì¥ë²ˆí˜¸</th>
                    <td colspan="3">${data.tracking_number || '-'}</td>
                `;
            } 
            // ì¼ë°˜í™”ë¬¼ì¸ ê²½ìš°
            else {
                html += `
                    <th width="20%">ë§ˆìŠ¤í„° B/L</th>
                    <td>${data.master_bl || '-'}</td>
                    <th width="20%">í•˜ìš°ìŠ¤ B/L</th>
                    <td>${data.house_bl || '-'}</td>
                `;
            }
            
            html += `
                        </tr>
                    </table>
                    
                    <h4 class="mt-4"><i class="fas fa-clipboard-list"></i> í†µê´€ ìƒì„¸ì •ë³´</h4>
                    <table class="table table-striped">
                        <thead class="thead-dark">
                            <tr>
                                <th>í’ˆëª…</th>
                                <th>í†µê´€ìƒíƒœ</th>
                                <th>ìˆ˜ëŸ‰/ì¤‘ëŸ‰</th>
                                <th>ë°œì†¡êµ­</th>
                                <th>ìˆ˜í•˜ì¸</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            if (data.customs_info && data.customs_info.length > 0) {
                data.customs_info.forEach(info => {
                    const weight = info.weight ? `${info.weight}kg` : '-';
                    const quantity = info.quantity ? `${info.quantity}ê°œ` : '';
                    
                    html += `
                        <tr>
                            <td>${info.product_name || info.prnm || '-'}</td>
                            <td><span class="badge badge-primary badge-pill">${info.customs_status || info.csclPrgsStts || '-'}</span></td>
                            <td>${quantity} ${weight}</td>
                            <td>${info.departure_country || info.shipNat || '-'}</td>
                            <td>${info.receiver_name || info.cnsiNm || '-'}</td>
                        </tr>
                    `;
                });
            } else {
                html += `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            <i class="fas fa-exclamation-circle"></i> í†µê´€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
            }
            
            html += `
                        </tbody>
                    </table>
            `;
            
            // ì§„í–‰ ì´ë ¥
            if (data.events && data.events.length > 0) {
                html += `
                    <h4 class="mt-4"><i class="fas fa-history"></i> í†µê´€ ì§„í–‰ ì´ë ¥</h4>
                    <div class="customs-timeline">
                `;
                
                data.events.forEach((event, index) => {
                    html += `
                        <div class="timeline-item">
                            <div class="timeline-marker">${index + 1}</div>
                            <div class="timeline-content">
                                <div class="timeline-date">
                                    <i class="far fa-calendar-alt"></i> ${event.eventDate} ${event.eventTime}
                                </div>
                                <div class="timeline-title">
                                    <i class="fas fa-tag"></i> ${event.eventName}
                                </div>
                                ${event.location ? `<div class="timeline-location"><i class="fas fa-map-marker-alt"></i> ${event.location}</div>` : ''}
                                ${event.remark ? `<div class="timeline-remark"><i class="fas fa-comment"></i> ${event.remark}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                    </div>
                `;
            } else {
                html += `
                    <div class="alert alert-warning mt-4">
                        <i class="fas fa-exclamation-triangle"></i> í†µê´€ ì§„í–‰ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                `;
            }
            
            html += `</div>`;
            
            content.innerHTML = html;
            $(modal).modal('show');
        }

        // ë°°ì†¡ ì¡°íšŒ í•¨ìˆ˜ (ê¸°ì¡´)
        async function viewTracking(orderId) {
            // ê¸°ì¡´ ë°°ì†¡ ì¡°íšŒ ë¡œì§...
            alert('ë°°ì†¡ ì¡°íšŒ: Order ID ' + orderId);
        }
    </script>