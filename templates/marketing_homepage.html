{% extends "base.html" %}
{% block title %}ë§ˆì¼€íŒ… - í†µí˜ì´ì§€{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* ========================================
       ğŸ¨ marketing_cafe.htmlê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼
       ======================================== */
    
    /* ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* ì¹´ë“œ */
    .card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        margin-bottom: 30px;
        animation: fadeInUp 0.8s ease-out;
    }
    
    .card:hover {
        transform: translateY(-8px) scale(1.01);
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15);
    }
    
    /* ë²„íŠ¼ */
    .btn {
        border-radius: 14px;
        padding: 10px 20px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
    }
    
    .btn-primary, .btn-info {
        background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
        color: white;
        box-shadow: 0 8px 24px rgba(74, 144, 226, 0.35);
    }
    
    .btn-primary:hover, .btn-info:hover {
        background: linear-gradient(135deg, #3A7BC8 0%, #4A90E2 100%);
        transform: translateY(-4px);
        box-shadow: 0 12px 32px rgba(74, 144, 226, 0.45);
        color: white;
    }
    
    /* ========================================
       ğŸ“Š ëŒ€ì‹œë³´ë“œ ë° ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ ìŠ¤íƒ€ì¼
       ======================================== */
    
    .dashboard-header {
        background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        color: white;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }
    
    @media (max-width: 992px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 576px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .stat-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        animation: fadeInUp 0.8s ease-out;
        text-align: center;
    }
    
    .stat-card:hover {
        transform: translateY(-8px) scale(1.01);
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15);
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
    }
    
    .date-nav {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 25px 0;
        gap: 20px;
        flex-wrap: wrap;
    }
    
    .date-display {
        font-size: 1.4rem;
        font-weight: bold;
        min-width: 250px;
        text-align: center;
        color: #495057;
    }
    
    .filter-btn {
        border-radius: 20px;
        padding: 10px 20px;
        margin: 0 5px;
        transition: all 0.3s;
        border: 2px solid #dee2e6;
        background: white;
        color: #495057;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .filter-btn.active {
        background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
        color: white;
        transform: scale(1.05);
        border-color: transparent;
        box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
    }
    
    .filter-btn:hover:not(.active) {
        background: #f8f9fa;
        border-color: #4A90E2;
        color: #4A90E2;
        transform: translateY(-2px);
    }
    
    .filter-btn .badge {
        margin-left: 8px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
    }
    
    /* ========================================
       ğŸ“Š ìŠ¤ì¼€ì¤„ í…Œì´ë¸” ìŠ¤íƒ€ì¼
       ======================================== */
    
    .schedule-table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .schedule-table thead {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .schedule-table th {
        font-weight: 700;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        white-space: nowrap;
        padding: 16px 12px;
        font-size: 0.9rem;
    }
    
    .schedule-table tbody td {
        padding: 16px 12px;
        vertical-align: middle;
        border-color: #f0f1f3;
        font-size: 0.9rem;
    }
    
    .schedule-row {
        transition: all 0.3s;
    }
    
    .schedule-row:hover {
        background: linear-gradient(135deg, rgba(74, 144, 226, 0.05) 0%, rgba(91, 163, 245, 0.05) 100%);
    }
    
    .status-badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        white-space: nowrap;
        display: inline-block;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .status-pending {
        background: linear-gradient(135deg, #ffd43b 0%, #fcc419 100%);
        color: #000;
    }
    
    .status-completed {
        background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        color: white;
    }
    
    .status-in-progress {
        background: linear-gradient(135deg, #339af0 0%, #228be6 100%);
        color: white;
    }
    
    .status-skipped {
        background: linear-gradient(135deg, #868e96 0%, #495057 100%);
        color: white;
    }
    
    .check-complete {
        width: 22px;
        height: 22px;
        cursor: pointer;
    }
    
    .check-complete:checked {
        background-color: #51cf66;
        border-color: #51cf66;
    }
    
    .keyword-badge {
        background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        color: #495057;
        padding: 6px 12px;
        border-radius: 12px;
        font-size: 0.85rem;
        white-space: nowrap;
        display: inline-block;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .action-buttons {
        display: flex;
        gap: 5px;
        justify-content: center;
        flex-wrap: nowrap;
    }
    
    .action-buttons .btn-sm {
        padding: 6px 10px;
        font-size: 0.8rem;
    }
    
    .no-data {
        padding: 60px;
        text-align: center;
        color: #adb5bd;
        background: #f8f9fa;
        border-radius: 10px;
    }
    
    .no-data i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #dee2e6;
    }
    
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
    .form-check-input:checked {
        background-color: #198754;
        border-color: #198754;
    }
    
    .form-check-label {
        font-size: 0.9em;
        margin-left: 0.3em;
    }
    
    #workersTable th:nth-child(6) {
        min-width: 120px;
    }
    
    .table th {
        background-color: #f8f9fa;
    }
    
    .img-thumbnail {
        object-fit: cover;
    }
    
    .badge {
        font-size: 0.9em;
    }
    
    .progress {
        margin-top: 5px;
    }
    
    .collapsed .when-expanded {
        display: none;
    }
    
    .when-collapsed {
        display: inline;
    }
    
    .collapsed .when-collapsed {
        display: inline;
    }
    
    :not(.collapsed) .when-collapsed {
        display: none;
    }
    
    :not(.collapsed) .when-expanded {
        display: inline;
    }
    
    .table-secondary {
        opacity: 0.6;
    }
    
    .card-header h5 {
        margin: 0;
    }
    
    .badge {
        font-size: 0.85em;
        padding: 0.35em 0.65em;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    #postDetailBody .bg-light {
        background-color: #f8f9fa !important;
    }
    
    #postDetailBody img {
        transition: transform 0.2s;
    }
    
    #postDetailBody img:hover {
        transform: scale(1.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>ğŸ  í†µí˜ì´ì§€ ì‘ì—… ê´€ë¦¬</h1>
        <a href="/" class="btn btn-secondary">â† í™ˆìœ¼ë¡œ</a>
    </div>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <ul class="nav nav-tabs" id="homepageTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab">
                ğŸ“Š ì „ì²´ í˜„í™©
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="products-tab" data-bs-toggle="tab" href="#products" role="tab">
                ğŸ“¦ ìƒí’ˆ ê´€ë¦¬
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="posts-tab" data-bs-toggle="tab" href="#posts" role="tab">
                âœï¸ ê¸€ ê´€ë¦¬
            </a>
        </li>
        {% if is_manager %}
        <li class="nav-item">
            <a class="nav-link" id="accounts-tab" data-bs-toggle="tab" href="#accounts" role="tab">
                ğŸ‘¤ ê³„ì • ê´€ë¦¬
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="workers-tab" data-bs-toggle="tab" href="#workers" role="tab">
                ğŸ‘¥ ì‘ì—…ì ê´€ë¦¬
            </a>
        </li>
        {% endif %}
    </ul>

    <!-- íƒ­ ì½˜í…ì¸  -->
    <div class="tab-content mt-3" id="homepageTabContent">
        
        <!-- ==================== íƒ­ 1: ì „ì²´ í˜„í™© (ì¹´í˜ ìŠ¤íƒ€ì¼ ì ìš©) ==================== -->
        <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
            <div class="p-3">
                
                <!-- âœ… 1. ëŒ€ì‹œë³´ë“œ í—¤ë” -->
                <div class="dashboard-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="mb-0">ğŸ“Š ì˜¤ëŠ˜ì˜ ì‘ì—… í˜„í™©</h1>
                            <p class="mb-0 mt-2 opacity-90" id="selectedDateText">{{ today }}</p>
                        </div>
                        <div>
                            {% if is_manager %}
                            <button type="button" class="btn btn-light btn-lg" onclick="assignDailyTasks()">
                                <i class="bi bi-plus-circle"></i> ì˜¤ëŠ˜ ì‘ì—… ìë™ ë°°ì •
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- âœ… 2. í†µê³„ ëŒ€ì‹œë³´ë“œ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">ì˜¤ëŠ˜ í•  ì¼</div>
                        <div class="stat-value text-primary" id="statTotal">0</div>
                        <small class="text-muted">ì´ ì‘ì—…</small>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì™„ë£Œ</div>
                        <div class="stat-value text-success" id="statCompleted">0</div>
                        <small class="text-muted" id="statCompletedPercent">0%</small>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì§„í–‰ì¤‘</div>
                        <div class="stat-value text-info" id="statInProgress">0</div>
                        <small class="text-muted">ì‘ì—… ì¤‘</small>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ëŒ€ê¸°ì¤‘</div>
                        <div class="stat-value text-warning" id="statPending">0</div>
                        <small class="text-muted">ì‹œì‘ ì „</small>
                    </div>
                </div>
                
                <!-- âœ… 3. ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ -->
                <div class="date-nav">
                    <button class="btn btn-outline-primary" onclick="changeDateHomepage(-1)">
                        <i class="bi bi-chevron-left"></i> ì´ì „ë‚ 
                    </button>
                    <div class="date-display">
                        <i class="bi bi-calendar3"></i> <span id="displayDate"></span>
                        <span id="todayBadge" class="badge bg-success" style="display:none;">ì˜¤ëŠ˜</span>
                    </div>
                    <button class="btn btn-outline-primary" onclick="changeDateHomepage(1)">
                        ë‹¤ìŒë‚  <i class="bi bi-chevron-right"></i>
                    </button>
                    <input type="date" id="dateSelector" class="form-control" style="width: auto;" 
                        onchange="selectDateHomepage(this.value)">
                </div>
                
                <!-- âœ… 4. í•„í„° ë²„íŠ¼ -->
                <div class="text-center mb-4">
                    <button class="btn filter-btn active" onclick="filterStatusHomepage('all')">
                        ì „ì²´ <span class="badge bg-secondary" id="filterAllCount">0</span>
                    </button>
                    <button class="btn filter-btn" onclick="filterStatusHomepage('pending')">
                        ëŒ€ê¸°ì¤‘ <span class="badge bg-warning text-dark" id="filterPendingCount">0</span>
                    </button>
                    <button class="btn filter-btn" onclick="filterStatusHomepage('in_progress')">
                        ì§„í–‰ì¤‘ <span class="badge bg-info" id="filterInProgressCount">0</span>
                    </button>
                    <button class="btn filter-btn" onclick="filterStatusHomepage('completed')">
                        ì™„ë£Œ <span class="badge bg-success" id="filterCompletedCount">0</span>
                    </button>
                    <button class="btn filter-btn" onclick="filterStatusHomepage('skipped')">
                        ê±´ë„ˆëœ€ <span class="badge bg-secondary" id="filterSkippedCount">0</span>
                    </button>
                </div>
                
                <!-- âœ… 5. ì‘ì—… ëª©ë¡ í…Œì´ë¸” -->
                <div class="schedule-table">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th width="50" class="text-center">ì™„ë£Œ</th>
                                <th>ì‘ì—…ì</th>
                                <th>ê³„ì •</th>
                                <th>ìƒí’ˆ</th>
                                <th>í‚¤ì›Œë“œ</th>
                                <th width="100">ìƒíƒœ</th>
                                <th width="120">ì‘ì„±ëœ ê¸€</th>
                                <th width="180" class="text-center">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleTableBody">
                            <tr>
                                <td colspan="8">
                                    <div class="no-data">
                                        <i class="bi bi-calendar-x"></i>
                                        <p class="mb-2">ì‘ì—…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ==================== íƒ­ 2: ìƒí’ˆ ê´€ë¦¬ ==================== -->
        <div class="tab-pane fade" id="products" role="tabpanel">
            {% if is_manager %}
            <div class="alert alert-info d-flex justify-content-between align-items-center">
                <div>
                    <strong>ğŸ’¡ ì•ˆë‚´:</strong> ê° ìƒí’ˆì˜ í‚¤ì›Œë“œë¥¼ í†µí˜ì´ì§€ì—ì„œ ì‚¬ìš©í• ì§€ ON/OFF í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
                <div>
                    <button class="btn btn-primary me-2" onclick="syncAllKeywords()">
                        <i class="bi bi-arrow-repeat"></i> í‚¤ì›Œë“œ ë™ê¸°í™”
                    </button>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="expandAllProducts()">
                        â–¼ ì „ì²´ í¼ì¹˜ê¸°
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="collapseAllProducts()">
                        â–² ì „ì²´ ì ‘ê¸°
                    </button>
                </div>
            </div>
            {% endif %}
            <div id="productsContainer">
                <p class="text-center">ë¡œë”© ì¤‘...</p>
            </div>
        </div>

        <!-- ==================== íƒ­ 3: ê¸€ ê´€ë¦¬ ==================== -->
        <div class="tab-pane fade" id="posts" role="tabpanel">
            <div class="mb-3">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPostModal">
                    â• ê¸€ ì‘ì„±
                </button>
            </div>

            <table class="table table-hover" id="postsTable">
                <thead>
                    <tr>
                        <th>ë‚ ì§œ</th>
                        <th>ì œëª©</th>
                        <th>í‚¤ì›Œë“œ</th>
                        <th>í†µê³„</th>
                        <th>ì´ë¯¸ì§€</th>
                        <th>ì‘ì—…ì</th>
                        <th>ê³„ì •</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="postsTableBody">
                    <tr>
                        <td colspan="8" class="text-center">ë¡œë”© ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ==================== íƒ­ 4: ê³„ì • ê´€ë¦¬ (ê´€ë¦¬ì ì „ìš©) ==================== -->
        {% if is_manager %}
        <div class="tab-pane fade" id="accounts" role="tabpanel">
            <div class="mb-3">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                    â• ê³„ì • ì¶”ê°€
                </button>
            </div>

            <table class="table table-hover" id="accountsTable">
                <thead>
                    <tr>
                        <th>ê³„ì • ID</th>
                        <th>í†µí˜ì´ì§€ URL</th>
                        <th>IP ì£¼ì†Œ</th>
                        <th>ì¹´í…Œê³ ë¦¬</th>
                        <th>ë°°ì •ëœ ì‘ì—…ì</th>
                        <th>ìƒíƒœ</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="accountsTableBody">
                    <tr>
                        <td colspan="7" class="text-center">ë¡œë”© ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ==================== íƒ­ 5: ì‘ì—…ì ê´€ë¦¬ (ê´€ë¦¬ì ì „ìš©) ==================== -->
        <div class="tab-pane fade" id="workers" role="tabpanel">
            <div class="mb-3">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWorkerModal">
                    â• ì‘ì—…ì ì¶”ê°€
                </button>
            </div>

            <table class="table table-hover" id="workersTable">
                <thead>
                    <tr>
                        <th>ì‘ì—…ìëª…</th>
                        <th>í†µí˜ì´ì§€ ê³„ì •</th>
                        <th>í˜„ì¬ ìƒí’ˆ</th>
                        <th>ì§„í–‰ë¥ </th>
                        <th>ì¼ì¼ ì‘ì—…ëŸ‰</th>
                        <th>í†µí˜ì´ì§€ ê´€ë¦¬ì</th>
                        <th>ìƒíƒœ</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="workersTableBody">
                    <tr>
                        <td colspan="8" class="text-center">ë¡œë”© ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% endif %}

    </div>
</div>

<!-- ==================== ëª¨ë‹¬: ê¸€ ì‘ì„± ==================== -->
<div class="modal fade" id="createPostModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">âœï¸ í†µí˜ì´ì§€ ê¸€ ì‘ì„±</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createPostForm" enctype="multipart/form-data">
                    <input type="hidden" id="taskId" name="task_id">
                    
                    <div class="mb-3">
                        <label class="form-label">ì‘ì—… ì„ íƒ</label>
                        <select class="form-select" id="taskSelect" required>
                            <option value="">ì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ì œëª©</label>
                        <input type="text" class="form-control" id="postTitle" name="title" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ë³¸ë¬¸</label>
                        <textarea class="form-control" id="postBody" name="body" rows="10" required></textarea>
                        <small class="text-muted">
                            í˜„ì¬ ê¸€ì ìˆ˜: <span id="charCount">0</span>ì
                        </small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">í†µí˜ì´ì§€ URL (ì„ íƒ)</label>
                        <input type="text" class="form-control" id="postUrl" name="post_url" 
                               placeholder="https://blog.naver.com/...">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ì´ë¯¸ì§€ ì²¨ë¶€ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</label>
                        <input type="file" class="form-control" id="postImages" name="images" 
                               multiple accept="image/*">
                    </div>

                    <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
                    <div class="mb-3" id="imagePreviewContainer" style="display: none;">
                        <label class="form-label">ì²¨ë¶€ëœ ì´ë¯¸ì§€ (<span id="imageCount">0</span>ê°œ)</label>
                        <div class="d-flex flex-wrap gap-2" id="imagePreview"></div>
                    </div>

                    <!-- í‚¤ì›Œë“œ ì¶œí˜„ íšŸìˆ˜ -->
                    <div class="alert alert-info" id="keywordAlert" style="display: none;">
                        ğŸ¯ íƒ€ê²Ÿ í‚¤ì›Œë“œ: <strong id="targetKeyword"></strong><br>
                        í‚¤ì›Œë“œ ì¶œí˜„ íšŸìˆ˜: <span id="keywordCount" class="badge bg-primary">0</span>íšŒ
                        <small class="text-muted">(ê¶Œì¥: 3~5íšŒ)</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="submitPost()">ì‘ì„± ì™„ë£Œ</button>
            </div>
        </div>
    </div>
</div>

<!-- ==================== ëª¨ë‹¬: ê³„ì • ì¶”ê°€ ==================== -->
{% if is_manager %}
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ê³„ì • ì¶”ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addAccountForm">
                    <div class="mb-3">
                        <label class="form-label">ê³„ì • ID</label>
                        <input type="text" class="form-control" name="account_id" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" class="form-control" name="account_pw" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">í†µí˜ì´ì§€ URL</label>
                        <input type="text" class="form-control" name="blog_url">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">IP ì£¼ì†Œ</label>
                        <input type="text" class="form-control" name="ip_address">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                        <input type="text" class="form-control" name="category">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="submitAccount()">ì¶”ê°€</button>
            </div>
        </div>
    </div>
</div>

<!-- ==================== ëª¨ë‹¬: ê³„ì • ìˆ˜ì • ==================== -->
<div class="modal fade" id="editAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ê³„ì • ìˆ˜ì •</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editAccountId">
                
                <div class="mb-3">
                    <label class="form-label">ê³„ì • ID</label>
                    <input type="text" class="form-control" id="editAccountAccountId" readonly>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">ë¹„ë°€ë²ˆí˜¸ (ë³€ê²½ ì‹œë§Œ ì…ë ¥)</label>
                    <input type="password" class="form-control" id="editAccountPw" 
                           placeholder="ë³€ê²½í•˜ì§€ ì•Šìœ¼ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš”">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">í†µí˜ì´ì§€ URL</label>
                    <input type="text" class="form-control" id="editBlogUrl">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">IP ì£¼ì†Œ</label>
                    <input type="text" class="form-control" id="editIpAddress">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                    <input type="text" class="form-control" id="editCategory">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">ë°°ì •ëœ ì‘ì—…ì</label>
                    <select class="form-select" id="editAssignedWorker">
                        <option value="0">ë¯¸ë°°ì •</option>
                    </select>
                    <small class="text-muted">ì‘ì—…ìë¥¼ ë³€ê²½í•˜ë©´ ìë™ìœ¼ë¡œ ì¬ë°°ì •ë©ë‹ˆë‹¤</small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">ìƒíƒœ</label>
                    <select class="form-select" id="editStatus">
                        <option value="active">í™œì„±</option>
                        <option value="inactive">ë¹„í™œì„±</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="submitEditAccount()">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<!-- ==================== ëª¨ë‹¬: ì‘ì—…ì ì¶”ê°€ ==================== -->
<div class="modal fade" id="addWorkerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì‘ì—…ì ì¶”ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addWorkerForm">
                    <div class="mb-3">
                        <label class="form-label">ì‚¬ì´íŠ¸ íšŒì› ì„ íƒ</label>
                        <select class="form-select" name="user_id" id="userSelect" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì‹œì‘ ìƒí’ˆ ì„ íƒ</label>
                        <select class="form-select" name="product_id" id="productSelect" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì¼ì¼ ì‘ì—…ëŸ‰</label>
                        <input type="number" class="form-control" name="daily_quota" value="3" min="1" required>
                        <small class="text-muted">ê³„ì •ë‹¹ ìµœëŒ€ 3ê°œì”© ë°°ì •ë©ë‹ˆë‹¤</small>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" name="is_homepage_manager" id="isHomepageManager">
                        <label class="form-check-label" for="isHomepageManager">
                            í†µí˜ì´ì§€ ê´€ë¦¬ìë¡œ ì§€ì •
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="submitWorker()">ì¶”ê°€</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ==================== JavaScript ==================== -->
<script>
// ==================== ì „ì—­ ë³€ìˆ˜ ====================
let currentSelectedDateHomepage = new Date().toISOString().split('T')[0];
let todaySchedulesHomepage = [];

// ==================== í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ====================
document.addEventListener('DOMContentLoaded', function() {
    // ë‚ ì§œ ì´ˆê¸°í™”
    document.getElementById('dateSelector').value = currentSelectedDateHomepage;
    updateDateDisplay();
    
    loadHomepageDashboard();
    loadProducts();
    loadPosts();
    
    {% if is_manager %}
    loadAccounts();
    loadWorkers();
    loadAvailableUsers();
    loadProductsForSelect();
    {% endif %}

    // íƒ­ ì „í™˜ ì‹œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            const target = e.target.getAttribute('href');
            if (target === '#dashboard') loadHomepageDashboard();
            else if (target === '#products') loadProducts();
            else if (target === '#posts') loadPosts();
            else if (target === '#accounts') loadAccounts();
            else if (target === '#workers') loadWorkers();
        });
    });

    // ê¸€ ì‘ì„± ëª¨ë‹¬ - ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
    document.getElementById('postImages').addEventListener('change', function(e) {
        const files = e.target.files;
        const preview = document.getElementById('imagePreview');
        const container = document.getElementById('imagePreviewContainer');
        const count = document.getElementById('imageCount');
        
        preview.innerHTML = '';
        count.textContent = files.length;
        
        if (files.length > 0) {
            container.style.display = 'block';
            
            Array.from(files).forEach((file, i) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'position-relative';
                    div.innerHTML = `
                        <img src="${e.target.result}" class="img-thumbnail" 
                             style="width: 100px; height: 100px; object-fit: cover;">
                        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0"
                                onclick="removeImage(${i})">Ã—</button>
                    `;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        } else {
            container.style.display = 'none';
        }
    });

    // ê¸€ ì‘ì„± - ì‹¤ì‹œê°„ ê¸€ì ìˆ˜ & í‚¤ì›Œë“œ ì¹´ìš´íŠ¸
    const titleInput = document.getElementById('postTitle');
    const bodyInput = document.getElementById('postBody');
    
    function updateStats() {
        const title = titleInput.value;
        const body = bodyInput.value;
        const charCount = body.length;
        const keyword = document.getElementById('targetKeyword').textContent;
        
        document.getElementById('charCount').textContent = charCount;
        
        if (keyword) {
            const combined = title + ' ' + body;
            const count = (combined.toLowerCase().match(new RegExp(keyword.toLowerCase(), 'g')) || []).length;
            document.getElementById('keywordCount').textContent = count;
        }
    }
    
    titleInput.addEventListener('input', updateStats);
    bodyInput.addEventListener('input', updateStats);

    // ì‘ì—… ì„ íƒ ì‹œ í‚¤ì›Œë“œ í‘œì‹œ
    document.getElementById('taskSelect').addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        if (option.value) {
            const keyword = option.dataset.keyword;
            document.getElementById('taskId').value = option.value;
            document.getElementById('targetKeyword').textContent = keyword;
            document.getElementById('keywordAlert').style.display = 'block';
            updateStats();
        } else {
            document.getElementById('keywordAlert').style.display = 'none';
        }
    });
});

// ==================== ğŸ“… ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ ====================
function updateDateDisplay() {
    const dateObj = new Date(currentSelectedDateHomepage);
    const today = new Date().toISOString().split('T')[0];
    
    const year = dateObj.getFullYear();
    const month = dateObj.getMonth() + 1;
    const day = dateObj.getDate();
    const dateStr = `${year}ë…„ ${month}ì›” ${day}ì¼`;
    
    document.getElementById('displayDate').textContent = dateStr;
    document.getElementById('selectedDateText').textContent = dateStr;
    
    if (currentSelectedDateHomepage === today) {
        document.getElementById('todayBadge').style.display = 'inline';
    } else {
        document.getElementById('todayBadge').style.display = 'none';
    }
}

function changeDateHomepage(days) {
    const dateObj = new Date(currentSelectedDateHomepage);
    dateObj.setDate(dateObj.getDate() + days);
    currentSelectedDateHomepage = dateObj.toISOString().split('T')[0];
    
    document.getElementById('dateSelector').value = currentSelectedDateHomepage;
    updateDateDisplay();
    loadHomepageDashboard();
}

function selectDateHomepage(date) {
    currentSelectedDateHomepage = date;
    updateDateDisplay();
    loadHomepageDashboard();
}

// ==================== ğŸ¯ ìƒíƒœ í•„í„°ë§ ====================
function filterStatusHomepage(status) {
    const rows = document.querySelectorAll('.schedule-row');
    const buttons = document.querySelectorAll('.filter-btn');
    
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    rows.forEach(row => {
        if (status === 'all' || row.dataset.status === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// ==================== âœ… ì™„ë£Œ í† ê¸€ ====================
function toggleCompleteHomepage(scheduleId, checkbox) {
    fetch(`/marketing/homepage/api/schedule/${scheduleId}/toggle-complete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            is_completed: checkbox.checked
        })
    }).then(response => {
        if (response.ok) {
            loadHomepageDashboard();
        } else {
            checkbox.checked = !checkbox.checked;
            alert('ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    });
}

// ==================== ğŸ”„ ìƒíƒœ ë³€ê²½ ====================
function changeHomepageStatus(scheduleId, newStatus) {
    const statusNames = {
        'pending': 'ëŒ€ê¸°ì¤‘',
        'in_progress': 'ì§„í–‰ì¤‘',
        'completed': 'ì™„ë£Œ',
        'skipped': 'ê±´ë„ˆëœ€'
    };
    
    if (confirm(`ìƒíƒœë¥¼ "${statusNames[newStatus]}"(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        fetch(`/marketing/homepage/api/schedule/${scheduleId}/change-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: newStatus
            })
        }).then(response => {
            if (response.ok) {
                loadHomepageDashboard();
            } else {
                alert('ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
}

// ==================== âœï¸ ìŠ¤ì¼€ì¤„ ìˆ˜ì • ====================
function editHomepageSchedule(scheduleId, currentStatus) {
    if (currentStatus !== 'completed') {
        fetch(`/marketing/homepage/api/schedule/${scheduleId}/change-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: 'in_progress'
            })
        }).then(response => {
            if (response.ok) {
                const row = document.querySelector(`tr[data-schedule-id="${scheduleId}"]`);
                if (row) {
                    const statusBadge = row.querySelector('.status-badge');
                    if (statusBadge) {
                        statusBadge.className = 'status-badge status-in-progress';
                        statusBadge.textContent = 'ì§„í–‰ì¤‘';
                    }
                    row.setAttribute('data-status', 'in_progress');
                }
            }
        });
    }
    
    openCreatePostModal(scheduleId, '');
}

// ==================== ğŸ—‘ï¸ ìŠ¤ì¼€ì¤„ ì‚­ì œ ====================
function deleteHomepageSchedule(scheduleId) {
    if (confirm('ì´ ìŠ¤ì¼€ì¤„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        fetch(`/marketing/homepage/api/schedule/${scheduleId}/delete`, {
            method: 'POST'
        }).then(response => {
            if (response.ok) {
                loadHomepageDashboard();
            } else {
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }
}

// ==================== ì „ì²´ í˜„í™© ====================
function loadHomepageDashboard() {
    fetch(`/marketing/homepage/api/dashboard?date=${currentSelectedDateHomepage}`)
        .then(r => r.json())
        .then(data => {
            const total = data.total || 0;
            const completed = data.completed || 0;
            const inProgress = data.in_progress || 0;
            const pending = data.pending || 0;
            
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statCompleted').textContent = completed;
            document.getElementById('statInProgress').textContent = inProgress;
            document.getElementById('statPending').textContent = pending;
            
            const completedPercent = total > 0 ? Math.round((completed / total) * 100) : 0;
            document.getElementById('statCompletedPercent').textContent = completedPercent + '%';
            
            todaySchedulesHomepage = data.schedules || [];
            
            renderScheduleTable();
            updateFilterCounts();
        })
        .catch(error => {
            console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
        });
}

function renderScheduleTable() {
    const tbody = document.getElementById('scheduleTableBody');
    
    if (todaySchedulesHomepage.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8">
                    <div class="no-data">
                        <i class="bi bi-calendar-x"></i>
                        <p class="mb-2">ì„ íƒí•œ ë‚ ì§œì— í• ë‹¹ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = todaySchedulesHomepage.map(schedule => `
        <tr class="schedule-row" data-status="${schedule.status}" data-schedule-id="${schedule.id}">
            <td class="text-center">
                <input type="checkbox" 
                    class="form-check-input check-complete" 
                    ${schedule.is_completed ? 'checked' : ''}
                    onchange="toggleCompleteHomepage(${schedule.id}, this)"
                    ${schedule.status === 'completed' || schedule.status === 'skipped' ? 'disabled' : ''}
                    data-bs-toggle="tooltip" 
                    title="${schedule.status === 'completed' ? 'ì™„ë£Œ ì ê¹€' : 'ì™„ë£Œ ì²´í¬'}">
            </td>
            <td><strong>${schedule.worker_name || 'ë¯¸í• ë‹¹'}</strong></td>
            <td><span class="text-primary">${schedule.account_id || 'ë¯¸í• ë‹¹'}</span></td>
            <td><small>${schedule.product_name || '-'}</small></td>
            <td><span class="keyword-badge">${schedule.keyword}</span></td>
            <td>
                <span class="status-badge status-${schedule.status.replace('_', '-')}">
                    ${schedule.status === 'pending' ? 'ëŒ€ê¸°ì¤‘' :
                      schedule.status === 'in_progress' ? 'ì§„í–‰ì¤‘' :
                      schedule.status === 'completed' ? 'ì™„ë£Œ' : 'ê±´ë„ˆëœ€'}
                </span>
            </td>
            <td>
                ${schedule.post_url ? 
                    `<a href="${schedule.post_url}" target="_blank" class="btn btn-sm btn-success">
                        <i class="bi bi-box-arrow-up-right"></i> ë³´ê¸°
                    </a>` : 
                    '<span class="text-muted">-</span>'}
            </td>
            <td class="text-center">
                <div class="action-buttons">
                    <button class="btn btn-sm ${schedule.status === 'completed' ? 'btn-success' : 'btn-outline-info'}" 
                            onclick="editHomepageSchedule(${schedule.id}, '${schedule.status}')"
                            ${schedule.status === 'completed' ? 'disabled' : ''}
                            data-bs-toggle="tooltip" 
                            title="${schedule.status === 'completed' ? 'ì™„ë£Œëœ ê¸€ì€ ìˆ˜ì • ë¶ˆê°€' : 'ìˆ˜ì •'}">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning"
                            onclick="changeHomepageStatus(${schedule.id}, 'pending')"
                            data-bs-toggle="tooltip" title="ëŒ€ê¸°ì¤‘">
                        <i class="bi bi-pause-circle"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary"
                            onclick="changeHomepageStatus(${schedule.id}, 'skipped')"
                            data-bs-toggle="tooltip" title="ê±´ë„ˆë›°ê¸°">
                        <i class="bi bi-skip-forward"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger"
                            onclick="deleteHomepageSchedule(${schedule.id})"
                            data-bs-toggle="tooltip" title="ì‚­ì œ">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
    
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
}

function updateFilterCounts() {
    const all = todaySchedulesHomepage.length;
    const pending = todaySchedulesHomepage.filter(s => s.status === 'pending').length;
    const inProgress = todaySchedulesHomepage.filter(s => s.status === 'in_progress').length;
    const completed = todaySchedulesHomepage.filter(s => s.status === 'completed').length;
    const skipped = todaySchedulesHomepage.filter(s => s.status === 'skipped').length;
    
    document.getElementById('filterAllCount').textContent = all;
    document.getElementById('filterPendingCount').textContent = pending;
    document.getElementById('filterInProgressCount').textContent = inProgress;
    document.getElementById('filterCompletedCount').textContent = completed;
    document.getElementById('filterSkippedCount').textContent = skipped;
}

function openCreatePostModal(taskId, keyword) {
    const modal = new bootstrap.Modal(document.getElementById('createPostModal'));
    
    fetch('/marketing/homepage/api/tasks/today')
        .then(r => r.json())
        .then(tasks => {
            const select = document.getElementById('taskSelect');
            const pendingTasks = tasks.filter(t => t.status === 'pending');
            
            select.innerHTML = '<option value="">ì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”</option>' +
                pendingTasks.map(t => 
                    `<option value="${t.id}" data-keyword="${t.keyword}" ${t.id === taskId ? 'selected' : ''}>
                        ${t.product_name} - ${t.keyword}
                    </option>`
                ).join('');
            
            if (taskId) {
                select.value = taskId;
                select.dispatchEvent(new Event('change'));
            }
        });
    
    modal.show();
}

function assignDailyTasks() {
    if (!confirm('ì˜¤ëŠ˜ ì‘ì—…ì„ ìë™ìœ¼ë¡œ ë°°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    const formData = new FormData();
    fetch('/marketing/homepage/api/schedule/auto-assign', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message);
        loadHomepageDashboard();
    })
    .catch(err => {
        alert('ì˜¤ë¥˜: ' + err.message);
    });
}

// ==================== ìƒí’ˆ ê´€ë¦¬ ====================
function loadProducts() {
    fetch('/marketing/homepage/api/products')
        .then(r => r.json())
        .then(products => {
            const container = document.getElementById('productsContainer');
            
            if (products.length === 0) {
                container.innerHTML = '<p class="text-center">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }
            
            container.innerHTML = products.map(product => {
                const hasKeywords = product.homepage_keywords.length > 0;
                const activeCount = product.homepage_keywords.filter(kw => kw.is_active).length;
                const totalCount = product.homepage_keywords.length;
                
                return `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-3">
                                <h5 class="mb-0">${product.product_code} - ${product.name}</h5>
                                ${hasKeywords ? `
                                    <span class="badge bg-primary">
                                        í‚¤ì›Œë“œ: ${activeCount}/${totalCount}ê°œ
                                    </span>
                                ` : ''}
                            </div>
                            <div class="d-flex gap-2">
                                {% if is_manager %}
                                ${hasKeywords ? 
                                    `<button class="btn btn-sm btn-outline-primary" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#keywords-${product.id}"
                                            aria-expanded="false">
                                        <span class="when-collapsed">â–¼ í¼ì¹˜ê¸°</span>
                                        <span class="when-expanded">â–² ì ‘ê¸°</span>
                                    </button>` : 
                                    `<button class="btn btn-sm btn-primary" onclick="syncKeywords(${product.id})">
                                        í‚¤ì›Œë“œ ë™ê¸°í™”
                                    </button>`}
                                {% endif %}
                            </div>
                        </div>
                        
                        ${hasKeywords ? `
                            <div class="collapse" id="keywords-${product.id}">
                                <div class="card-body">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th style="width: 60px;">ìˆœì„œ</th>
                                                <th>í‚¤ì›Œë“œ</th>
                                                <th style="width: 120px;">í†µí˜ì´ì§€ ì‚¬ìš©</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${product.homepage_keywords.map((kw, i) => `
                                                <tr class="${!kw.is_active ? 'table-secondary' : ''}">
                                                    <td>${i + 1}</td>
                                                    <td>${kw.text}</td>
                                                    <td>
                                                        {% if is_manager %}
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" 
                                                                   ${kw.is_active ? 'checked' : ''}
                                                                   onchange="toggleKeyword(${kw.id})">
                                                        </div>
                                                        {% else %}
                                                        ${kw.is_active ? 'âœ… ON' : 'âŒ OFF'}
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : `
                            <div class="card-body">
                                <p class="text-muted mb-0">í‚¤ì›Œë“œë¥¼ ë™ê¸°í™”í•´ì£¼ì„¸ìš”</p>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        });
}

function syncKeywords(productId) {
    if (!confirm('ê¸°ë³¸ í‚¤ì›Œë“œë¥¼ í†µí˜ì´ì§€ í‚¤ì›Œë“œë¡œ ë™ê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    fetch(`/marketing/homepage/api/products/${productId}/sync-keywords`, {
        method: 'POST'
    })
    .then(r => r.json())
    .then(data => {
        if (data.keyword_count === 0) {
            alert('âš ï¸ ' + data.message);
        } else {
            alert('âœ… ' + data.message);
        }
        loadProducts();
    })
    .catch(error => {
        console.error('ë™ê¸°í™” ì˜¤ë¥˜:', error);
        alert('ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

function toggleKeyword(keywordId) {
    fetch(`/marketing/homepage/api/keywords/${keywordId}/toggle`, {
        method: 'PUT'
    })
    .then(r => r.json())
    .then(data => {
        console.log('Toggled:', data.is_active);
    });
}

// ==================== ê¸€ ê´€ë¦¬ ====================
function loadPosts() {
    fetch('/marketing/homepage/api/posts')
        .then(r => r.json())
        .then(posts => {
            const tbody = document.getElementById('postsTableBody');
            
            if (posts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            tbody.innerHTML = posts.map(post => `
                <tr>
                    <td>${post.created_at}</td>
                    <td>${post.title}</td>
                    <td><span class="badge bg-info">${post.keyword}</span></td>
                    <td>
                        ğŸ“ ${post.char_count}ì<br>
                        ğŸ¯ í‚¤ì›Œë“œ ${post.keyword_count}íšŒ
                    </td>
                    <td>
                        ${post.images.length > 0 ? `
                            <div class="d-flex gap-1">
                                ${post.images.slice(0, 2).map(img => `
                                    <img src="/static/uploads/homepage_images/${img.filename}" 
                                         class="img-thumbnail" style="width: 40px; height: 40px;">
                                `).join('')}
                                ${post.images.length > 2 ? 
                                    `<span class="badge bg-secondary">+${post.images.length - 2}</span>` : ''}
                            </div>
                        ` : '-'}
                    </td>
                    <td>${post.worker_name}</td>
                    <td>${post.account_id}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewPost(${post.id})">ë³´ê¸°</button>
                        {% if is_manager %}
                        <button class="btn btn-sm btn-danger" onclick="deletePost(${post.id})">ì‚­ì œ</button>
                        {% endif %}
                    </td>
                </tr>
            `).join('');
        });
}

function submitPost() {
    const form = document.getElementById('createPostForm');
    const formData = new FormData(form);
    
    const files = document.getElementById('postImages').files;
    for (let file of files) {
        formData.append('images', file);
    }
    
    fetch('/marketing/homepage/api/posts', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message);
        bootstrap.Modal.getInstance(document.getElementById('createPostModal')).hide();
        form.reset();
        loadHomepageDashboard();
        loadPosts();
    })
    .catch(err => {
        alert('ì˜¤ë¥˜: ' + err.message);
    });
}

function viewPost(postId) {
    fetch('/marketing/homepage/api/posts/' + postId)
        .then(r => {
            if (!r.ok) throw new Error('ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return r.json();
        })
        .then(post => {
            const modal = new bootstrap.Modal(document.getElementById('createPostModal'));
            modal.show();
            
            setTimeout(() => {
                try {
                    const modalTitle = document.querySelector('#createPostModal .modal-title');
                    if (modalTitle) modalTitle.textContent = 'âœï¸ í†µí˜ì´ì§€ ê¸€ ìˆ˜ì •';
                    
                    const form = document.getElementById('createPostForm');
                    if (form) {
                        form.reset();
                        
                        const taskIdElem = document.getElementById('taskId');
                        const titleElem = document.getElementById('postTitle');
                        const bodyElem = document.getElementById('postBody');
                        const urlElem = document.getElementById('postUrl');
                        
                        if (taskIdElem) taskIdElem.value = post.task_id || '';
                        if (titleElem) titleElem.value = post.title;
                        if (bodyElem) bodyElem.value = post.body;
                        if (urlElem) urlElem.value = post.post_url || '';
                        
                        const taskSelect = document.getElementById('taskSelect');
                        if (taskSelect) {
                            taskSelect.innerHTML = `<option value="" selected>${post.product_name} - ${post.keyword}</option>`;
                            taskSelect.disabled = true;
                        }
                        
                        const targetKeyword = document.getElementById('targetKeyword');
                        const keywordAlert = document.getElementById('keywordAlert');
                        
                        if (targetKeyword) targetKeyword.textContent = post.keyword;
                        if (keywordAlert) keywordAlert.style.display = 'block';
                        
                        const charCountElem = document.getElementById('charCount');
                        const keywordCountElem = document.getElementById('keywordCount');
                        
                        if (charCountElem) charCountElem.textContent = post.char_count;
                        if (keywordCountElem) keywordCountElem.textContent = post.keyword_count;
                        
                        if (post.images && post.images.length > 0) {
                            const container = document.getElementById('imagePreviewContainer');
                            const preview = document.getElementById('imagePreview');
                            const count = document.getElementById('imageCount');
                            
                            if (container && preview && count) {
                                container.style.display = 'block';
                                count.textContent = post.images.length;
                                
                                preview.innerHTML = post.images.map((img, i) => `
                                    <div class="position-relative">
                                        <img src="/static/uploads/homepage_images/${img.filename}" 
                                             class="img-thumbnail" 
                                             style="width: 100px; height: 100px; object-fit: cover;">
                                        <span class="badge bg-secondary position-absolute top-0 start-0">ê¸°ì¡´</span>
                                    </div>
                                `).join('');
                            }
                        }
                        
                        form.dataset.editMode = 'true';
                        form.dataset.postId = postId;
                    }
                    
                    const submitBtn = document.querySelector('#createPostModal .modal-footer .btn-primary');
                    if (submitBtn) {
                        submitBtn.textContent = 'ìˆ˜ì • ì™„ë£Œ';
                        submitBtn.onclick = function() { submitPostEdit(postId); };
                    }
                    
                } catch (error) {
                    console.error('ëª¨ë‹¬ ì„¤ì • ì¤‘ ì˜¤ë¥˜:', error);
                    alert('ëª¨ë‹¬ì„ ì—¬ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }, 100);
            
        })
        .catch(err => {
            console.error('Error:', err);
            alert('ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message);
        });
}

function submitPostEdit(postId) {
    const form = document.getElementById('createPostForm');
    if (!form) {
        alert('í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    const formData = new FormData(form);
    
    const filesInput = document.getElementById('postImages');
    if (filesInput && filesInput.files) {
        const files = filesInput.files;
        for (let file of files) {
            formData.append('images', file);
        }
    }
    
    fetch(`/marketing/homepage/api/posts/${postId}`, {
        method: 'PUT',
        body: formData
    })
    .then(r => {
        if (!r.ok) throw new Error('ìˆ˜ì • ì‹¤íŒ¨');
        return r.json();
    })
    .then(data => {
        alert('ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
        
        const modalElement = document.getElementById('createPostModal');
        if (modalElement) {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) modal.hide();
        }
        
        form.reset();
        form.dataset.editMode = 'false';
        delete form.dataset.postId;
        
        const modalTitle = document.querySelector('#createPostModal .modal-title');
        if (modalTitle) modalTitle.textContent = 'âœï¸ í†µí˜ì´ì§€ ê¸€ ì‘ì„±';
        
        const submitBtn = document.querySelector('#createPostModal .modal-footer .btn-primary');
        if (submitBtn) {
            submitBtn.textContent = 'ì‘ì„± ì™„ë£Œ';
            submitBtn.onclick = submitPost;
        }
        
        const taskSelect = document.getElementById('taskSelect');
        if (taskSelect) taskSelect.disabled = false;
        
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        if (imagePreviewContainer) imagePreviewContainer.style.display = 'none';
        
        loadPosts();
        loadHomepageDashboard();
    })
    .catch(err => {
        console.error('ìˆ˜ì • ì˜¤ë¥˜:', err);
        alert('ì˜¤ë¥˜: ' + err.message);
    });
}

function deletePost(postId) {
    if (!confirm('ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ê¸€ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
    }
    
    fetch(`/marketing/homepage/api/posts/${postId}`, {
        method: 'DELETE'
    })
    .then(r => {
        if (!r.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
        return r.json();
    })
    .then(data => {
        alert(data.message || 'ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadPosts();
        loadHomepageDashboard();
    })
    .catch(err => {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', err);
        alert('ì˜¤ë¥˜: ' + err.message);
    });
}

// ==================== ê³„ì • ê´€ë¦¬ ====================
{% if is_manager %}
function loadAccounts() {
    fetch('/marketing/homepage/api/accounts')
        .then(r => r.json())
        .then(accounts => {
            const tbody = document.getElementById('accountsTableBody');
            
            if (accounts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">ë“±ë¡ëœ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            tbody.innerHTML = accounts.map(acc => `
                <tr>
                    <td>${acc.account_id}</td>
                    <td>${acc.blog_url || '-'}</td>
                    <td>${acc.ip_address || '-'}</td>
                    <td>${acc.category || '-'}</td>
                    <td>${acc.assigned_worker_name || 'ë¯¸ë°°ì •'}</td>
                    <td>
                        <span class="badge bg-${acc.status === 'active' ? 'success' : 'secondary'}">
                            ${acc.status === 'active' ? 'í™œì„±' : 'ë¹„í™œì„±'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" onclick="editAccount(${acc.id})">
                            âœï¸ ìˆ˜ì •
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAccount(${acc.id}, '${acc.account_id}')">
                            ğŸ—‘ï¸ ì‚­ì œ
                        </button>
                    </td>
                </tr>
            `).join('');
        });
}

function submitAccount() {
    const form = document.getElementById('addAccountForm');
    const formData = new FormData(form);
    
    fetch('/marketing/homepage/api/accounts', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message);
        bootstrap.Modal.getInstance(document.getElementById('addAccountModal')).hide();
        form.reset();
        loadAccounts();
    })
    .catch(err => {
        alert('ì˜¤ë¥˜: ' + err.message);
    });
}

function editAccount(accountId) {
    fetch('/marketing/homepage/api/workers')
        .then(r => r.json())
        .then(workers => {
            const workerSelect = document.getElementById('editAssignedWorker');
            workerSelect.innerHTML = '<option value="0">ë¯¸ë°°ì •</option>' +
                workers.map(w => `<option value="${w.id}">${w.username}</option>`).join('');
            
            return fetch('/marketing/homepage/api/accounts');
        })
        .then(r => r.json())
        .then(accounts => {
            const account = accounts.find(a => a.id === accountId);
            if (!account) {
                alert('ê³„ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            document.getElementById('editAccountId').value = account.id;
            document.getElementById('editAccountAccountId').value = account.account_id;
            document.getElementById('editAccountPw').value = '';
            document.getElementById('editBlogUrl').value = account.blog_url || '';
            document.getElementById('editIpAddress').value = account.ip_address || '';
            document.getElementById('editCategory').value = account.category || '';
            document.getElementById('editStatus').value = account.status || 'active';
            
            const workerSelect = document.getElementById('editAssignedWorker');
            if (account.assigned_worker_name) {
                const option = Array.from(workerSelect.options).find(
                    opt => opt.text === account.assigned_worker_name
                );
                if (option) {
                    workerSelect.value = option.value;
                }
            } else {
                workerSelect.value = '0';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('editAccountModal'));
            modal.show();
        })
        .catch(error => {
            console.error('ê³„ì • ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            alert('ê³„ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });
}

function submitEditAccount() {
    const accountId = document.getElementById('editAccountId').value;
    const formData = new FormData();
    
    const password = document.getElementById('editAccountPw').value;
    if (password) formData.append('account_pw', password);
    
    formData.append('blog_url', document.getElementById('editBlogUrl').value);
    formData.append('ip_address', document.getElementById('editIpAddress').value);
    formData.append('category', document.getElementById('editCategory').value);
    formData.append('status', document.getElementById('editStatus').value);
    
    const assignedWorkerId = document.getElementById('editAssignedWorker').value;
    formData.append('assigned_worker_id', assignedWorkerId);
    
    fetch(`/marketing/homepage/api/accounts/${accountId}`, {
        method: 'PUT',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message || 'ê³„ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        bootstrap.Modal.getInstance(document.getElementById('editAccountModal')).hide();
        loadAccounts();
    })
    .catch(error => {
        console.error('ê³„ì • ìˆ˜ì • ì˜¤ë¥˜:', error);
        alert('ê³„ì • ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

async function deleteAccount(accountId, accountName) {
    if (!confirm(`ì •ë§ë¡œ ê³„ì • "${accountName}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/marketing/homepage/api/accounts/${accountId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('ê³„ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadAccounts();
        } else {
            const data = await response.json();
            alert('ì‚­ì œ ì‹¤íŒ¨: ' + (data.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
    } catch (error) {
        console.error('ê³„ì • ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('ê³„ì • ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ==================== ì‘ì—…ì ê´€ë¦¬ ====================
function loadWorkers() {
    fetch('/marketing/homepage/api/workers')
        .then(r => r.json())
        .then(workers => {
            const tbody = document.getElementById('workersTableBody');
            
            if (workers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">ë“±ë¡ëœ ì‘ì—…ìê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            tbody.innerHTML = workers.map(worker => `
                <tr>
                    <td>${worker.username}</td>
                    <td>${worker.accounts.join(', ') || 'ë¯¸ë°°ì •'}</td>
                    <td>${worker.current_product || '-'}</td>
                    <td>
                        ${worker.progress} (${worker.progress_percent}%)
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar" style="width: ${worker.progress_percent}%"></div>
                        </div>
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm" 
                               value="${worker.daily_quota}" min="1" 
                               onchange="updateQuota(${worker.id}, this.value)">
                    </td>
                    <td>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" 
                                   id="homepageManager${worker.id}"
                                   ${worker.is_homepage_manager ? 'checked' : ''}
                                   onchange="toggleHomepageManager(${worker.id}, this.checked)">
                            <label class="form-check-label" for="homepageManager${worker.id}">
                                ${worker.is_homepage_manager ? 'âœ… ê´€ë¦¬ì' : 'ì¼ë°˜'}
                            </label>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-${worker.status === 'active' ? 'success' : 'secondary'}">
                            ${worker.status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" 
                                onclick="toggleWorkerStatus(${worker.id}, '${worker.status}')">
                            ${worker.status === 'active' ? 'ì¤‘ì§€' : 'í™œì„±'}
                        </button>
                        <button class="btn btn-sm btn-danger" 
                                onclick="deleteWorker(${worker.id}, '${worker.username}')">
                            ğŸ—‘ï¸ ì‚­ì œ
                        </button>
                    </td>
                </tr>
            `).join('');
        });
}

function loadAvailableUsers() {
    fetch('/marketing/homepage/api/available-users')
        .then(r => r.json())
        .then(users => {
            const select = document.getElementById('userSelect');
            select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' +
                users.map(u => `<option value="${u.id}">${u.username}</option>`).join('');
        });
}

function loadProductsForSelect() {
    fetch('/marketing/homepage/api/products')
        .then(r => r.json())
        .then(products => {
            const select = document.getElementById('productSelect');
            select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' +
                products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        });
}

function submitWorker() {
    const form = document.getElementById('addWorkerForm');
    const formData = new FormData(form);
    
    fetch('/marketing/homepage/api/workers', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message);
        bootstrap.Modal.getInstance(document.getElementById('addWorkerModal')).hide();
        form.reset();
        loadWorkers();
        loadAvailableUsers();
    })
    .catch(err => {
        alert('ì˜¤ë¥˜: ' + err.message);
    });
}

function updateQuota(workerId, newQuota) {
    const formData = new FormData();
    formData.append('daily_quota', newQuota);
    
    fetch(`/marketing/homepage/api/workers/${workerId}/quota`, {
        method: 'PUT',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message);
        loadWorkers();
    })
    .catch(err => {
        alert('ì˜¤ë¥˜: ' + err.message);
    });
}

function toggleWorkerStatus(workerId, currentStatus) {
    const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
    const formData = new FormData();
    formData.append('status', newStatus);
    
    fetch(`/marketing/homepage/api/workers/${workerId}/status`, {
        method: 'PUT',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message);
        loadWorkers();
    });
}

async function deleteWorker(workerId, username) {
    if (!confirm(`ì •ë§ë¡œ ì‘ì—…ì "${username}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në°°ì •ëœ ê³„ì •ì´ ëª¨ë‘ í•´ì œë©ë‹ˆë‹¤.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/marketing/homepage/api/workers/${workerId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('ì‘ì—…ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadWorkers();
            loadAvailableUsers();
        } else {
            const data = await response.json();
            alert('ì‚­ì œ ì‹¤íŒ¨: ' + (data.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
    } catch (error) {
        console.error('ì‘ì—…ì ì‚­ì œ ì˜¤ë¥˜:', error);
        alert('ì‘ì—…ì ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

function toggleHomepageManager(workerId, isHomepageManager) {
    const formData = new FormData();
    formData.append('is_homepage_manager', isHomepageManager);
    
    fetch(`/marketing/homepage/api/workers/${workerId}/homepage-manager`, {
        method: 'PUT',
        body: formData
    })
    .then(r => {
        if (!r.ok) {
            return r.json().then(data => {
                throw new Error(data.detail || 'ë³€ê²½ ì‹¤íŒ¨');
            });
        }
        return r.json();
    })
    .then(data => {
        alert(data.message);
        loadWorkers();
    })
    .catch(err => {
        alert('ì˜¤ë¥˜: ' + err.message);
        loadWorkers();
    });
}

function expandAllProducts() {
    const collapses = document.querySelectorAll('[id^="keywords-"]');
    collapses.forEach(collapse => {
        const bsCollapse = new bootstrap.Collapse(collapse, {
            show: true
        });
    });
}

function collapseAllProducts() {
    const collapses = document.querySelectorAll('[id^="keywords-"].show');
    collapses.forEach(collapse => {
        const bsCollapse = bootstrap.Collapse.getInstance(collapse);
        if (bsCollapse) {
            bsCollapse.hide();
        }
    });
}

async function syncAllKeywords() {
    if (!confirm('ëª¨ë“  ë§ˆì¼€íŒ… ìƒí’ˆì˜ í‚¤ì›Œë“œë¥¼ ë™ê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ í‚¤ì›Œë“œëŠ” ìœ ì§€ë˜ê³  ìƒˆë¡œìš´ í‚¤ì›Œë“œë§Œ ì¶”ê°€ë©ë‹ˆë‹¤)')) {
        return;
    }

    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ë™ê¸°í™” ì¤‘...';

    try {
        const response = await fetch('/marketing/homepage/api/products/sync-keywords', {
            method: 'POST'
        });

        const result = await response.json();

        if (response.ok) {
            alert(`âœ… í‚¤ì›Œë“œ ë™ê¸°í™” ì™„ë£Œ!\n\n` +
                  `ë™ê¸°í™”ëœ ìƒí’ˆ: ${result.synced_count}ê°œ\n` +
                  `ìƒˆë¡œ ì¶”ê°€ëœ í‚¤ì›Œë“œ: ${result.total_keywords_added}ê°œ`);
            
            await loadProducts();
        } else {
            throw new Error(result.detail || 'ë™ê¸°í™” ì‹¤íŒ¨');
        }
    } catch (error) {
        console.error('í‚¤ì›Œë“œ ë™ê¸°í™” ì˜¤ë¥˜:', error);
        alert('âŒ í‚¤ì›Œë“œ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

{% endif %}
</script>
{% endblock %}