<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>업무 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .stat-card {
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">업무 관리 시스템</a>
            <div class="d-flex">
                <a href="/tasks/create" class="btn btn-primary btn-sm me-2">
                    <i class="bi bi-plus-lg"></i> 새 업무
                </a>
                <a href="/tasks" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-list"></i> 목록
                </a>
                <a href="/" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-house"></i> 홈
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <h2 class="mb-4">
            <i class="bi bi-graph-up"></i> 업무 관리 대시보드
            <small class="text-muted">(관리자 전용)</small>
        </h2>

        <!-- 통계 카드 -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card stat-card text-center">
                    <div class="card-body">
                        <h6 class="text-muted">전체 업무</h6>
                        <div class="stat-number text-primary">{{ stats.total }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card text-center">
                    <div class="card-body">
                        <h6 class="text-muted">새 지시</h6>
                        <div class="stat-number text-danger">{{ stats.new }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card text-center">
                    <div class="card-body">
                        <h6 class="text-muted">진행중</h6>
                        <div class="stat-number text-warning">{{ stats.in_progress }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card text-center">
                    <div class="card-body">
                        <h6 class="text-muted">완료</h6>
                        <div class="stat-number text-success">{{ stats.completed }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card text-center border-warning">
                    <div class="card-body">
                        <h6 class="text-muted">오늘 마감</h6>
                        <div class="stat-number text-warning">{{ stats.today_deadline }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card text-center border-danger">
                    <div class="card-body">
                        <h6 class="text-muted">지연중</h6>
                        <div class="stat-number text-danger">{{ stats.delayed }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 직원별 통계 -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">직원별 통계 (최근 3개월)</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>직원명</th>
                                        <th>총 업무</th>
                                        <th>완료</th>
                                        <th>지연</th>
                                        <th>완료율</th>
                                        <th>진행률</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stat in user_stats %}
                                    <tr>
                                        <td><strong>{{ stat.username }}</strong></td>
                                        <td>{{ stat.total }}</td>
                                        <td><span class="badge bg-success">{{ stat.completed }}</span></td>
                                        <td>
                                            {% if stat.delayed > 0 %}
                                            <span class="badge bg-danger">{{ stat.delayed }}</span>
                                            {% else %}
                                            <span class="badge bg-secondary">0</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if stat.completion_rate >= 80 %}
                                            <span class="badge bg-success">{{ stat.completion_rate }}%</span>
                                            {% elif stat.completion_rate >= 60 %}
                                            <span class="badge bg-warning">{{ stat.completion_rate }}%</span>
                                            {% else %}
                                            <span class="badge bg-danger">{{ stat.completion_rate }}%</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar 
                                                    {% if stat.completion_rate >= 80 %}bg-success
                                                    {% elif stat.completion_rate >= 60 %}bg-warning
                                                    {% else %}bg-danger{% endif %}" 
                                                    role="progressbar" 
                                                    style="width: {{ stat.completion_rate }}%"
                                                    aria-valuenow="{{ stat.completion_rate }}" 
                                                    aria-valuemin="0" 
                                                    aria-valuemax="100">
                                                    {{ stat.completion_rate }}%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 차트 -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">상태별 분포</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 미처리 업무 목록 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0">미처리 업무 목록 (최신순 20개)</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>제목</th>
                                        <th>담당자</th>
                                        <th>상태</th>
                                        <th>우선순위</th>
                                        <th>마감시한</th>
                                        <th>생성일</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for task in pending_tasks %}
                                    <tr>
                                        <td>
                                            <a href="/tasks/{{ task.id }}">{{ task.title }}</a>
                                        </td>
                                        <td>{{ task.assignee.username if task.assignee else '-' }}</td>
                                        <td>
                                            {% if task.status == 'new' %}
                                            <span class="badge bg-danger">새 지시</span>
                                            {% elif task.status == 'confirmed' %}
                                            <span class="badge bg-info">확인함</span>
                                            {% elif task.status == 'in_progress' %}
                                            <span class="badge bg-warning">진행중</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if task.priority == 'urgent' %}
                                            <span class="badge bg-danger">긴급</span>
                                            {% elif task.priority == 'important' %}
                                            <span class="badge bg-warning">중요</span>
                                            {% else %}
                                            <span class="badge bg-primary">보통</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if task.deadline %}
                                            {{ task.deadline.strftime('%m/%d %H:%M') }}
                                            {% else %}
                                            -
                                            {% endif %}
                                        </td>
                                        <td>{{ task.created_at.strftime('%m/%d %H:%M') }}</td>
                                        <td>
                                            <a href="/tasks/{{ task.id }}" class="btn btn-sm btn-outline-primary">
                                                상세보기
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 상태별 분포 차트
        const ctx = document.getElementById('statusChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['새 지시', '확인함', '진행중', '완료'],
                datasets: [{
                    data: [
                        {{ stats.new }},
                        {{ stats.new }},  // confirmed는 따로 없어서 임시로 new 사용
                        {{ stats.in_progress }},
                        {{ stats.completed }}
                    ],
                    backgroundColor: [
                        '#dc3545',
                        '#17a2b8',
                        '#ffc107',
                        '#28a745'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    </script>
</body>
</html>