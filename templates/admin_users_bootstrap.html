{% extends "base.html" %}
{% block title %}사용자 관리{% endblock %}

{% block head %}
{{ super() }}
<style>
    body {
        background: linear-gradient(135deg, #ffffffff 0%, #5BA3F5 100%);
        min-height: 100vh;
    }
    
    .container-fluid {
        max-width: 1600px;
        margin: 0 auto;
        padding: 30px;
    }
    
    /* 헤더 스타일 */
    .page-header {
        background: white;
        border-radius: 15px;
        padding: 25px 30px;
        margin-bottom: 30px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }
    
    .page-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0;
    }
    
    .page-title h1 {
        font-size: 1.8rem;
        font-weight: bold;
        color: #2d3436;
        margin: 0;
    }
    
    /* 검색 바 */
    .search-bar {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
    }
    
    .search-input-wrapper {
        position: relative;
        max-width: 500px;
    }
    
    .search-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #adb5bd;
        font-size: 1.1rem;
    }
    
    .search-input {
        padding: 12px 15px 12px 45px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        width: 100%;
        font-size: 1rem;
        transition: all 0.3s;
    }
    
    .search-input:focus {
        border-color: #4A90E2;
        outline: none;
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }
    
    /* 사용자 테이블 */
    .users-table-container {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
        overflow-x: auto;
    }
    
    .users-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 1200px;
    }
    
    .users-table thead th {
        background: #f8f9fa;
        color: #495057;
        font-weight: 600;
        padding: 15px 12px;
        text-align: left;
        font-size: 0.9rem;
        border-bottom: 2px solid #e9ecef;
        white-space: nowrap;
    }
    
    .users-table tbody tr {
        transition: background 0.2s ease;
        border-bottom: 1px solid #f0f1f3;
    }
    
    .users-table tbody tr:hover {
        background: #f8f9fa;
    }
    
    .users-table td {
        padding: 12px;
        vertical-align: middle;
    }
    
    /* 권한 체크박스 */
    .permission-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    
    .permission-checkbox:checked {
        background-color: #4A90E2;
        border-color: #4A90E2;
    }
    
    /* 일일 할당량 입력 */
    .quota-input {
        width: 80px;
        padding: 6px 10px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
        transition: all 0.3s;
    }
    
    .quota-input:enabled {
        background: white;
    }
    
    .quota-input:disabled {
        background: #f8f9fa;
        color: #adb5bd;
        cursor: not-allowed;
    }
    
    .quota-input:focus:enabled {
        border-color: #4A90E2;
        outline: none;
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }
    
    /* 버튼 스타일 */
    .btn-action {
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    
    .btn-primary-custom {
        background: #4A90E2;
        color: white;
    }
    
    .btn-primary-custom:hover {
        background: #5a67d8;
        transform: translateY(-2px);
    }
    
    .btn-danger-custom {
        background: #e74c3c;
        color: white;
    }
    
    .btn-danger-custom:hover {
        background: #c0392b;
        transform: translateY(-2px);
    }
    
    .btn-warning-custom {
        background: #f39c12;
        color: white;
    }
    
    .btn-warning-custom:hover {
        background: #e67e22;
        transform: translateY(-2px);
    }
    
    .btn-home {
        background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
        color: white;
        padding: 10px 20px;
        border-radius: 10px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-home:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(74, 144, 226, 0.3);
        color: white;
    }
    
    .btn-logs {
        background: white;
        color: #4A90E2;
        border: 2px solid #4A90E2;
        padding: 10px 20px;
        border-radius: 10px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-logs:hover {
        background: #4A90E2;
        color: white;
        transform: translateY(-2px);
    }
    
    /* 뱃지 */
    .badge-admin {
        background: #e74c3c;
        color: white;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .badge-user {
        background: #95a5a6;
        color: white;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    /* 🎨 index.html과 똑같은 모던 스타일 */
    
    /* 애니메이션 */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* 컨테이너 */
    .container, .container-fluid {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
    }
    
    /* 페이지 헤더 */
    .page-header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        padding: 24px 28px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        animation: fadeInUp 0.8s ease-out;
    }
    
    .page-title h1 {
        font-size: 1.8rem;
        font-weight: 700;
        background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    /* 카드 - index.html 스타일 */
    .card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        margin-bottom: 30px;
        animation: fadeInUp 0.8s ease-out;
    }
    
    .card:hover {
        transform: translateY(-8px) scale(1.01);
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15);
    }
    
    .card-header {
        background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
        color: white;
        border-radius: 20px 20px 0 0 !important;
        padding: 20px 24px;
        font-weight: 700;
        border: none;
        box-shadow: 0 4px 16px rgba(74, 144, 226, 0.3);
    }
    
    .card-body {
        padding: 24px;
    }
    
    /* 통계 카드 - index.html 스타일 */
    .stat-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        animation: fadeInUp 0.8s ease-out;
    }
    
    .stat-card:hover {
        transform: translateY(-8px) scale(1.01);
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15);
    }
    
    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        margin-bottom: 16px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 800;
        background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    /* 검색 바 */
    .search-bar {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        padding: 24px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        animation: fadeInUp 0.8s ease-out 0.3s backwards;
    }
    
    .search-input {
        border-radius: 12px;
        border: 2px solid #e9ecef;
        padding: 12px 16px 12px 45px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .search-input:focus {
        border-color: #4A90E2;
        box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.15);
        outline: none;
        transform: translateY(-2px);
    }
    
    /* 테이블 컨테이너 */
    .logs-table-container, .table-responsive {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        animation: fadeInUp 0.8s ease-out 0.5s backwards;
    }
    
    /* 테이블 - index.html 스타일 */
    .table, .logs-table {
        border-radius: 20px;
        overflow: hidden;
    }
    
    .table thead th, .logs-table thead th {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        font-weight: 700;
        color: #495057;
        border: none;
        padding: 16px 20px;
        font-size: 0.9rem;
    }
    
    .table tbody tr, .logs-table tbody tr {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-bottom: 1px solid #f0f1f3;
    }
    
    .table tbody tr:hover, .logs-table tbody tr:hover {
        background: linear-gradient(135deg, rgba(74, 144, 226, 0.05) 0%, rgba(91, 163, 245, 0.05) 100%);
        transform: scale(1.01);
    }
    
    .table tbody td, .logs-table tbody td {
        padding: 16px 20px;
        vertical-align: middle;
        border-color: #f0f1f3;
        font-size: 0.9rem;
    }
    
    /* 버튼 - index.html 스타일 */
    .btn {
        border-radius: 14px;
        padding: 10px 20px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
    }
    
    .btn-sm {
        padding: 8px 16px;
        font-size: 0.85rem;
        border-radius: 12px;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
        color: white;
        box-shadow: 0 8px 24px rgba(74, 144, 226, 0.35);
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #3A7BC8 0%, #4A90E2 100%);
        transform: translateY(-4px);
        box-shadow: 0 12px 32px rgba(74, 144, 226, 0.45);
        color: white;
    }
    
    .btn-secondary {
        background: linear-gradient(135deg, #636e72 0%, #2d3436 100%);
        color: white;
        box-shadow: 0 8px 24px rgba(99, 110, 114, 0.35);
    }
    
    .btn-secondary:hover {
        background: linear-gradient(135deg, #2d3436 0%, #1a1d1f 100%);
        transform: translateY(-4px);
        box-shadow: 0 12px 32px rgba(99, 110, 114, 0.45);
    }
    
    .btn-home, .btn-refresh {
        background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
        color: white;
        padding: 10px 20px;
        border-radius: 14px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
        box-shadow: 0 8px 24px rgba(74, 144, 226, 0.35);
    }
    
    .btn-home:hover, .btn-refresh:hover {
        background: linear-gradient(135deg, #3A7BC8 0%, #4A90E2 100%);
        transform: translateY(-4px);
        box-shadow: 0 12px 32px rgba(74, 144, 226, 0.45);
        color: white;
    }
    
    /* 상태 뱃지 */
    .status-badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
    }
    
    .status-success {
        background: rgba(17, 153, 142, 0.15);
        color: #00b894;
    }
    
    .status-failed {
        background: rgba(214, 48, 49, 0.15);
        color: #d63031;
    }
    
    /* 반응형 */
    @media (max-width: 768px) {
        .container, .container-fluid {
            padding: 0 15px;
        }
        
        .card {
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            padding: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 페이지 헤더 -->
    <div class="page-header">
        <div class="page-title">
            <div style="display: flex; align-items: center; gap: 15px;">
                <h1><i class="bi bi-people-fill"></i> 사용자 관리</h1>
            </div>
            <div style="display: flex; gap: 10px;">
                <a href="/admin/logs" class="btn-logs">
                    <i class="bi bi-clock-history"></i> 로그인 기록
                </a>
                <a href="/" class="btn-home">
                    <i class="bi bi-house-door"></i> 홈으로
                </a>
            </div>
        </div>
    </div>
    
    <!-- 검색 바 -->
    <div class="search-bar">
        <form method="get" action="/admin/users">
            <div class="search-input-wrapper">
                <i class="bi bi-search search-icon"></i>
                <input type="text" 
                       name="search" 
                       class="search-input" 
                       placeholder="사용자 이름으로 검색..." 
                       value="{{ search }}">
            </div>
        </form>
    </div>
    
    <!-- 사용자 테이블 -->
    <div class="users-table-container">
        <table class="users-table">
            <thead>
                <tr>
                    <th width="5%">ID</th>
                    <th width="15%">사용자명</th>
                    <th width="10%" class="text-center">관리자</th>
                    <th width="10%" class="text-center">상품 관리</th>
                    <th width="10%" class="text-center">마케팅 관리</th>
                    <th width="10%" class="text-center">일일 할당량</th>
                    <th width="25%" class="text-center">관리</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>
                        <strong>{{ user.username }}</strong>
                        {% if user.is_admin %}
                        <span class="badge-admin">ADMIN</span>
                        {% else %}
                        <span class="badge-user">USER</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <form method="post" action="/admin/users/toggle-admin/{{ user.id }}" style="display: inline;">
                            <input type="checkbox" 
                                   class="form-check-input permission-checkbox" 
                                   {{ 'checked' if user.is_admin else '' }}
                                   onchange="this.form.submit()"
                                   {{ 'disabled' if user.username == 'shsboss274' else '' }}>
                        </form>
                    </td>
                    <td class="text-center">
                        <form method="post" action="/admin/users/toggle-products/{{ user.id }}" style="display: inline;">
                            <input type="checkbox" 
                                   class="form-check-input permission-checkbox" 
                                   {{ 'checked' if user.can_manage_products else '' }}
                                   onchange="this.form.submit()">
                        </form>
                    </td>
                    <td class="text-center">
                        <form method="post" action="/admin/users/toggle-marketing/{{ user.id }}" style="display: inline;">
                            <input type="checkbox" 
                                   class="form-check-input permission-checkbox" 
                                   {{ 'checked' if user.can_manage_marketing else '' }}
                                   onchange="this.form.submit()">
                        </form>
                    </td>
                    <td class="text-center">
                        <form method="post" action="/admin/users/set-quota/{{ user.id }}" style="display: inline;">
                            <input type="number" 
                                   name="daily_quota" 
                                   class="quota-input" 
                                   value="{{ user.daily_quota or 0 }}"
                                   min="0"
                                   max="50"
                                   {{ 'disabled' if not user.can_manage_marketing else '' }}
                                   onchange="this.form.submit()">
                        </form>
                    </td>
                    <td class="text-center">
                        <div style="display: flex; gap: 5px; justify-content: center;">
                            <!-- 이름 수정 버튼 -->
                            <button type="button" 
                                    class="btn-action btn-primary-custom" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#editModal{{ user.id }}">
                                <i class="bi bi-pencil"></i> 수정
                            </button>
                            
                            <!-- 비밀번호 초기화 버튼 -->
                            {% if user.username != 'shsboss274' %}
                            <form method="post" action="/admin/users/reset-password" style="display: inline;" onsubmit="return confirm('{{ user.username }}의 비밀번호를 1234로 초기화하시겠습니까?');">
                                <input type="hidden" name="user_id" value="{{ user.id }}">
                                <button type="submit" class="btn-action btn-warning-custom">
                                    <i class="bi bi-key"></i> PW 초기화
                                </button>
                            </form>
                            
                            <!-- 삭제 버튼 -->
                            <form method="post" action="/admin/users/delete" style="display: inline;" onsubmit="return confirm('{{ user.username }}를 정말 삭제하시겠습니까?');">
                                <input type="hidden" name="user_id" value="{{ user.id }}">
                                <button type="submit" class="btn-action btn-danger-custom">
                                    <i class="bi bi-trash"></i> 삭제
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                
                <!-- 이름 수정 모달 -->
                <div class="modal fade" id="editModal{{ user.id }}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">사용자 이름 수정</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form method="post" action="/admin/users/update">
                                <div class="modal-body">
                                    <input type="hidden" name="user_id" value="{{ user.id }}">
                                    <div class="mb-3">
                                        <label class="form-label">새 사용자명</label>
                                        <input type="text" 
                                               name="new_username" 
                                               class="form-control" 
                                               value="{{ user.username }}" 
                                               required>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                    <button type="submit" class="btn btn-primary">저장</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                {% if not users %}
                <tr>
                    <td colspan="7" class="text-center" style="padding: 60px;">
                        <div style="color: #adb5bd;">
                            <i class="bi bi-inbox" style="font-size: 3rem; margin-bottom: 15px;"></i>
                            <p style="font-size: 1.1rem;">사용자가 없습니다.</p>
                        </div>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
// 할당량 변경 시 확인 메시지 (선택사항)
document.querySelectorAll('.quota-input').forEach(input => {
    input.addEventListener('change', function(e) {
        if (!this.disabled) {
            const value = this.value;
            if (value < 0 || value > 50) {
                alert('할당량은 0~50 사이의 값이어야 합니다.');
                e.preventDefault();
                return false;
            }
        }
    });
});
</script>
{% endblock %}