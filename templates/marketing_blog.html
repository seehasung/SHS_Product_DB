{% extends "base.html" %}
{% block title %}ë§ˆì¼€íŒ… - ë¸”ë¡œê·¸{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>ğŸ“ ë¸”ë¡œê·¸ ì‘ì—… ê´€ë¦¬</h1>
        <a href="/" class="btn btn-secondary">â† í™ˆìœ¼ë¡œ</a>
    </div>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <ul class="nav nav-tabs" id="blogTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab">
                ğŸ“Š ì „ì²´ í˜„í™©
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="products-tab" data-bs-toggle="tab" href="#products" role="tab">
                ğŸ“¦ ìƒí’ˆ ê´€ë¦¬
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="posts-tab" data-bs-toggle="tab" href="#posts" role="tab">
                âœï¸ ê¸€ ê´€ë¦¬
            </a>
        </li>
        {% if is_manager %}
        <li class="nav-item">
            <a class="nav-link" id="accounts-tab" data-bs-toggle="tab" href="#accounts" role="tab">
                ğŸ‘¤ ê³„ì • ê´€ë¦¬
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="workers-tab" data-bs-toggle="tab" href="#workers" role="tab">
                ğŸ‘¥ ì‘ì—…ì ê´€ë¦¬
            </a>
        </li>
        {% endif %}
    </ul>

    <!-- íƒ­ ì½˜í…ì¸  -->
    <div class="tab-content mt-3" id="blogTabContent">
        
        <!-- ==================== íƒ­ 1: ì „ì²´ í˜„í™© ==================== -->
        <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
            <div class="row mb-4">
                <!-- í†µê³„ ì¹´ë“œ -->
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">ì˜¤ëŠ˜ì˜ ì‘ì—…</h5>
                            <h2 id="todayProgress">0%</h2>
                            <p id="todayTasks">0/0 ì™„ë£Œ</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">ì „ì²´ ê¸€ ìˆ˜</h5>
                            <h2 id="totalPosts">0</h2>
                            <p>ì´ ì‘ì„± ê¸€</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">ì˜¤ëŠ˜ ì‘ì„±</h5>
                            <h2 id="todayPosts">0</h2>
                            <p>ì˜¤ëŠ˜ ì¶”ê°€</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">í™œì„± ì‘ì—…ì</h5>
                            <h2 id="activeWorkers">0</h2>
                            <p>í˜„ì¬ í™œë™ ì¤‘</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ìŠ¤ì¼€ì¤„ ê´€ë¦¬ ë²„íŠ¼ (ê´€ë¦¬ì ì „ìš©) -->
            {% if is_manager %}
            <div class="mb-3">
                <button class="btn btn-primary" onclick="assignDailyTasks()">
                    ğŸ“… ì˜¤ëŠ˜ ì‘ì—… ìë™ ë°°ì •
                </button>
            </div>
            {% endif %}

            <!-- ì‘ì—… ëª©ë¡ -->
            <div class="card">
                <div class="card-header">
                    <h5>ì˜¤ëŠ˜ì˜ ì‘ì—… ëª©ë¡</h5>
                </div>
                <div class="card-body">
                    <table class="table table-hover" id="tasksTable">
                        <thead>
                            <tr>
                                <th>ë‚ ì§œ</th>
                                <th>ìƒí’ˆëª…</th>
                                <th>í‚¤ì›Œë“œ</th>
                                <th>ì‘ì—…ì</th>
                                <th>ê³„ì •</th>
                                <th>ìƒíƒœ</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTableBody">
                            <tr>
                                <td colspan="7" class="text-center">ë¡œë”© ì¤‘...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ==================== íƒ­ 2: ìƒí’ˆ ê´€ë¦¬ ==================== -->
        <div class="tab-pane fade" id="products" role="tabpanel">
            {% if is_manager %}
            <div class="alert alert-info">
                <strong>ğŸ’¡ ì•ˆë‚´:</strong> ê° ìƒí’ˆì˜ í‚¤ì›Œë“œë¥¼ ë¸”ë¡œê·¸ì—ì„œ ì‚¬ìš©í• ì§€ ON/OFF í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
            {% endif %}

            <div id="productsContainer">
                <p class="text-center">ë¡œë”© ì¤‘...</p>
            </div>
        </div>

        <!-- ==================== íƒ­ 3: ê¸€ ê´€ë¦¬ ==================== -->
        <div class="tab-pane fade" id="posts" role="tabpanel">
            <div class="mb-3">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPostModal">
                    â• ê¸€ ì‘ì„±
                </button>
            </div>

            <table class="table table-hover" id="postsTable">
                <thead>
                    <tr>
                        <th>ë‚ ì§œ</th>
                        <th>ì œëª©</th>
                        <th>í‚¤ì›Œë“œ</th>
                        <th>í†µê³„</th>
                        <th>ì´ë¯¸ì§€</th>
                        <th>ì‘ì—…ì</th>
                        <th>ê³„ì •</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="postsTableBody">
                    <tr>
                        <td colspan="8" class="text-center">ë¡œë”© ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ==================== íƒ­ 4: ê³„ì • ê´€ë¦¬ (ê´€ë¦¬ì ì „ìš©) ==================== -->
        {% if is_manager %}
        <div class="tab-pane fade" id="accounts" role="tabpanel">
            <div class="mb-3">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                    â• ê³„ì • ì¶”ê°€
                </button>
            </div>

            <table class="table table-hover" id="accountsTable">
                <thead>
                    <tr>
                        <th>ê³„ì • ID</th>
                        <th>ë¸”ë¡œê·¸ URL</th>
                        <th>IP ì£¼ì†Œ</th>
                        <th>ì¹´í…Œê³ ë¦¬</th>
                        <th>ë°°ì •ëœ ì‘ì—…ì</th>
                        <th>ìˆœì„œ</th>
                        <th>ìƒíƒœ</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="accountsTableBody">
                    <tr>
                        <td colspan="8" class="text-center">ë¡œë”© ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ==================== íƒ­ 5: ì‘ì—…ì ê´€ë¦¬ (ê´€ë¦¬ì ì „ìš©) ==================== -->
        <div class="tab-pane fade" id="workers" role="tabpanel">
            <div class="mb-3">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWorkerModal">
                    â• ì‘ì—…ì ì¶”ê°€
                </button>
            </div>

            <table class="table table-hover" id="workersTable">
                <thead>
                    <tr>
                        <th>ì‘ì—…ìëª…</th>
                        <th>ë¸”ë¡œê·¸ ê³„ì •</th>
                        <th>í˜„ì¬ ìƒí’ˆ</th>
                        <th>ì§„í–‰ë¥ </th>
                        <th>ì¼ì¼ ì‘ì—…ëŸ‰</th>
                        <th>ìƒíƒœ</th>
                        <th>ë¸”ë¡œê·¸ ê´€ë¦¬ì</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="workersTableBody">
                    <tr>
                        <td colspan="8" class="text-center">ë¡œë”© ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% endif %}

    </div>
</div>

<!-- ==================== ëª¨ë‹¬: ê¸€ ì‘ì„± ==================== -->
<div class="modal fade" id="createPostModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">âœï¸ ë¸”ë¡œê·¸ ê¸€ ì‘ì„±</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createPostForm" enctype="multipart/form-data">
                    <input type="hidden" id="taskId" name="task_id">
                    
                    <div class="mb-3">
                        <label class="form-label">ì‘ì—… ì„ íƒ</label>
                        <select class="form-select" id="taskSelect" required>
                            <option value="">ì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ì œëª©</label>
                        <input type="text" class="form-control" id="postTitle" name="title" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ë³¸ë¬¸</label>
                        <textarea class="form-control" id="postBody" name="body" rows="10" required></textarea>
                        <small class="text-muted">
                            í˜„ì¬ ê¸€ì ìˆ˜: <span id="charCount">0</span>ì
                        </small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ë¸”ë¡œê·¸ URL (ì„ íƒ)</label>
                        <input type="text" class="form-control" id="postUrl" name="post_url" 
                               placeholder="https://blog.naver.com/...">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ì´ë¯¸ì§€ ì²¨ë¶€ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</label>
                        <input type="file" class="form-control" id="postImages" name="images" 
                               multiple accept="image/*">
                    </div>

                    <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
                    <div class="mb-3" id="imagePreviewContainer" style="display: none;">
                        <label class="form-label">ì²¨ë¶€ëœ ì´ë¯¸ì§€ (<span id="imageCount">0</span>ê°œ)</label>
                        <div class="d-flex flex-wrap gap-2" id="imagePreview"></div>
                    </div>

                    <!-- í‚¤ì›Œë“œ ì¶œí˜„ íšŸìˆ˜ -->
                    <div class="alert alert-info" id="keywordAlert" style="display: none;">
                        ğŸ¯ íƒ€ê²Ÿ í‚¤ì›Œë“œ: <strong id="targetKeyword"></strong><br>
                        í‚¤ì›Œë“œ ì¶œí˜„ íšŸìˆ˜: <span id="keywordCount" class="badge bg-primary">0</span>íšŒ
                        <small class="text-muted">(ê¶Œì¥: 3~5íšŒ)</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="submitPost()">ì‘ì„± ì™„ë£Œ</button>
            </div>
        </div>
    </div>
</div>

<!-- ==================== ëª¨ë‹¬: ê³„ì • ì¶”ê°€ ==================== -->
{% if is_manager %}
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ê³„ì • ì¶”ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addAccountForm">
                    <div class="mb-3">
                        <label class="form-label">ê³„ì • ID</label>
                        <input type="text" class="form-control" name="account_id" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" class="form-control" name="account_pw" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ë¸”ë¡œê·¸ URL</label>
                        <input type="text" class="form-control" name="blog_url">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">IP ì£¼ì†Œ</label>
                        <input type="text" class="form-control" name="ip_address">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                        <input type="text" class="form-control" name="category">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="submitAccount()">ì¶”ê°€</button>
            </div>
        </div>
    </div>
</div>

<!-- ==================== ëª¨ë‹¬: ì‘ì—…ì ì¶”ê°€ ==================== -->
<div class="modal fade" id="addWorkerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì‘ì—…ì ì¶”ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addWorkerForm">
                    <div class="mb-3">
                        <label class="form-label">ì‚¬ì´íŠ¸ íšŒì› ì„ íƒ</label>
                        <select class="form-select" name="user_id" id="userSelect" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì‹œì‘ ìƒí’ˆ ì„ íƒ</label>
                        <select class="form-select" name="product_id" id="productSelect" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì¼ì¼ ì‘ì—…ëŸ‰</label>
                        <input type="number" class="form-control" name="daily_quota" value="3" min="1" required>
                        <small class="text-muted">ê³„ì •ë‹¹ ìµœëŒ€ 3ê°œì”© ë°°ì •ë©ë‹ˆë‹¤</small>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" name="is_blog_manager" id="isBlogManager">
                        <label class="form-check-label" for="isBlogManager">
                            ë¸”ë¡œê·¸ ê´€ë¦¬ìë¡œ ì§€ì •
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="submitWorker()">ì¶”ê°€</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ==================== JavaScript ==================== -->
<script>
// ==================== í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ====================
document.addEventListener('DOMContentLoaded', function() {
    loadDashboard();
    loadProducts();
    loadPosts();
    
    {% if is_manager %}
    loadAccounts();
    loadWorkers();
    loadAvailableUsers();
    loadProductsForSelect();
    {% endif %}

    // íƒ­ ì „í™˜ ì‹œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            const target = e.target.getAttribute('href');
            if (target === '#dashboard') loadDashboard();
            else if (target === '#products') loadProducts();
            else if (target === '#posts') loadPosts();
            else if (target === '#accounts') loadAccounts();
            else if (target === '#workers') loadWorkers();
        });
    });

    // ê¸€ ì‘ì„± ëª¨ë‹¬ - ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
    document.getElementById('postImages').addEventListener('change', function(e) {
        const files = e.target.files;
        const preview = document.getElementById('imagePreview');
        const container = document.getElementById('imagePreviewContainer');
        const count = document.getElementById('imageCount');
        
        preview.innerHTML = '';
        count.textContent = files.length;
        
        if (files.length > 0) {
            container.style.display = 'block';
            
            Array.from(files).forEach((file, i) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'position-relative';
                    div.innerHTML = `
                        <img src="${e.target.result}" class="img-thumbnail" 
                             style="width: 100px; height: 100px; object-fit: cover;">
                        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0"
                                onclick="removeImage(${i})">Ã—</button>
                    `;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        } else {
            container.style.display = 'none';
        }
    });

    // ê¸€ ì‘ì„± - ì‹¤ì‹œê°„ ê¸€ì ìˆ˜ & í‚¤ì›Œë“œ ì¹´ìš´íŠ¸
    const titleInput = document.getElementById('postTitle');
    const bodyInput = document.getElementById('postBody');
    
    function updateStats() {
        const title = titleInput.value;
        const body = bodyInput.value;
        const charCount = body.length;
        const keyword = document.getElementById('targetKeyword').textContent;
        
        document.getElementById('charCount').textContent = charCount;
        
        if (keyword) {
            const combined = title + ' ' + body;
            const count = (combined.toLowerCase().match(new RegExp(keyword.toLowerCase(), 'g')) || []).length;
            document.getElementById('keywordCount').textContent = count;
        }
    }
    
    titleInput.addEventListener('input', updateStats);
    bodyInput.addEventListener('input', updateStats);

    // ì‘ì—… ì„ íƒ ì‹œ í‚¤ì›Œë“œ í‘œì‹œ
    document.getElementById('taskSelect').addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        if (option.value) {
            const keyword = option.dataset.keyword;
            document.getElementById('taskId').value = option.value;
            document.getElementById('targetKeyword').textContent = keyword;
            document.getElementById('keywordAlert').style.display = 'block';
            updateStats();
        } else {
            document.getElementById('keywordAlert').style.display = 'none';
        }
    });
});

// ==================== ì „ì²´ í˜„í™© ====================
function loadDashboard() {
    fetch('/blog/api/dashboard')
        .then(r => r.json())
        .then(data => {
            document.getElementById('todayProgress').textContent = data.progress + '%';
            document.getElementById('todayTasks').textContent = `${data.completed_tasks}/${data.total_tasks} ì™„ë£Œ`;
            document.getElementById('totalPosts').textContent = data.total_posts;
            document.getElementById('todayPosts').textContent = data.today_posts;
            document.getElementById('activeWorkers').textContent = data.active_workers;
        });
    
    loadTodayTasks();
}

function loadTodayTasks() {
    fetch('/blog/api/tasks/today')
        .then(r => r.json())
        .then(tasks => {
            const tbody = document.getElementById('tasksTableBody');
            if (tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">ì˜¤ëŠ˜ ë°°ì •ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            tbody.innerHTML = tasks.map(task => `
                <tr>
                    <td>${new Date().toISOString().split('T')[0]}</td>
                    <td>${task.product_name}</td>
                    <td><span class="badge bg-info">${task.keyword}</span></td>
                    <td>${task.worker_name}</td>
                    <td>${task.account_id}</td>
                    <td>
                        ${task.status === 'completed' 
                            ? '<span class="badge bg-success">ì™„ë£Œ</span>' 
                            : '<span class="badge bg-warning">ëŒ€ê¸°</span>'}
                    </td>
                    <td>
                        ${task.status === 'pending' 
                            ? `<button class="btn btn-sm btn-primary" onclick="openCreatePostModal(${task.id}, '${task.keyword}')">ì™„ë£Œí•˜ê¸°</button>`
                            : `<a href="/blog/api/posts/${task.post_id}" class="btn btn-sm btn-info">ë³´ê¸°</a>`}
                    </td>
                </tr>
            `).join('');
        });
}

function openCreatePostModal(taskId, keyword) {
    // ëª¨ë‹¬ ì—´ê¸°
    const modal = new bootstrap.Modal(document.getElementById('createPostModal'));
    
    // ì‘ì—… ëª©ë¡ ë¡œë“œ
    fetch('/blog/api/tasks/today')
        .then(r => r.json())
        .then(tasks => {
            const select = document.getElementById('taskSelect');
            const pendingTasks = tasks.filter(t => t.status === 'pending');
            
            select.innerHTML = '<option value="">ì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”</option>' +
                pendingTasks.map(t => 
                    `<option value="${t.id}" data-keyword="${t.keyword}" ${t.id === taskId ? 'selected' : ''}>
                        ${t.product_name} - ${t.keyword}
                    </option>`
                ).join('');
            
            // ì„ íƒëœ ì‘ì—… ì„¤ì •
            if (taskId) {
                select.value = taskId;
                select.dispatchEvent(new Event('change'));
            }
        });
    
    modal.show();
}

function assignDailyTasks() {
    if (!confirm('ì˜¤ëŠ˜ ì‘ì—…ì„ ìë™ìœ¼ë¡œ ë°°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    const formData = new FormData();
    fetch('/blog/api/schedule/auto-assign', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message);
        loadDashboard();
    })
    .catch(err => {
        alert('ì˜¤ë¥˜: ' + err.message);
    });
}

// ==================== ìƒí’ˆ ê´€ë¦¬ ====================
function loadProducts() {
    fetch('/blog/api/products')
        .then(r => r.json())
        .then(products => {
            const container = document.getElementById('productsContainer');
            
            if (products.length === 0) {
                container.innerHTML = '<p class="text-center">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }
            
            container.innerHTML = products.map(product => {
                const hasKeywords = product.blog_keywords.length > 0;
                
                return `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between">
                            <h5>${product.product_code} - ${product.name}</h5>
                            {% if is_manager %}
                            ${!hasKeywords ? 
                                `<button class="btn btn-sm btn-primary" onclick="syncKeywords(${product.id})">
                                    í‚¤ì›Œë“œ ë™ê¸°í™”
                                </button>` : ''}
                            {% endif %}
                        </div>
                        <div class="card-body">
                            ${hasKeywords ? `
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>ìˆœì„œ</th>
                                            <th>í‚¤ì›Œë“œ</th>
                                            <th>ë¸”ë¡œê·¸ ì‚¬ìš©</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${product.blog_keywords.map((kw, i) => `
                                            <tr>
                                                <td>${i + 1}</td>
                                                <td>${kw.text}</td>
                                                <td>
                                                    {% if is_manager %}
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" 
                                                               ${kw.is_active ? 'checked' : ''}
                                                               onchange="toggleKeyword(${kw.id})">
                                                    </div>
                                                    {% else %}
                                                    ${kw.is_active ? 'âœ… ON' : 'âŒ OFF'}
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : '<p class="text-muted">í‚¤ì›Œë“œë¥¼ ë™ê¸°í™”í•´ì£¼ì„¸ìš”</p>'}
                        </div>
                    </div>
                `;
            }).join('');
        });
}

function syncKeywords(productId) {
    if (!confirm('ê¸°ë³¸ í‚¤ì›Œë“œë¥¼ ë¸”ë¡œê·¸ í‚¤ì›Œë“œë¡œ ë™ê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    fetch(`/blog/api/products/${productId}/sync-keywords`, {
        method: 'POST'
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message);
        loadProducts();
    });
}

function toggleKeyword(keywordId) {
    fetch(`/blog/api/keywords/${keywordId}/toggle`, {
        method: 'PUT'
    })
    .then(r => r.json())
    .then(data => {
        console.log('Toggled:', data.is_active);
    });
}

// ==================== ê¸€ ê´€ë¦¬ ====================
function loadPosts() {
    fetch('/blog/api/posts')
        .then(r => r.json())
        .then(posts => {
            const tbody = document.getElementById('postsTableBody');
            
            if (posts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            tbody.innerHTML = posts.map(post => `
                <tr>
                    <td>${post.created_at}</td>
                    <td>${post.title}</td>
                    <td><span class="badge bg-info">${post.keyword}</span></td>
                    <td>
                        ğŸ“ ${post.char_count}ì<br>
                        ğŸ¯ í‚¤ì›Œë“œ ${post.keyword_count}íšŒ
                    </td>
                    <td>
                        ${post.images.length > 0 ? `
                            <div class="d-flex gap-1">
                                ${post.images.slice(0, 2).map(img => `
                                    <img src="/static/uploads/blog_images/${img.filename}" 
                                         class="img-thumbnail" style="width: 40px; height: 40px;">
                                `).join('')}
                                ${post.images.length > 2 ? 
                                    `<span class="badge bg-secondary">+${post.images.length - 2}</span>` : ''}
                            </div>
                        ` : '-'}
                    </td>
                    <td>${post.worker_name}</td>
                    <td>${post.account_id}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewPost(${post.id})">ë³´ê¸°</button>
                        {% if is_manager %}
                        <button class="btn btn-sm btn-danger" onclick="deletePost(${post.id})">ì‚­ì œ</button>
                        {% endif %}
                    </td>
                </tr>
            `).join('');
        });
}

function submitPost() {
    const form = document.getElementById('createPostForm');
    const formData = new FormData(form);
    
    // íŒŒì¼ë„ í¬í•¨
    const files = document.getElementById('postImages').files;
    for (let file of files) {
        formData.append('images', file);
    }
    
    fetch('/blog/api/posts', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message);
        bootstrap.Modal.getInstance(document.getElementById('createPostModal')).hide();
        form.reset();
        loadDashboard();
        loadPosts();
    })
    .catch(err => {
        alert('ì˜¤ë¥˜: ' + err.message);
    });
}

function viewPost(postId) {
    // TODO: ê¸€ ìƒì„¸ ë³´ê¸° ëª¨ë‹¬
    alert('ê¸€ ìƒì„¸ ë³´ê¸° ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
}

function deletePost(postId) {
    if (!confirm('ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    fetch(`/blog/api/posts/${postId}`, {
        method: 'DELETE'
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message);
        loadPosts();
    });
}

// ==================== ê³„ì • ê´€ë¦¬ ====================
{% if is_manager %}
function loadAccounts() {
    fetch('/blog/api/accounts')
        .then(r => r.json())
        .then(accounts => {
            const tbody = document.getElementById('accountsTableBody');
            
            if (accounts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">ë“±ë¡ëœ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            tbody.innerHTML = accounts.map(acc => `
                <tr>
                    <td>${acc.account_id}</td>
                    <td>${acc.blog_url || '-'}</td>
                    <td>${acc.ip_address || '-'}</td>
                    <td>${acc.category || '-'}</td>
                    <td>${acc.assigned_worker_name || 'ë¯¸ë°°ì •'}</td>
                    <td>${acc.assignment_order || '-'}</td>
                    <td>
                        <span class="badge bg-${acc.status === 'active' ? 'success' : 'secondary'}">
                            ${acc.status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editAccount(${acc.id})">ìˆ˜ì •</button>
                        ${!acc.assigned_worker_name ? 
                            `<button class="btn btn-sm btn-danger" onclick="deleteAccount(${acc.id})">ì‚­ì œ</button>` 
                            : ''}
                    </td>
                </tr>
            `).join('');
        });
}

function submitAccount() {
    const form = document.getElementById('addAccountForm');
    const formData = new FormData(form);
    
    fetch('/blog/api/accounts', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message);
        bootstrap.Modal.getInstance(document.getElementById('addAccountModal')).hide();
        form.reset();
        loadAccounts();
    })
    .catch(err => {
        alert('ì˜¤ë¥˜: ' + err.message);
    });
}

function deleteAccount(accountId) {
    if (!confirm('ì´ ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    fetch(`/blog/api/accounts/${accountId}`, {
        method: 'DELETE'
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message);
        loadAccounts();
    })
    .catch(err => {
        alert('ì˜¤ë¥˜: ' + err.message);
    });
}

// ==================== ì‘ì—…ì ê´€ë¦¬ ====================
function loadWorkers() {
    fetch('/blog/api/workers')
        .then(r => r.json())
        .then(workers => {
            const tbody = document.getElementById('workersTableBody');
            
            if (workers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">ë“±ë¡ëœ ì‘ì—…ìê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            tbody.innerHTML = workers.map(worker => `
                <tr>
                    <td>${worker.username}</td>
                    <td>${worker.accounts.join(', ') || 'ë¯¸ë°°ì •'}</td>
                    <td>${worker.current_product || '-'}</td>
                    <td>
                        ${worker.progress} (${worker.progress_percent}%)
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar" style="width: ${worker.progress_percent}%"></div>
                        </div>
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm" 
                               value="${worker.daily_quota}" min="1" 
                               onchange="updateQuota(${worker.id}, this.value)">
                    </td>
                    <td>
                        <span class="badge bg-${worker.status === 'active' ? 'success' : 'secondary'}">
                            ${worker.status}
                        </span>
                    </td>
                    <td>${worker.is_blog_manager ? 'âœ…' : 'âŒ'}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" 
                                onclick="toggleWorkerStatus(${worker.id}, '${worker.status}')">
                            ${worker.status === 'active' ? 'ì¤‘ì§€' : 'í™œì„±'}
                        </button>
                    </td>
                </tr>
            `).join('');
        });
}

function loadAvailableUsers() {
    fetch('/blog/api/available-users')
        .then(r => r.json())
        .then(users => {
            const select = document.getElementById('userSelect');
            select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' +
                users.map(u => `<option value="${u.id}">${u.username}</option>`).join('');
        });
}

function loadProductsForSelect() {
    fetch('/blog/api/products')
        .then(r => r.json())
        .then(products => {
            const select = document.getElementById('productSelect');
            select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' +
                products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        });
}

function submitWorker() {
    const form = document.getElementById('addWorkerForm');
    const formData = new FormData(form);
    
    fetch('/blog/api/workers', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message);
        bootstrap.Modal.getInstance(document.getElementById('addWorkerModal')).hide();
        form.reset();
        loadWorkers();
        loadAvailableUsers();
    })
    .catch(err => {
        alert('ì˜¤ë¥˜: ' + err.message);
    });
}

function updateQuota(workerId, newQuota) {
    const formData = new FormData();
    formData.append('daily_quota', newQuota);
    
    fetch(`/blog/api/workers/${workerId}/quota`, {
        method: 'PUT',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message);
        loadWorkers();
    })
    .catch(err => {
        alert('ì˜¤ë¥˜: ' + err.message);
    });
}

function toggleWorkerStatus(workerId, currentStatus) {
    const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
    const formData = new FormData();
    formData.append('status', newStatus);
    
    fetch(`/blog/api/workers/${workerId}/status`, {
        method: 'PUT',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message);
        loadWorkers();
    });
}
{% endif %}
</script>

<style>
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.table th {
    background-color: #f8f9fa;
}

.img-thumbnail {
    object-fit: cover;
}

.badge {
    font-size: 0.9em;
}

.progress {
    margin-top: 5px;
}
</style>

{% endblock %}