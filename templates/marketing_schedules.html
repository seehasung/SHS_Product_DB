{% extends "base.html" %}
{% block title %}ì „ì²´ ìŠ¤ì¼€ì¤„ ê´€ë¦¬{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* ëŒ€ì‹œë³´ë“œ ìŠ¤íƒ€ì¼ */
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        color: white;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    /* ìŠ¤ì¼€ì¤„ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
    .schedule-table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .schedule-table thead {
        background: #f8f9fa;
    }
    
    .schedule-table th {
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
    }
    
    .schedule-row {
        transition: all 0.3s;
    }
    
    .schedule-row:hover {
        background: #f8f9fa;
    }
    
    .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .status-pending {
        background: #ffd43b;
        color: #000;
    }
    
    .status-completed {
        background: #51cf66;
        color: white;
    }
    
    .status-in-progress {
        background: #339af0;
        color: white;
    }
    
    .status-skipped {
        background: #868e96;
        color: white;
    }
    
    /* ì²´í¬ë°•ìŠ¤ ì»¤ìŠ¤í…€ */
    .check-complete {
        width: 22px;
        height: 22px;
        cursor: pointer;
    }
    
    .check-complete:checked {
        background-color: #51cf66;
        border-color: #51cf66;
    }
    
    /* í•„í„° ë²„íŠ¼ */
    .filter-btn {
        border-radius: 20px;
        padding: 8px 20px;
        margin: 0 5px;
        transition: all 0.3s;
    }
    
    .filter-btn.active {
        background: #4c6ef5;
        color: white;
        transform: scale(1.05);
    }
    
    /* ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ */
    .date-nav {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 25px 0;
        gap: 20px;
    }
    
    .date-display {
        font-size: 1.4rem;
        font-weight: bold;
        min-width: 250px;
        text-align: center;
        color: #495057;
    }
    
    .keyword-badge {
        background: #e9ecef;
        color: #495057;
        padding: 4px 8px;
        border-radius: 5px;
        font-size: 0.85rem;
    }
    
    .action-buttons {
        display: flex;
        gap: 5px;
    }
    
    .no-data {
        padding: 60px;
        text-align: center;
        color: #adb5bd;
        background: #f8f9fa;
        border-radius: 10px;
    }
    
    .no-data i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- í—¤ë” -->
    <div class="dashboard-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-0">ğŸ“Š ì „ì²´ ìŠ¤ì¼€ì¤„ ê´€ë¦¬</h1>
                <p class="mb-0 mt-2 opacity-90">ë‚ ì§œë³„ ê¸€ ì‘ì„± ìŠ¤ì¼€ì¤„ ë° ì§„í–‰ ìƒí™©</p>
            </div>
            <div>
                <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
                    <i class="bi bi-plus-circle"></i> ì‘ì—… í• ë‹¹
                </button>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#bulkGenerateModal">
                    <i class="bi bi-magic"></i> ìë™ ìƒì„±
                </button>
                <a href="/marketing/cafe?tab=status" class="btn btn-outline-light">
                    <i class="bi bi-arrow-left"></i> ëŒì•„ê°€ê¸°
                </a>
            </div>
        </div>
    </div>
    
    <!-- ì˜¤ëŠ˜ì˜ í†µê³„ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">ì˜¤ëŠ˜ í•  ì¼</div>
            <div class="stat-value text-primary">{{ today_stats.total }}</div>
            <small class="text-muted">ì´ ì‘ì—…</small>
        </div>
        <div class="stat-card">
            <div class="stat-label">ì™„ë£Œ</div>
            <div class="stat-value text-success">{{ today_stats.completed }}</div>
            <small class="text-muted">{{ (today_stats.completed / today_stats.total * 100) if today_stats.total else 0 }}%</small>
        </div>
        <div class="stat-card">
            <div class="stat-label">ì§„í–‰ì¤‘</div>
            <div class="stat-value text-info">{{ today_stats.in_progress }}</div>
            <small class="text-muted">ì‘ì—… ì¤‘</small>
        </div>
        <div class="stat-card">
            <div class="stat-label">ëŒ€ê¸°ì¤‘</div>
            <div class="stat-value text-warning">{{ today_stats.pending }}</div>
            <small class="text-muted">ì‹œì‘ ì „</small>
        </div>
    </div>
    
    <!-- ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="date-nav">
        <button class="btn btn-outline-primary" onclick="changeDate(-1)">
            <i class="bi bi-chevron-left"></i> ì´ì „ë‚ 
        </button>
        <div class="date-display">
            <i class="bi bi-calendar3"></i> {{ selected_date.strftime('%Yë…„ %mì›” %dì¼') }}
            {% if selected_date.strftime('%Y-%m-%d') == today.strftime('%Y-%m-%d') %}
            <span class="badge bg-success">ì˜¤ëŠ˜</span>
            {% endif %}
        </div>
        <button class="btn btn-outline-primary" onclick="changeDate(1)">
            ë‹¤ìŒë‚  <i class="bi bi-chevron-right"></i>
        </button>
        <input type="date" id="dateSelector" class="form-control" style="width: auto;" 
               value="{{ selected_date }}" onchange="selectDate(this.value)">
    </div>
    
    <!-- í•„í„° ë²„íŠ¼ -->
    <div class="text-center mb-4">
        <button class="btn filter-btn active" onclick="filterStatus('all')">
            ì „ì²´ <span class="badge bg-secondary">{{ schedules|length }}</span>
        </button>
        <button class="btn filter-btn" onclick="filterStatus('pending')">
            ëŒ€ê¸°ì¤‘ <span class="badge bg-warning text-dark">{{ schedules|selectattr('status', 'eq', 'pending')|list|length }}</span>
        </button>
        <button class="btn filter-btn" onclick="filterStatus('in_progress')">
            ì§„í–‰ì¤‘ <span class="badge bg-info">{{ schedules|selectattr('status', 'eq', 'in_progress')|list|length }}</span>
        </button>
        <button class="btn filter-btn" onclick="filterStatus('completed')">
            ì™„ë£Œ <span class="badge bg-success">{{ schedules|selectattr('status', 'eq', 'completed')|list|length }}</span>
        </button>
        <button class="btn filter-btn" onclick="filterStatus('skipped')">
            ê±´ë„ˆëœ€ <span class="badge bg-secondary">{{ schedules|selectattr('status', 'eq', 'skipped')|list|length }}</span>
        </button>
    </div>
    
    <!-- ìŠ¤ì¼€ì¤„ í…Œì´ë¸” -->
    <div class="schedule-table">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th width="50" class="text-center">ì™„ë£Œ</th>
                    <th>ì‘ì—…ì</th>
                    <th>ê³„ì •</th>
                    <th>ì¹´í˜</th>
                    <th>ìƒí’ˆ</th>
                    <th>í‚¤ì›Œë“œ</th>
                    <th width="100">ìƒíƒœ</th>
                    <th width="120">ì‘ì„±ëœ ê¸€</th>
                    <th width="180" class="text-center">ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody>
                {% for schedule in schedules %}
                <tr class="schedule-row" data-status="{{ schedule.status }}">
                    <td class="text-center">
                        <input type="checkbox" 
                               class="form-check-input check-complete" 
                               {{ 'checked' if schedule.is_completed }}
                               onchange="toggleComplete({{ schedule.id }}, this)"
                               {{ 'disabled' if schedule.status == 'skipped' }}>
                    </td>
                    <td>
                        <strong>{{ schedule.worker.username if schedule.worker else 'ë¯¸í• ë‹¹' }}</strong>
                    </td>
                    <td>
                        <span class="text-primary">{{ schedule.account.account_id if schedule.account else 'ë¯¸í• ë‹¹' }}</span>
                    </td>
                    <td>
                        {{ schedule.cafe.name if schedule.cafe else 'ë¯¸í• ë‹¹' }}
                    </td>
                    <td>
                        <small>{{ schedule.marketing_product.product.name[:30] if schedule.marketing_product else '-' }}...</small>
                    </td>
                    <td>
                        <span class="keyword-badge">{{ schedule.keyword_text }}</span>
                    </td>
                    <td>
                        <span class="status-badge status-{{ schedule.status }}">
                            {% if schedule.status == 'pending' %}ëŒ€ê¸°ì¤‘
                            {% elif schedule.status == 'in_progress' %}ì§„í–‰ì¤‘
                            {% elif schedule.status == 'completed' %}ì™„ë£Œ
                            {% elif schedule.status == 'skipped' %}ê±´ë„ˆëœ€
                            {% endif %}
                        </span>
                    </td>
                    <td>
                        {% if schedule.marketing_post %}
                        <a href="{{ schedule.marketing_post.post_url }}" target="_blank" class="btn btn-sm btn-success">
                            <i class="bi bi-box-arrow-up-right"></i> ë³´ê¸°
                        </a>
                        {% else %}
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="linkPost({{ schedule.id }})"
                                {{ 'disabled' if not schedule.is_completed }}>
                            <i class="bi bi-link-45deg"></i> ì—°ê²°
                        </button>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-info" 
                                    onclick="editSchedule({{ schedule.id }})"
                                    data-bs-toggle="tooltip" title="ìˆ˜ì •">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning"
                                    onclick="changeStatus({{ schedule.id }}, 'in_progress')"
                                    data-bs-toggle="tooltip" title="ì§„í–‰ì¤‘">
                                <i class="bi bi-play-circle"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary"
                                    onclick="changeStatus({{ schedule.id }}, 'skipped')"
                                    data-bs-toggle="tooltip" title="ê±´ë„ˆë›°ê¸°">
                                <i class="bi bi-skip-forward"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger"
                                    onclick="deleteSchedule({{ schedule.id }})"
                                    data-bs-toggle="tooltip" title="ì‚­ì œ">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9">
                        <div class="no-data">
                            <i class="bi bi-calendar-x"></i>
                            <p class="mb-2">ì´ ë‚ ì§œì— í• ë‹¹ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
                                ì²« ì‘ì—… í• ë‹¹í•˜ê¸°
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- ë©”ëª¨/ë…¸íŠ¸ ì„¹ì…˜ (ì„ íƒì‚¬í•­) -->
    {% if schedules %}
    <div class="mt-4">
        <h5>ğŸ“ ì‘ì—… ë©”ëª¨</h5>
        <div class="list-group">
            {% for schedule in schedules if schedule.notes %}
            <div class="list-group-item">
                <strong>{{ schedule.worker.username }}</strong> - {{ schedule.keyword_text }}:
                <p class="mb-0 ms-3">{{ schedule.notes }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- ì‘ì—… í• ë‹¹ ëª¨ë‹¬ -->
    <div class="modal fade" id="addScheduleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form action="/marketing/schedule/add" method="post" id="addScheduleForm">
                    <div class="modal-header">
                        <h5 class="modal-title">â• ìƒˆ ì‘ì—… í• ë‹¹</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ë‚ ì§œ <span class="text-danger">*</span></label>
                                <input type="date" name="scheduled_date" class="form-control" 
                                       value="{{ selected_date }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ì‘ì—…ì <span class="text-danger">*</span></label>
                                <select name="worker_id" class="form-select" required>
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                    {% for worker in workers %}
                                    <option value="{{ worker.id }}">
                                        {{ worker.username }} (ì¼ì¼ {{ worker.daily_quota or 6 }}ê°œ)
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ë„¤ì´ë²„ ê³„ì • <span class="text-danger">*</span></label>
                                <select name="account_id" class="form-select" required 
                                        onchange="updateCafeOptions(this.value)">
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                    {% for account in accounts %}
                                    <option value="{{ account.id }}">{{ account.account_id }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ì¹´í˜ <span class="text-danger">*</span></label>
                                <select name="cafe_id" class="form-select" required disabled>
                                    <option value="">ê³„ì •ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ìƒí’ˆ <span class="text-danger">*</span></label>
                                <select name="marketing_product_id" class="form-select" required
                                        onchange="updateKeywordOptions(this.value)">
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                    {% for mp in marketing_products %}
                                    <option value="{{ mp.id }}">{{ mp.product.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">í‚¤ì›Œë“œ <span class="text-danger">*</span></label>
                                <select name="keyword_text" class="form-select" required disabled>
                                    <option value="">ìƒí’ˆì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">ë©”ëª¨ (ì„ íƒ)</label>
                            <textarea name="notes" class="form-control" rows="3" 
                                      placeholder="ì‘ì—…ì— ëŒ€í•œ íŠ¹ë³„í•œ ì§€ì‹œì‚¬í•­ì´ë‚˜ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>íŒ:</strong> ê³„ì •ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ ê³„ì •ì´ ê°€ì…ëœ ì¹´í˜ë§Œ í‘œì‹œë©ë‹ˆë‹¤.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                        <button type="submit" class="btn btn-primary">í• ë‹¹í•˜ê¸°</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ëŒ€ëŸ‰ ìƒì„± ëª¨ë‹¬ -->
    <div class="modal fade" id="bulkGenerateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form action="/marketing/schedule/generate" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title">ğŸ¤– ìŠ¤ì¼€ì¤„ ìë™ ìƒì„±</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>ì£¼ì˜:</strong> ìë™ ìƒì„±ì€ ì„¤ì •ëœ ê·œì¹™ì— ë”°ë¼ ëŒ€ëŸ‰ì˜ ìŠ¤ì¼€ì¤„ì„ ìƒì„±í•©ë‹ˆë‹¤.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ì‹œì‘ ë‚ ì§œ</label>
                                <input type="date" name="start_date" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ì¢…ë£Œ ë‚ ì§œ</label>
                                <input type="date" name="end_date" class="form-control" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">ìƒí’ˆ ì„ íƒ</label>
                            <select name="marketing_product_id" class="form-select" required>
                                <option value="">ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”</option>
                                {% for mp in marketing_products %}
                                <option value="{{ mp.id }}">
                                    {{ mp.product.name }} 
                                    (í‚¤ì›Œë“œ {{ product_keywords_map.get(mp.id, [])|length }}ê°œ)
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">ì‘ì—…ì ì„ íƒ</label>
                            <input type="hidden" name="worker_ids" id="worker_ids_hidden" value="">
                            <div class="form-check">
                                {% for worker in workers %}
                                <div class="form-check">
                                    <input class="form-check-input worker-checkbox" type="checkbox" 
                                           value="{{ worker.id }}" id="worker_gen_{{ worker.id }}" checked>
                                    <label class="form-check-label" for="worker_gen_{{ worker.id }}">
                                        {{ worker.username }} (ì¼ì¼ {{ worker.daily_quota or 6 }}ê°œ)
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6>ğŸ“‹ ìƒì„± ê·œì¹™:</h6>
                                <ul class="mb-0">
                                    <li>í‚¤ì›Œë“œë‹¹ 3ê°œ ì¹´í˜ì— ìë™ ë¶„ë°°</li>
                                    <li>ê³„ì •-ì¹´í˜ ìˆœí™˜ ì‚¬ìš©</li>
                                    <li>ë™ì¼ ì¡°í•© ìµœëŒ€ 2íšŒ ì œí•œ</li>
                                    <li>ì£¼ë§(í† ,ì¼) ìë™ ì œì™¸</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                        <button type="submit" class="btn btn-success">ìƒì„±í•˜ê¸°</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ê¸€ ì—°ê²° ëª¨ë‹¬ -->
    <div class="modal fade" id="linkPostModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="linkPostForm" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title">ğŸ”— ì‘ì„±ëœ ê¸€ ì—°ê²°</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">ì‘ì„±ëœ ê¸€ ì„ íƒ</label>
                            <select name="marketing_post_id" class="form-select" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                {% for post in unlinked_posts %}
                                <option value="{{ post.id }}">
                                    [{{ post.keyword_text }}] {{ post.post_title[:50] or 'ì œëª© ì—†ìŒ' }}
                                    ({{ post.worker.username if post.worker else 'ì‘ì—…ì ì—†ìŒ' }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="alert alert-info">
                            <small>ë“±ë¡ ì™„ë£Œëœ ê¸€ ì¤‘ ì•„ì§ ì—°ê²°ë˜ì§€ ì•Šì€ ê¸€ë§Œ í‘œì‹œë©ë‹ˆë‹¤.</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                        <button type="submit" class="btn btn-primary">ì—°ê²°í•˜ê¸°</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// ê³„ì •-ì¹´í˜ ë§¤í•‘ ë°ì´í„°
const membershipMap = {{ membership_map | tojson | safe }};

// ìƒí’ˆ-í‚¤ì›Œë“œ ë§¤í•‘ ë°ì´í„°  
const productKeywordsMap = {{ product_keywords_map | tojson | safe }};

// ë‚ ì§œ ë³€ê²½
function changeDate(days) {
    const currentDate = new Date('{{ selected_date }}');
    currentDate.setDate(currentDate.getDate() + days);
    const dateStr = currentDate.toISOString().split('T')[0];
    window.location.href = `/marketing/schedules?selected_date=${dateStr}`;
}

function selectDate(date) {
    window.location.href = `/marketing/schedules?selected_date=${date}`;
}

// ìƒíƒœ í•„í„°ë§
function filterStatus(status) {
    const rows = document.querySelectorAll('.schedule-row');
    const buttons = document.querySelectorAll('.filter-btn');
    
    // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // í–‰ í‘œì‹œ/ìˆ¨ê¸°ê¸°
    rows.forEach(row => {
        if (status === 'all' || row.dataset.status === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// ì™„ë£Œ í† ê¸€
function toggleComplete(scheduleId, checkbox) {
    fetch(`/marketing/api/schedule/complete/${scheduleId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            checkbox.checked = !checkbox.checked;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        checkbox.checked = !checkbox.checked;
    });
}

// ì§„í–‰ ì¤‘ìœ¼ë¡œ ë³€ê²½
function setInProgress(scheduleId) {
    const formData = new FormData();
    formData.append('status', 'in_progress');
    
    fetch(`/marketing/api/schedule/status/${scheduleId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        }
    });
}

// ê±´ë„ˆë›°ê¸°
function skipSchedule(scheduleId) {
    if (confirm('ì´ ìŠ¤ì¼€ì¤„ì„ ê±´ë„ˆë›°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const formData = new FormData();
        formData.append('status', 'skipped');
        
        fetch(`/marketing/api/schedule/status/${scheduleId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        });
    }
}

// ì‚­ì œ
function deleteSchedule(scheduleId) {
    if (confirm('ì´ ìŠ¤ì¼€ì¤„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        fetch(`/marketing/api/schedule/${scheduleId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        });
    }
}

// ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
function editSchedule(scheduleId) {
    fetch(`/marketing/api/schedule/edit/${scheduleId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // ëª¨ë‹¬ì— ë°ì´í„° ì±„ìš°ê¸°
                document.getElementById('edit-schedule-id').value = data.data.id;
                document.getElementById('edit-worker').value = data.data.worker_id || '';
                document.getElementById('edit-account').value = data.data.account_id || '';
                document.getElementById('edit-cafe').value = data.data.cafe_id || '';
                document.getElementById('edit-keyword').value = data.data.keyword_text || '';
                document.getElementById('edit-notes').value = data.data.notes || '';
                
                // ì˜µì…˜ ëª©ë¡ ì—…ë°ì´íŠ¸
                updateSelectOptions('edit-worker', data.workers, 'name');
                updateSelectOptions('edit-account', data.accounts, 'name');
                updateSelectOptions('edit-cafe', data.cafes, 'name');
                
                // ëª¨ë‹¬ í‘œì‹œ
                const modal = new bootstrap.Modal(document.getElementById('editScheduleModal'));
                modal.show();
            }
        });
}

// ì…€ë ‰íŠ¸ ì˜µì…˜ ì—…ë°ì´íŠ¸
function updateSelectOptions(selectId, options, labelField) {
    const select = document.getElementById(selectId);
    const currentValue = select.value;
    
    // ê¸°ì¡´ ì˜µì…˜ ì œê±°
    select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
    
    // ìƒˆ ì˜µì…˜ ì¶”ê°€
    options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.id;
        option.textContent = opt[labelField];
        select.appendChild(option);
    });
    
    // ê¸°ì¡´ ê°’ ë³µì›
    select.value = currentValue;
}

// ìˆ˜ì • ì €ì¥
function saveScheduleEdit() {
    const scheduleId = document.getElementById('edit-schedule-id').value;
    const formData = new FormData();
    
    const workerId = document.getElementById('edit-worker').value;
    const accountId = document.getElementById('edit-account').value;
    const cafeId = document.getElementById('edit-cafe').value;
    const keyword = document.getElementById('edit-keyword').value;
    const notes = document.getElementById('edit-notes').value;
    
    if (workerId) formData.append('worker_id', workerId);
    if (accountId) formData.append('account_id', accountId);
    if (cafeId) formData.append('cafe_id', cafeId);
    if (keyword) formData.append('keyword_text', keyword);
    formData.append('notes', notes);
    
    fetch(`/marketing/api/schedule/edit/${scheduleId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        }
    });
}

// ì‘ì„±ëœ ê¸€ ì—°ê²°
function linkPost(scheduleId) {
    const postId = prompt('ì—°ê²°í•  ê¸€ì˜ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
    if (postId) {
        const formData = new FormData();
        formData.append('post_id', postId);
        
        fetch(`/marketing/api/schedule/link-post/${scheduleId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        });
    }
}

// ìë™ ìƒì„±
function generateSchedule() {
    const productId = document.getElementById('generate-product').value;
    const startDate = document.getElementById('generate-start').value;
    const endDate = document.getElementById('generate-end').value;
    
    if (!productId || !startDate || !endDate) {
        alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
    }
    
    const formData = new FormData();
    formData.append('product_id', productId);
    formData.append('start_date', startDate);
    formData.append('end_date', endDate);
    
    // ë¡œë”© í‘œì‹œ
    const button = event.target;
    button.disabled = true;
    button.textContent = 'ìƒì„± ì¤‘...';
    
    fetch('/marketing/api/generate-schedule', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || 'ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        }
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = 'ìë™ ìƒì„±';
    });
}
</script>

<!-- ìˆ˜ì • ëª¨ë‹¬ HTML -->
<div class="modal fade" id="editScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ìŠ¤ì¼€ì¤„ ìˆ˜ì •</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-schedule-id">
                
                <div class="mb-3">
                    <label class="form-label">ì‘ì—…ì</label>
                    <select id="edit-worker" class="form-control">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">ê³„ì •</label>
                    <select id="edit-account" class="form-control">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">ì¹´í˜</label>
                    <select id="edit-cafe" class="form-control">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">í‚¤ì›Œë“œ</label>
                    <input type="text" id="edit-keyword" class="form-control">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">ë©”ëª¨</label>
                    <textarea id="edit-notes" class="form-control" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="saveScheduleEdit()">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}