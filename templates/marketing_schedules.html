{% extends "base.html" %}
{% block title %}전체 스케줄 관리{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* 대시보드 스타일 */
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        color: white;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    /* 스케줄 테이블 스타일 */
    .schedule-table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .schedule-table thead {
        background: #f8f9fa;
    }
    
    .schedule-table th {
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
    }
    
    .schedule-row {
        transition: all 0.3s;
    }
    
    .schedule-row:hover {
        background: #f8f9fa;
    }
    
    .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .status-pending {
        background: #ffd43b;
        color: #000;
    }
    
    .status-completed {
        background: #51cf66;
        color: white;
    }
    
    .status-in-progress {
        background: #339af0;
        color: white;
    }
    
    .status-skipped {
        background: #868e96;
        color: white;
    }
    
    /* 체크박스 커스텀 */
    .check-complete {
        width: 22px;
        height: 22px;
        cursor: pointer;
    }
    
    .check-complete:checked {
        background-color: #51cf66;
        border-color: #51cf66;
    }
    
    /* 필터 버튼 */
    .filter-btn {
        border-radius: 20px;
        padding: 8px 20px;
        margin: 0 5px;
        transition: all 0.3s;
    }
    
    .filter-btn.active {
        background: #4c6ef5;
        color: white;
        transform: scale(1.05);
    }
    
    /* 날짜 네비게이션 */
    .date-nav {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 25px 0;
        gap: 20px;
    }
    
    .date-display {
        font-size: 1.4rem;
        font-weight: bold;
        min-width: 250px;
        text-align: center;
        color: #495057;
    }
    
    .keyword-badge {
        background: #e9ecef;
        color: #495057;
        padding: 4px 8px;
        border-radius: 5px;
        font-size: 0.85rem;
    }
    
    .action-buttons {
        display: flex;
        gap: 5px;
    }
    
    .no-data {
        padding: 60px;
        text-align: center;
        color: #adb5bd;
        background: #f8f9fa;
        border-radius: 10px;
    }
    
    .no-data i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- 헤더 -->
    <div class="dashboard-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-0">📊 전체 스케줄 관리</h1>
                <p class="mb-0 mt-2 opacity-90">날짜별 글 작성 스케줄 및 진행 상황</p>
            </div>
            <div>
                <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
                    <i class="bi bi-plus-circle"></i> 작업 할당
                </button>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#bulkGenerateModal">
                    <i class="bi bi-magic"></i> 자동 생성
                </button>
                <a href="/marketing/cafe?tab=status" class="btn btn-outline-light">
                    <i class="bi bi-arrow-left"></i> 돌아가기
                </a>
            </div>
        </div>
    </div>
    
    <!-- 오늘의 통계 -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">오늘 할 일</div>
            <div class="stat-value text-primary">{{ today_stats.total }}</div>
            <small class="text-muted">총 작업</small>
        </div>
        <div class="stat-card">
            <div class="stat-label">완료</div>
            <div class="stat-value text-success">{{ today_stats.completed }}</div>
            <small class="text-muted">{{ (today_stats.completed / today_stats.total * 100) if today_stats.total else 0 }}%</small>
        </div>
        <div class="stat-card">
            <div class="stat-label">진행중</div>
            <div class="stat-value text-info">{{ today_stats.in_progress }}</div>
            <small class="text-muted">작업 중</small>
        </div>
        <div class="stat-card">
            <div class="stat-label">대기중</div>
            <div class="stat-value text-warning">{{ today_stats.pending }}</div>
            <small class="text-muted">시작 전</small>
        </div>
    </div>
    
    <!-- 날짜 네비게이션 -->
    <div class="date-nav">
        <button class="btn btn-outline-primary" onclick="changeDate(-1)">
            <i class="bi bi-chevron-left"></i> 이전날
        </button>
        <div class="date-display">
            <i class="bi bi-calendar3"></i> {{ selected_date.strftime('%Y년 %m월 %d일') }}
            {% if selected_date.strftime('%Y-%m-%d') == today.strftime('%Y-%m-%d') %}
            <span class="badge bg-success">오늘</span>
            {% endif %}
        </div>
        <button class="btn btn-outline-primary" onclick="changeDate(1)">
            다음날 <i class="bi bi-chevron-right"></i>
        </button>
        <input type="date" id="dateSelector" class="form-control" style="width: auto;" 
               value="{{ selected_date }}" onchange="selectDate(this.value)">
    </div>
    
    <!-- 필터 버튼 -->
    <div class="text-center mb-4">
        <button class="btn filter-btn active" onclick="filterStatus('all')">
            전체 <span class="badge bg-secondary">{{ schedules|length }}</span>
        </button>
        <button class="btn filter-btn" onclick="filterStatus('pending')">
            대기중 <span class="badge bg-warning text-dark">{{ schedules|selectattr('status', 'eq', 'pending')|list|length }}</span>
        </button>
        <button class="btn filter-btn" onclick="filterStatus('in_progress')">
            진행중 <span class="badge bg-info">{{ schedules|selectattr('status', 'eq', 'in_progress')|list|length }}</span>
        </button>
        <button class="btn filter-btn" onclick="filterStatus('completed')">
            완료 <span class="badge bg-success">{{ schedules|selectattr('status', 'eq', 'completed')|list|length }}</span>
        </button>
        <button class="btn filter-btn" onclick="filterStatus('skipped')">
            건너뜀 <span class="badge bg-secondary">{{ schedules|selectattr('status', 'eq', 'skipped')|list|length }}</span>
        </button>
    </div>
    
    <!-- 스케줄 테이블 -->
    <div class="schedule-table">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th width="50" class="text-center">완료</th>
                    <th>작업자</th>
                    <th>계정</th>
                    <th>카페</th>
                    <th>상품</th>
                    <th>키워드</th>
                    <th width="100">상태</th>
                    <th width="120">작성된 글</th>
                    <th width="180" class="text-center">관리</th>
                </tr>
            </thead>
            <tbody>
                {% for schedule in schedules %}
                <tr class="schedule-row" data-status="{{ schedule.status }}">
                    <td class="text-center">
                        <input type="checkbox" 
                               class="form-check-input check-complete" 
                               {{ 'checked' if schedule.is_completed }}
                               onchange="toggleComplete({{ schedule.id }}, this)"
                               {{ 'disabled' if schedule.status == 'skipped' }}>
                    </td>
                    <td>
                        <strong>{{ schedule.worker.username if schedule.worker else '미할당' }}</strong>
                    </td>
                    <td>
                        <span class="text-primary">{{ schedule.account.account_id if schedule.account else '미할당' }}</span>
                    </td>
                    <td>
                        {{ schedule.cafe.name if schedule.cafe else '미할당' }}
                    </td>
                    <td>
                        <small>{{ schedule.marketing_product.product.name[:30] if schedule.marketing_product else '-' }}...</small>
                    </td>
                    <td>
                        <span class="keyword-badge">{{ schedule.keyword_text }}</span>
                    </td>
                    <td>
                        <span class="status-badge status-{{ schedule.status }}">
                            {% if schedule.status == 'pending' %}대기중
                            {% elif schedule.status == 'in_progress' %}진행중
                            {% elif schedule.status == 'completed' %}완료
                            {% elif schedule.status == 'skipped' %}건너뜀
                            {% endif %}
                        </span>
                    </td>
                    <td>
                        {% if schedule.marketing_post %}
                        <a href="{{ schedule.marketing_post.post_url }}" target="_blank" class="btn btn-sm btn-success">
                            <i class="bi bi-box-arrow-up-right"></i> 보기
                        </a>
                        {% else %}
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="linkPost({{ schedule.id }})"
                                {{ 'disabled' if not schedule.is_completed }}>
                            <i class="bi bi-link-45deg"></i> 연결
                        </button>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-info" 
                                    onclick="editSchedule({{ schedule.id }})"
                                    data-bs-toggle="tooltip" title="수정">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning"
                                    onclick="changeStatus({{ schedule.id }}, 'in_progress')"
                                    data-bs-toggle="tooltip" title="진행중">
                                <i class="bi bi-play-circle"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary"
                                    onclick="changeStatus({{ schedule.id }}, 'skipped')"
                                    data-bs-toggle="tooltip" title="건너뛰기">
                                <i class="bi bi-skip-forward"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger"
                                    onclick="deleteSchedule({{ schedule.id }})"
                                    data-bs-toggle="tooltip" title="삭제">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9">
                        <div class="no-data">
                            <i class="bi bi-calendar-x"></i>
                            <p class="mb-2">이 날짜에 할당된 작업이 없습니다</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
                                첫 작업 할당하기
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- 메모/노트 섹션 (선택사항) -->
    {% if schedules %}
    <div class="mt-4">
        <h5>📝 작업 메모</h5>
        <div class="list-group">
            {% for schedule in schedules if schedule.notes %}
            <div class="list-group-item">
                <strong>{{ schedule.worker.username }}</strong> - {{ schedule.keyword_text }}:
                <p class="mb-0 ms-3">{{ schedule.notes }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- 작업 할당 모달 -->
    <div class="modal fade" id="addScheduleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form action="/marketing/schedule/add" method="post" id="addScheduleForm">
                    <div class="modal-header">
                        <h5 class="modal-title">➕ 새 작업 할당</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">날짜 <span class="text-danger">*</span></label>
                                <input type="date" name="scheduled_date" class="form-control" 
                                       value="{{ selected_date }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">작업자 <span class="text-danger">*</span></label>
                                <select name="worker_id" class="form-select" required>
                                    <option value="">선택하세요</option>
                                    {% for worker in workers %}
                                    <option value="{{ worker.id }}">
                                        {{ worker.username }} (일일 {{ worker.daily_quota or 6 }}개)
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">네이버 계정 <span class="text-danger">*</span></label>
                                <select name="account_id" class="form-select" required 
                                        onchange="updateCafeOptions(this.value)">
                                    <option value="">선택하세요</option>
                                    {% for account in accounts %}
                                    <option value="{{ account.id }}">{{ account.account_id }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">카페 <span class="text-danger">*</span></label>
                                <select name="cafe_id" class="form-select" required disabled>
                                    <option value="">계정을 먼저 선택하세요</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">상품 <span class="text-danger">*</span></label>
                                <select name="marketing_product_id" class="form-select" required
                                        onchange="updateKeywordOptions(this.value)">
                                    <option value="">선택하세요</option>
                                    {% for mp in marketing_products %}
                                    <option value="{{ mp.id }}">{{ mp.product.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">키워드 <span class="text-danger">*</span></label>
                                <select name="keyword_text" class="form-select" required disabled>
                                    <option value="">상품을 먼저 선택하세요</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">메모 (선택)</label>
                            <textarea name="notes" class="form-control" rows="3" 
                                      placeholder="작업에 대한 특별한 지시사항이나 메모를 입력하세요"></textarea>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>팁:</strong> 계정을 선택하면 해당 계정이 가입된 카페만 표시됩니다.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="submit" class="btn btn-primary">할당하기</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 대량 생성 모달 -->
    <div class="modal fade" id="bulkGenerateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form action="/marketing/schedule/generate" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title">🤖 스케줄 자동 생성</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>주의:</strong> 자동 생성은 설정된 규칙에 따라 대량의 스케줄을 생성합니다.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">시작 날짜</label>
                                <input type="date" name="start_date" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">종료 날짜</label>
                                <input type="date" name="end_date" class="form-control" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">상품 선택</label>
                            <select name="marketing_product_id" class="form-select" required>
                                <option value="">상품을 선택하세요</option>
                                {% for mp in marketing_products %}
                                <option value="{{ mp.id }}">
                                    {{ mp.product.name }} 
                                    (키워드 {{ product_keywords_map.get(mp.id, [])|length }}개)
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">작업자 선택</label>
                            <input type="hidden" name="worker_ids" id="worker_ids_hidden" value="">
                            <div class="form-check">
                                {% for worker in workers %}
                                <div class="form-check">
                                    <input class="form-check-input worker-checkbox" type="checkbox" 
                                           value="{{ worker.id }}" id="worker_gen_{{ worker.id }}" checked>
                                    <label class="form-check-label" for="worker_gen_{{ worker.id }}">
                                        {{ worker.username }} (일일 {{ worker.daily_quota or 6 }}개)
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6>📋 생성 규칙:</h6>
                                <ul class="mb-0">
                                    <li>키워드당 3개 카페에 자동 분배</li>
                                    <li>계정-카페 순환 사용</li>
                                    <li>동일 조합 최대 2회 제한</li>
                                    <li>주말(토,일) 자동 제외</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="submit" class="btn btn-success">생성하기</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 글 연결 모달 -->
    <div class="modal fade" id="linkPostModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="linkPostForm" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title">🔗 작성된 글 연결</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">작성된 글 선택</label>
                            <select name="marketing_post_id" class="form-select" required>
                                <option value="">선택하세요</option>
                                {% for post in unlinked_posts %}
                                <option value="{{ post.id }}">
                                    [{{ post.keyword_text }}] {{ post.post_title[:50] or '제목 없음' }}
                                    ({{ post.worker.username if post.worker else '작업자 없음' }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="alert alert-info">
                            <small>등록 완료된 글 중 아직 연결되지 않은 글만 표시됩니다.</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="submit" class="btn btn-primary">연결하기</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// 계정-카페 매핑 데이터
const membershipMap = {{ membership_map | tojson | safe }};

// 상품-키워드 매핑 데이터  
const productKeywordsMap = {{ product_keywords_map | tojson | safe }};

// 날짜 변경
function changeDate(days) {
    const currentDate = new Date('{{ selected_date }}');
    currentDate.setDate(currentDate.getDate() + days);
    const dateStr = currentDate.toISOString().split('T')[0];
    window.location.href = `/marketing/schedules?selected_date=${dateStr}`;
}

function selectDate(date) {
    window.location.href = `/marketing/schedules?selected_date=${date}`;
}

// 상태 필터링
function filterStatus(status) {
    const rows = document.querySelectorAll('.schedule-row');
    const buttons = document.querySelectorAll('.filter-btn');
    
    // 버튼 활성화 상태 변경
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // 행 표시/숨기기
    rows.forEach(row => {
        if (status === 'all' || row.dataset.status === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// 완료 토글
function toggleComplete(scheduleId, checkbox) {
    fetch(`/marketing/api/schedule/complete/${scheduleId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || '처리 중 오류가 발생했습니다');
            checkbox.checked = !checkbox.checked;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        checkbox.checked = !checkbox.checked;
    });
}

// 진행 중으로 변경
function setInProgress(scheduleId) {
    const formData = new FormData();
    formData.append('status', 'in_progress');
    
    fetch(`/marketing/api/schedule/status/${scheduleId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || '처리 중 오류가 발생했습니다');
        }
    });
}

// 건너뛰기
function skipSchedule(scheduleId) {
    if (confirm('이 스케줄을 건너뛰시겠습니까?')) {
        const formData = new FormData();
        formData.append('status', 'skipped');
        
        fetch(`/marketing/api/schedule/status/${scheduleId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || '처리 중 오류가 발생했습니다');
            }
        });
    }
}

// 삭제
function deleteSchedule(scheduleId) {
    if (confirm('이 스케줄을 삭제하시겠습니까?')) {
        fetch(`/marketing/api/schedule/${scheduleId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || '처리 중 오류가 발생했습니다');
            }
        });
    }
}

// 수정 모달 열기
function editSchedule(scheduleId) {
    fetch(`/marketing/api/schedule/edit/${scheduleId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 모달에 데이터 채우기
                document.getElementById('edit-schedule-id').value = data.data.id;
                document.getElementById('edit-worker').value = data.data.worker_id || '';
                document.getElementById('edit-account').value = data.data.account_id || '';
                document.getElementById('edit-cafe').value = data.data.cafe_id || '';
                document.getElementById('edit-keyword').value = data.data.keyword_text || '';
                document.getElementById('edit-notes').value = data.data.notes || '';
                
                // 옵션 목록 업데이트
                updateSelectOptions('edit-worker', data.workers, 'name');
                updateSelectOptions('edit-account', data.accounts, 'name');
                updateSelectOptions('edit-cafe', data.cafes, 'name');
                
                // 모달 표시
                const modal = new bootstrap.Modal(document.getElementById('editScheduleModal'));
                modal.show();
            }
        });
}

// 셀렉트 옵션 업데이트
function updateSelectOptions(selectId, options, labelField) {
    const select = document.getElementById(selectId);
    const currentValue = select.value;
    
    // 기존 옵션 제거
    select.innerHTML = '<option value="">선택하세요</option>';
    
    // 새 옵션 추가
    options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.id;
        option.textContent = opt[labelField];
        select.appendChild(option);
    });
    
    // 기존 값 복원
    select.value = currentValue;
}

// 수정 저장
function saveScheduleEdit() {
    const scheduleId = document.getElementById('edit-schedule-id').value;
    const formData = new FormData();
    
    const workerId = document.getElementById('edit-worker').value;
    const accountId = document.getElementById('edit-account').value;
    const cafeId = document.getElementById('edit-cafe').value;
    const keyword = document.getElementById('edit-keyword').value;
    const notes = document.getElementById('edit-notes').value;
    
    if (workerId) formData.append('worker_id', workerId);
    if (accountId) formData.append('account_id', accountId);
    if (cafeId) formData.append('cafe_id', cafeId);
    if (keyword) formData.append('keyword_text', keyword);
    formData.append('notes', notes);
    
    fetch(`/marketing/api/schedule/edit/${scheduleId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || '수정 중 오류가 발생했습니다');
        }
    });
}

// 작성된 글 연결
function linkPost(scheduleId) {
    const postId = prompt('연결할 글의 ID를 입력하세요:');
    if (postId) {
        const formData = new FormData();
        formData.append('post_id', postId);
        
        fetch(`/marketing/api/schedule/link-post/${scheduleId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || '연결 중 오류가 발생했습니다');
            }
        });
    }
}

// 자동 생성
function generateSchedule() {
    const productId = document.getElementById('generate-product').value;
    const startDate = document.getElementById('generate-start').value;
    const endDate = document.getElementById('generate-end').value;
    
    if (!productId || !startDate || !endDate) {
        alert('모든 필드를 입력해주세요');
        return;
    }
    
    const formData = new FormData();
    formData.append('product_id', productId);
    formData.append('start_date', startDate);
    formData.append('end_date', endDate);
    
    // 로딩 표시
    const button = event.target;
    button.disabled = true;
    button.textContent = '생성 중...';
    
    fetch('/marketing/api/generate-schedule', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || '생성 중 오류가 발생했습니다');
        }
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = '자동 생성';
    });
}
</script>

<!-- 수정 모달 HTML -->
<div class="modal fade" id="editScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">스케줄 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-schedule-id">
                
                <div class="mb-3">
                    <label class="form-label">작업자</label>
                    <select id="edit-worker" class="form-control">
                        <option value="">선택하세요</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">계정</label>
                    <select id="edit-account" class="form-control">
                        <option value="">선택하세요</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">카페</label>
                    <select id="edit-cafe" class="form-control">
                        <option value="">선택하세요</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">키워드</label>
                    <input type="text" id="edit-keyword" class="form-control">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">메모</label>
                    <textarea id="edit-notes" class="form-control" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="saveScheduleEdit()">저장</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}