{% extends "base.html" %}
{% block title %}CS 통합 관리{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* 배경 및 레이아웃 */
    body {
        background: #f5f6fa;
        min-height: 100vh;
    }
    
    /* CS 대시보드 레이아웃 */
    .cs-container {
        display: grid;
        grid-template-columns: 400px 1fr;
        gap: 20px;
        padding: 20px;
        height: calc(100vh - 100px);
    }
    
    /* 왼쪽 패널 - 전화 검색 및 고객 정보 */
    .left-panel {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        overflow-y: auto;
    }
    
    /* 오른쪽 패널 - 상품 목록 및 CS 기록 */
    .right-panel {
        display: grid;
        grid-template-rows: 1fr 1fr;
        gap: 20px;
    }
    
    .product-section, .cs-history-section {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        overflow-y: auto;
    }
    
    /* 전화번호 검색 */
    .phone-search {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
    }
    
    .phone-input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }
    
    .phone-input {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 500;
    }
    
    .phone-input:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
    }
    
    .phone-search-btn {
        padding: 12px 24px;
        background: white;
        color: #667eea;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .phone-search-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    /* 고객 정보 카드 */
    .customer-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .customer-new {
        background: #fff3cd;
        border: 2px solid #ffc107;
    }
    
    .customer-existing {
        background: #d1f2eb;
        border: 2px solid #00b894;
    }
    
    .customer-name {
        font-size: 1.3rem;
        font-weight: 700;
        color: #2d3436;
        margin-bottom: 10px;
    }
    
    .customer-info {
        display: grid;
        gap: 8px;
        font-size: 0.95rem;
        color: #636e72;
    }
    
    .customer-info-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .customer-info-item i {
        color: #667eea;
        width: 20px;
    }
    
    /* 구매 이력 */
    .purchase-history {
        margin-top: 20px;
    }
    
    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2d3436;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .purchase-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .purchase-item:hover {
        border-color: #667eea;
        box-shadow: 0 3px 10px rgba(102, 126, 234, 0.1);
    }
    
    .purchase-item-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }
    
    .purchase-product-name {
        font-weight: 600;
        color: #2d3436;
    }
    
    .purchase-date {
        font-size: 0.85rem;
        color: #95a5a6;
    }
    
    .purchase-details {
        display: flex;
        gap: 15px;
        font-size: 0.9rem;
        color: #636e72;
    }
    
    /* 배송 상태 */
    .shipment-status {
        background: linear-gradient(135deg, #00b894 0%, #55efc4 100%);
        color: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .shipment-tracking {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 10px;
    }
    
    .shipment-progress {
        display: flex;
        justify-content: space-between;
        position: relative;
        margin-top: 15px;
    }
    
    .shipment-step {
        text-align: center;
        flex: 1;
        position: relative;
    }
    
    .shipment-step::after {
        content: '';
        position: absolute;
        top: 15px;
        left: 50%;
        width: 100%;
        height: 2px;
        background: rgba(255, 255, 255, 0.3);
    }
    
    .shipment-step:last-child::after {
        display: none;
    }
    
    .shipment-step.active .step-icon {
        background: white;
        color: #00b894;
    }
    
    .step-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 5px;
        position: relative;
        z-index: 1;
    }
    
    .step-label {
        font-size: 0.8rem;
    }
    
    /* CS 입력 폼 */
    .cs-input-form {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #2d3436;
        font-size: 0.9rem;
    }
    
    .form-control {
        width: 100%;
        padding: 10px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.2s;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .form-textarea {
        min-height: 100px;
        resize: vertical;
    }
    
    .form-select {
        cursor: pointer;
    }
    
    /* CS 이력 카드 */
    .cs-record {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        position: relative;
    }
    
    .cs-record.priority-urgent {
        border-left: 4px solid #e74c3c;
    }
    
    .cs-record.priority-important {
        border-left: 4px solid #f39c12;
    }
    
    .cs-record-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }
    
    .cs-type-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        color: white;
    }
    
    .cs-type-delivery {
        background: #3498db;
    }
    
    .cs-type-exchange {
        background: #e67e22;
    }
    
    .cs-type-refund {
        background: #e74c3c;
    }
    
    .cs-type-general {
        background: #95a5a6;
    }
    
    .cs-status-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .cs-status-ongoing {
        background: #fff3cd;
        color: #856404;
    }
    
    .cs-status-completed {
        background: #d4edda;
        color: #155724;
    }
    
    .cs-status-hold {
        background: #f8d7da;
        color: #721c24;
    }
    
    .cs-content {
        color: #2d3436;
        margin-bottom: 10px;
        line-height: 1.5;
    }
    
    .cs-meta {
        display: flex;
        gap: 20px;
        font-size: 0.85rem;
        color: #95a5a6;
    }
    
    /* 버튼 스타일 */
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #00b894 0%, #55efc4 100%);
        color: white;
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
    }
    
    .btn-sm {
        padding: 6px 12px;
        font-size: 0.85rem;
    }
    
    /* 상품 검색 섹션 */
    .product-search-box {
        margin-bottom: 20px;
    }
    
    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
    }
    
    .product-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .product-card:hover {
        background: #e9ecef;
        transform: translateY(-3px);
    }
    
    .product-card.selected {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .product-card img {
        width: 100%;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 8px;
    }
    
    .product-card-name {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .product-card-price {
        font-size: 0.85rem;
        color: #636e72;
    }
    
    .product-card.selected .product-card-price {
        color: rgba(255, 255, 255, 0.8);
    }
    
    /* 통관 상태 */
    .customs-status-card {
        background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
        color: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .customs-status-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 10px;
    }
    
    .customs-info {
        display: grid;
        gap: 8px;
        font-size: 0.9rem;
    }
    
    /* 알림 메시지 */
    .alert {
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .alert-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
    }
    
    .alert-danger {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    /* 로딩 스피너 */
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 40px;
    }
    
    .loading-spinner.active {
        display: block;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* 반응형 */
    @media (max-width: 1200px) {
        .cs-container {
            grid-template-columns: 1fr;
        }
        
        .right-panel {
            grid-template-rows: auto auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="cs-container">
    <!-- 왼쪽 패널: 전화 검색 및 고객 정보 -->
    <div class="left-panel">
        <!-- 전화번호 검색 -->
        <div class="phone-search">
            <h3 style="color: white; margin-bottom: 15px;">
                <i class="bi bi-telephone-fill"></i> 전화번호 검색
            </h3>
            <div class="phone-input-group">
                <input type="tel" 
                       id="phoneInput" 
                       class="phone-input" 
                       placeholder="전화번호 입력 (예: 010-1234-5678)"
                       autocomplete="off">
                <button class="phone-search-btn" onclick="searchByPhone()">
                    <i class="bi bi-search"></i> 조회
                </button>
            </div>
            <div style="color: rgba(255, 255, 255, 0.8); font-size: 0.85rem;">
                전화가 오면 번호를 입력하여 고객 정보를 조회하세요
            </div>
        </div>
        
        <!-- 고객 정보 표시 영역 -->
        <div id="customerInfoSection">
            <!-- 고객 정보가 여기에 동적으로 표시됩니다 -->
        </div>
        
        <!-- CS 입력 폼 -->
        <div class="cs-input-form" id="csInputForm" style="display: none;">
            <h4 class="section-title">CS 기록 작성</h4>
            
            <div class="form-group">
                <label class="form-label">CS 유형</label>
                <select id="csType" class="form-control form-select">
                    <option value="배송문의">배송문의</option>
                    <option value="교환">교환</option>
                    <option value="환불">환불</option>
                    <option value="제품문의">제품문의</option>
                    <option value="일반문의">일반문의</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">우선순위</label>
                <select id="csPriority" class="form-control form-select">
                    <option value="일반">일반</option>
                    <option value="중요">중요</option>
                    <option value="긴급">긴급</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">구매처</label>
                <select id="marketplace" class="form-control form-select">
                    <option value="">선택하세요</option>
                    <option value="쿠팡">쿠팡</option>
                    <option value="네이버">네이버</option>
                    <option value="타오바오">타오바오</option>
                    <option value="기타">기타</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">주문번호</label>
                <input type="text" id="orderNumber" class="form-control" placeholder="주문번호 입력">
            </div>
            
            <div class="form-group">
                <label class="form-label">송장번호</label>
                <input type="text" id="trackingNumber" class="form-control" placeholder="송장번호 입력">
            </div>
            
            <div class="form-group">
                <label class="form-label">문의 내용</label>
                <textarea id="csContent" class="form-control form-textarea" placeholder="고객 문의 내용을 상세히 입력하세요"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">처리 결과</label>
                <textarea id="csResult" class="form-control form-textarea" placeholder="처리 결과를 입력하세요 (선택)"></textarea>
            </div>
            
            <button class="btn btn-primary" onclick="saveCSRecord()">
                <i class="bi bi-save"></i> CS 기록 저장
            </button>
        </div>
    </div>
    
    <!-- 오른쪽 패널: 상품 목록 및 CS 이력 -->
    <div class="right-panel">
        <!-- 상품 선택 섹션 -->
        <div class="product-section">
            <h3 class="section-title">
                <span><i class="bi bi-box-seam"></i> 상품 선택</span>
                <button class="btn btn-sm btn-primary" onclick="loadAllProducts()">
                    전체 상품 보기
                </button>
            </h3>
            
            <div class="product-search-box">
                <input type="text" 
                       id="productSearch" 
                       class="form-control" 
                       placeholder="상품명으로 검색..."
                       onkeyup="searchProducts(this.value)">
            </div>
            
            <div id="productGrid" class="product-grid">
                <!-- 상품 목록이 여기에 표시됩니다 -->
            </div>
        </div>
        
        <!-- CS 이력 섹션 -->
        <div class="cs-history-section">
            <h3 class="section-title">
                <span><i class="bi bi-clock-history"></i> CS 이력</span>
                <span id="csCount" style="font-size: 0.9rem; color: #95a5a6;"></span>
            </h3>
            
            <div id="csHistoryList">
                <!-- CS 이력이 여기에 표시됩니다 -->
                <div style="text-align: center; color: #95a5a6; padding: 40px;">
                    전화번호를 검색하여 CS 이력을 확인하세요
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 전역 변수
let currentCustomer = null;
let selectedProduct = null;
let allProducts = [];

// 전화번호로 고객 검색
async function searchByPhone() {
    const phone = document.getElementById('phoneInput').value;
    if (!phone) {
        alert('전화번호를 입력하세요');
        return;
    }
    
    try {
        const response = await fetch(`/cs/search-by-phone?phone=${encodeURIComponent(phone)}`);
        const data = await response.json();
        
        if (data.is_new_customer) {
            // 신규 고객
            showNewCustomerForm(phone);
        } else {
            // 기존 고객
            currentCustomer = data.customer;
            displayCustomerInfo(data);
            displayCSHistory(data.cs_records);
            displayPurchases(data.purchases);
            displayShipments(data.active_shipments);
        }
        
        // CS 입력 폼 표시
        document.getElementById('csInputForm').style.display = 'block';
        
    } catch (error) {
        console.error('Error:', error);
        alert('고객 정보 조회 중 오류가 발생했습니다');
    }
}

// 신규 고객 폼 표시
function showNewCustomerForm(phone) {
    const section = document.getElementById('customerInfoSection');
    section.innerHTML = `
        <div class="customer-card customer-new">
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> 신규 고객입니다. 정보를 등록하세요.
            </div>
            
            <div class="form-group">
                <label class="form-label">고객명 <span style="color: red;">*</span></label>
                <input type="text" id="newCustomerName" class="form-control" placeholder="고객명 입력">
            </div>
            
            <div class="form-group">
                <label class="form-label">전화번호</label>
                <input type="tel" id="newCustomerPhone" class="form-control" value="${phone}" readonly>
            </div>
            
            <div class="form-group">
                <label class="form-label">이메일</label>
                <input type="email" id="newCustomerEmail" class="form-control" placeholder="이메일 입력 (선택)">
            </div>
            
            <div class="form-group">
                <label class="form-label">주소</label>
                <input type="text" id="newCustomerAddress" class="form-control" placeholder="주소 입력 (선택)">
            </div>
            
            <div class="form-group">
                <label class="form-label">메모</label>
                <textarea id="newCustomerMemo" class="form-control form-textarea" placeholder="고객 메모 (선택)"></textarea>
            </div>
            
            <button class="btn btn-success" onclick="createNewCustomer()">
                <i class="bi bi-person-plus"></i> 고객 등록
            </button>
        </div>
    `;
}

// 신규 고객 등록
async function createNewCustomer() {
    const name = document.getElementById('newCustomerName').value;
    if (!name) {
        alert('고객명을 입력하세요');
        return;
    }
    
    const formData = new FormData();
    formData.append('name', name);
    formData.append('phone', document.getElementById('newCustomerPhone').value);
    formData.append('email', document.getElementById('newCustomerEmail').value || '');
    formData.append('address', document.getElementById('newCustomerAddress').value || '');
    formData.append('memo', document.getElementById('newCustomerMemo').value || '');
    
    try {
        const response = await fetch('/cs/create-customer', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('고객이 등록되었습니다');
            // 다시 검색하여 정보 표시
            searchByPhone();
        }
    } catch (error) {
        console.error('Error:', error);
        alert('고객 등록 중 오류가 발생했습니다');
    }
}

// 고객 정보 표시
function displayCustomerInfo(data) {
    const section = document.getElementById('customerInfoSection');
    const customer = data.customer;
    
    section.innerHTML = `
        <div class="customer-card customer-existing">
            <div class="customer-name">
                <i class="bi bi-person-circle"></i> ${customer.name}
            </div>
            <div class="customer-info">
                <div class="customer-info-item">
                    <i class="bi bi-telephone"></i>
                    <span>${customer.phone}</span>
                </div>
                ${customer.email ? `
                <div class="customer-info-item">
                    <i class="bi bi-envelope"></i>
                    <span>${customer.email}</span>
                </div>
                ` : ''}
                ${customer.address ? `
                <div class="customer-info-item">
                    <i class="bi bi-geo-alt"></i>
                    <span>${customer.address}</span>
                </div>
                ` : ''}
                <div class="customer-info-item">
                    <i class="bi bi-calendar"></i>
                    <span>가입일: ${new Date(customer.created_at).toLocaleDateString()}</span>
                </div>
                <div class="customer-info-item">
                    <i class="bi bi-chat-dots"></i>
                    <span>총 CS: ${data.total_cs_count}건</span>
                </div>
                <div class="customer-info-item">
                    <i class="bi bi-cart"></i>
                    <span>총 구매: ${data.total_purchase_count}건</span>
                </div>
            </div>
            ${customer.memo ? `
            <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 8px;">
                <strong>메모:</strong> ${customer.memo}
            </div>
            ` : ''}
        </div>
    `;
}

// 구매 이력 표시
function displayPurchases(purchases) {
    if (!purchases || purchases.length === 0) return;
    
    const section = document.getElementById('customerInfoSection');
    let purchaseHTML = `
        <div class="purchase-history">
            <h4 class="section-title">
                <span><i class="bi bi-bag-check"></i> 구매 이력</span>
                <span style="font-size: 0.9rem; color: #95a5a6;">${purchases.length}건</span>
            </h4>
    `;
    
    purchases.forEach(purchase => {
        purchaseHTML += `
            <div class="purchase-item" onclick="selectProductFromPurchase(${purchase.product?.id})">
                <div class="purchase-item-header">
                    <span class="purchase-product-name">${purchase.product?.name || '상품명 없음'}</span>
                    <span class="purchase-date">${new Date(purchase.purchase_date).toLocaleDateString()}</span>
                </div>
                <div class="purchase-details">
                    <span><i class="bi bi-shop"></i> ${purchase.marketplace || '-'}</span>
                    <span><i class="bi bi-receipt"></i> ${purchase.order_number || '-'}</span>
                    <span><i class="bi bi-box"></i> ${purchase.quantity}개</span>
                    <span><i class="bi bi-cash"></i> ₩${(purchase.price || 0).toLocaleString()}</span>
                </div>
            </div>
        `;
    });
    
    purchaseHTML += '</div>';
    section.innerHTML += purchaseHTML;
}

// 배송 상태 표시
function displayShipments(shipments) {
    if (!shipments || shipments.length === 0) return;
    
    const section = document.getElementById('customerInfoSection');
    let shipmentHTML = '<div class="shipment-section">';
    
    shipments.forEach(shipment => {
        const steps = [
            { icon: 'bi-box', label: '주문접수', active: true },
            { icon: 'bi-airplane', label: '해외배송', active: shipment.international_status === '배송중' || shipment.international_status === '완료' },
            { icon: 'bi-building', label: '통관', active: shipment.customs_status === '완료' },
            { icon: 'bi-truck', label: '국내배송', active: shipment.domestic_status === '배송중' || shipment.domestic_status === '완료' },
            { icon: 'bi-check-circle', label: '배송완료', active: shipment.delivered_date != null }
        ];
        
        shipmentHTML += `
            <div class="shipment-status">
                <div class="shipment-tracking">
                    <i class="bi bi-geo-alt"></i> 송장: ${shipment.domestic_tracking || shipment.international_tracking || '미등록'}
                </div>
                <div class="shipment-progress">
                    ${steps.map(step => `
                        <div class="shipment-step ${step.active ? 'active' : ''}">
                            <div class="step-icon">
                                <i class="bi ${step.icon}"></i>
                            </div>
                            <div class="step-label">${step.label}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        // 통관 상태가 있으면 표시
        if (shipment.customs_status && shipment.customs_status !== '완료') {
            shipmentHTML += `
                <div class="customs-status-card">
                    <div class="customs-status-title">
                        <i class="bi bi-exclamation-triangle"></i> 통관 상태: ${shipment.customs_status}
                    </div>
                    <div class="customs-info">
                        ${shipment.customs_number ? `<div>통관번호: ${shipment.customs_number}</div>` : ''}
                        ${shipment.customs_issue ? `<div>이슈: ${shipment.customs_issue}</div>` : ''}
                    </div>
                </div>
            `;
        }
    });
    
    shipmentHTML += '</div>';
    section.innerHTML += shipmentHTML;
}

// CS 이력 표시
function displayCSHistory(records) {
    const historyList = document.getElementById('csHistoryList');
    document.getElementById('csCount').textContent = `총 ${records.length}건`;
    
    if (!records || records.length === 0) {
        historyList.innerHTML = '<div style="text-align: center; color: #95a5a6; padding: 40px;">CS 이력이 없습니다</div>';
        return;
    }
    
    let html = '';
    records.forEach(record => {
        const priorityClass = record.priority === '긴급' ? 'priority-urgent' : 
                            record.priority === '중요' ? 'priority-important' : '';
        
        const statusBadgeClass = record.cs_status === '진행중' ? 'cs-status-ongoing' :
                                record.cs_status === '완료' ? 'cs-status-completed' : 'cs-status-hold';
        
        const typeBadgeClass = record.cs_type === '배송문의' ? 'cs-type-delivery' :
                              record.cs_type === '교환' ? 'cs-type-exchange' :
                              record.cs_type === '환불' ? 'cs-type-refund' : 'cs-type-general';
        
        html += `
            <div class="cs-record ${priorityClass}">
                <div class="cs-record-header">
                    <div>
                        <span class="cs-type-badge ${typeBadgeClass}">${record.cs_type}</span>
                        <span class="cs-status-badge ${statusBadgeClass}">${record.cs_status}</span>
                    </div>
                    <div>
                        ${record.priority === '긴급' ? '<i class="bi bi-exclamation-triangle" style="color: #e74c3c;"></i>' : ''}
                    </div>
                </div>
                <div class="cs-content">
                    ${record.cs_content}
                    ${record.cs_result ? `<div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;"><strong>처리결과:</strong> ${record.cs_result}</div>` : ''}
                </div>
                <div class="cs-meta">
                    <span><i class="bi bi-person"></i> ${record.handler_name}</span>
                    <span><i class="bi bi-calendar"></i> ${new Date(record.created_at).toLocaleString()}</span>
                    ${record.marketplace ? `<span><i class="bi bi-shop"></i> ${record.marketplace}</span>` : ''}
                    ${record.tracking_number ? `<span><i class="bi bi-truck"></i> ${record.tracking_number}</span>` : ''}
                </div>
            </div>
        `;
    });
    
    historyList.innerHTML = html;
}

// 모든 상품 로드
async function loadAllProducts() {
    try {
        const response = await fetch('/products/api/search?q=');
        const products = await response.json();
        allProducts = products;
        displayProducts(products);
    } catch (error) {
        console.error('Error loading products:', error);
    }
}

// 상품 검색
async function searchProducts(query) {
    if (!query) {
        displayProducts(allProducts);
        return;
    }
    
    try {
        const response = await fetch(`/products/api/search?q=${encodeURIComponent(query)}`);
        const products = await response.json();
        displayProducts(products);
    } catch (error) {
        console.error('Error searching products:', error);
    }
}

// 상품 목록 표시
function displayProducts(products) {
    const grid = document.getElementById('productGrid');
    
    if (!products || products.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #95a5a6;">상품이 없습니다</div>';
        return;
    }
    
    let html = '';
    products.forEach(product => {
        const isSelected = selectedProduct && selectedProduct.id === product.id;
        html += `
            <div class="product-card ${isSelected ? 'selected' : ''}" onclick="selectProduct(${product.id}, '${product.name}', ${product.price})">
                ${product.image ? 
                    `<img src="${product.image}" alt="${product.name}">` :
                    `<div style="height: 100px; background: #e9ecef; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-image" style="font-size: 2rem; color: #95a5a6;"></i>
                    </div>`
                }
                <div class="product-card-name">${product.name}</div>
                <div class="product-card-price">₩${(product.price || 0).toLocaleString()}</div>
            </div>
        `;
    });
    
    grid.innerHTML = html;
}

// 상품 선택
function selectProduct(id, name, price) {
    selectedProduct = { id, name, price };
    
    // UI 업데이트
    document.querySelectorAll('.product-card').forEach(card => {
        card.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
}

// 구매 이력에서 상품 선택
function selectProductFromPurchase(productId) {
    if (!productId) return;
    
    // 상품 검색하여 선택
    const product = allProducts.find(p => p.id === productId);
    if (product) {
        selectProduct(product.id, product.name, product.price);
        // 상품 카드 하이라이트
        displayProducts(allProducts);
    }
}

// CS 기록 저장
async function saveCSRecord() {
    if (!currentCustomer) {
        alert('먼저 고객을 검색하세요');
        return;
    }
    
    const csContent = document.getElementById('csContent').value;
    if (!csContent) {
        alert('문의 내용을 입력하세요');
        return;
    }
    
    const formData = new FormData();
    formData.append('customer_id', currentCustomer.id);
    if (selectedProduct) {
        formData.append('product_id', selectedProduct.id);
    }
    formData.append('cs_type', document.getElementById('csType').value);
    formData.append('cs_content', csContent);
    formData.append('cs_result', document.getElementById('csResult').value || '');
    formData.append('marketplace', document.getElementById('marketplace').value || '');
    formData.append('order_number', document.getElementById('orderNumber').value || '');
    formData.append('tracking_number', document.getElementById('trackingNumber').value || '');
    formData.append('priority', document.getElementById('csPriority').value);
    
    try {
        const response = await fetch('/cs/create-cs-record', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('CS 기록이 저장되었습니다');
            // 폼 초기화
            document.getElementById('csContent').value = '';
            document.getElementById('csResult').value = '';
            document.getElementById('orderNumber').value = '';
            document.getElementById('trackingNumber').value = '';
            // CS 이력 새로고침
            searchByPhone();
        }
    } catch (error) {
        console.error('Error:', error);
        alert('CS 기록 저장 중 오류가 발생했습니다');
    }
}

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    // 전화번호 입력 시 엔터키 처리
    document.getElementById('phoneInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchByPhone();
        }
    });
    
    // 초기 상품 로드
    loadAllProducts();
});
</script>
{% endblock %}