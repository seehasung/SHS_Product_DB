{% extends "base.html" %}
{% block title %}주문조회 - 주문조회{% endblock %}

{% block head %}
{{ super() }}
<style>
    .search-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .search-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
    }
    
    /* 검색 바 */
    .search-bar {
        display: flex;
        gap: 10px;
    }
    
    .search-input {
        flex: 1;
        padding: 15px 20px;
        border: 2px solid #e1e8ed;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .search-input:focus {
        outline: none;
        border-color: #4A90E2;
        box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1);
    }
    
    .btn-search {
        padding: 15px 40px;
        background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-search:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
    }
    
    /* 하이라이트 스타일 */
    .highlight {
        background: linear-gradient(135deg, #fff176 0%, #ffeb3b 100%);
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: 700;
        color: #000;
    }
    
    /* 테이블 카드 */
    .table-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    }
    
    /* 테이블 헤더 */
    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e1e8ed;
    }
    
    .table-header h3 {
        font-size: 1.5rem;
        font-weight: 800;
        color: #2d3436;
        margin: 0;
    }
    
    /* 테이블 */
    .order-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .order-table thead th {
        background: linear-gradient(135deg, rgba(74, 144, 226, 0.1) 0%, rgba(91, 163, 245, 0.1) 100%);
        padding: 15px;
        text-align: left;
        font-weight: 700;
        color: #2d3436;
        font-size: 0.9rem;
        border-bottom: 2px solid #e1e8ed;
        white-space: nowrap;
    }
    
    .order-table thead th:first-child {
        border-radius: 10px 0 0 0;
    }
    
    .order-table thead th:last-child {
        border-radius: 0 10px 0 0;
    }
    
    .order-table tbody tr {
        transition: all 0.2s;
        background: white;
    }
    
    .order-table tbody tr:hover {
        background: rgba(74, 144, 226, 0.05);
        transform: scale(1.002);
    }
    
    .order-table tbody td {
        padding: 15px;
        border-bottom: 1px solid #f1f3f5;
        color: #495057;
        font-size: 0.9rem;
    }
    
    /* 상태 배지 */
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
    }
    
    .status-badge.completed {
        background: #d4edda;
        color: #155724;
    }
    
    .status-badge.shipping {
        background: #cce5ff;
        color: #004085;
    }
    
    .status-badge.pending {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-badge.cancelled {
        background: #f8d7da;
        color: #721c24;
    }
    
    /* 액션 버튼 */
    .action-buttons {
        display: flex;
        gap: 5px;
    }
    
    .btn-action {
        padding: 6px 12px;
        border: none;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }
    
    .btn-action i {
        font-size: 0.9rem;
    }
    
    .no-data {
        text-align: center;
        padding: 60px 20px;
        color: #adb5bd;
    }
    
    .no-data i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }
    
    /* 페이지네이션 스타일 */
    .pagination {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }
    
    .pagination .page-item {
        list-style: none;
    }
    
    .pagination .page-link {
        padding: 8px 16px;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        color: #4A90E2;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        text-decoration: none;
        display: inline-block;
    }
    
    .pagination .page-link:hover {
        background: #4A90E2;
        color: white;
        border-color: #4A90E2;
        transform: translateY(-2px);
    }
    
    .pagination .page-item.active .page-link {
        background: #4A90E2;
        color: white;
        border-color: #4A90E2;
    }
    
    .pagination .page-item.disabled .page-link {
        color: #b2bec3;
        cursor: not-allowed;
        border-color: #e1e8ed;
    }
    
    .pagination .page-item.disabled .page-link:hover {
        background: white;
        color: #b2bec3;
        transform: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="search-container">
    <!-- 페이지 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 style="font-weight: 800; color: #2d3436;">
            <i class="bi bi-search"></i> 주문조회
        </h1>
        <a href="/orders/dashboard" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> 전체 현황으로
        </a>
    </div>
    
    <!-- 검색 카드 -->
    <div class="search-card">
        <h4 style="margin-bottom: 15px; color: #2d3436;">
            <i class="bi bi-funnel-fill"></i> 통합 검색
        </h4>
        <div class="alert alert-info mb-3">
            <i class="bi bi-info-circle"></i>
            <strong>검색 가능:</strong> 고객명, 수령자명, 연락처, 송장번호, 상품명
        </div>
        <div class="search-bar">
            <input type="text" 
                   id="searchInput" 
                   class="search-input" 
                   placeholder="검색어를 입력하세요..."
                   onkeypress="if(event.key === 'Enter') searchOrders()">
            <button class="btn-search" onclick="searchOrders()">
                <i class="bi bi-search"></i> 검색
            </button>
        </div>
    </div>
    
    <!-- 결과 테이블 -->
    <div class="table-card">
        <div class="table-header">
            <h3><i class="bi bi-list-ul"></i> 검색 결과</h3>
            <div>
                <span id="resultsCount" style="color: #636e72; font-weight: 600;"></span>
            </div>
        </div>
        
        <div id="resultsContainer">
            <div class="no-data">
                <i class="bi bi-search"></i>
                <p style="font-size: 1.1rem; margin-top: 10px;">검색어를 입력하세요</p>
                <p style="color: #636e72;">고객명, 수령자명, 연락처, 송장번호, 상품명으로 검색할 수 있습니다</p>
            </div>
        </div>
        
        <!-- 페이지네이션 -->
        <div id="searchPaginationContainer" style="display: none; margin-top: 20px; text-align: center;">
            <nav>
                <ul class="pagination justify-content-center" id="searchPaginationButtons">
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- 주문 상세 모달 -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-file-text"></i> 주문 상세 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailContent">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 배송 조회 모달 -->
<div class="modal fade" id="trackingModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-truck"></i> <span id="trackingTitle">배송 조회</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="trackingContent">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 통관 조회 모달 -->
<div class="modal fade" id="customsModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-globe"></i> 통관 진행정보
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="customsContent">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-3">통관 정보를 조회 중입니다...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i> 닫기
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // ===== 전역 변수: 검색어 저장 =====
    let currentSearchTerm = '';
    let currentSearchPage = 1;

    // ===== 송장번호 정리 함수 (.0 제거) =====
    function cleanTrackingNumber(trackingNumber) {
        if (!trackingNumber) return '-';
        const cleaned = String(trackingNumber);
        if (cleaned.endsWith('.0')) {
            return cleaned.slice(0, -2);
        }
        return cleaned;
    }

    // ===== 텍스트 하이라이트 함수 =====
    function highlightText(text, searchTerm) {
        if (!text || !searchTerm) return text || '-';
        
        const textStr = String(text);
        const searchStr = String(searchTerm);
        
        // 대소문자 구분 없이 검색
        const regex = new RegExp(`(${searchStr})`, 'gi');
        return textStr.replace(regex, '<span class="highlight">$1</span>');
    }

    // ===== 통합 검색 (페이지네이션 지원) =====
    async function searchOrders(page = 1) {
        const search = document.getElementById('searchInput').value.trim();
        const container = document.getElementById('resultsContainer');
        
        if (!search) {
            container.innerHTML = `
                <div class="no-data">
                    <i class="bi bi-search"></i>
                    <p style="font-size: 1.1rem; margin-top: 10px;">검색어를 입력하세요</p>
                </div>
            `;
            document.getElementById('resultsCount').textContent = '';
            document.getElementById('searchPaginationContainer').style.display = 'none';
            currentSearchTerm = '';
            return;
        }
        
        currentSearchPage = page;
        
        container.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                <p style="margin-top: 15px; color: #636e72;">검색 중...</p>
            </div>
        `;
        
        try {
            // 통합 검색 API 호출 (페이지네이션)
            const response = await fetch(`/orders/api/search/all?search=${encodeURIComponent(search)}&page=${page}&limit=100`);
            const data = await response.json();
            
            console.log('검색 결과:', data);
            
            // 검색어 저장
            currentSearchTerm = data.search_term || search;
            
            if (data.orders && data.orders.length > 0) {
                displayOrders(data.orders);
                
                // 페이지네이션 렌더링
                if (data.pagination) {
                    renderSearchPagination(data.pagination);
                    document.getElementById('resultsCount').textContent = 
                        `총 ${data.pagination.total_count.toLocaleString()}건 (${data.pagination.current_page}/${data.pagination.total_pages} 페이지)`;
                } else {
                    document.getElementById('resultsCount').textContent = `총 ${data.orders.length}건`;
                    document.getElementById('searchPaginationContainer').style.display = 'none';
                }
            } else {
                container.innerHTML = `
                    <div class="no-data">
                        <i class="bi bi-inbox"></i>
                        <p style="font-size: 1.1rem; margin-top: 10px;">검색 결과가 없습니다</p>
                        <p style="color: #636e72;">"${search}" 에 대한 검색 결과가 없습니다</p>
                    </div>
                `;
                document.getElementById('resultsCount').textContent = '';
                document.getElementById('searchPaginationContainer').style.display = 'none';
                currentSearchTerm = '';
            }
        } catch (error) {
            console.error('검색 오류:', error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> 검색 중 오류가 발생했습니다.
                </div>
            `;
            document.getElementById('resultsCount').textContent = '';
            document.getElementById('searchPaginationContainer').style.display = 'none';
            currentSearchTerm = '';
        }
    }
    
    // ===== 검색 페이지네이션 렌더링 =====
    function renderSearchPagination(pagination) {
        const container = document.getElementById('searchPaginationContainer');
        const buttons = document.getElementById('searchPaginationButtons');
        
        if (pagination.total_pages <= 1) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'block';
        
        let html = '';
        
        // 이전 버튼
        html += `
            <li class="page-item ${pagination.has_prev ? '' : 'disabled'}">
                <a class="page-link" onclick="${pagination.has_prev ? `searchOrders(${pagination.current_page - 1})` : 'return false;'}">
                    <i class="bi bi-chevron-left"></i> 이전
                </a>
            </li>
        `;
        
        // 페이지 번호 버튼
        const maxButtons = 10;
        let startPage = Math.max(1, pagination.current_page - 5);
        let endPage = Math.min(pagination.total_pages, startPage + maxButtons - 1);
        
        // 시작 페이지 조정
        if (endPage - startPage < maxButtons - 1) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }
        
        // 첫 페이지
        if (startPage > 1) {
            html += `
                <li class="page-item">
                    <a class="page-link" onclick="searchOrders(1)">1</a>
                </li>
            `;
            if (startPage > 2) {
                html += `<li class="page-item disabled"><a class="page-link">...</a></li>`;
            }
        }
        
        // 페이지 번호들
        for (let i = startPage; i <= endPage; i++) {
            html += `
                <li class="page-item ${i === pagination.current_page ? 'active' : ''}">
                    <a class="page-link" onclick="searchOrders(${i})">${i}</a>
                </li>
            `;
        }
        
        // 마지막 페이지
        if (endPage < pagination.total_pages) {
            if (endPage < pagination.total_pages - 1) {
                html += `<li class="page-item disabled"><a class="page-link">...</a></li>`;
            }
            html += `
                <li class="page-item">
                    <a class="page-link" onclick="searchOrders(${pagination.total_pages})">${pagination.total_pages}</a>
                </li>
            `;
        }
        
        // 다음 버튼
        html += `
            <li class="page-item ${pagination.has_next ? '' : 'disabled'}">
                <a class="page-link" onclick="${pagination.has_next ? `searchOrders(${pagination.current_page + 1})` : 'return false;'}">
                    다음 <i class="bi bi-chevron-right"></i>
                </a>
            </li>
        `;
        
        buttons.innerHTML = html;
    }

    // ===== 주문 목록 표시 (하이라이트 적용) =====
    function displayOrders(orders) {
        const container = document.getElementById('resultsContainer');
        
        let html = `
            <div style="overflow-x: auto;">
                <table class="order-table">
                    <thead>
                        <tr>
                            <th>주문번호</th>
                            <th>판매처</th>
                            <th>주문상태</th>
                            <th>택배사</th>
                            <th>송장번호</th>
                            <th>주문일자</th>
                            <th>구매자</th>
                            <th>수령자</th>
                            <th>연락처</th>
                            <th>제품명</th>
                            <th>결제금액</th>
                            <th style="min-width: 200px;">액션</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        orders.forEach(order => {
            let statusClass = 'pending';
            if (order.order_status && (order.order_status.includes('완료') || order.order_status.includes('배송'))) {
                statusClass = 'completed';
            } else if (order.order_status && (order.order_status.includes('취소') || order.order_status.includes('반품'))) {
                statusClass = 'cancelled';
            } else if (order.order_status && (order.order_status.includes('대기') || order.order_status.includes('준비'))) {
                statusClass = 'pending';
            } else {
                statusClass = 'shipping';
            }
            
            let formattedAmount = '-';
            if (order.payment_amount) {
                let amount = order.payment_amount.toString().replace(/[^0-9]/g, '');
                if (amount) {
                    formattedAmount = parseInt(amount).toLocaleString('ko-KR') + '원';
                }
            }
            
            let salesChannel = order.sales_channel || '-';
            if (salesChannel.length > 20) {
                salesChannel = salesChannel.substring(0, 20) + '...';
            }
            
            let productName = order.product_name || '-';
            if (productName.length > 30) {
                productName = productName.substring(0, 30) + '...';
            }
            
            // 하이라이트 적용 (검색 대상 필드만)
            const highlightedBuyerName = highlightText(order.buyer_name, currentSearchTerm);
            const highlightedRecipientName = highlightText(order.recipient_name, currentSearchTerm);
            const highlightedContactNumber = highlightText(order.contact_number, currentSearchTerm);
            const highlightedTrackingNumber = highlightText(cleanTrackingNumber(order.tracking_number), currentSearchTerm);
            const highlightedProductName = highlightText(productName, currentSearchTerm);
            
            html += `
                <tr>
                    <td><strong>${order.order_number || '-'}</strong></td>
                    <td>${salesChannel}</td>
                    <td><span class="status-badge ${statusClass}">${order.order_status || '-'}</span></td>
                    <td>${order.courier_company || '-'}</td>
                    <td><strong style="color: #4A90E2;">${highlightedTrackingNumber}</strong></td>
                    <td>${order.order_date || '-'}</td>
                    <td>${highlightedBuyerName}</td>
                    <td>${highlightedRecipientName}</td>
                    <td>${highlightedContactNumber}</td>
                    <td>${highlightedProductName}</td>
                    <td><strong>${formattedAmount}</strong></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary btn-action" onclick="viewOrder(${order.id})">
                                <i class="bi bi-eye"></i> 상세
                            </button>
                            <button class="btn btn-sm btn-success btn-action" onclick="viewTracking(${order.id})">
                                <i class="bi bi-truck"></i> 배송
                            </button>
                            <button class="btn btn-sm btn-info btn-action" onclick="viewCustoms(${order.id})">
                                <i class="bi bi-globe"></i> 통관
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        container.innerHTML = html;
    }

    // ===== 주문 상세보기 =====
    async function viewOrder(orderId) {
        const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
        modal.show();
        
        document.getElementById('orderDetailContent').innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary"></div>
            </div>
        `;
        
        try {
            const response = await fetch(`/orders/api/${orderId}/detail`);
            const order = await response.json();
            
            document.getElementById('orderDetailContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">주문번호</label>
                        <input type="text" class="form-control" value="${order.order_number || '-'}" readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">주문상태</label>
                        <input type="text" class="form-control" value="${order.order_status || '-'}" readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">주문일자</label>
                        <input type="text" class="form-control" value="${order.order_date || '-'}" readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">구매자</label>
                        <input type="text" class="form-control" value="${order.buyer_name || '-'}" readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">수령자</label>
                        <input type="text" class="form-control" value="${order.recipient_name || '-'}" readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">연락처</label>
                        <input type="text" class="form-control" value="${order.contact_number || '-'}" readonly>
                    </div>
                    <div class="col-12 mb-3">
                        <label class="form-label fw-bold">배송지</label>
                        <input type="text" class="form-control" value="${order.delivery_address || '-'}" readonly>
                    </div>
                    <div class="col-12 mb-3">
                        <label class="form-label fw-bold">제품명</label>
                        <textarea class="form-control" rows="2" readonly>${order.product_name || '-'}</textarea>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">송장번호</label>
                        <input type="text" class="form-control" value="${cleanTrackingNumber(order.tracking_number)}" readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">택배사</label>
                        <input type="text" class="form-control" value="${order.courier_company || '-'}" readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">결제금액</label>
                        <input type="text" class="form-control" value="${order.payment_amount || '-'}" readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">판매처</label>
                        <input type="text" class="form-control" value="${order.sales_channel || '-'}" readonly>
                    </div>
                </div>
            `;
        } catch (error) {
            console.error('상세 조회 오류:', error);
            document.getElementById('orderDetailContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> 주문 정보를 불러오는데 실패했습니다.
                </div>
            `;
        }
    }

    // ===== 배송 조회 =====
    async function viewTracking(orderId) {
        const modal = new bootstrap.Modal(document.getElementById('trackingModal'));
        modal.show();
        
        document.getElementById('trackingContent').innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary"></div>
                <p class="mt-3">배송 정보를 조회 중입니다...</p>
            </div>
        `;
        
        try {
            const response = await fetch(`/orders/api/tracking/${orderId}`);
            const data = await response.json();
            
            if (!data.success) {
                document.getElementById('trackingContent').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> ${data.message || '배송 정보를 가져올 수 없습니다.'}
                    </div>
                `;
                return;
            }
            
            document.getElementById('trackingTitle').textContent = 
                `배송 조회 - ${data.courier} (${cleanTrackingNumber(data.tracking_number)})`;
            
            // 간단한 배송 정보 표시
            document.getElementById('trackingContent').innerHTML = `
                <div class="alert alert-success">
                    <h5 class="alert-heading">배송 정보</h5>
                    <hr>
                    <p class="mb-1"><strong>택배사:</strong> ${data.courier}</p>
                    <p class="mb-0"><strong>송장번호:</strong> ${cleanTrackingNumber(data.tracking_number)}</p>
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 상세한 배송 추적 정보는 전체 현황 페이지에서 확인하실 수 있습니다.
                </div>
            `;
        } catch (error) {
            console.error('배송 조회 오류:', error);
            document.getElementById('trackingContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> 조회 중 오류가 발생했습니다.
                </div>
            `;
        }
    }

    // ===== 통관 조회 =====
    async function viewCustoms(orderId) {
        const modal = new bootstrap.Modal(document.getElementById('customsModal'));
        modal.show();
        
        document.getElementById('customsContent').innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary"></div>
                <p class="mt-3">통관 정보를 조회 중입니다...</p>
            </div>
        `;
        
        try {
            const response = await fetch(`/orders/api/customs/${orderId}`);
            const data = await response.json();
            
            if (data.success) {
                displayCustomsModal(data);
            } else {
                document.getElementById('customsContent').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> ${data.message || '통관 정보를 불러올 수 없습니다.'}
                    </div>
                `;
            }
        } catch (error) {
            console.error('통관 조회 오류:', error);
            document.getElementById('customsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> 통관 조회 중 오류가 발생했습니다.
                </div>
            `;
        }
    }

    // ===== 통관 정보 모달 표시 (7customs 버전) =====
    function displayCustomsModal(data) {
        const content = document.getElementById('customsContent');
        
        const basicInfo = data.basic_info || {};
        const history = data.history || [];
        const cleanedTracking = cleanTrackingNumber(data.tracking_number);
        
        let html = `
            <div class="customs-info">
                <!-- 조회 정보 헤더 -->
                <div class="alert alert-info mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="mb-0">
                                <i class="bi bi-upc-scan"></i> 
                                <strong>송장번호:</strong> ${cleanedTracking}
                            </h5>
                        </div>
                        <div class="col-md-4 text-end">
                            ${data.url ? `
                                <a href="${data.url}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-box-arrow-up-right"></i> 7customs.com에서 보기
                                </a>
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                <!-- 통관 상태 카드 -->
                <div class="card mb-4" style="border-left: 4px solid #667eea;">
                    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> 통관 상태</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="text-muted small d-block">현재 상태</label>
                                <h4 class="mb-0" style="color: #667eea;">
                                    ${basicInfo.customs_status || '정보 없음'}
                                </h4>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="text-muted small d-block">통관완료 예상일</label>
                                <h5 class="mb-0 text-danger">
                                    ${basicInfo.expected_clearance_date || '정보 없음'}
                                </h5>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="text-muted small d-block">입항일</label>
                                <p class="mb-0 h6">
                                    ${basicInfo.arrival_date || '정보 없음'}
                                </p>
                            </div>
                        </div>
                        <hr>
                        <div>
                            <label class="text-muted small d-block">물품정보</label>
                            <p class="mb-0">
                                ${basicInfo.product_info || '정보 없음'}
                            </p>
                        </div>
                    </div>
                </div>
        `;
        
        // 통관상세내역 (히스토리)
        if (history && history.length > 0) {
            html += `
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-clock-history"></i> 통관상세내역 (${history.length}건)
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th width="15%">처리구분</th>
                                        <th width="50%">내용</th>
                                        <th width="20%">처리일시</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            history.forEach(item => {
                html += `
                                    <tr>
                                        <td>
                                            <span class="badge bg-primary" style="font-size: 0.85rem;">
                                                ${item.process_type || '-'}
                                            </span>
                                        </td>
                                        <td>${item.content || '-'}</td>
                                        <td>
                                            <small class="text-muted">
                                                ${item.processing_datetime || '-'}
                                            </small>
                                        </td>
                                    </tr>
                `;
            });
            
            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        } else {
            html += `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill"></i> 
                    통관 진행 이력이 없습니다.
                </div>
            `;
        }
        
        html += `</div>`;
        
        content.innerHTML = html;
    }
</script>

{% endblock %}