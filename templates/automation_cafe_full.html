{% extends "base.html" %}
{% block title %}ìë™í™” - ì¹´í˜ ê´€ë¦¬{% endblock %}

{% block head %}
{{ super() }}
<style>
    .automation-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* íƒ­ ìŠ¤íƒ€ì¼ */
    .nav-tabs {
        border-bottom: 2px solid #e1e8ed;
        margin-bottom: 30px;
    }
    
    .nav-tabs .nav-link {
        border: none;
        color: #636e72;
        font-weight: 600;
        padding: 15px 30px;
        transition: all 0.3s;
        position: relative;
    }
    
    .nav-tabs .nav-link:hover {
        color: #4A90E2;
        background: rgba(74, 144, 226, 0.05);
    }
    
    .nav-tabs .nav-link.active {
        color: #4A90E2;
        background: transparent;
    }
    
    .nav-tabs .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 3px;
        background: #4A90E2;
    }
    
    /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .content-card {
        background: white;
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        margin-bottom: 20px;
    }
    
    .card-header-custom {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e1e8ed;
    }
    
    .card-header-custom h4 {
        font-weight: 700;
        color: #2d3436;
        margin: 0;
    }
    
    /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .data-table thead th {
        background: linear-gradient(135deg, rgba(74, 144, 226, 0.1) 0%, rgba(91, 163, 245, 0.1) 100%);
        padding: 12px;
        text-align: left;
        font-weight: 700;
        color: #2d3436;
        font-size: 0.9rem;
        border-bottom: 2px solid #e1e8ed;
    }
    
    .data-table tbody tr {
        transition: all 0.2s;
        border-bottom: 1px solid #f1f3f5;
    }
    
    .data-table tbody tr:hover {
        background: rgba(74, 144, 226, 0.05);
    }
    
    .data-table tbody td {
        padding: 12px;
        color: #495057;
        font-size: 0.9rem;
    }
    
    /* ë°°ì§€ ìŠ¤íƒ€ì¼ */
    .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
    }
    
    .status-badge.online { background: #d4edda; color: #155724; }
    .status-badge.busy { background: #fff3cd; color: #856404; }
    .status-badge.offline { background: #f8d7da; color: #721c24; }
    .status-badge.active { background: #d4edda; color: #155724; }
    .status-badge.suspended { background: #f8d7da; color: #721c24; }
    
    /* ë¹ˆ ìƒíƒœ */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #adb5bd;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="automation-container">
    <h1 style="font-weight: 800; margin-bottom: 30px;">
        <i class="bi bi-robot"></i> ì¹´í˜ ìë™í™” ê´€ë¦¬
    </h1>
    
    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#dashboard">
                <i class="bi bi-speedometer2"></i> ëŒ€ì‹œë³´ë“œ
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#pcs">
                <i class="bi bi-pc-display"></i> PC ê´€ë¦¬
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#accounts">
                <i class="bi bi-person-badge"></i> ê³„ì • ê´€ë¦¬
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#cafes">
                <i class="bi bi-cup-hot"></i> ì¹´í˜ ê´€ë¦¬
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#prompts">
                <i class="bi bi-chat-square-text"></i> í”„ë¡¬í”„íŠ¸ ê´€ë¦¬
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#schedules">
                <i class="bi bi-calendar-week"></i> ìŠ¤ì¼€ì¤„ ê´€ë¦¬
            </a>
        </li>
    </ul>
    
    <!-- íƒ­ ì»¨í…ì¸  -->
    <div class="tab-content">
        <!-- ëŒ€ì‹œë³´ë“œ íƒ­ -->
        <div class="tab-pane fade show active" id="dashboard">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-speedometer2"></i> ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ</h4>
                    <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    <strong>ì•ˆë‚´:</strong> ìë™í™” ì‹œìŠ¤í…œì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. 
                    ê° íƒ­ì—ì„œ PC, ê³„ì •, ì¹´í˜ ë“±ì„ ê´€ë¦¬í•˜ì„¸ìš”.
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <p>ëŒ€ì‹œë³´ë“œ ë‚´ìš©ì€ <code>automation_dashboard.html</code>ì˜ ë‚´ìš©ì„ ì—¬ê¸°ì— í†µí•© ì˜ˆì •</p>
                        <p>í˜„ì¬ëŠ” ê° íƒ­ì—ì„œ ê´€ë¦¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì„¸ìš”.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PC ê´€ë¦¬ íƒ­ -->
        <div class="tab-pane fade" id="pcs">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-pc-display"></i> PC ê´€ë¦¬</h4>
                    {% if is_admin %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPCModal">
                        <i class="bi bi-plus-circle"></i> PC ì¶”ê°€
                    </button>
                    {% endif %}
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>PC ë²ˆí˜¸</th>
                                <th>PC ì´ë¦„</th>
                                <th>IP ì£¼ì†Œ</th>
                                <th>ìƒíƒœ</th>
                                <th>CPU</th>
                                <th>ë©”ëª¨ë¦¬</th>
                                <th>ë§ˆì§€ë§‰ í†µì‹ </th>
                                <th>í˜„ì¬ ì‘ì—…</th>
                                {% if is_admin %}<th>ê´€ë¦¬</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody id="pcsTableBody">
                            <tr>
                                <td colspan="9" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split"></i> ë°ì´í„° ë¡œë”© ì¤‘...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ê³„ì • ê´€ë¦¬ íƒ­ -->
        <div class="tab-pane fade" id="accounts">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-person-badge"></i> ê³„ì • ê´€ë¦¬</h4>
                    {% if is_admin %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                        <i class="bi bi-plus-circle"></i> ê³„ì • ì¶”ê°€
                    </button>
                    {% endif %}
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ê³„ì • ID</th>
                                <th>í• ë‹¹ PC</th>
                                <th>ìƒíƒœ</th>
                                <th>ë¡œê·¸ì¸ ìƒíƒœ</th>
                                <th>ì‘ì„± ê¸€</th>
                                <th>ì‘ì„± ëŒ“ê¸€</th>
                                <th>ë§ˆì§€ë§‰ ì‚¬ìš©</th>
                                {% if is_admin %}<th>ê´€ë¦¬</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody id="accountsTableBody">
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split"></i> ë°ì´í„° ë¡œë”© ì¤‘...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ì¹´í˜ ê´€ë¦¬ íƒ­ -->
        <div class="tab-pane fade" id="cafes">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-cup-hot"></i> ì¹´í˜ ê´€ë¦¬</h4>
                    {% if is_admin %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCafeModal">
                        <i class="bi bi-plus-circle"></i> ì¹´í˜ ì¶”ê°€
                    </button>
                    {% endif %}
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ì¹´í˜ëª…</th>
                                <th>URL</th>
                                <th>ìƒíƒœ</th>
                                <th>ë“±ë¡ì¼</th>
                                {% if is_admin %}<th>ê´€ë¦¬</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody id="cafesTableBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split"></i> ë°ì´í„° ë¡œë”© ì¤‘...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ íƒ­ -->
        <div class="tab-pane fade" id="prompts">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-chat-square-text"></i> AI í”„ë¡¬í”„íŠ¸ ê´€ë¦¬</h4>
                    {% if is_admin %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPromptModal">
                        <i class="bi bi-plus-circle"></i> í”„ë¡¬í”„íŠ¸ ì¶”ê°€
                    </button>
                    {% endif %}
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ì´ë¦„</th>
                                <th>íƒ€ì…</th>
                                <th>Temperature</th>
                                <th>Max Tokens</th>
                                <th>ìƒíƒœ</th>
                                <th>ë“±ë¡ì¼</th>
                                {% if is_admin %}<th>ê´€ë¦¬</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody id="promptsTableBody">
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split"></i> ë°ì´í„° ë¡œë”© ì¤‘...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ìŠ¤ì¼€ì¤„ ê´€ë¦¬ íƒ­ -->
        <div class="tab-pane fade" id="schedules">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-calendar-week"></i> ìŠ¤ì¼€ì¤„ ê´€ë¦¬</h4>
                    {% if is_admin %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createScheduleModal">
                        <i class="bi bi-plus-circle"></i> ìŠ¤ì¼€ì¤„ ìƒì„±
                    </button>
                    {% endif %}
                </div>
                
                <div class="alert alert-success">
                    <i class="bi bi-lightbulb"></i> 
                    <strong>Tip:</strong> ìŠ¤ì¼€ì¤„ì„ ìƒì„±í•˜ë©´ ìë™ìœ¼ë¡œ ì‘ì—… íì— ì¶”ê°€ë©ë‹ˆë‹¤.
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ë‚ ì§œ</th>
                                <th>ëª¨ë“œ</th>
                                <th>ìƒí’ˆ</th>
                                <th>í‚¤ì›Œë“œ</th>
                                <th>í”„ë¡¬í”„íŠ¸</th>
                                <th>ìƒíƒœ</th>
                                <th>ì‘ì—…</th>
                                {% if is_admin %}<th>ê´€ë¦¬</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody id="schedulesTableBody">
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split"></i> ë°ì´í„° ë¡œë”© ì¤‘...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PC ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="addPCModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pc-display"></i> PC ì¶”ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="addPC(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">PC ë²ˆí˜¸ (1-8)</label>
                        <input type="number" class="form-control" name="pc_number" min="1" max="8" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">PC ì´ë¦„</label>
                        <input type="text" class="form-control" name="pc_name" placeholder="Worker PC #1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">IP ì£¼ì†Œ</label>
                        <input type="text" class="form-control" name="ip_address" placeholder="192.168.1.101" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ê³„ì • ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-person-plus"></i> ê³„ì • ì¶”ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="addAccount(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ê³„ì • ID</label>
                        <input type="text" class="form-control" name="account_id" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" class="form-control" name="account_pw" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">í• ë‹¹ PC</label>
                        <select class="form-select" name="assigned_pc_id">
                            <option value="">ë‚˜ì¤‘ì— í• ë‹¹</option>
                            <!-- JavaScriptë¡œ ë™ì  ë¡œë“œ -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ì¹´í˜ ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="addCafeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-cup-hot"></i> ì¹´í˜ ì¶”ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="addCafe(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ì¹´í˜ëª…</label>
                        <input type="text" class="form-control" name="cafe_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì¹´í˜ URL</label>
                        <input type="url" class="form-control" name="cafe_url" 
                               placeholder="https://cafe.naver.com/example" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ìŠ¤ì¼€ì¤„ ìƒì„± ëª¨ë‹¬ -->
<div class="modal fade" id="createScheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-calendar-plus"></i> ìŠ¤ì¼€ì¤„ ìë™ ìƒì„±</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="createSchedule(event)">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        <strong>ì•ˆë‚´:</strong> ì„¤ì •í•œ ê¸°ê°„ ë™ì•ˆ ìë™ìœ¼ë¡œ ìŠ¤ì¼€ì¤„ì„ ìƒì„±í•©ë‹ˆë‹¤. (ì£¼ë§ í¬í•¨)
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">ëª¨ë“œ ì„ íƒ</label>
                        <select class="form-select" name="mode" id="scheduleMode" required onchange="toggleModeFields()">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="human">íœ´ë¨¼ ëª¨ë“œ (ì‚¬ëŒì´ ì‘ì„±í•œ ê¸€)</option>
                            <option value="ai">AI ëª¨ë“œ (Claude ìë™ ìƒì„±)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">ìƒí’ˆ ì„ íƒ</label>
                        <select class="form-select" name="product_id" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <!-- JavaScriptë¡œ ë™ì  ë¡œë“œ -->
                        </select>
                    </div>
                    
                    <div class="mb-3" id="promptField" style="display: none;">
                        <label class="form-label">í”„ë¡¬í”„íŠ¸ ì„ íƒ (AI ëª¨ë“œ)</label>
                        <select class="form-select" name="prompt_id">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <!-- JavaScriptë¡œ ë™ì  ë¡œë“œ -->
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ì‹œì‘ì¼</label>
                            <input type="date" class="form-control" name="start_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ì¢…ë£Œì¼</label>
                            <input type="date" class="form-control" name="end_date" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">í•˜ë£¨ ì‘ì„± ê°œìˆ˜</label>
                        <input type="number" class="form-control" name="daily_count" 
                               value="3" min="1" max="10" required>
                        <small class="text-muted">í•˜ë£¨ì— ì‘ì„±í•  ê¸€ ê°œìˆ˜ (1~10ê°œ, ì£¼ë§ í¬í•¨)</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-calendar-check"></i> ìŠ¤ì¼€ì¤„ ìƒì„±
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- í”„ë¡¬í”„íŠ¸ ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="addPromptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-chat-square-text"></i> í”„ë¡¬í”„íŠ¸ ì¶”ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="addPrompt(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">í”„ë¡¬í”„íŠ¸ ì´ë¦„</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">íƒ€ì…</label>
                        <select class="form-select" name="prompt_type" required>
                            <option value="post">ê¸€ ì‘ì„±</option>
                            <option value="comment">ëŒ“ê¸€ ì‘ì„±</option>
                            <option value="reply">ëŒ€ëŒ“ê¸€ ì‘ì„±</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸</label>
                        <textarea class="form-control" name="system_prompt" rows="4" required
                                  placeholder="AIì˜ ì—­í• ê³¼ ì„±ê²©ì„ ì •ì˜í•˜ì„¸ìš”"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿</label>
                        <textarea class="form-control" name="user_prompt_template" rows="6" required
                                  placeholder="{product_name}, {keyword} ë³€ìˆ˜ ì‚¬ìš© ê°€ëŠ¥"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Temperature (0.0~1.0)</label>
                            <input type="number" class="form-control" name="temperature" 
                                   value="0.7" step="0.1" min="0" max="1" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Max Tokens</label>
                            <input type="number" class="form-control" name="max_tokens" 
                                   value="1000" min="100" max="4000" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
document.addEventListener('DOMContentLoaded', function() {
    loadAllData();
    
    // 30ì´ˆë§ˆë‹¤ PC ìƒíƒœ ê°±ì‹ 
    setInterval(loadPCs, 30000);
    
    // ëª¨ë‹¬ ì—´ë¦´ ë•Œ ë°ì´í„° ë¡œë“œ
    const addAccountModal = document.getElementById('addAccountModal');
    if (addAccountModal) {
        addAccountModal.addEventListener('show.bs.modal', function() {
            loadPCsForDropdown();
        });
    }
    
    const createScheduleModal = document.getElementById('createScheduleModal');
    if (createScheduleModal) {
        createScheduleModal.addEventListener('show.bs.modal', function() {
            loadProductsForSchedule();
            loadPromptsForSchedule();
        });
    }
});

// PC ë“œë¡­ë‹¤ìš´ ë¡œë“œ
async function loadPCsForDropdown() {
    try {
        const response = await fetch('/automation/api/pcs/list');
        const data = await response.json();
        
        if (data.success) {
            const select = document.querySelector('#addAccountModal select[name="assigned_pc_id"]');
            
            // ê¸°ì¡´ ì˜µì…˜ ìœ ì§€í•˜ê³  PC ì¶”ê°€
            let html = '<option value="">ë‚˜ì¤‘ì— í• ë‹¹</option>';
            
            data.pcs.forEach(pc => {
                html += `<option value="${pc.id}">PC #${pc.pc_number} - ${pc.pc_name} (${pc.status})</option>`;
            });
            
            select.innerHTML = html;
        }
    } catch (error) {
        console.error('PC ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

async function loadAllData() {
    await loadPCs();
    await loadAccounts();
    await loadCafes();
    await loadPrompts();
    await loadSchedules();
}

async function loadPCs() {
    try {
        const response = await fetch('/automation/api/pcs/list');
        const data = await response.json();
        
        if (data.success) {
            displayPCs(data.pcs);
        }
    } catch (error) {
        console.error('PC ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

function displayPCs(pcs) {
    const tbody = document.getElementById('pcsTableBody');
    
    if (pcs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-muted">
                    <div class="empty-state">
                        <i class="bi bi-pc-display"></i>
                        <p>ë“±ë¡ëœ PCê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        <p>Worker Agentë¥¼ ì‹¤í–‰í•˜ë©´ ìë™ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    const html = pcs.map(pc => `
        <tr>
            <td><strong>#${pc.pc_number}</strong></td>
            <td>${pc.pc_name}</td>
            <td><code>${pc.ip_address}</code></td>
            <td><span class="status-badge ${pc.status}">${pc.status}</span></td>
            <td>${pc.cpu_usage ? pc.cpu_usage.toFixed(1) + '%' : '-'}</td>
            <td>${pc.memory_usage ? pc.memory_usage.toFixed(1) + '%' : '-'}</td>
            <td>${pc.last_heartbeat || '-'}</td>
            <td>${pc.current_task_id ? 'Task #' + pc.current_task_id : '-'}</td>
            ${window.is_admin ? `
            <td>
                <button class="btn btn-sm btn-danger" onclick="deletePC(${pc.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
            ` : ''}
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
}

async function loadAccounts() {
    try {
        const response = await fetch('/automation/api/accounts/list');
        const data = await response.json();
        
        if (data.success) {
            displayAccounts(data.accounts);
        }
    } catch (error) {
        console.error('ê³„ì • ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

function displayAccounts(accounts) {
    const tbody = document.getElementById('accountsTableBody');
    
    if (accounts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted">
                    ë“±ë¡ëœ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤
                </td>
            </tr>
        `;
        return;
    }
    
    const html = accounts.map(acc => `
        <tr>
            <td><code>${acc.account_id}</code></td>
            <td>${acc.assigned_pc ? 'PC #' + acc.assigned_pc.pc_number : '-'}</td>
            <td><span class="status-badge ${acc.status}">${acc.status}</span></td>
            <td>${acc.login_status}</td>
            <td>${acc.total_posts}</td>
            <td>${acc.total_comments}</td>
            <td>${acc.last_used_at || '-'}</td>
            ${window.is_admin ? `
            <td>
                <button class="btn btn-sm btn-warning" onclick="editAccount(${acc.id})">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteAccount(${acc.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
            ` : ''}
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
}

async function loadCafes() {
    try {
        const response = await fetch('/automation/api/cafes/list');
        const data = await response.json();
        
        if (data.success) {
            displayCafes(data.cafes);
        }
    } catch (error) {
        console.error('ì¹´í˜ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

function displayCafes(cafes) {
    const tbody = document.getElementById('cafesTableBody');
    
    if (cafes.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">
                    ë“±ë¡ëœ ì¹´í˜ê°€ ì—†ìŠµë‹ˆë‹¤
                </td>
            </tr>
        `;
        return;
    }
    
    const html = cafes.map(cafe => `
        <tr>
            <td><strong>${cafe.name}</strong></td>
            <td><a href="${cafe.url}" target="_blank">${cafe.url}</a></td>
            <td><span class="status-badge ${cafe.status}">${cafe.status}</span></td>
            <td>${cafe.created_at}</td>
            ${window.is_admin ? `
            <td>
                <button class="btn btn-sm btn-danger" onclick="deleteCafe(${cafe.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
            ` : ''}
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
}

async function loadPrompts() {
    try {
        const response = await fetch('/automation/api/prompts/list');
        const data = await response.json();
        
        if (data.success) {
            displayPrompts(data.prompts);
        }
    } catch (error) {
        console.error('í”„ë¡¬í”„íŠ¸ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

function displayPrompts(prompts) {
    const tbody = document.getElementById('promptsTableBody');
    
    if (prompts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    ë“±ë¡ëœ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤
                </td>
            </tr>
        `;
        return;
    }
    
    const html = prompts.map(prompt => `
        <tr>
            <td><strong>${prompt.name}</strong></td>
            <td><span class="badge bg-primary">${prompt.prompt_type}</span></td>
            <td>${prompt.temperature}</td>
            <td>${prompt.max_tokens}</td>
            <td>${prompt.is_active ? 'ğŸŸ¢ í™œì„±' : 'ğŸ”´ ë¹„í™œì„±'}</td>
            <td>${prompt.created_at}</td>
            ${window.is_admin ? `
            <td>
                <button class="btn btn-sm btn-info" onclick="viewPrompt(${prompt.id})">
                    <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-sm btn-warning" onclick="editPrompt(${prompt.id})">
                    <i class="bi bi-pencil"></i>
                </button>
            </td>
            ` : ''}
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
}

// ê´€ë¦¬ì ê¶Œí•œ ì „ì—­ ë³€ìˆ˜
window.is_admin = {{ 'true' if is_admin else 'false' }};

// ===== ê´€ë¦¬ API í•¨ìˆ˜ë“¤ =====

async function addPC(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        const response = await fetch('/automation/api/pcs/register', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('âœ… PCê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
            bootstrap.Modal.getInstance(document.getElementById('addPCModal')).hide();
            loadPCs();
        } else {
            alert('âŒ ' + result.message);
        }
    } catch (error) {
        alert('âŒ PC ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        console.error(error);
    }
}

async function addAccount(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        const response = await fetch('/automation/api/accounts/add', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('âœ… ê³„ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
            bootstrap.Modal.getInstance(document.getElementById('addAccountModal')).hide();
            loadAccounts();
        } else {
            alert('âŒ ' + result.message);
        }
    } catch (error) {
        alert('âŒ ê³„ì • ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        console.error(error);
    }
}

async function addCafe(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        const response = await fetch('/automation/api/cafes/add', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('âœ… ì¹´í˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
            bootstrap.Modal.getInstance(document.getElementById('addCafeModal')).hide();
            loadCafes();
        } else {
            alert('âŒ ' + result.message);
        }
    } catch (error) {
        alert('âŒ ì¹´í˜ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        console.error(error);
    }
}

async function addPrompt(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        const response = await fetch('/automation/api/prompts/add', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('âœ… í”„ë¡¬í”„íŠ¸ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
            bootstrap.Modal.getInstance(document.getElementById('addPromptModal')).hide();
            loadPrompts();
        } else {
            alert('âŒ ' + result.message);
        }
    } catch (error) {
        alert('âŒ í”„ë¡¬í”„íŠ¸ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        console.error(error);
    }
}

async function deletePC(id) {
    if (!confirm('ì •ë§ ì´ PCë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const response = await fetch(`/automation/api/pcs/${id}/delete`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('âœ… PCê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            loadPCs();
        } else {
            alert('âŒ ' + result.message);
        }
    } catch (error) {
        alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
}

async function deleteAccount(id) {
    if (!confirm('ì •ë§ ì´ ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const response = await fetch(`/automation/api/accounts/${id}/delete`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('âœ… ê³„ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            loadAccounts();
        } else {
            alert('âŒ ' + result.message);
        }
    } catch (error) {
        alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
}

async function deleteCafe(id) {
    if (!confirm('ì •ë§ ì´ ì¹´í˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const response = await fetch(`/automation/api/cafes/${id}/delete`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('âœ… ì¹´í˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            loadCafes();
        } else {
            alert('âŒ ' + result.message);
        }
    } catch (error) {
        alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
}

function editAccount(id) {
    alert('ê³„ì • ìˆ˜ì • ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.\n\ní˜„ì¬ëŠ” ì‚­ì œ í›„ ë‹¤ì‹œ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
}

function editPrompt(id) {
    alert('í”„ë¡¬í”„íŠ¸ ìˆ˜ì • ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
}

function viewPrompt(id) {
    alert('í”„ë¡¬í”„íŠ¸ ë³´ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
}

// ===== ìŠ¤ì¼€ì¤„ ìƒì„± ê´€ë ¨ í•¨ìˆ˜ =====

async function loadProductsForSchedule() {
    try {
        const response = await fetch('/automation/api/products/list');
        const data = await response.json();
        
        if (data.success) {
            const select = document.querySelector('#createScheduleModal select[name="product_id"]');
            
            let html = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            
            data.products.forEach(product => {
                html += `<option value="${product.id}">${product.name}</option>`;
            });
            
            select.innerHTML = html;
        }
    } catch (error) {
        console.error('ìƒí’ˆ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

async function loadPromptsForSchedule() {
    try {
        const response = await fetch('/automation/api/prompts/list');
        const data = await response.json();
        
        if (data.success) {
            const select = document.querySelector('#createScheduleModal select[name="prompt_id"]');
            
            let html = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            
            data.prompts.filter(p => p.is_active && p.prompt_type === 'post').forEach(prompt => {
                html += `<option value="${prompt.id}">${prompt.name}</option>`;
            });
            
            select.innerHTML = html;
        }
    } catch (error) {
        console.error('í”„ë¡¬í”„íŠ¸ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

function toggleModeFields() {
    const mode = document.getElementById('scheduleMode').value;
    const promptField = document.getElementById('promptField');
    
    if (mode === 'ai') {
        promptField.style.display = 'block';
        promptField.querySelector('select').required = true;
    } else {
        promptField.style.display = 'none';
        promptField.querySelector('select').required = false;
    }
}

async function loadSchedules() {
    try {
        const response = await fetch('/automation/api/schedules/list');
        const data = await response.json();
        
        if (data.success) {
            displaySchedules(data.schedules);
        }
    } catch (error) {
        console.error('ìŠ¤ì¼€ì¤„ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

function displaySchedules(schedules) {
    const tbody = document.getElementById('schedulesTableBody');
    
    if (schedules.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted">
                    ë“±ë¡ëœ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤
                </td>
            </tr>
        `;
        return;
    }
    
    const html = schedules.map(schedule => `
        <tr>
            <td>${schedule.scheduled_date}</td>
            <td><span class="task-badge ${schedule.mode}">${schedule.mode === 'human' ? 'ğŸ‘¤ íœ´ë¨¼' : 'ğŸ¤– AI'}</span></td>
            <td>${schedule.product_name || '-'}</td>
            <td><span class="badge bg-primary">${schedule.keyword_text}</span></td>
            <td>${schedule.prompt_name || '-'}</td>
            <td><span class="status-badge ${schedule.status}">${schedule.status}</span></td>
            <td>${schedule.task_count || 0}ê°œ</td>
            ${window.is_admin ? `
            <td>
                <button class="btn btn-sm btn-danger" onclick="deleteSchedule(${schedule.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
            ` : ''}
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
}

async function createSchedule(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        const response = await fetch('/automation/api/schedules/create-auto', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('âœ… ìŠ¤ì¼€ì¤„ ' + result.count + 'ê°œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
            bootstrap.Modal.getInstance(document.getElementById('createScheduleModal')).hide();
            loadSchedules();  // ìŠ¤ì¼€ì¤„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } else {
            alert('âŒ ' + result.message);
        }
    } catch (error) {
        alert('âŒ ìŠ¤ì¼€ì¤„ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        console.error(error);
    }
}

async function deleteSchedule(id) {
    if (!confirm('ì •ë§ ì´ ìŠ¤ì¼€ì¤„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const response = await fetch(`/automation/api/schedules/${id}/delete`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('âœ… ìŠ¤ì¼€ì¤„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            loadSchedules();
        } else {
            alert('âŒ ' + result.message);
        }
    } catch (error) {
        alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
}
</script>
{% endblock %}

