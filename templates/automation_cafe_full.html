{% extends "base.html" %}
{% block title %}AI 자동화 - 카페 관리{% endblock %}

{% block head %}
{{ super() }}
<style>
    .automation-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* 탭 스타일 */
    .nav-tabs {
        border-bottom: 2px solid #e1e8ed;
        margin-bottom: 30px;
    }
    
    .nav-tabs .nav-link {
        border: none;
        color: #636e72;
        font-weight: 600;
        padding: 15px 30px;
        transition: all 0.3s;
        position: relative;
    }
    
    .nav-tabs .nav-link:hover {
        color: #4A90E2;
        background: rgba(74, 144, 226, 0.05);
    }
    
    .nav-tabs .nav-link.active {
        color: #4A90E2;
        background: transparent;
    }
    
    .nav-tabs .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 3px;
        background: #4A90E2;
    }
    
    /* 카드 스타일 */
    .content-card {
        background: white;
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        margin-bottom: 20px;
    }
    
    .card-header-custom {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e1e8ed;
    }
    
    .card-header-custom h4 {
        font-weight: 700;
        color: #2d3436;
        margin: 0;
    }
    
    /* 테이블 스타일 */
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .data-table thead th {
        background: linear-gradient(135deg, rgba(74, 144, 226, 0.1) 0%, rgba(91, 163, 245, 0.1) 100%);
        padding: 12px;
        text-align: left;
        font-weight: 700;
        color: #2d3436;
        font-size: 0.9rem;
        border-bottom: 2px solid #e1e8ed;
    }
    
    .data-table tbody tr {
        transition: all 0.2s;
        border-bottom: 1px solid #f1f3f5;
    }
    
    .data-table tbody tr:hover {
        background: rgba(74, 144, 226, 0.05);
    }
    
    .data-table tbody td {
        padding: 12px;
        color: #495057;
        font-size: 0.9rem;
    }
    
    /* 배지 스타일 */
    .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
    }
    
    .status-badge.online { background: #d4edda; color: #155724; }
    .status-badge.busy { background: #fff3cd; color: #856404; }
    .status-badge.offline { background: #f8d7da; color: #721c24; }
    .status-badge.active { background: #d4edda; color: #155724; }
    .status-badge.suspended { background: #f8d7da; color: #721c24; }
    
    /* 빈 상태 */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #adb5bd;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="automation-container">
    <h1 style="font-weight: 800; margin-bottom: 30px;">
        <i class="bi bi-robot"></i> 카페 자동화 관리
    </h1>
    
    <!-- 통합 탭 (휴먼 + AI) -->
    <ul class="nav nav-tabs" role="tablist">
        <!-- AI 자동화 메인 탭들 -->
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#ai-product-setup">
                <i class="bi bi-stars"></i> AI 상품 세팅
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#ai-prompt-templates">
                <i class="bi bi-file-text"></i> AI 템플릿
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#ai-prompts">
                <i class="bi bi-chat-dots"></i> AI 프롬프트
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#ai-schedules">
                <i class="bi bi-calendar-check"></i> AI 스케줄
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#ai-posts">
                <i class="bi bi-file-earmark-text"></i> AI 신규발행
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#ai-connections">
                <i class="bi bi-link-45deg"></i> AI 연동
            </a>
        </li>
        
        <!-- 공통 설정 탭들 (드롭다운 스타일) -->
        <li class="nav-item dropdown ms-auto">
            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button">
                <i class="bi bi-gear"></i> 설정
            </a>
            <ul class="dropdown-menu">
                <li><a class="nav-link" data-bs-toggle="tab" href="#dashboard">
                    <i class="bi bi-speedometer2"></i> 대시보드
                </a></li>
                <li><a class="nav-link" data-bs-toggle="tab" href="#pcs">
                    <i class="bi bi-pc-display"></i> PC 관리
                </a></li>
                <li><a class="nav-link" data-bs-toggle="tab" href="#accounts">
                    <i class="bi bi-person-badge"></i> 계정 관리
                </a></li>
                <li><a class="nav-link" data-bs-toggle="tab" href="#cafes">
                    <i class="bi bi-cup-hot"></i> 카페 관리
                </a></li>
                <li><a class="nav-link" data-bs-toggle="tab" href="#prompts">
                    <i class="bi bi-chat-square-text"></i> 프롬프트 (휴먼)
                </a></li>
                <li><a class="nav-link" data-bs-toggle="tab" href="#schedules">
                    <i class="bi bi-calendar-week"></i> 스케줄 (휴먼)
                </a></li>
            </ul>
        </li>
    </ul>
    
    <!-- 탭 컨텐츠 -->
    <div class="tab-content">
        <!-- 대시보드 탭 -->
        <div class="tab-pane fade" id="dashboard">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-speedometer2"></i> 실시간 대시보드</h4>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadTasks()">
                        <i class="bi bi-arrow-clockwise"></i> 새로고침
                    </button>
                </div>
                
                <!-- 작업 큐 탭 -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#pending-tasks">
                            <i class="bi bi-hourglass-split"></i> 대기 중
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#in-progress-tasks">
                            <i class="bi bi-arrow-repeat"></i> 진행 중
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#completed-tasks">
                            <i class="bi bi-check-circle"></i> 완료
                        </a>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- 대기 중 -->
                    <div class="tab-pane fade show active" id="pending-tasks">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>모드</th>
                                        <th>타입</th>
                                        <th>카페</th>
                                        <th>상품</th>
                                        <th>키워드</th>
                                        <th>상태</th>
                                        <th>PC</th>
                                        <th>계정</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingTasksBody">
                                    <tr><td colspan="9" class="text-center text-muted">로딩 중...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- 진행 중 -->
                    <div class="tab-pane fade" id="in-progress-tasks">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>모드</th>
                                        <th>카페</th>
                                        <th>PC</th>
                                        <th>계정</th>
                                        <th>시작 시간</th>
                                    </tr>
                                </thead>
                                <tbody id="inProgressTasksBody">
                                    <tr><td colspan="6" class="text-center text-muted">로딩 중...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- 완료 -->
                    <div class="tab-pane fade" id="completed-tasks">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>모드</th>
                                        <th>카페</th>
                                        <th>상품</th>
                                        <th>완료 시간</th>
                                        <th>URL</th>
                                    </tr>
                                </thead>
                                <tbody id="completedTasksBody">
                                    <tr><td colspan="6" class="text-center text-muted">로딩 중...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PC 관리 탭 -->
        <div class="tab-pane fade" id="pcs">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-pc-display"></i> PC 관리</h4>
                    {% if is_admin %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPCModal">
                        <i class="bi bi-plus-circle"></i> PC 추가
                    </button>
                    {% endif %}
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>PC 번호</th>
                                <th>PC 이름</th>
                                <th>IP 주소</th>
                                <th>상태</th>
                                <th>CPU</th>
                                <th>메모리</th>
                                <th>마지막 통신</th>
                                <th>현재 작업</th>
                                {% if is_admin %}<th>관리</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody id="pcsTableBody">
                            <tr>
                                <td colspan="9" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split"></i> 데이터 로딩 중...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 계정 관리 탭 -->
        <div class="tab-pane fade" id="accounts">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-person-badge"></i> 계정 관리</h4>
                    {% if is_admin %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                        <i class="bi bi-plus-circle"></i> 계정 추가
                    </button>
                    {% endif %}
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>계정 ID</th>
                                <th>할당 PC</th>
                                <th>상태</th>
                                <th>로그인 상태</th>
                                <th>작성 글</th>
                                <th>작성 댓글</th>
                                <th>마지막 사용</th>
                                {% if is_admin %}<th>관리</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody id="accountsTableBody">
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split"></i> 데이터 로딩 중...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 카페 관리 탭 -->
        <div class="tab-pane fade" id="cafes">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-cup-hot"></i> 카페 관리</h4>
                    {% if is_admin %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCafeModal">
                        <i class="bi bi-plus-circle"></i> 카페 추가
                    </button>
                    {% endif %}
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>카페명</th>
                                <th>URL</th>
                                <th style="width: 25%;">특성</th>
                                <th>상태</th>
                                <th>등록일</th>
                                {% if is_admin %}<th>관리</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody id="cafesTableBody">
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split"></i> 데이터 로딩 중...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 프롬프트 관리 탭 -->
        <div class="tab-pane fade" id="prompts">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-chat-square-text"></i> 휴먼 프롬프트 관리 (기존)</h4>
                    {% if is_admin %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addHumanPromptModal">
                        <i class="bi bi-plus-circle"></i> 프롬프트 추가
                    </button>
                    {% endif %}
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>이름</th>
                                <th>타입</th>
                                <th>Temperature</th>
                                <th>Max Tokens</th>
                                <th>상태</th>
                                <th>등록일</th>
                                {% if is_admin %}<th>관리</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody id="promptsTableBody">
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split"></i> 데이터 로딩 중...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 스케줄 관리 탭 -->
        <div class="tab-pane fade" id="schedules">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-calendar-week"></i> 스케줄 관리</h4>
                    {% if is_admin %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createScheduleModal">
                        <i class="bi bi-plus-circle"></i> 스케줄 생성
                    </button>
                    {% endif %}
                </div>
                
                <div class="alert alert-success">
                    <i class="bi bi-lightbulb"></i> 
                    <strong>Tip:</strong> 스케줄을 생성하면 자동으로 작업 큐에 추가됩니다.
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>날짜</th>
                                <th>모드</th>
                                <th>상품</th>
                                <th>키워드</th>
                                <th>프롬프트</th>
                                <th>상태</th>
                                <th>작업</th>
                                {% if is_admin %}<th>관리</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody id="schedulesTableBody">
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split"></i> 데이터 로딩 중...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ============================================ -->
        <!-- AI 자동화 탭들 -->
        <!-- ============================================ -->
        
        <!-- AI 상품 세팅 탭 -->
        <div class="tab-pane fade show active" id="ai-product-setup">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-stars"></i> AI 상품 세팅</h4>
                    <button class="btn btn-primary" onclick="showAddProductModal()">
                        <i class="bi bi-plus-circle"></i> 상품 추가
                    </button>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>안내:</strong> 마케팅 상품을 AI 자동화에 추가하고 상세 정보를 입력하세요.
                </div>
                
                <div id="aiProductList" class="row">
                    <!-- JavaScript로 로드 -->
                </div>
            </div>
        </div>
        
        <!-- AI 프롬프트 템플릿 탭 -->
        <div class="tab-pane fade" id="ai-prompt-templates">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-file-text"></i> AI 프롬프트 템플릿</h4>
                    <button class="btn btn-primary" onclick="showAddTemplateModal()">
                        <i class="bi bi-plus-circle"></i> 템플릿 추가
                    </button>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">분류 필터</label>
                    <select class="form-select" id="templateTypeFilter" style="max-width: 200px;" onchange="loadPromptTemplates()">
                        <option value="all">전체</option>
                        <option value="alternative">대안성</option>
                        <option value="informational">정보성</option>
                    </select>
                </div>
                
                <div id="promptTemplatesList">
                    <!-- JavaScript로 로드 -->
                </div>
            </div>
        </div>
        
        <!-- AI 프롬프트 관리 탭 -->
        <div class="tab-pane fade" id="ai-prompts">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-chat-dots"></i> AI 프롬프트 관리</h4>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="showTestGenerationModal()">
                            <i class="bi bi-magic"></i> AI 글 생성 테스트
                        </button>
                        <button class="btn btn-primary" onclick="showAddPromptModal()">
                            <i class="bi bi-plus-circle"></i> 프롬프트 추가
                        </button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-4">
                            <select class="form-select" id="promptProductFilter" onchange="loadPrompts()">
                                <option value="">전체 상품</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="promptTypeFilter" onchange="loadPrompts()">
                                <option value="all">전체 분류</option>
                                <option value="alternative">대안성</option>
                                <option value="informational">정보성</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="promptsList">
                    <!-- JavaScript로 로드 -->
                </div>
            </div>
        </div>
        
        <!-- AI 스케줄 관리 탭 -->
        <div class="tab-pane fade" id="ai-schedules">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-calendar-check"></i> AI 스케줄 관리</h4>
                    <button class="btn btn-primary" onclick="showAddScheduleModal()">
                        <i class="bi bi-plus-circle"></i> 스케줄 생성
                    </button>
                </div>
                
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="scheduleProductSearch" 
                                   placeholder="상품명 검색..." onkeyup="searchSchedules()">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="scheduleStatusFilter" onchange="searchSchedules()">
                                <option value="all">전체 상태</option>
                                <option value="scheduled">진행예정</option>
                                <option value="in_progress">진행중</option>
                                <option value="completed">종료</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="schedulesList">
                    <!-- JavaScript로 로드 -->
                </div>
                
                <div id="schedulePagination" class="mt-3">
                    <!-- 페이지네이션 -->
                </div>
            </div>
        </div>
        
        <!-- AI 신규 발행 관리 탭 -->
        <div class="tab-pane fade" id="ai-posts">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-file-earmark-text"></i> AI 신규 발행 관리</h4>
                </div>
                
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-4">
                            <select class="form-select" id="postAccountFilter" onchange="loadGeneratedPosts()">
                                <option value="">전체 계정</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="postCafeFilter" onchange="loadGeneratedPosts()">
                                <option value="">전체 카페</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="generatedPostsList">
                    <!-- JavaScript로 로드 -->
                </div>
            </div>
        </div>
        
        <!-- AI 연동 관리 탭 -->
        <div class="tab-pane fade" id="ai-connections">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-link-45deg"></i> AI 연동 관리</h4>
                    <button class="btn btn-primary" onclick="showAddConnectionModal()">
                        <i class="bi bi-plus-circle"></i> 연동 추가
                    </button>
                </div>
                
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>주의:</strong> AI 자동화 전용 연동입니다. 휴먼 모드 계정/카페와는 별개로 관리됩니다.
                </div>
                
                <!-- 필터 -->
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">카페 필터</label>
                            <select class="form-select" id="connectionCafeFilter" onchange="loadConnections()">
                                <option value="">전체 카페</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">계정 필터</label>
                            <select class="form-select" id="connectionAccountFilter" onchange="loadConnections()">
                                <option value="">전체 계정</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="connectionsList">
                    <!-- JavaScript로 로드 -->
                </div>
            </div>
        </div>
        
    </div>
</div>

<!-- PC 추가 모달 -->
<div class="modal fade" id="addPCModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pc-display"></i> PC 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="addPC(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">PC 번호 (1-8)</label>
                        <input type="number" class="form-control" name="pc_number" min="1" max="8" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">PC 이름</label>
                        <input type="text" class="form-control" name="pc_name" placeholder="Worker PC #1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">IP 주소</label>
                        <input type="text" class="form-control" name="ip_address" placeholder="192.168.1.101" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">등록</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 계정 추가 모달 -->
<div class="modal fade" id="addAccountModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-person-plus"></i> 계정 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form onsubmit="addAccount(event)" id="addAccountForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">계정 ID</label>
                        <input type="text" class="form-control" name="account_id" id="accountIdInput" required autocomplete="off">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">비밀번호</label>
                        <input type="password" class="form-control" name="account_pw" id="accountPwInput" required autocomplete="new-password">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">할당 PC</label>
                        <select class="form-select" name="assigned_pc_id" id="accountPcSelect">
                            <option value="">나중에 할당</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> 등록
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 계정 수정 모달 -->
<div class="modal fade" id="editAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> 계정 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="event.preventDefault(); updateAccount();">
                <input type="hidden" id="editAccountId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">계정 ID</label>
                        <input type="text" class="form-control" id="editAccountIdInput" readonly>
                        <small class="text-muted">계정 ID는 변경할 수 없습니다.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">비밀번호 (변경 시만 입력)</label>
                        <input type="password" class="form-control" id="editAccountPw" autocomplete="new-password">
                        <small class="text-muted">비워두면 변경하지 않습니다.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">할당 PC</label>
                        <select class="form-select" id="editAccountPc">
                            <option value="">나중에 할당</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">상태</label>
                        <select class="form-select" id="editAccountStatus">
                            <option value="active">활성</option>
                            <option value="suspended">정지</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 카페 추가 모달 -->
<div class="modal fade" id="addCafeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-cup-hot"></i> 카페 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="addCafe(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">카페명 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="cafe_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">카페 URL <span class="text-danger">*</span></label>
                        <input type="url" class="form-control" name="cafe_url" 
                               placeholder="https://cafe.naver.com/example" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">카페 특성</label>
                        <textarea class="form-control" name="characteristics" rows="3"
                                  placeholder="예: 주부 중심, 친근한 말투, 육아/생활 팁 선호"></textarea>
                        <small class="text-muted">AI가 이 특성에 맞춰 글을 작성합니다.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">등록</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 카페 수정 모달 -->
<div class="modal fade" id="editCafeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> 카페 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="event.preventDefault(); updateCafe();">
                <input type="hidden" id="editCafeId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">카페명 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editCafeName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">카페 URL <span class="text-danger">*</span></label>
                        <input type="url" class="form-control" id="editCafeUrl" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">카페 특성</label>
                        <textarea class="form-control" id="editCafeCharacteristics" rows="3"
                                  placeholder="예: 주부 중심, 친근한 말투, 육아/생활 팁 선호"></textarea>
                        <small class="text-muted">AI가 이 특성에 맞춰 글을 작성합니다.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">상태</label>
                        <select class="form-select" id="editCafeStatus">
                            <option value="active">활성</option>
                            <option value="inactive">비활성</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 스케줄 생성 모달 -->
<div class="modal fade" id="createScheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-calendar-plus"></i> 스케줄 자동 생성</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="createSchedule(event)">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        <strong>안내:</strong> 설정한 기간 동안 자동으로 스케줄을 생성합니다. (주말 포함)
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">모드 선택</label>
                        <select class="form-select" name="mode" id="scheduleMode" required onchange="toggleModeFields()">
                            <option value="">선택하세요</option>
                            <option value="human">휴먼 모드 (사람이 작성한 글)</option>
                            <option value="ai">AI 모드 (Claude 자동 생성)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">상품 선택</label>
                        <select class="form-select" name="product_id" required>
                            <option value="">선택하세요</option>
                            <!-- JavaScript로 동적 로드 -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">카페 선택</label>
                        <select class="form-select" name="cafe_id" required>
                            <option value="">선택하세요</option>
                            <!-- JavaScript로 동적 로드 -->
                        </select>
                    </div>
                    
                    <div class="mb-3" id="promptField" style="display: none;">
                        <label class="form-label">프롬프트 선택 (AI 모드)</label>
                        <select class="form-select" name="prompt_id">
                            <option value="">선택하세요</option>
                            <!-- JavaScript로 동적 로드 -->
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">시작일</label>
                            <input type="date" class="form-control" name="start_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">종료일</label>
                            <input type="date" class="form-control" name="end_date" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">하루 작성 개수</label>
                        <input type="number" class="form-control" name="daily_count" 
                               value="3" min="1" max="10" required>
                        <small class="text-muted">하루에 작성할 글 개수 (1~10개, 주말 포함)</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-calendar-check"></i> 스케줄 생성
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 휴먼 프롬프트 추가 모달 -->
<div class="modal fade" id="addHumanPromptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-chat-square-text"></i> 휴먼 프롬프트 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="addPrompt(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">프롬프트 이름</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">타입</label>
                        <select class="form-select" name="prompt_type" required>
                            <option value="post">글 작성</option>
                            <option value="comment">댓글 작성</option>
                            <option value="reply">대댓글 작성</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">시스템 프롬프트</label>
                        <textarea class="form-control" name="system_prompt" rows="4" required
                                  placeholder="AI의 역할과 성격을 정의하세요"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">사용자 프롬프트 템플릿</label>
                        <textarea class="form-control" name="user_prompt_template" rows="6" required
                                  placeholder="{product_name}, {keyword} 변수 사용 가능"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Temperature (0.0~1.0)</label>
                            <input type="number" class="form-control" name="temperature" 
                                   value="0.7" step="0.1" min="0" max="1" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Max Tokens</label>
                            <input type="number" class="form-control" name="max_tokens" 
                                   value="1000" min="100" max="4000" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">등록</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 댓글 원고 관리 모달 -->
<div class="modal fade" id="commentScriptModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-chat-dots"></i> 댓글 원고 관리</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form onsubmit="saveCommentScript(event)">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-lightbulb"></i> 
                        <strong>댓글 원고 형식:</strong><br>
                        <code>그룹-순서: PC번호 "내용"</code><br><br>
                        <strong>예시:</strong><br>
                        <code>1-1: PC1 도와주세요ㅠㅜㅠㅠㅠ</code><br>
                        <code>1-2: PC2 저도 궁금하네요</code><br>
                        <code>1-3: PC1 오 대박...</code><br><br>
                        <code>2-1: PC3 다들 고민이... (새 댓글)</code><br>
                        <code>2-2: PC1 와 헐 대박... (2-1에 대한 대댓글)</code><br>
                    </div>
                    
                    <div id="scriptStats"></div>
                    
                    <input type="hidden" name="post_task_id" id="postTaskIdInput">
                    
                    <div class="mb-3">
                        <label class="form-label">댓글 원고 입력</label>
                        <textarea class="form-control" name="script_text" id="commentScriptText" 
                                  rows="15" required
                                  placeholder="1-1: PC1 도와주세요ㅠㅜㅠㅠㅠ
1-2: PC2 저도 궁금하네요
1-3: PC1 오 대박...

2-1: PC3 다들 고민이...
2-2: PC1 와 헐 대박..."
                                  style="font-family: monospace;"></textarea>
                        <small class="text-muted">
                            그룹 번호가 바뀌면 새 댓글, 같은 그룹은 대댓글입니다.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> 저장
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// ============================================
// 설정 모달 함수
// ============================================
function showSettings(tab) {
    const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
    modal.show();
    
    // 해당 탭 활성화
    const tabLinks = {
        'dashboard': '#settings-dashboard',
        'pcs': '#settings-pcs',
        'accounts': '#settings-accounts',
        'cafes': '#settings-cafes'
    };
    
    // 모든 탭 비활성화
    document.querySelectorAll('#settingsModal .nav-link').forEach(link => {
        link.classList.remove('active');
    });
    document.querySelectorAll('#settingsModal .tab-pane').forEach(pane => {
        pane.classList.remove('show', 'active');
    });
    
    // 선택한 탭 활성화
    const targetTab = tabLinks[tab];
    document.querySelector(`#settingsModal a[href="${targetTab}"]`)?.classList.add('active');
    document.querySelector(targetTab)?.classList.add('show', 'active');
}

// 페이지 로드 시 데이터 로드
document.addEventListener('DOMContentLoaded', function() {
    // AI 페이지에서는 휴먼 탭 제거했으므로 loadAllData 수정 필요
    // loadAllData();
    
    // 30초마다 PC 상태 갱신
    setInterval(loadPCs, 30000);
    
    // 모달 열릴 때 데이터 로드 및 초기화
    const addAccountModal = document.getElementById('addAccountModal');
    if (addAccountModal) {
        addAccountModal.addEventListener('show.bs.modal', function() {
            // 폼 리셋
            const form = document.getElementById('addAccountForm');
            if (form) form.reset();
            
            // PC 목록 로드
            loadPCsForDropdown();
        });
        
        // 모달 닫힐 때 폼 리셋
        addAccountModal.addEventListener('hidden.bs.modal', function() {
            const form = document.getElementById('addAccountForm');
            if (form) form.reset();
        });
    }
    
    const createScheduleModal = document.getElementById('createScheduleModal');
    if (createScheduleModal) {
        createScheduleModal.addEventListener('show.bs.modal', function() {
            loadProductsForSchedule();
            loadPromptsForSchedule();
            loadCafesForSchedule();
        });
    }
});

// PC 드롭다운 로드
async function loadPCsForDropdown() {
    try {
        const response = await fetch('/automation/api/pcs/list');
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('accountPcSelect');
            
            if (!select) {
                console.error('accountPcSelect 요소를 찾을 수 없습니다');
                return;
            }
            
            // 기존 옵션 유지하고 PC 추가
            let html = '<option value="">나중에 할당</option>';
            
            data.pcs.forEach(pc => {
                const statusIcon = pc.status === 'online' ? '🟢' : '🔴';
                html += `<option value="${pc.id}">${statusIcon} PC #${pc.pc_number} - ${pc.pc_name}</option>`;
            });
            
            select.innerHTML = html;
            console.log('✅ PC 목록 로드 완료:', data.pcs.length);
        }
    } catch (error) {
        console.error('PC 목록 로드 오류:', error);
    }
}

async function loadAllData() {
    await loadPCs();
    await loadAccounts();
    await loadCafes();
    await loadPrompts();
    await loadSchedules();
    await loadTasks();
}

async function loadTasks() {
    await loadTasksByStatus('pending', 'pendingTasksBody');
    await loadTasksByStatus('in_progress', 'inProgressTasksBody');
    await loadTasksByStatus('completed', 'completedTasksBody');
}

async function loadTasksByStatus(status, tbodyId) {
    try {
        const response = await fetch(`/automation/api/tasks/list?status=${status}`);
        const data = await response.json();
        
        if (data.success) {
            displayTasks(data.tasks, tbodyId, status);
        }
    } catch (error) {
        console.error(`Task 로드 오류 (${status}):`, error);
    }
}

function displayTasks(tasks, tbodyId, status) {
    const tbody = document.getElementById(tbodyId);
    
    if (tasks.length === 0) {
        const colSpan = status === 'completed' ? 6 : status === 'in_progress' ? 6 : 9;
        tbody.innerHTML = `
            <tr>
                <td colspan="${colSpan}" class="text-center text-muted">
                    ${status === 'pending' ? '대기 중인' : status === 'in_progress' ? '진행 중인' : '완료된'} 작업이 없습니다
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    
    tasks.forEach(task => {
        const modeIcon = task.mode === 'human' ? '👤' : '🤖';
        const typeIcon = task.task_type === 'post' ? '📝' : '💬';
        
        if (status === 'pending') {
            const commentBtn = task.task_type === 'post' ? 
                `<button class="btn btn-sm btn-info" onclick="showCommentScriptModal(${task.id})" title="댓글 원고 관리">
                    <i class="bi bi-chat-dots"></i>
                </button>` : '';
            
            html += `
                <tr>
                    <td><strong>#${task.id}</strong></td>
                    <td><span class="task-badge ${task.mode}">${modeIcon} ${task.mode}</span></td>
                    <td>${typeIcon} ${task.task_type}</td>
                    <td>${task.cafe_name || '-'}</td>
                    <td>${task.product_name || '-'}</td>
                    <td><span class="badge bg-primary">${task.keyword_text || '-'}</span></td>
                    <td><span class="status-badge ${task.status}">${task.status}</span></td>
                    <td>${task.assigned_pc ? 'PC #' + task.assigned_pc : '-'}</td>
                    <td>${task.assigned_account || '-'} ${commentBtn}</td>
                </tr>
            `;
        } else if (status === 'in_progress') {
            html += `
                <tr>
                    <td><strong>#${task.id}</strong></td>
                    <td><span class="task-badge ${task.mode}">${modeIcon}</span></td>
                    <td>${task.cafe_name || '-'}</td>
                    <td>PC #${task.assigned_pc || '-'}</td>
                    <td>${task.assigned_account || '-'}</td>
                    <td>${task.started_at || '-'}</td>
                </tr>
            `;
        } else if (status === 'completed') {
            const commentBtn = task.task_type === 'post' && task.post_url ? 
                `<button class="btn btn-sm btn-success" onclick="createCommentTasks(${task.id})" title="댓글 Task 생성">
                    <i class="bi bi-plus-circle"></i> 댓글
                </button>` : '';
            
            html += `
                <tr>
                    <td><strong>#${task.id}</strong></td>
                    <td><span class="task-badge ${task.mode}">${modeIcon}</span></td>
                    <td>${task.cafe_name || '-'}</td>
                    <td>${task.product_name || '-'}</td>
                    <td>${task.completed_at || '-'}</td>
                    <td>
                        ${task.post_url ? `<a href="${task.post_url}" target="_blank">보기</a>` : '-'}
                        ${commentBtn}
                    </td>
                </tr>
            `;
        }
    });
    
    tbody.innerHTML = html;
}

async function loadPCs() {
    try {
        const response = await fetch('/automation/api/pcs/list');
        const data = await response.json();
        
        if (data.success) {
            displayPCs(data.pcs);
        }
    } catch (error) {
        console.error('PC 데이터 로드 오류:', error);
    }
}

function displayPCs(pcs) {
    const tbody = document.getElementById('pcsTableBody');
    
    if (pcs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-muted">
                    <div class="empty-state">
                        <i class="bi bi-pc-display"></i>
                        <p>등록된 PC가 없습니다</p>
                        <p>Worker Agent를 실행하면 자동으로 등록됩니다</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    const html = pcs.map(pc => `
        <tr>
            <td><strong>#${pc.pc_number}</strong></td>
            <td>${pc.pc_name}</td>
            <td><code>${pc.ip_address}</code></td>
            <td><span class="status-badge ${pc.status}">${pc.status}</span></td>
            <td>${pc.cpu_usage ? pc.cpu_usage.toFixed(1) + '%' : '-'}</td>
            <td>${pc.memory_usage ? pc.memory_usage.toFixed(1) + '%' : '-'}</td>
            <td>${pc.last_heartbeat || '-'}</td>
            <td>${pc.current_task_id ? 'Task #' + pc.current_task_id : '-'}</td>
            ${window.is_admin ? `
            <td>
                <button class="btn btn-sm btn-danger" onclick="deletePC(${pc.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
            ` : ''}
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
}

async function loadAccounts() {
    try {
        const response = await fetch('/automation/api/accounts/list');
        const data = await response.json();
        
        if (data.success) {
            displayAccounts(data.accounts);
        }
    } catch (error) {
        console.error('계정 데이터 로드 오류:', error);
    }
}

function displayAccounts(accounts) {
    const tbody = document.getElementById('accountsTableBody');
    
    if (accounts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted">
                    등록된 계정이 없습니다
                </td>
            </tr>
        `;
        return;
    }
    
    const html = accounts.map(acc => `
        <tr>
            <td><code>${acc.account_id}</code></td>
            <td>${acc.assigned_pc ? 'PC #' + acc.assigned_pc.pc_number : '-'}</td>
            <td><span class="status-badge ${acc.status}">${acc.status}</span></td>
            <td>${acc.login_status}</td>
            <td>${acc.total_posts}</td>
            <td>${acc.total_comments}</td>
            <td>${acc.last_used_at || '-'}</td>
            ${window.is_admin ? `
            <td>
                <button class="btn btn-sm btn-warning" onclick="editAccount(${acc.id})">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteAccount(${acc.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
            ` : ''}
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
}

async function loadCafes() {
    try {
        const response = await fetch('/automation/api/cafes/list');
        const data = await response.json();
        
        if (data.success) {
            displayCafes(data.cafes);
        }
    } catch (error) {
        console.error('카페 데이터 로드 오류:', error);
    }
}

async function loadHumanPrompts() {
    try {
        const response = await fetch('/automation/api/prompts/list');
        const data = await response.json();
        
        if (data.success) {
            displayHumanPrompts(data.prompts);
        }
    } catch (error) {
        console.error('휴먼 프롬프트 로드 오류:', error);
    }
}

function displayHumanPrompts(prompts) {
    const tbody = document.getElementById('promptsTableBody');
    
    if (!tbody) return;
    
    if (prompts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">등록된 프롬프트가 없습니다</td></tr>';
        return;
    }
    
    tbody.innerHTML = prompts.map(p => `
        <tr>
            <td>${p.name}</td>
            <td><span class="badge bg-info">${p.prompt_type}</span></td>
            <td>${p.temperature}</td>
            <td>${p.max_tokens}</td>
            <td><span class="badge ${p.is_active ? 'bg-success' : 'bg-secondary'}">${p.is_active ? '활성' : '비활성'}</span></td>
            <td>
                <button class="btn btn-sm btn-warning" onclick="editHumanPrompt(${p.id})"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-danger" onclick="deleteHumanPrompt(${p.id})"><i class="bi bi-trash"></i></button>
            </td>
        </tr>
    `).join('');
}

async function loadHumanSchedules() {
    // 휴먼 스케줄 로드 (추후 구현)
    console.log('휴먼 스케줄 로드');
}

function displayCafes(cafes) {
    const tbody = document.getElementById('cafesTableBody');
    
    if (cafes.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted">
                    등록된 카페가 없습니다
                </td>
            </tr>
        `;
        return;
    }
    
    const html = cafes.map(cafe => `
        <tr>
            <td><strong>${cafe.name}</strong></td>
            <td><a href="${cafe.url}" target="_blank" class="small">${cafe.url.substring(0, 40)}...</a></td>
            <td><small class="text-muted">${cafe.characteristics || '-'}</small></td>
            <td><span class="status-badge ${cafe.status}">${cafe.status}</span></td>
            <td>${cafe.created_at}</td>
            ${window.is_admin ? `
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-warning" onclick="editCafe(${cafe.id})" title="수정">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-danger" onclick="deleteCafe(${cafe.id})" title="삭제">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
            ` : ''}
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
}

async function loadPrompts() {
    try {
        const response = await fetch('/automation/api/prompts/list');
        const data = await response.json();
        
        if (data.success) {
            displayPrompts(data.prompts);
        }
    } catch (error) {
        console.error('프롬프트 데이터 로드 오류:', error);
    }
}

function displayPrompts(prompts) {
    const tbody = document.getElementById('promptsTableBody');
    
    if (prompts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    등록된 프롬프트가 없습니다
                </td>
            </tr>
        `;
        return;
    }
    
    const html = prompts.map(prompt => `
        <tr>
            <td><strong>${prompt.name}</strong></td>
            <td><span class="badge bg-primary">${prompt.prompt_type}</span></td>
            <td>${prompt.temperature}</td>
            <td>${prompt.max_tokens}</td>
            <td>${prompt.is_active ? '🟢 활성' : '🔴 비활성'}</td>
            <td>${prompt.created_at}</td>
            ${window.is_admin ? `
            <td>
                <button class="btn btn-sm btn-info" onclick="viewPrompt(${prompt.id})">
                    <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-sm btn-warning" onclick="editPrompt(${prompt.id})">
                    <i class="bi bi-pencil"></i>
                </button>
            </td>
            ` : ''}
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
}

// 관리자 권한 전역 변수
window.is_admin = {{ 'true' if is_admin else 'false' }};

// ===== 공통 유틸리티 함수 =====

function closeModalCompletely(modalId) {
    // 모달 완전히 닫기
    const modalElement = document.getElementById(modalId);
    if (!modalElement) return;
    
    // Bootstrap 모달 인스턴스 닫기
    const modal = bootstrap.Modal.getInstance(modalElement);
    if (modal) {
        modal.hide();
    }
    
    // 강제 정리
    modalElement.classList.remove('show');
    modalElement.style.display = 'none';
    modalElement.setAttribute('aria-hidden', 'true');
    modalElement.removeAttribute('aria-modal');
    
    // backdrop 제거
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(backdrop => backdrop.remove());
    
    // body 클래스 정리
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
}

// ===== 관리 API 함수들 =====

async function addPC(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        const response = await fetch('/automation/api/pcs/register', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('✅ PC가 등록되었습니다!');
            bootstrap.Modal.getInstance(document.getElementById('addPCModal')).hide();
            loadPCs();
        } else {
            alert('❌ ' + result.message);
        }
    } catch (error) {
        alert('❌ PC 추가 중 오류가 발생했습니다');
        console.error(error);
    }
}

async function addAccount(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    // 로딩 표시
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 등록 중...';
    
    try {
        const response = await fetch('/automation/api/accounts/add', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        // 버튼 복원
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        
        if (result.success) {
            // 모달 닫기
            closeModalCompletely('addAccountModal');
            
            // 폼 리셋
            form.reset();
            
            // 목록 새로고침
            loadAccounts();
            
            // 성공 메시지
            alert('✅ 계정이 등록되었습니다!');
        } else {
            alert('❌ ' + result.message);
        }
    } catch (error) {
        // 버튼 복원
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        
        alert('❌ 계정 추가 중 오류가 발생했습니다');
        console.error('계정 추가 오류:', error);
    }
}

async function addCafe(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    try {
        const response = await fetch('/automation/api/cafes/add', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // 모달 닫기
            closeModalCompletely('addCafeModal');
            
            form.reset();
            loadCafes();
            
            alert('✅ 카페가 등록되었습니다!');
        } else {
            alert('❌ ' + result.message);
        }
    } catch (error) {
        alert('❌ 카페 추가 중 오류가 발생했습니다');
        console.error(error);
    }
}

async function addPrompt(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    try {
        const response = await fetch('/automation/api/prompts/add', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // 모달 강제 닫기
            closeModalCompletely('addPromptModal');
            
            form.reset();
            loadPrompts();
            
            alert('✅ 프롬프트가 등록되었습니다!');
        } else {
            alert('❌ ' + result.message);
        }
    } catch (error) {
        alert('❌ 프롬프트 추가 중 오류가 발생했습니다');
        console.error(error);
    }
}

async function deletePC(id) {
    if (!confirm('정말 이 PC를 삭제하시겠습니까?')) return;
    
    try {
        const response = await fetch(`/automation/api/pcs/${id}/delete`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('✅ PC가 삭제되었습니다');
            loadPCs();
        } else {
            alert('❌ ' + result.message);
        }
    } catch (error) {
        alert('❌ 삭제 중 오류가 발생했습니다');
    }
}

async function deleteAccount(id) {
    if (!confirm('정말 이 계정을 삭제하시겠습니까?')) return;
    
    try {
        const response = await fetch(`/automation/api/accounts/${id}/delete`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('✅ 계정이 삭제되었습니다');
            loadAccounts();
        } else {
            alert('❌ ' + result.message);
        }
    } catch (error) {
        alert('❌ 삭제 중 오류가 발생했습니다');
    }
}

async function editCafe(id) {
    try {
        // 카페 정보 가져오기
        const response = await fetch('/automation/api/cafes/list');
        const data = await response.json();
        
        if (data.success) {
            const cafe = data.cafes.find(c => c.id === id);
            
            if (!cafe) {
                alert('카페 정보를 찾을 수 없습니다.');
                return;
            }
            
            // 폼 채우기
            document.getElementById('editCafeId').value = id;
            document.getElementById('editCafeName').value = cafe.name;
            document.getElementById('editCafeUrl').value = cafe.url;
            document.getElementById('editCafeCharacteristics').value = cafe.characteristics || '';
            document.getElementById('editCafeStatus').value = cafe.status;
            
            // 모달 열기
            const modal = new bootstrap.Modal(document.getElementById('editCafeModal'));
            modal.show();
        }
    } catch (error) {
        console.error('카페 정보 로드 오류:', error);
        alert('오류가 발생했습니다.');
    }
}

async function updateCafe() {
    const id = document.getElementById('editCafeId').value;
    const name = document.getElementById('editCafeName').value;
    const url = document.getElementById('editCafeUrl').value;
    const characteristics = document.getElementById('editCafeCharacteristics').value;
    const status = document.getElementById('editCafeStatus').value;
    
    try {
        const formData = new FormData();
        formData.append('cafe_name', name);
        formData.append('cafe_url', url);
        formData.append('characteristics', characteristics);
        formData.append('status', status);
        
        const response = await fetch(`/automation/api/cafes/update/${id}`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            alert('카페가 수정되었습니다.');
            bootstrap.Modal.getInstance(document.getElementById('editCafeModal')).hide();
            loadCafes();
        } else {
            alert('오류: ' + data.message);
        }
    } catch (error) {
        alert('수정 중 오류가 발생했습니다.');
    }
}

async function deleteCafe(id) {
    if (!confirm('정말 이 카페를 삭제하시겠습니까?')) return;
    
    try {
        const response = await fetch(`/automation/api/cafes/${id}/delete`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('✅ 카페가 삭제되었습니다');
            loadCafes();
        } else {
            alert('❌ ' + result.message);
        }
    } catch (error) {
        alert('❌ 삭제 중 오류가 발생했습니다');
    }
}

async function editAccount(id) {
    try {
        // 계정 정보 가져오기
        const response = await fetch('/automation/api/accounts/list');
        const data = await response.json();
        
        if (data.success) {
            const account = data.accounts.find(acc => acc.id === id);
            
            if (!account) {
                alert('계정 정보를 찾을 수 없습니다.');
                return;
            }
            
            // 폼 채우기
            document.getElementById('editAccountId').value = id;
            document.getElementById('editAccountIdInput').value = account.account_id;
            document.getElementById('editAccountPw').value = '';  // 비밀번호는 비워둠
            document.getElementById('editAccountStatus').value = account.status;
            
            // PC 목록 로드
            await loadPCsForEdit();
            
            // 현재 할당된 PC 선택
            if (account.assigned_pc && account.assigned_pc.id) {
                document.getElementById('editAccountPc').value = account.assigned_pc.id;
            }
            
            // 모달 열기
            const modal = new bootstrap.Modal(document.getElementById('editAccountModal'));
            modal.show();
        }
    } catch (error) {
        console.error('계정 정보 로드 오류:', error);
        alert('오류가 발생했습니다.');
    }
}

async function loadPCsForEdit() {
    const response = await fetch('/automation/api/pcs/list');
    const data = await response.json();
    
    if (data.success) {
        const select = document.getElementById('editAccountPc');
        select.innerHTML = '<option value="">나중에 할당</option>';
        
        data.pcs.forEach(pc => {
            const option = document.createElement('option');
            option.value = pc.id;
            option.textContent = `PC #${pc.pc_number} - ${pc.pc_name}`;
            select.appendChild(option);
        });
    }
}

async function updateAccount() {
    const id = document.getElementById('editAccountId').value;
    const password = document.getElementById('editAccountPw').value;
    const pcId = document.getElementById('editAccountPc').value;
    const status = document.getElementById('editAccountStatus').value;
    
    try {
        const formData = new FormData();
        if (password) formData.append('account_pw', password);
        if (pcId) formData.append('assigned_pc_id', pcId);
        formData.append('status', status);
        
        const response = await fetch(`/automation/api/accounts/update/${id}`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            alert('계정이 수정되었습니다.');
            bootstrap.Modal.getInstance(document.getElementById('editAccountModal')).hide();
            loadAccounts();
        } else {
            alert('오류: ' + data.message);
        }
    } catch (error) {
        alert('수정 중 오류가 발생했습니다.');
    }
}

// 프롬프트 보기
async function viewPrompt(id) {
    try {
        const response = await fetch(`/automation/api/prompts/list`);
        const data = await response.json();
        
        if (data.success) {
            const prompt = data.prompts.find(p => p.id === id);
            
            if (!prompt) {
                alert('프롬프트를 찾을 수 없습니다');
                return;
            }
            
            // 임시 모달 생성
            const modalHtml = `
                <div class="modal fade" id="viewPromptModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="bi bi-eye"></i> 프롬프트 보기</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">이름</label>
                                    <input type="text" class="form-control" value="${prompt.name}" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">타입</label>
                                    <input type="text" class="form-control" value="${prompt.prompt_type}" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Temperature</label>
                                    <input type="text" class="form-control" value="${prompt.temperature}" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Max Tokens</label>
                                    <input type="text" class="form-control" value="${prompt.max_tokens}" readonly>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" onclick="editPrompt(${id})">
                                    <i class="bi bi-pencil"></i> 수정
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 기존 모달 제거
            const existingModal = document.getElementById('viewPromptModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 새 모달 추가
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('viewPromptModal'));
            modal.show();
            
            // 모달 닫힐 때 제거
            document.getElementById('viewPromptModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }
    } catch (error) {
        alert('프롬프트 정보를 불러오는데 실패했습니다');
        console.error(error);
    }
}

// 프롬프트 수정
async function editPrompt(id) {
    // viewPrompt 모달 닫기
    const viewModal = document.getElementById('viewPromptModal');
    if (viewModal) {
        bootstrap.Modal.getInstance(viewModal)?.hide();
        viewModal.remove();
    }
    
    try {
        const response = await fetch(`/automation/api/prompts/list`);
        const data = await response.json();
        
        if (data.success) {
            const prompt = data.prompts.find(p => p.id === id);
            
            if (!prompt) {
                alert('프롬프트를 찾을 수 없습니다');
                return;
            }
            
            // 수정 모달 HTML
            const modalHtml = `
                <div class="modal fade" id="editPromptModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="bi bi-pencil"></i> 프롬프트 수정</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form id="editPromptForm">
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">프롬프트 이름</label>
                                        <input type="text" class="form-control" name="name" value="${prompt.name}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">타입</label>
                                        <select class="form-select" name="prompt_type" required>
                                            <option value="post" ${prompt.prompt_type === 'post' ? 'selected' : ''}>글 작성</option>
                                            <option value="comment" ${prompt.prompt_type === 'comment' ? 'selected' : ''}>댓글 작성</option>
                                            <option value="reply" ${prompt.prompt_type === 'reply' ? 'selected' : ''}>대댓글 작성</option>
                                        </select>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Temperature</label>
                                            <input type="number" class="form-control" name="temperature" value="${prompt.temperature}" step="0.1" min="0" max="1" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Max Tokens</label>
                                            <input type="number" class="form-control" name="max_tokens" value="${prompt.max_tokens}" min="100" max="64000" required>
                                            <small class="text-muted">최대 64,000 (Claude Opus 4.5 한도)</small>
                                        </div>
                                    </div>
                                    <div class="alert alert-info">
                                        <i class="bi bi-lightbulb"></i> 시스템 프롬프트와 사용자 프롬프트는 보안상 수정할 수 없습니다. 새로 추가해주세요.
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-lg"></i> 저장
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // 기존 모달 제거
            const existingModal = document.getElementById('editPromptModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 새 모달 추가
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('editPromptModal'));
            modal.show();
            
            // form submit 이벤트
            document.getElementById('editPromptForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                
                try {
                    const updateResponse = await fetch(`/automation/api/prompts/${id}/update`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await updateResponse.json();
                    
                    if (result.success) {
                        modal.hide();
                        loadPrompts();
                        alert('✅ 프롬프트가 수정되었습니다!');
                    } else {
                        alert('❌ ' + result.message);
                    }
                } catch (error) {
                    alert('❌ 수정 중 오류가 발생했습니다');
                    console.error(error);
                }
            });
            
            // 모달 닫힐 때 제거
            document.getElementById('editPromptModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }
    } catch (error) {
        alert('프롬프트 정보를 불러오는데 실패했습니다');
        console.error(error);
    }
}

// ===== 스케줄 생성 관련 함수 =====

async function loadProductsForSchedule() {
    try {
        const response = await fetch('/automation/api/products/list');
        const data = await response.json();
        
        if (data.success) {
            const select = document.querySelector('#createScheduleModal select[name="product_id"]');
            
            let html = '<option value="">선택하세요</option>';
            
            data.products.forEach(product => {
                html += `<option value="${product.id}">${product.name}</option>`;
            });
            
            select.innerHTML = html;
        }
    } catch (error) {
        console.error('상품 목록 로드 오류:', error);
    }
}

async function loadPromptsForSchedule() {
    try {
        const response = await fetch('/automation/api/prompts/list');
        const data = await response.json();
        
        if (data.success) {
            const select = document.querySelector('#createScheduleModal select[name="prompt_id"]');
            
            let html = '<option value="">선택하세요</option>';
            
            data.prompts.filter(p => p.is_active && p.prompt_type === 'post').forEach(prompt => {
                html += `<option value="${prompt.id}">${prompt.name}</option>`;
            });
            
            select.innerHTML = html;
        }
    } catch (error) {
        console.error('프롬프트 목록 로드 오류:', error);
    }
}

async function loadCafesForSchedule() {
    try {
        const response = await fetch('/automation/api/cafes/list');
        const data = await response.json();
        
        if (data.success) {
            const select = document.querySelector('#createScheduleModal select[name="cafe_id"]');
            
            let html = '<option value="">선택하세요</option>';
            
            data.cafes.filter(c => c.status === 'active').forEach(cafe => {
                html += `<option value="${cafe.id}">${cafe.name}</option>`;
            });
            
            select.innerHTML = html;
        }
    } catch (error) {
        console.error('카페 목록 로드 오류:', error);
    }
}

function toggleModeFields() {
    const mode = document.getElementById('scheduleMode').value;
    const promptField = document.getElementById('promptField');
    
    if (mode === 'ai') {
        promptField.style.display = 'block';
        promptField.querySelector('select').required = true;
    } else {
        promptField.style.display = 'none';
        promptField.querySelector('select').required = false;
    }
}

async function loadSchedules() {
    try {
        const response = await fetch('/automation/api/schedules/list');
        const data = await response.json();
        
        if (data.success) {
            displaySchedules(data.schedules);
        }
    } catch (error) {
        console.error('스케줄 데이터 로드 오류:', error);
    }
}

function displaySchedules(schedules) {
    const tbody = document.getElementById('schedulesTableBody');
    
    if (schedules.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted">
                    등록된 스케줄이 없습니다
                </td>
            </tr>
        `;
        return;
    }
    
    const html = schedules.map(schedule => `
        <tr>
            <td>${schedule.scheduled_date}</td>
            <td><span class="task-badge ${schedule.mode}">${schedule.mode === 'human' ? '👤 휴먼' : '🤖 AI'}</span></td>
            <td>${schedule.product_name || '-'}</td>
            <td><span class="badge bg-primary">${schedule.keyword_text}</span></td>
            <td>${schedule.prompt_name || '-'}</td>
            <td><span class="status-badge ${schedule.status}">${schedule.status}</span></td>
            <td>${schedule.task_count || 0}개</td>
            ${window.is_admin ? `
            <td>
                <button class="btn btn-sm btn-danger" onclick="deleteSchedule(${schedule.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
            ` : ''}
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
}

async function createSchedule(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    // 로딩 표시
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 생성 중...';
    
    try {
        const response = await fetch('/automation/api/schedules/create-auto', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        // 버튼 복원
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        
        if (result.success) {
            // 모달 닫기
            closeModalCompletely('createScheduleModal');
            
            form.reset();
            loadSchedules();
            loadTasks();  // Task 목록도 새로고침
            
            alert('✅ 스케줄 ' + result.count + '개가 생성되었습니다!');
        } else {
            alert('❌ ' + result.message);
        }
    } catch (error) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        
        alert('❌ 스케줄 생성 중 오류가 발생했습니다');
        console.error(error);
    }
}

async function deleteSchedule(id) {
    if (!confirm('정말 이 스케줄을 삭제하시겠습니까?')) return;
    
    try {
        const response = await fetch(`/automation/api/schedules/${id}/delete`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('✅ 스케줄이 삭제되었습니다');
            loadSchedules();
        } else {
            alert('❌ ' + result.message);
        }
    } catch (error) {
        alert('❌ 삭제 중 오류가 발생했습니다');
    }
}

// ============================================
// 댓글 원고 관리 함수
// ============================================

async function showCommentScriptModal(taskId) {
    const modal = document.getElementById('commentScriptModal');
    document.getElementById('postTaskIdInput').value = taskId;
    
    // 기존 댓글 원고 로드
    try {
        const response = await fetch(`/automation/api/comment-scripts/list?post_task_id=${taskId}`);
        const data = await response.json();
        
        if (data.success && data.scripts && data.scripts.length > 0) {
            // 원고 텍스트로 변환
            let scriptText = '';
            data.scripts.forEach(script => {
                scriptText += `${script.group_number}-${script.sequence_number}: PC${script.pc_number} ${script.content}\n`;
            });
            document.getElementById('commentScriptText').value = scriptText;
            
            // 통계 표시
            document.getElementById('scriptStats').innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    저장된 댓글: <strong>${data.total_count}개</strong> 
                    / 그룹: <strong>${data.total_groups}개</strong>
                </div>
            `;
        } else {
            document.getElementById('commentScriptText').value = '';
            document.getElementById('scriptStats').innerHTML = '';
        }
    } catch (error) {
        console.error('댓글 원고 로드 오류:', error);
    }
    
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

async function saveCommentScript(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    
    try {
        const response = await fetch('/automation/api/comment-scripts/parse', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`✅ ${data.message}`);
            bootstrap.Modal.getInstance(document.getElementById('commentScriptModal')).hide();
            loadTasks();
        } else {
            let errorMsg = data.message || '댓글 원고 저장 실패';
            if (data.errors && data.errors.length > 0) {
                errorMsg += '\n\n오류:\n' + data.errors.join('\n');
            }
            alert('❌ ' + errorMsg);
        }
    } catch (error) {
        console.error('댓글 원고 저장 오류:', error);
        alert('❌ 저장 중 오류가 발생했습니다');
    }
}

async function createCommentTasks(taskId) {
    if (!confirm('본문 글 작성 완료 후 댓글 Task를 생성하시겠습니까?')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('post_task_id', taskId);
    
    try {
        const response = await fetch('/automation/api/comment-scripts/create-tasks', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`✅ ${data.message}`);
            loadTasks();
        } else {
            alert('❌ ' + data.message);
        }
    } catch (error) {
        console.error('댓글 Task 생성 오류:', error);
        alert('❌ 생성 중 오류가 발생했습니다');
    }
}

// ============================================
// AI 자동화 관련 함수들
// ============================================

// AI 상품 목록 로드
async function loadAIProducts() {
    try {
        const response = await fetch('/ai-automation/api/products');
        const data = await response.json();
        
        if (data.success) {
            const container = document.getElementById('aiProductList');
            container.innerHTML = '';
            
            if (data.products.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="bi bi-box-seam"></i>
                            <p>등록된 AI 상품이 없습니다.<br>상품을 추가해주세요.</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            data.products.forEach(product => {
                const card = `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <img src="${product.thumbnail || '/static/images/no-image.png'}" 
                                         class="img-thumbnail me-3" style="width: 80px; height: 80px; object-fit: cover;">
                                    <div>
                                        <h5 class="card-title mb-1">${product.product_name}</h5>
                                        <small class="text-muted">${product.product_code}</small>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <span class="badge ${product.use_for_cafe ? 'bg-primary' : 'bg-secondary'}">카페</span>
                                    <span class="badge ${product.use_for_blog ? 'bg-success' : 'bg-secondary'}">블로그</span>
                                </div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-primary" onclick="editAIProduct(${product.id})">
                                        <i class="bi bi-pencil"></i> 상세정보 수정
                                    </button>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-info" onclick="manageKeywords(${product.id})">
                                            <i class="bi bi-key"></i> 키워드
                                        </button>
                                        <button class="btn btn-sm btn-success" onclick="manageReferences(${product.id})">
                                            <i class="bi bi-book"></i> 레퍼런스
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        }
    } catch (error) {
        console.error('AI 상품 로드 오류:', error);
    }
}

// 탭 전환 시 데이터 로드
document.addEventListener('DOMContentLoaded', function() {
    // 탭 클릭 이벤트
    const tabLinks = document.querySelectorAll('[data-bs-toggle="tab"]');
    tabLinks.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (event) {
            const targetId = event.target.getAttribute('href').substring(1);
            
            switch(targetId) {
                // 설정 탭들
                case 'dashboard':
                    loadTasks();
                    loadPCs();
                    break;
                case 'pcs':
                    loadPCs();
                    break;
                case 'accounts':
                    loadAccounts();
                    break;
                case 'cafes':
                    loadCafes();
                    break;
                case 'prompts':
                    loadHumanPrompts();
                    break;
                case 'schedules':
                    loadHumanSchedules();
                    break;
                // AI 탭들
                case 'ai-product-setup':
                    loadAIProducts();
                    break;
                case 'ai-prompt-templates':
                    loadPromptTemplates();
                    break;
                case 'ai-prompts':
                    loadPromptProductFilter();
                    loadPrompts();
                    break;
                case 'ai-schedules':
                    loadSchedules();
                    break;
                case 'ai-posts':
                    loadPostFilters();
                    loadGeneratedPosts();
                    break;
                case 'ai-connections':
                    loadConnections();
                    break;
            }
        });
    });
});

// 프롬프트 템플릿 로드
async function loadPromptTemplates() {
    try {
        // 필터 값 가져오기
        const typeFilter = document.getElementById('templateTypeFilter')?.value || 'all';
        
        const url = typeFilter === 'all' 
            ? '/ai-automation/api/prompt-templates' 
            : `/ai-automation/api/prompt-templates?type=${typeFilter}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            const container = document.getElementById('promptTemplatesList');
            container.innerHTML = '';
            
            if (data.templates.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-file-text"></i>
                        <p>등록된 템플릿이 없습니다.</p>
                    </div>
                `;
                return;
            }
            
            const table = `
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>템플릿명</th>
                                <th>분류</th>
                                <th style="width: 40%;">프롬프트 미리보기</th>
                                <th>생성일</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.templates.map(t => `
                                <tr>
                                    <td><strong>${t.template_name}</strong></td>
                                    <td>
                                        <span class="badge ${t.template_type === 'alternative' ? 'bg-success' : 'bg-info'}">
                                            ${t.template_type === 'alternative' ? '대안성' : '정보성'}
                                        </span>
                                    </td>
                                    <td>
                                        <small style="line-height: 1.8;">
                                            ${renderVariablesAsBadges(t.user_prompt_template?.substring(0, 150) + '...')}
                                        </small>
                                    </td>
                                    <td>${new Date(t.created_at).toLocaleDateString()}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="editTemplate(${t.id})" title="수정">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-secondary" onclick="duplicateTemplate(${t.id})" title="복제">
                                            <i class="bi bi-files"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteTemplate(${t.id})" title="삭제">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = table;
        }
    } catch (error) {
        console.error('템플릿 로드 오류:', error);
    }
}

// 프롬프트 로드
// 프롬프트 상품 필터 로드
async function loadPromptProductFilter() {
    try {
        const response = await fetch('/ai-automation/api/products');
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('promptProductFilter');
            select.innerHTML = '<option value="">전체 상품</option>';
            
            data.products.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.product_name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('상품 필터 로드 오류:', error);
    }
}

async function loadPrompts() {
    const productFilter = document.getElementById('promptProductFilter')?.value || '';
    const typeFilter = document.getElementById('promptTypeFilter')?.value || 'all';
    
    try {
        // 빈 문자열이면 파라미터 제외
        let url = '/ai-automation/api/prompts?';
        const params = [];
        if (productFilter) params.push(`product=${productFilter}`);
        if (typeFilter && typeFilter !== 'all') params.push(`type=${typeFilter}`);
        url += params.join('&');
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            const container = document.getElementById('promptsList');
            container.innerHTML = '';
            
            if (data.prompts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-chat-dots"></i>
                        <p>등록된 프롬프트가 없습니다.</p>
                    </div>
                `;
                return;
            }
            
            const table = `
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>상품명</th>
                                <th>분류</th>
                                <th>Temperature</th>
                                <th>Max Tokens</th>
                                <th>이미지 생성</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.prompts.map(p => `
                                <tr>
                                    <td><strong>${p.product_name}</strong></td>
                                    <td>
                                        <span class="badge ${p.keyword_classification === 'alternative' ? 'bg-success' : 'bg-info'}">
                                            ${p.keyword_classification === 'alternative' ? '대안성' : '정보성'}
                                        </span>
                                    </td>
                                    <td>${p.temperature}</td>
                                    <td>${p.max_tokens}</td>
                                    <td>${p.generate_images ? '✅' : '❌'}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="editPrompt(${p.id})">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deletePrompt(${p.id})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = table;
        }
    } catch (error) {
        console.error('프롬프트 로드 오류:', error);
    }
}

// 스케줄 로드
async function loadSchedules(page = 1) {
    const productSearch = document.getElementById('scheduleProductSearch')?.value || '';
    const statusFilter = document.getElementById('scheduleStatusFilter')?.value || 'all';
    
    try {
        const response = await fetch(`/ai-automation/api/schedules?page=${page}&search=${productSearch}&status=${statusFilter}`);
        const data = await response.json();
        
        if (data.success) {
            const container = document.getElementById('schedulesList');
            container.innerHTML = '';
            
            if (data.schedules.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-calendar-check"></i>
                        <p>등록된 스케줄이 없습니다.</p>
                    </div>
                `;
                return;
            }
            
            const table = `
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>상품명</th>
                                <th>프롬프트 분류</th>
                                <th>시작일</th>
                                <th>종료일</th>
                                <th>일일 개수</th>
                                <th>예상 총 발행</th>
                                <th>상태</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.schedules.map(s => `
                                <tr>
                                    <td><strong>${s.product_name}</strong></td>
                                    <td>
                                        <span class="badge ${s.keyword_classification === 'alternative' ? 'bg-success' : 'bg-info'}">
                                            ${s.keyword_classification === 'alternative' ? '대안성' : '정보성'}
                                        </span>
                                    </td>
                                    <td>${s.start_date}</td>
                                    <td>${s.end_date}</td>
                                    <td>${s.daily_post_count}개</td>
                                    <td><strong>${s.expected_total_posts}개</strong></td>
                                    <td>
                                        <span class="badge ${s.status === 'scheduled' ? 'bg-warning' : s.status === 'in_progress' ? 'bg-primary' : 'bg-success'}">
                                            ${s.status === 'scheduled' ? '진행예정' : s.status === 'in_progress' ? '진행중' : '종료'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" onclick="deleteSchedule(${s.id})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = table;
            
            // 페이지네이션
            if (data.total_pages > 1) {
                let pagination = '<nav><ul class="pagination justify-content-center">';
                for (let i = 1; i <= data.total_pages; i++) {
                    pagination += `
                        <li class="page-item ${i === page ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="loadSchedules(${i}); return false;">${i}</a>
                        </li>
                    `;
                }
                pagination += '</ul></nav>';
                document.getElementById('schedulePagination').innerHTML = pagination;
            }
        }
    } catch (error) {
        console.error('스케줄 로드 오류:', error);
    }
}

// 검색 함수
function searchSchedules() {
    loadSchedules(1);
}

// 신규 발행 글 필터 로드
async function loadPostFilters() {
    try {
        // 계정 목록
        const accountsResponse = await fetch('/automation/api/accounts/list');
        const accountsData = await accountsResponse.json();
        
        if (accountsData.success) {
            const accountSelect = document.getElementById('postAccountFilter');
            accountSelect.innerHTML = '<option value="">전체 계정</option>';
            
            accountsData.accounts.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.id;
                option.textContent = acc.account_id;
                accountSelect.appendChild(option);
            });
        }
        
        // 카페 목록
        const cafesResponse = await fetch('/automation/api/cafes/list');
        const cafesData = await cafesResponse.json();
        
        if (cafesData.success) {
            const cafeSelect = document.getElementById('postCafeFilter');
            cafeSelect.innerHTML = '<option value="">전체 카페</option>';
            
            cafesData.cafes.forEach(cafe => {
                const option = document.createElement('option');
                option.value = cafe.id;
                option.textContent = cafe.name;
                cafeSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('필터 로드 오류:', error);
    }
}

// 신규 발행 글 로드
async function loadGeneratedPosts() {
    const accountFilter = document.getElementById('postAccountFilter')?.value || '';
    const cafeFilter = document.getElementById('postCafeFilter')?.value || '';
    
    try {
        // 빈 문자열이면 파라미터 제외
        let url = '/ai-automation/api/generated-posts?';
        const params = [];
        if (accountFilter) params.push(`account=${accountFilter}`);
        if (cafeFilter) params.push(`cafe=${cafeFilter}`);
        url += params.join('&');
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            const container = document.getElementById('generatedPostsList');
            container.innerHTML = '';
            
            if (data.posts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-file-earmark-text"></i>
                        <p>생성된 글이 없습니다.</p>
                    </div>
                `;
                return;
            }
            
            const table = `
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>상품명</th>
                                <th>계정</th>
                                <th>카페</th>
                                <th>제목</th>
                                <th>상태</th>
                                <th>생성일</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.posts.map(p => `
                                <tr>
                                    <td>${p.product_name}</td>
                                    <td>${p.account_name}</td>
                                    <td>${p.cafe_name}</td>
                                    <td><strong>${p.post_title}</strong></td>
                                    <td>
                                        <span class="badge ${p.status === 'published' ? 'bg-success' : 'bg-secondary'}">
                                            ${p.status === 'published' ? '발행완료' : '초안'}
                                        </span>
                                    </td>
                                    <td>${new Date(p.created_at).toLocaleString('ko-KR')}</td>
                                    <td>
                                        ${p.post_url ? `<a href="${p.post_url}" target="_blank" class="btn btn-sm btn-info"><i class="bi bi-box-arrow-up-right"></i></a>` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = table;
        }
    } catch (error) {
        console.error('발행 글 로드 오류:', error);
    }
}

// 연동 추가 모달 열기
async function showAddConnectionModal() {
    // 계정 목록 로드
    const accountsResponse = await fetch('/automation/api/accounts/list');
    const accountsData = await accountsResponse.json();
    
    if (accountsData.success) {
        const select = document.getElementById('connectionAccountSelect');
        select.innerHTML = '<option value="">선택하세요</option>';
        
        accountsData.accounts.forEach(acc => {
            const option = document.createElement('option');
            option.value = acc.id;
            option.textContent = acc.account_id;
            select.appendChild(option);
        });
    }
    
    // 카페 목록 로드
    const cafesResponse = await fetch('/automation/api/cafes/list');
    const cafesData = await cafesResponse.json();
    
    if (cafesData.success) {
        const select = document.getElementById('connectionCafeSelect');
        select.innerHTML = '<option value="">선택하세요</option>';
        
        cafesData.cafes.forEach(cafe => {
            const option = document.createElement('option');
            option.value = cafe.id;
            option.textContent = cafe.name;
            select.appendChild(option);
        });
    }
    
    // 모달 열기
    const modal = new bootstrap.Modal(document.getElementById('addConnectionModal'));
    modal.show();
}

// 연동 저장
async function saveConnection() {
    const accountId = document.getElementById('connectionAccountSelect').value;
    const cafeId = document.getElementById('connectionCafeSelect').value;
    const isMember = document.getElementById('connectionIsMember').checked;
    
    if (!accountId || !cafeId) {
        alert('계정과 카페를 모두 선택해주세요.');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('account_id', accountId);
        formData.append('cafe_id', cafeId);
        formData.append('is_member', isMember);
        
        const response = await fetch('/ai-automation/api/connections/add', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            alert('연동이 추가되었습니다.');
            bootstrap.Modal.getInstance(document.getElementById('addConnectionModal')).hide();
            loadConnections();
        } else {
            alert('오류: ' + data.error);
        }
    } catch (error) {
        alert('연동 추가 중 오류가 발생했습니다.');
    }
}

// 연동 삭제
async function deleteConnection(id) {
    if (!confirm('이 연동을 삭제하시겠습니까?')) {
        return;
    }
    
    try {
        const response = await fetch(`/ai-automation/api/connections/delete/${id}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            loadConnections();
        } else {
            alert('삭제 중 오류가 발생했습니다.');
        }
    } catch (error) {
        alert('삭제 중 오류가 발생했습니다.');
    }
}

// ============================================
// Claude API 테스트
// ============================================

async function showTestGenerationModal() {
    // 상품 목록 로드
    const response = await fetch('/ai-automation/api/products');
    const data = await response.json();
    
    if (data.success) {
        const select = document.getElementById('testProductSelect');
        select.innerHTML = '<option value="">상품을 선택하세요</option>';
        
        data.products.forEach(p => {
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = p.product_name;
            select.appendChild(option);
        });
    }
    
    // 카페 목록 로드
    const cafesResp = await fetch('/automation/api/cafes/list');
    const cafesData = await cafesResp.json();
    
    if (cafesData.success) {
        const select = document.getElementById('testCafeSelect');
        select.innerHTML = '<option value="">카페를 선택하세요</option>';
        
        cafesData.cafes.forEach(cafe => {
            const option = document.createElement('option');
            option.value = cafe.id;
            option.textContent = cafe.name;
            option.dataset.characteristics = cafe.characteristics || '일반적인 톤';
            select.appendChild(option);
        });
    }
    
    const modal = new bootstrap.Modal(document.getElementById('testGenerationModal'));
    modal.show();
}

// 카페 특성 미리보기
function showCafeCharacteristics() {
    const select = document.getElementById('testCafeSelect');
    const selectedOption = select.options[select.selectedIndex];
    
    if (selectedOption && selectedOption.value) {
        const characteristics = selectedOption.dataset.characteristics;
        document.getElementById('cafeCharacteristicsText').textContent = characteristics;
        document.getElementById('cafeCharacteristicsPreview').style.display = 'block';
    } else {
        document.getElementById('cafeCharacteristicsPreview').style.display = 'none';
    }
}

async function updateTestTemplates() {
    const productId = document.getElementById('testProductSelect').value;
    
    if (!productId) {
        document.getElementById('testTemplateSelect').innerHTML = '<option value="">먼저 상품을 선택하세요</option>';
        document.getElementById('testPromptSelect').innerHTML = '<option value="">먼저 상품을 선택하세요</option>';
        document.getElementById('testKeywordSelect').innerHTML = '<option value="">먼저 프롬프트를 선택하세요</option>';
        return;
    }
    
    // 템플릿 목록 로드
    const templatesResp = await fetch('/ai-automation/api/prompt-templates');
    const templatesData = await templatesResp.json();
    
    if (templatesData.success) {
        const select = document.getElementById('testTemplateSelect');
        select.innerHTML = '<option value="">템플릿 없이 진행</option>';
        
        templatesData.templates.forEach(t => {
            const option = document.createElement('option');
            option.value = t.id;
            option.textContent = `${t.template_name} (${t.template_type === 'alternative' ? '대안성' : '정보성'})`;
            select.appendChild(option);
        });
    }
    
    // 프롬프트 목록 로드
    const promptsResp = await fetch(`/ai-automation/api/prompts?product=${productId}`);
    const promptsData = await promptsResp.json();
    
    if (promptsData.success) {
        const select = document.getElementById('testPromptSelect');
        select.innerHTML = '<option value="">프롬프트를 선택하세요</option>';
        
        promptsData.prompts.forEach(p => {
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = `${p.keyword_classification === 'alternative' ? '대안성' : '정보성'} 프롬프트`;
            option.dataset.classification = p.keyword_classification;
            option.dataset.productId = p.ai_product_id;
            select.appendChild(option);
        });
        
        if (promptsData.prompts.length === 0) {
            select.innerHTML = '<option value="">해당 상품의 프롬프트가 없습니다</option>';
        }
    }
}

async function updateTestKeywords() {
    const promptSelect = document.getElementById('testPromptSelect');
    const selectedOption = promptSelect.options[promptSelect.selectedIndex];
    
    if (!selectedOption || !selectedOption.value) {
        document.getElementById('testKeywordSelect').innerHTML = '<option value="">먼저 프롬프트를 선택하세요</option>';
        return;
    }
    
    const productId = selectedOption.dataset.productId;
    const classification = selectedOption.dataset.classification;
    
    // 키워드 가져오기
    const response = await fetch(`/ai-automation/api/products/${productId}/keywords`);
    const data = await response.json();
    
    if (data.success) {
        const keywordSelect = document.getElementById('testKeywordSelect');
        keywordSelect.innerHTML = '<option value="">키워드를 선택하세요</option>';
        
        // 같은 분류의 키워드만
        const filtered = data.keywords.filter(k => k.keyword_type === classification && k.is_active);
        
        filtered.forEach(kw => {
            const option = document.createElement('option');
            option.value = kw.keyword_text;
            option.textContent = kw.keyword_text;
            keywordSelect.appendChild(option);
        });
        
        if (filtered.length === 0) {
            keywordSelect.innerHTML = '<option value="">해당 분류의 활성 키워드가 없습니다</option>';
        }
    }
}

async function generateTestContent() {
    const promptId = document.getElementById('testPromptSelect').value;
    const keyword = document.getElementById('testKeywordSelect').value;
    const cafeId = document.getElementById('testCafeSelect').value;
    
    if (!promptId || !keyword || !cafeId) {
        alert('프롬프트, 키워드, 카페를 모두 선택해주세요.');
        return;
    }
    
    // 입력 모달 닫기
    bootstrap.Modal.getInstance(document.getElementById('testGenerationModal')).hide();
    
    // 결과 모달 열기 (로딩 중)
    const resultModal = new bootstrap.Modal(document.getElementById('testResultModal'));
    resultModal.show();
    
    try {
        const formData = new FormData();
        formData.append('prompt_id', promptId);
        formData.append('keyword', keyword);
        formData.append('cafe_id', cafeId);  // 카페 추가
        
        const response = await fetch('/ai-automation/api/test-generate', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            // 결과 표시 (카페 정보 포함)
            document.getElementById('testResultContent').innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="bi bi-check-circle"></i> AI 생성 완료!</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-0">
                                <strong>상품:</strong> ${data.prompt_name.split(' - ')[0]}<br>
                                <strong>키워드:</strong> ${data.keyword}<br>
                                <strong>참고 레퍼런스:</strong> ${data.references_used}개
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-0">
                                <strong>카페:</strong> ${data.cafe_name}<br>
                                <strong>카페 특성:</strong> ${data.cafe_characteristics}<br>
                                <strong>토큰:</strong> 입력 ${data.usage.input_tokens} / 출력 ${data.usage.output_tokens}
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-file-text"></i> 생성된 글</h6>
                    </div>
                    <div class="card-body">
                        <div style="white-space: pre-wrap; line-height: 1.8; font-size: 1.05rem;">
                            ${data.content}
                        </div>
                    </div>
                </div>
            `;
        } else {
            document.getElementById('testResultContent').innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="bi bi-x-circle"></i> 생성 실패</h5>
                    <p class="mb-0">${data.error}</p>
                </div>
            `;
        }
    } catch (error) {
        document.getElementById('testResultContent').innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="bi bi-x-circle"></i> 오류 발생</h5>
                <p class="mb-0">${error.message}</p>
            </div>
        `;
    }
}

// ============================================
// 신규발행 글 URL 관리
// ============================================

// 버튼에서 data 속성 읽기
function manageDraftPostsFromButton(button) {
    const linkId = button.getAttribute('data-link-id');
    const cafeName = button.getAttribute('data-cafe-name');
    const accountName = button.getAttribute('data-account-name');
    
    manageDraftPosts(linkId, cafeName, accountName);
}

async function manageDraftPosts(linkId, cafeName, accountName) {
    // 요소 확인 (헤더에 있는 요소 사용)
    const linkIdInput = document.getElementById('draftLinkId');
    const cafeNameHeader = document.getElementById('draftCafeNameHeader');
    const accountNameHeader = document.getElementById('draftAccountNameHeader');
    const modalEl = document.getElementById('manageDraftPostsModal');
    
    if (!linkIdInput || !cafeNameHeader || !accountNameHeader || !modalEl) {
        console.error('모달 요소를 찾을 수 없습니다:', {
            linkIdInput, cafeNameHeader, accountNameHeader, modalEl
        });
        alert('모달을 열 수 없습니다. 페이지를 새로고침(Ctrl+Shift+R)해주세요.');
        return;
    }
    
    // 값 설정 (헤더에 표시 - 계속 보임!)
    linkIdInput.value = linkId || '';
    cafeNameHeader.textContent = cafeName || '알 수 없음';
    accountNameHeader.textContent = accountName || '알 수 없음';
    
    // 기존 모달 인스턴스 확인
    let modal = bootstrap.Modal.getInstance(modalEl);
    if (!modal) {
        modal = new bootstrap.Modal(modalEl, {
            backdrop: 'static',
            keyboard: true
        });
    }
    
    modal.show();
    
    // URL 목록 로드
    if (linkId) {
        await loadDraftPosts(linkId);
    }
}

async function loadDraftPosts(linkId) {
    try {
        const response = await fetch(`/ai-automation/api/draft-posts/list/${linkId}`);
        const data = await response.json();
        
        if (data.success) {
            const container = document.getElementById('draftPostsList');
            
            if (data.draft_posts.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">등록된 URL이 없습니다.</p>';
                return;
            }
            
            container.innerHTML = data.draft_posts.map((dp, idx) => `
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>URL ${idx + 1}</strong>
                                <span class="badge ${dp.status === 'available' ? 'bg-success' : 'bg-secondary'} ms-2">
                                    ${dp.status === 'available' ? '사용 가능' : '사용됨'}
                                </span>
                                <br>
                                <a href="${dp.draft_url}" target="_blank" class="small">
                                    ${dp.draft_url}
                                </a>
                                ${dp.used_at ? `<br><small class="text-muted">사용일: ${new Date(dp.used_at).toLocaleString('ko-KR')}</small>` : ''}
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="deleteDraftPost(${dp.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('URL 목록 로드 오류:', error);
    }
}

async function addDraftPost() {
    const linkId = document.getElementById('draftLinkId').value;
    const url = document.getElementById('draftPostUrl').value.trim();
    
    if (!url) {
        alert('URL을 입력해주세요.');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('link_id', linkId);
        formData.append('draft_url', url);
        
        const response = await fetch('/ai-automation/api/draft-posts/add', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            alert('URL이 추가되었습니다.');
            document.getElementById('draftPostUrl').value = '';
            await loadDraftPosts(linkId);
            await loadConnections();  // 연동 목록도 새로고침 (개수 업데이트)
        } else {
            alert('오류: ' + data.error);
        }
    } catch (error) {
        alert('URL 추가 중 오류가 발생했습니다.');
    }
}

async function deleteDraftPost(id) {
    if (!confirm('이 URL을 삭제하시겠습니까?')) {
        return;
    }
    
    const linkId = document.getElementById('draftLinkId').value;
    
    try {
        const response = await fetch(`/ai-automation/api/draft-posts/delete/${id}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            await loadDraftPosts(linkId);
            await loadConnections();  // 연동 목록도 새로고침 (개수 업데이트)
        } else {
            alert('삭제 중 오류가 발생했습니다.');
        }
    } catch (error) {
        alert('삭제 중 오류가 발생했습니다.');
    }
}

// 연동 필터 로드
async function loadConnectionFilters() {
    try {
        // 카페 목록
        const cafesResp = await fetch('/automation/api/cafes/list');
        const cafesData = await cafesResp.json();
        
        if (cafesData.success) {
            const select = document.getElementById('connectionCafeFilter');
            select.innerHTML = '<option value="">전체 카페</option>';
            
            cafesData.cafes.forEach(cafe => {
                const option = document.createElement('option');
                option.value = cafe.id;
                option.textContent = cafe.name;
                select.appendChild(option);
            });
        }
        
        // 계정 목록
        const accountsResp = await fetch('/automation/api/accounts/list');
        const accountsData = await accountsResp.json();
        
        if (accountsData.success) {
            const select = document.getElementById('connectionAccountFilter');
            select.innerHTML = '<option value="">전체 계정</option>';
            
            accountsData.accounts.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.id;
                option.textContent = acc.account_id;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('필터 로드 오류:', error);
    }
}

// 연동 관리 로드
async function loadConnections() {
    // 필터 로드 (처음 한 번만)
    const cafeFilter = document.getElementById('connectionCafeFilter');
    if (cafeFilter && cafeFilter.options.length <= 1) {
        await loadConnectionFilters();
    }
    
    // 필터 값 가져오기
    const cafeFilterValue = document.getElementById('connectionCafeFilter')?.value || '';
    const accountFilterValue = document.getElementById('connectionAccountFilter')?.value || '';
    
    try {
        const response = await fetch('/ai-automation/api/connections');
        const data = await response.json();
        
        if (data.success) {
            const container = document.getElementById('connectionsList');
            container.innerHTML = '';
            
            // 필터 적용
            let filtered = data.connections;
            if (cafeFilterValue) {
                filtered = filtered.filter(c => c.cafe_id == cafeFilterValue);
            }
            if (accountFilterValue) {
                filtered = filtered.filter(c => c.account_id == accountFilterValue);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-link-45deg"></i>
                        <p>해당 조건의 연동이 없습니다.</p>
                    </div>
                `;
                return;
            }
            
            data.connections = filtered;  // 필터링된 데이터 사용
            
            const table = `
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>카페</th>
                                <th>계정</th>
                                <th>가입 여부</th>
                                <th>상태</th>
                                <th>신규발행 글</th>
                                <th>사용된 글</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.connections.map(c => `
                                <tr>
                                    <td><strong>${c.cafe_name}</strong></td>
                                    <td><code>${c.account_name}</code></td>
                                    <td>
                                        <span class="badge ${c.is_member ? 'bg-success' : 'bg-secondary'}">
                                            ${c.is_member ? '가입완료' : '미가입'}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge ${c.status === 'active' ? 'bg-success' : 'bg-danger'}">
                                            ${c.status === 'active' ? '활성' : '정지'}
                                        </span>
                                    </td>
                                    <td><span class="badge bg-primary">${c.draft_post_count}개</span></td>
                                    <td><span class="badge bg-info">${c.used_post_count}개</span></td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-info" 
                                                    data-link-id="${c.id}" 
                                                    data-cafe-name="${c.cafe_name}" 
                                                    data-account-name="${c.account_name}"
                                                    onclick="manageDraftPostsFromButton(this)" 
                                                    title="URL 관리">
                                                <i class="bi bi-link-45deg"></i> URL
                                            </button>
                                            <button class="btn btn-danger" onclick="deleteConnection(${c.id})" title="연동 삭제">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = table;
        }
    } catch (error) {
        console.error('연동 로드 오류:', error);
    }
}

// ============================================
// AI 모달 관리 함수들
// ============================================

// 상품 추가 모달
async function showAddProductModal() {
    try {
        const response = await fetch('/ai-automation/api/available-products');
        const data = await response.json();
        
        if (!data.success || data.products.length === 0) {
            alert('추가 가능한 상품이 없습니다.');
            return;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('addAIProductModal'));
        
        // 상품 목록 채우기
        const container = document.getElementById('availableProductsList');
        container.innerHTML = data.products.map(p => `
            <div class="col-md-6 mb-2">
                <div class="card cursor-pointer" onclick="addAIProduct(${p.id})">
                    <div class="card-body d-flex align-items-center p-2">
                        <img src="${p.thumbnail || '/static/images/no-image.png'}" 
                             class="img-thumbnail me-2" style="width: 50px; height: 50px;">
                        <div>
                            <small><strong>${p.name}</strong></small><br>
                            <small class="text-muted">${p.product_code}</small>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        modal.show();
    } catch (error) {
        console.error('상품 목록 로드 오류:', error);
        alert('상품 목록을 불러올 수 없습니다.');
    }
}

async function addAIProduct(marketingProductId) {
    try {
        const response = await fetch(`/ai-automation/api/products/add/${marketingProductId}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            alert('상품이 추가되었습니다.');
            bootstrap.Modal.getInstance(document.getElementById('addAIProductModal')).hide();
            loadAIProducts();
        } else {
            alert('오류: ' + data.error);
        }
    } catch (error) {
        alert('상품 추가 중 오류가 발생했습니다.');
    }
}

// 상품 수정 모달
async function editAIProduct(id) {
    try {
        const response = await fetch(`/ai-automation/api/products/${id}`);
        const data = await response.json();
        
        if (!data.success) {
            alert('상품 정보를 불러올 수 없습니다.');
            return;
        }
        
        const product = data.product;
        
        // 폼 채우기
        document.getElementById('editProductId').value = id;
        document.getElementById('editUseCafe').checked = product.use_for_cafe;
        document.getElementById('editUseBlog').checked = product.use_for_blog;
        document.getElementById('editProductName').value = product.product_name || '';
        document.getElementById('editCoreValue').value = product.core_value || '';
        document.getElementById('editSubCoreValue').value = product.sub_core_value || '';
        document.getElementById('editSizeWeight').value = product.size_weight || '';
        document.getElementById('editDifference').value = product.difference || '';
        document.getElementById('editFamousBrands').value = product.famous_brands || '';
        document.getElementById('editMarketProblem').value = product.market_problem || '';
        document.getElementById('editOurPrice').value = product.our_price || '';
        document.getElementById('editMarketAvgPrice').value = product.market_avg_price || '';
        document.getElementById('editTargetAge').value = product.target_age || '';
        document.getElementById('editTargetGender').value = product.target_gender || '';
        document.getElementById('editAdditionalInfo').value = product.additional_info || '';
        document.getElementById('editMarketingLink').value = product.marketing_link || '';
        
        const modal = new bootstrap.Modal(document.getElementById('editAIProductModal'));
        modal.show();
    } catch (error) {
        console.error('상품 정보 로드 오류:', error);
        alert('상품 정보를 불러올 수 없습니다.');
    }
}

async function saveAIProduct() {
    const form = document.getElementById('editAIProductForm');
    const formData = new FormData(form);
    const id = document.getElementById('editProductId').value;
    
    try {
        const response = await fetch(`/ai-automation/api/products/update/${id}`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            alert('저장되었습니다.');
            bootstrap.Modal.getInstance(document.getElementById('editAIProductModal')).hide();
            loadAIProducts();
        } else {
            alert('오류: ' + data.error);
        }
    } catch (error) {
        alert('저장 중 오류가 발생했습니다.');
    }
}

// ============================================
// 키워드 관리
// ============================================

async function manageKeywords(productId) {
    document.getElementById('keywordProductId').value = productId;
    
    const modal = new bootstrap.Modal(document.getElementById('manageKeywordsModal'));
    modal.show();
    
    await loadKeywords(productId);
}

async function loadKeywords(productId) {
    try {
        const response = await fetch(`/ai-automation/api/products/${productId}/keywords`);
        const data = await response.json();
        
        if (data.success) {
            const tbody = document.getElementById('keywordsTableBody');
            tbody.innerHTML = '';
            
            if (data.keywords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">키워드가 없습니다. 동기화 버튼을 눌러주세요.</td></tr>';
                return;
            }
            
            data.keywords.forEach(kw => {
                const typeClass = kw.keyword_type === 'alternative' ? 'success' : 
                                 kw.keyword_type === 'informational' ? 'info' : 'secondary';
                const typeName = kw.keyword_type === 'alternative' ? '대안성' :
                                kw.keyword_type === 'informational' ? '정보성' : '미분류';
                
                const row = `
                    <tr>
                        <td><strong>${kw.keyword_text}</strong></td>
                        <td>
                            <select class="form-select form-select-sm" onchange="updateKeywordType(${kw.id}, this.value)">
                                <option value="unclassified" ${kw.keyword_type === 'unclassified' ? 'selected' : ''}>미분류</option>
                                <option value="alternative" ${kw.keyword_type === 'alternative' ? 'selected' : ''}>대안성</option>
                                <option value="informational" ${kw.keyword_type === 'informational' ? 'selected' : ''}>정보성</option>
                            </select>
                        </td>
                        <td>
                            <span class="badge ${kw.is_active ? 'bg-success' : 'bg-secondary'}">
                                ${kw.is_active ? '활성' : '비활성'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteKeyword(${kw.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
    } catch (error) {
        console.error('키워드 로드 오류:', error);
    }
}

async function syncKeywordsFromMarketing() {
    const productId = document.getElementById('keywordProductId').value;
    
    if (!confirm('마케팅 상품의 키워드를 동기화하시겠습니까?')) {
        return;
    }
    
    try {
        const response = await fetch(`/ai-automation/keywords/sync/${productId}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            alert(`${data.added_count}개의 키워드가 추가되었습니다.`);
            await loadKeywords(productId);
        } else {
            alert('오류: ' + data.error);
        }
    } catch (error) {
        alert('동기화 중 오류가 발생했습니다.');
    }
}

async function updateKeywordType(keywordId, newType) {
    try {
        const formData = new FormData();
        formData.append('keyword_type', newType);
        
        const response = await fetch(`/ai-automation/keywords/update/${keywordId}`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            // 성공 메시지 (조용히)
        } else {
            alert('오류: ' + data.error);
            // 실패 시 페이지 새로고침
            const productId = document.getElementById('keywordProductId').value;
            await loadKeywords(productId);
        }
    } catch (error) {
        alert('업데이트 중 오류가 발생했습니다.');
    }
}

function showAddKeywordForm() {
    const form = document.getElementById('addKeywordForm');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

async function saveNewKeyword() {
    const productId = document.getElementById('keywordProductId').value;
    const keywordText = document.getElementById('newKeywordText').value.trim();
    const keywordType = document.getElementById('newKeywordType').value;
    
    if (!keywordText) {
        alert('키워드를 입력해주세요.');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('keyword_text', keywordText);
        formData.append('keyword_type', keywordType);
        
        const response = await fetch(`/ai-automation/keywords/add/${productId}`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            alert('키워드가 추가되었습니다.');
            document.getElementById('newKeywordText').value = '';
            document.getElementById('newKeywordType').value = 'unclassified';
            document.getElementById('addKeywordForm').style.display = 'none';
            await loadKeywords(productId);
        } else {
            alert('오류: ' + data.error);
        }
    } catch (error) {
        alert('추가 중 오류가 발생했습니다.');
    }
}

async function deleteKeyword(keywordId) {
    if (!confirm('이 키워드를 삭제하시겠습니까?')) {
        return;
    }
    
    try {
        const response = await fetch(`/ai-automation/keywords/delete/${keywordId}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            const productId = document.getElementById('keywordProductId').value;
            await loadKeywords(productId);
        } else {
            alert('삭제 중 오류가 발생했습니다.');
}
    } catch (error) {
        alert('삭제 중 오류가 발생했습니다.');
    }
}

// ============================================
// 레퍼런스 관리
// ============================================

async function manageReferences(productId) {
    document.getElementById('referenceProductId').value = productId;
    
    const modal = new bootstrap.Modal(document.getElementById('manageReferencesModal'));
    modal.show();
    
    await loadReferences(productId);
}

async function loadReferences(productId) {
    try {
        const response = await fetch(`/ai-automation/api/products/${productId}/references`);
        const data = await response.json();
        
        if (data.success) {
            const tbody = document.getElementById('referencesTableBody');
            tbody.innerHTML = '';
            
            if (data.references.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">레퍼런스가 없습니다. 동기화 버튼을 눌러주세요.</td></tr>';
                return;
            }
            
            data.references.forEach(ref => {
                const typeClass = ref.reference_type === 'alternative' ? 'success' : 
                                 ref.reference_type === 'informational' ? 'info' : 'secondary';
                const typeName = ref.reference_type === 'alternative' ? '대안성' :
                                ref.reference_type === 'informational' ? '정보성' : '미분류';
                
                const refTypeBadge = ref.ref_type ? `<span class="badge bg-secondary">${ref.ref_type}</span>` : '';
                const contentPreview = ref.content ? ref.content.substring(0, 80) + '...' : '';
                
                const row = `
                    <tr>
                        <td>
                            <strong>${ref.title}</strong>
                            <br><small class="text-muted">ID: ${ref.reference_id}</small>
                        </td>
                        <td>
                            <select class="form-select form-select-sm" onchange="updateReferenceType(${ref.id}, this.value)">
                                <option value="unclassified" ${ref.reference_type === 'unclassified' ? 'selected' : ''}>미분류</option>
                                <option value="alternative" ${ref.reference_type === 'alternative' ? 'selected' : ''}>대안성</option>
                                <option value="informational" ${ref.reference_type === 'informational' ? 'selected' : ''}>정보성</option>
                            </select>
                        </td>
                        <td>${refTypeBadge || '<span class="badge bg-light text-dark">없음</span>'}</td>
                        <td><small class="text-muted">${contentPreview}</small></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-info" onclick="viewReferenceDetailFull(${ref.reference_id})" title="상세보기">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-warning" onclick="editReference(${ref.id}, ${ref.reference_id})" title="수정">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-danger" onclick="deleteAIReference(${ref.id})" title="삭제">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
    } catch (error) {
        console.error('레퍼런스 로드 오류:', error);
    }
}

async function syncReferencesFromMarketing() {
    const productId = document.getElementById('referenceProductId').value;
    
    if (!confirm('마케팅 레퍼런스를 동기화하시겠습니까?')) {
        return;
    }
    
    try {
        const response = await fetch(`/ai-automation/references/sync/${productId}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            alert(`${data.added_count}개의 레퍼런스가 추가되었습니다.`);
            await loadReferences(productId);
        } else {
            alert('오류: ' + data.error);
        }
    } catch (error) {
        alert('동기화 중 오류가 발생했습니다.');
    }
}

async function updateReferenceType(aiRefId, newType) {
    try {
        const formData = new FormData();
        formData.append('reference_type', newType);
        
        const response = await fetch(`/ai-automation/references/update/${aiRefId}`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (!data.success) {
            alert('오류: ' + data.error);
            const productId = document.getElementById('referenceProductId').value;
            await loadReferences(productId);
        }
    } catch (error) {
        alert('업데이트 중 오류가 발생했습니다.');
    }
}

// 레퍼런스 상세 보기 (본문+댓글)
async function viewReferenceDetailFull(referenceId) {
    try {
        // 레퍼런스 정보 가져오기 (본문 + 댓글)
        const response = await fetch(`/marketing/reference/${referenceId}/content`);
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('viewRefId').value = referenceId;
            document.getElementById('viewRefTitle').textContent = data.title;
            document.getElementById('viewRefContent').textContent = data.body || '내용 없음';
            
            // 댓글 표시 (본문 + 댓글 모두 표시)
            const commentsDiv = document.getElementById('viewRefComments');
            const comments = data.comments || [];
            
            document.getElementById('viewRefCommentCount').textContent = comments.length;
            
            if (comments.length === 0) {
                commentsDiv.innerHTML = '<p class="text-muted text-center">댓글이 없습니다.</p>';
            } else {
                commentsDiv.innerHTML = comments.map((comment, idx) => {
                    // 대댓글은 들여쓰기
                    const marginLeft = comment.is_reply ? 'margin-left: 40px;' : '';
                    const replyBadge = comment.is_reply ? '<span class="badge bg-info me-2">↪ 대댓글</span>' : '';
                    
                    return `
                    <div class="card mb-2" style="${marginLeft}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    ${replyBadge}
                                    <strong>${comment.commenter_name}</strong>
                                </div>
                                <small class="text-muted">계정 순서: ${comment.account_sequence}</small>
                            </div>
                            <p class="mb-0" style="white-space: pre-wrap;">${comment.comment_text || comment.text}</p>
                        </div>
                    </div>
                `;
                }).join('');
            }
            
            const modal = new bootstrap.Modal(document.getElementById('viewReferenceModal'));
            modal.show();
        } else {
            alert('레퍼런스를 불러올 수 없습니다.');
        }
    } catch (error) {
        console.error('레퍼런스 상세 로드 오류:', error);
        alert('오류가 발생했습니다.');
    }
}

// 레퍼런스 수정 모달 열기
async function editReference(aiRefId, referenceId) {
    try {
        const response = await fetch(`/marketing/reference/${referenceId}/content`);
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('editRefId').value = referenceId;
            document.getElementById('editAiRefId').value = aiRefId;
            document.getElementById('editRefTitle').value = data.title;
            document.getElementById('editRefContent').value = data.body || '';
            
            // 현재 AI 분류 가져오기
            const productId = document.getElementById('referenceProductId').value;
            const refsResponse = await fetch(`/ai-automation/api/products/${productId}/references`);
            const refsData = await refsResponse.json();
            
            if (refsData.success) {
                const aiRef = refsData.references.find(r => r.id === aiRefId);
                if (aiRef) {
                    document.getElementById('editRefType').value = aiRef.reference_type;
                }
            }
            
            const modal = new bootstrap.Modal(document.getElementById('editReferenceModal'));
            modal.show();
        }
    } catch (error) {
        console.error('레퍼런스 로드 오류:', error);
        alert('오류가 발생했습니다.');
    }
}

// 레퍼런스 수정 저장
async function updateReferenceContent() {
    const aiRefId = document.getElementById('editAiRefId').value;
    const refType = document.getElementById('editRefType').value;
    
    try {
        const formData = new FormData();
        formData.append('reference_type', refType);
        
        const response = await fetch(`/ai-automation/references/update/${aiRefId}`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            alert('분류가 업데이트되었습니다.');
            bootstrap.Modal.getInstance(document.getElementById('editReferenceModal')).hide();
            
            const productId = document.getElementById('referenceProductId').value;
            await loadReferences(productId);
        } else {
            alert('오류: ' + data.error);
        }
    } catch (error) {
        alert('업데이트 중 오류가 발생했습니다.');
    }
}

// 레퍼런스 추가 폼 표시/숨김
function showAddReferenceForm() {
    document.getElementById('addReferenceForm').style.display = 'block';
}

function hideAddReferenceForm() {
    document.getElementById('addReferenceForm').style.display = 'none';
    document.getElementById('newRefTitle').value = '';
    document.getElementById('newRefContent').value = '';
    document.getElementById('newRefType').value = 'unclassified';
}

// 새 레퍼런스 저장
async function saveNewReference() {
    const productId = document.getElementById('referenceProductId').value;
    const title = document.getElementById('newRefTitle').value.trim();
    const content = document.getElementById('newRefContent').value.trim();
    const refType = document.getElementById('newRefType').value;
    
    if (!title || !content) {
        alert('제목과 내용을 입력해주세요.');
        return;
    }
    
    try {
        // 먼저 Reference 생성 (마케팅)
        const refResponse = await fetch('/marketing/api/reference/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                title: title,
                content: content,
                ref_type: '기타'
            })
        });
        const refData = await refResponse.json();
        
        if (refData.success) {
            // AIProductReference에 추가
            const formData = new FormData();
            formData.append('reference_id', refData.id);
            formData.append('reference_type', refType);
            
            const aiRefResponse = await fetch(`/ai-automation/references/add/${productId}`, {
                method: 'POST',
                body: formData
            });
            const aiRefData = await aiRefResponse.json();
            
            if (aiRefData.success) {
                alert('레퍼런스가 추가되었습니다.');
                hideAddReferenceForm();
                await loadReferences(productId);
            } else {
                alert('AI 레퍼런스 연결 실패: ' + aiRefData.error);
            }
        } else {
            alert('레퍼런스 생성 실패: ' + refData.error);
        }
    } catch (error) {
        console.error('레퍼런스 추가 오류:', error);
        alert('추가 중 오류가 발생했습니다.');
    }
}

// AI 레퍼런스 삭제 (연결만 끊기)
async function deleteAIReference(aiRefId) {
    if (!confirm('이 레퍼런스 연결을 삭제하시겠습니까?\n(원본 레퍼런스는 마케팅에 남아있습니다)')) {
        return;
    }
    
    try {
        const response = await fetch(`/ai-automation/references/delete/${aiRefId}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            const productId = document.getElementById('referenceProductId').value;
            await loadReferences(productId);
        } else {
            alert('삭제 중 오류가 발생했습니다.');
        }
    } catch (error) {
        alert('삭제 중 오류가 발생했습니다.');
    }
}

// 프롬프트 템플릿 모달
function showAddTemplateModal() {
    const modal = new bootstrap.Modal(document.getElementById('addTemplateModal'));
    modal.show();
}

async function saveTemplate(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        const response = await fetch('/ai-automation/api/prompt-templates/add', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            alert('템플릿이 추가되었습니다.');
            bootstrap.Modal.getInstance(document.getElementById('addTemplateModal')).hide();
            event.target.reset();
            loadPromptTemplates();
        } else {
            alert('오류: ' + data.error);
        }
    } catch (error) {
        alert('템플릿 추가 중 오류가 발생했습니다.');
    }
}

async function editTemplate(id) {
    try {
        const response = await fetch(`/ai-automation/api/prompt-templates/${id}`);
        const data = await response.json();
        
        if (!data.success) {
            alert('템플릿 정보를 불러올 수 없습니다.');
            return;
        }
        
        const template = data.template;
        
        document.getElementById('editTemplateId').value = id;
        document.getElementById('editTemplateName').value = template.template_name;
        document.getElementById('editTemplateType').value = template.template_type;
        document.getElementById('editTemplatePrompt').value = template.user_prompt_template;
        
        const modal = new bootstrap.Modal(document.getElementById('editTemplateModal'));
        modal.show();
    } catch (error) {
        alert('템플릿 정보를 불러올 수 없습니다.');
    }
}

async function updateTemplate() {
    const id = document.getElementById('editTemplateId').value;
    const formData = new FormData();
    formData.append('template_name', document.getElementById('editTemplateName').value);
    formData.append('template_type', document.getElementById('editTemplateType').value);
    formData.append('user_prompt_template', document.getElementById('editTemplatePrompt').value);
    
    try {
        const response = await fetch(`/ai-automation/api/prompt-templates/update/${id}`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            alert('템플릿이 수정되었습니다.');
            bootstrap.Modal.getInstance(document.getElementById('editTemplateModal')).hide();
            loadPromptTemplates();
        } else {
            alert('오류: ' + data.error);
        }
    } catch (error) {
        alert('템플릿 수정 중 오류가 발생했습니다.');
    }
}

async function duplicateTemplate(id) {
    if (!confirm('이 템플릿을 복제하시겠습니까?')) return;
    
    try {
        const response = await fetch(`/ai-automation/api/prompt-templates/duplicate/${id}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            alert('템플릿이 복제되었습니다.');
            loadPromptTemplates();
        } else {
            alert('오류: ' + data.error);
        }
    } catch (error) {
        alert('템플릿 복제 중 오류가 발생했습니다.');
    }
}

async function deleteTemplate(id) {
    if (!confirm('정말로 삭제하시겠습니까?')) return;
    
    try {
        const response = await fetch(`/ai-automation/api/prompt-templates/delete/${id}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            alert('템플릿이 삭제되었습니다.');
            loadPromptTemplates();
        } else {
            alert('오류: ' + data.error);
        }
    } catch (error) {
        alert('템플릿 삭제 중 오류가 발생했습니다.');
    }
}

// 프롬프트 관리 모달
function showAddPromptModal() {
    const modal = new bootstrap.Modal(document.getElementById('addPromptModal'));
    modal.show();
}

async function savePrompt(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        const response = await fetch('/ai-automation/api/prompts/add', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            alert('프롬프트가 추가되었습니다.');
            bootstrap.Modal.getInstance(document.getElementById('addPromptModal')).hide();
            event.target.reset();
            loadPrompts();
        } else {
            alert('오류: ' + data.error);
        }
    } catch (error) {
        alert('프롬프트 추가 중 오류가 발생했습니다.');
    }
}

async function editPrompt(id) {
    try {
        // 상품 목록 로드
        const productsResp = await fetch('/ai-automation/api/products');
        const productsData = await productsResp.json();
        
        if (productsData.success) {
            const select = document.getElementById('editPromptProduct');
            select.innerHTML = '<option value="">선택하세요</option>';
            
            productsData.products.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.product_name;
                select.appendChild(option);
            });
        }
        
        // 프롬프트 정보 가져오기
        const response = await fetch(`/ai-automation/api/prompts/${id}`);
        const data = await response.json();
        
        if (!data.success) {
            alert('프롬프트 정보를 불러올 수 없습니다.');
            return;
        }
        
        const prompt = data.prompt;
        
        // 폼 채우기
        document.getElementById('editPromptId').value = id;
        document.getElementById('editPromptProduct').value = prompt.ai_product_id;  // 상품 ID로 선택
        document.getElementById('editPromptClassification').value = prompt.keyword_classification;
        document.getElementById('editPromptSystem').value = prompt.system_prompt;
        document.getElementById('editPromptUser').value = prompt.user_prompt;
        document.getElementById('editPromptTemp').value = prompt.temperature;
        document.getElementById('editPromptTokens').value = prompt.max_tokens;
        document.getElementById('editPromptImages').checked = prompt.generate_images;
        document.getElementById('editPromptCafeContext').checked = prompt.apply_cafe_context || false;
        
        // 모달 열기
        const modal = new bootstrap.Modal(document.getElementById('editAIPromptModal'));
        modal.show();
    } catch (error) {
        console.error('프롬프트 로드 오류:', error);
        alert('오류가 발생했습니다.');
    }
}

async function updatePrompt() {
    const id = document.getElementById('editPromptId').value;
    const productId = document.getElementById('editPromptProduct').value;
    
    if (!productId) {
        alert('상품을 선택해주세요.');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('ai_product_id', productId);
        formData.append('keyword_classification', document.getElementById('editPromptClassification').value);
        formData.append('system_prompt', document.getElementById('editPromptSystem').value);
        formData.append('user_prompt', document.getElementById('editPromptUser').value);
        formData.append('temperature', document.getElementById('editPromptTemp').value);
        formData.append('max_tokens', document.getElementById('editPromptTokens').value);
        formData.append('generate_images', document.getElementById('editPromptImages').checked);
        formData.append('apply_cafe_context', document.getElementById('editPromptCafeContext').checked);
        
        const response = await fetch(`/ai-automation/api/prompts/update/${id}`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            alert('프롬프트가 수정되었습니다.');
            bootstrap.Modal.getInstance(document.getElementById('editAIPromptModal')).hide();
            loadPrompts();
        } else {
            alert('오류: ' + data.error);
        }
    } catch (error) {
        alert('수정 중 오류가 발생했습니다.');
    }
}

async function deletePrompt(id) {
    if (!confirm('정말로 삭제하시겠습니까?')) return;
    
    try {
        const response = await fetch(`/ai-automation/api/prompts/delete/${id}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            alert('프롬프트가 삭제되었습니다.');
            loadPrompts();
        } else {
            alert('오류: ' + data.error);
        }
    } catch (error) {
        alert('프롬프트 삭제 중 오류가 발생했습니다.');
    }
}

// 스케줄 모달
function showAddScheduleModal() {
    const modal = new bootstrap.Modal(document.getElementById('addScheduleModal'));
    modal.show();
}

async function saveSchedule(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        const response = await fetch('/ai-automation/api/schedules/add', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            alert('스케줄이 생성되었습니다.');
            bootstrap.Modal.getInstance(document.getElementById('addScheduleModal')).hide();
            event.target.reset();
            loadSchedules();
        } else {
            alert('오류: ' + data.error);
        }
    } catch (error) {
        alert('스케줄 생성 중 오류가 발생했습니다.');
    }
}

async function deleteSchedule(id) {
    if (!confirm('정말로 삭제하시겠습니까?')) return;
    
    try {
        const response = await fetch(`/ai-automation/api/schedules/delete/${id}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            alert('스케줄이 삭제되었습니다.');
            loadSchedules();
        } else {
            alert('오류: ' + data.error);
        }
    } catch (error) {
        alert('스케줄 삭제 중 오류가 발생했습니다.');
    }
}

// showAddConnectionModal 함수는 위에 이미 구현됨 (2625줄)

// ============================================
// 변수 시스템 (프롬프트 템플릿용)
// ============================================

// 변수 삽입 함수
function insertVariable(textareaId, variableName) {
    const textarea = document.getElementById(textareaId);
    const cursorPos = textarea.selectionStart;
    const textBefore = textarea.value.substring(0, cursorPos);
    const textAfter = textarea.value.substring(cursorPos);
    
    const variableText = `{${variableName}}`;
    textarea.value = textBefore + variableText + textAfter;
    
    // 커서 위치 조정
    const newCursorPos = cursorPos + variableText.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    textarea.focus();
}

// 드롭박스에서 변수 선택 후 삽입
function insertVariableFromSelect(textareaId, selectId) {
    const select = document.getElementById(selectId);
    const variableName = select.value;
    
    if (!variableName) {
        alert('변수를 선택해주세요.');
        return;
    }
    
    insertVariable(textareaId, variableName);
    
    // 선택 초기화
    select.value = '';
}

// 이미지 생성 프롬프트 추가
function insertImageGenerationPrompt(textareaId) {
    const textarea = document.getElementById(textareaId);
    const imagePrompt = '\n\n위 내용을 정확하게 참조해서\n1. 제품 파손, 불량 등 부정적인 실제 사진같은 이미지\n2. 실제 한국사람이 고통스러워 하고있는 실제 사진같은 이미지\n3. 해당 제품의 실제 사용하는 것 같은 이미지\n이렇게 총 3장을 만들어줘';
    
    // 맨 끝에 추가
    textarea.value = textarea.value.trim() + imagePrompt;
    
    // 커서를 맨 끝으로
    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
    textarea.focus();
    
    alert('이미지 생성 프롬프트가 추가되었습니다.');
}

// 템플릿 텍스트에서 변수를 뱃지로 변환
function renderVariablesAsBadges(text) {
    if (!text) return '';
    
    // {변수명} 패턴을 찾아서 뱃지로 변환
    return text.replace(/\{([a-z_]+)\}/g, (match, varName) => {
        return `<span class="badge bg-primary">{${varName}}</span>`;
    });
}

// 모든 변수 목록
const AVAILABLE_VARIABLES = {
    'product_name': '우리제품명',
    'core_value': '우리 제품의 핵심',
    'sub_core_value': '우리 제품의 서브 핵심',
    'size_weight': '우리 제품 사이즈 & 무게',
    'difference': '타사 제품과 차별점',
    'famous_brands': '해당 제품의 유명 브랜드들',
    'market_problem': '기존 시장의 문제점',
    'our_price': '우리 제품의 가격',
    'market_avg_price': '기존 시장의 평균 가격',
    'target_age': '고객의 예상 연령대',
    'target_gender': '고객의 예상 성별',
    'additional_info': '기타 추가 특이사항',
    'marketing_link': '마케팅 링크'
};

// 템플릿 내용 로드 (프롬프트 생성 시)
async function loadTemplatesForType() {
    const type = document.getElementById('promptTypeSelect').value;
    if (!type) return;
    
    try {
        const response = await fetch(`/ai-automation/api/prompt-templates?type=${type}`);
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('templateSelectForPrompt');
            select.innerHTML = '<option value="">직접 입력</option>';
            
            data.templates.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = t.template_name;
                option.dataset.content = t.user_prompt_template;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('템플릿 로드 오류:', error);
    }
}

function loadTemplateContent() {
    const select = document.getElementById('templateSelectForPrompt');
    const selectedOption = select.options[select.selectedIndex];
    
    if (selectedOption.value && selectedOption.dataset.content) {
        document.getElementById('userPromptArea').value = selectedOption.dataset.content;
    }
}

// 키워드 개수 표시
async function showKeywordCount() {
    const productId = document.getElementById('scheduleProductSelect').value;
    if (!productId) {
        document.getElementById('keywordCountDisplay').textContent = '';
        document.getElementById('schedulePromptSelect').innerHTML = '<option value="">먼저 상품을 선택하세요</option>';
        return;
    }
    
    try {
        // 키워드 개수 가져오기
        const keywordResponse = await fetch(`/ai-automation/api/products/${productId}/keywords`);
        const keywordData = await keywordResponse.json();
        
        if (keywordData.success) {
            document.getElementById('keywordCountDisplay').textContent = 
                `해당 상품의 활성 키워드: ${keywordData.count}개`;
        }
        
        // 해당 상품의 프롬프트 목록 가져오기
        const promptResponse = await fetch(`/ai-automation/api/prompts?product=${productId}`);
        const promptData = await promptResponse.json();
        
        if (promptData.success) {
            const select = document.getElementById('schedulePromptSelect');
            select.innerHTML = '<option value="">선택하세요</option>';
            
            promptData.prompts.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.keyword_classification === 'alternative' ? '대안성' : '정보성'} 프롬프트`;
                option.dataset.classification = p.keyword_classification;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('데이터 로드 오류:', error);
    }
}

// 총 발행 수 계산
function calculateTotal() {
    const startDate = document.getElementById('scheduleStartDate').value;
    const endDate = document.getElementById('scheduleEndDate').value;
    const dailyCount = parseInt(document.getElementById('dailyPostCount').value) || 0;
    
    if (!startDate || !endDate || !dailyCount) {
        document.getElementById('totalPostsDisplay').style.display = 'none';
        return;
    }
    
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    if (start > end) {
        alert('종료일은 시작일보다 이후여야 합니다.');
        return;
    }
    
    // 주말 제외한 일수 계산
    let workDays = 0;
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        if (d.getDay() !== 0 && d.getDay() !== 6) { // 일요일(0), 토요일(6) 제외
            workDays++;
        }
    }
    
    const totalPosts = workDays * dailyCount;
    document.getElementById('totalPostsCount').textContent = totalPosts;
    document.getElementById('totalPostsDisplay').style.display = 'block';
}

// 모달이 열릴 때 상품 목록 로드
document.addEventListener('DOMContentLoaded', function() {
    // 프롬프트 추가 모달이 열릴 때
    const addPromptModal = document.getElementById('addPromptModal');
    if (addPromptModal) {
        addPromptModal.addEventListener('show.bs.modal', async function() {
            try {
                const response = await fetch('/ai-automation/api/products');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('promptProductSelect');
                    select.innerHTML = '<option value="">선택하세요</option>';
                    
                    data.products.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = p.product_name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('상품 목록 로드 오류:', error);
            }
        });
    }
    
    // 스케줄 추가 모달이 열릴 때
    const addScheduleModal = document.getElementById('addScheduleModal');
    if (addScheduleModal) {
        addScheduleModal.addEventListener('show.bs.modal', async function() {
            try {
                const response = await fetch('/ai-automation/api/products');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('scheduleProductSelect');
                    select.innerHTML = '<option value="">선택하세요</option>';
                    
                    data.products.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = p.product_name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('상품 목록 로드 오류:', error);
            }
        });
    }
});

</script>

<!-- ============================================ -->
<!-- AI 자동화 모달들 -->
<!-- ============================================ -->

<!-- 상품 추가 모달 -->
<div class="modal fade" id="addAIProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-stars"></i> AI 상품 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="availableProductsList" class="row">
                    <!-- JavaScript로 로드 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 상품 수정 모달 -->
<div class="modal fade" id="editAIProductModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> 상품 상세 정보 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editAIProductForm" onsubmit="event.preventDefault(); saveAIProduct();">
                <input type="hidden" id="editProductId">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6>플랫폼 사용 권한</h6>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="editUseCafe" name="use_for_cafe">
                                <label class="form-check-label" for="editUseCafe">카페</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="editUseBlog" name="use_for_blog">
                                <label class="form-check-label" for="editUseBlog">블로그</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">1. 우리제품명 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editProductName" name="product_name" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">8. 우리 제품의 가격 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editOurPrice" name="our_price" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">9. 기존 시장 평균 가격 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editMarketAvgPrice" name="market_avg_price" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">10. 고객의 예상 연령대 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editTargetAge" name="target_age" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">11. 고객의 예상 성별 <span class="text-danger">*</span></label>
                            <select class="form-select" id="editTargetGender" name="target_gender" required>
                                <option value="">선택하세요</option>
                                <option value="남성">남성</option>
                                <option value="여성">여성</option>
                                <option value="남녀공용">남녀공용</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">2. 우리 제품의 핵심 <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="editCoreValue" name="core_value" rows="4" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">3. 우리 제품의 서브 핵심 <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="editSubCoreValue" name="sub_core_value" rows="3" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">5. 타사 제품과 차별점 <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="editDifference" name="difference" rows="4" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">7. 기존 시장의 문제점 <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="editMarketProblem" name="market_problem" rows="4" required></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">4. 우리 제품 사이즈 & 무게 <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="editSizeWeight" name="size_weight" rows="2" required></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">6. 해당 제품의 유명 브랜드들 <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="editFamousBrands" name="famous_brands" rows="2" required></textarea>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">12. 기타 추가 특이사항 (선택)</label>
                        <textarea class="form-control" id="editAdditionalInfo" name="additional_info" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">마케팅 링크 <span class="text-danger">*</span></label>
                        <input type="url" class="form-control" id="editMarketingLink" name="marketing_link" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 템플릿 추가 모달 -->
<div class="modal fade" id="addTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-file-text"></i> 프롬프트 템플릿 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="saveTemplate(event)">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">템플릿 이름 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="template_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">분류 <span class="text-danger">*</span></label>
                            <select class="form-select" name="template_type" required>
                                <option value="">선택하세요</option>
                                <option value="alternative">대안성</option>
                                <option value="informational">정보성</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">사용자 프롬프트 템플릿 <span class="text-danger">*</span></label>
                            <div class="input-group input-group-sm" style="width: auto;">
                                <select class="form-select" id="addTemplateVariableSelect" style="width: 200px;">
                                    <option value="">변수 선택</option>
                                    <option value="타겟_키워드">🎯 타겟 키워드 (랜덤)</option>
                                    <option value="product_name">1. 우리제품명</option>
                                    <option value="core_value">2. 우리 제품의 핵심</option>
                                    <option value="sub_core_value">3. 서브 핵심</option>
                                    <option value="size_weight">4. 사이즈 & 무게</option>
                                    <option value="difference">5. 타사 차별점</option>
                                    <option value="famous_brands">6. 유명 브랜드들</option>
                                    <option value="market_problem">7. 시장 문제점</option>
                                    <option value="our_price">8. 우리 가격</option>
                                    <option value="market_avg_price">9. 시장 평균 가격</option>
                                    <option value="target_age">10. 예상 연령대</option>
                                    <option value="target_gender">11. 예상 성별</option>
                                    <option value="additional_info">12. 기타 특이사항</option>
                                    <option value="marketing_link">마케팅 링크</option>
                                </select>
                                <button type="button" class="btn btn-primary" onclick="insertVariableFromSelect('addTemplatePrompt', 'addTemplateVariableSelect')">
                                    <i class="bi bi-plus-circle"></i> 변수 추가
                                </button>
                            </div>
                        </div>
                        <textarea class="form-control" id="addTemplatePrompt" name="user_prompt_template" rows="10" required 
                                  placeholder="위에서 변수를 선택하고 추가 버튼을 눌러 템플릿에 삽입하세요."></textarea>
                        <small class="text-muted">변수는 실제 상품 정보로 자동 치환됩니다.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 템플릿 수정 모달 -->
<div class="modal fade" id="editTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> 프롬프트 템플릿 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editTemplateId">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">템플릿 이름 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editTemplateName" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">분류 <span class="text-danger">*</span></label>
                        <select class="form-select" id="editTemplateType" required>
                            <option value="alternative">대안성</option>
                            <option value="informational">정보성</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0">사용자 프롬프트 템플릿 <span class="text-danger">*</span></label>
                        <div class="input-group input-group-sm" style="width: auto;">
                            <select class="form-select" id="editTemplateVariableSelect" style="width: 200px;">
                                <option value="">변수 선택</option>
                                <option value="타겟_키워드">🎯 타겟 키워드 (랜덤)</option>
                                <option value="product_name">1. 우리제품명</option>
                                <option value="core_value">2. 우리 제품의 핵심</option>
                                <option value="sub_core_value">3. 서브 핵심</option>
                                <option value="size_weight">4. 사이즈 & 무게</option>
                                <option value="difference">5. 타사 차별점</option>
                                <option value="famous_brands">6. 유명 브랜드들</option>
                                <option value="market_problem">7. 시장 문제점</option>
                                <option value="our_price">8. 우리 가격</option>
                                <option value="market_avg_price">9. 시장 평균 가격</option>
                                <option value="target_age">10. 예상 연령대</option>
                                <option value="target_gender">11. 예상 성별</option>
                                <option value="additional_info">12. 기타 특이사항</option>
                                <option value="marketing_link">마케팅 링크</option>
                            </select>
                            <button type="button" class="btn btn-primary" onclick="insertVariableFromSelect('editTemplatePrompt', 'editTemplateVariableSelect')">
                                <i class="bi bi-plus-circle"></i> 변수 추가
                            </button>
                        </div>
                    </div>
                    <textarea class="form-control" id="editTemplatePrompt" rows="10" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="updateTemplate()">저장</button>
            </div>
        </div>
    </div>
</div>

<!-- 프롬프트 추가 모달 -->
<div class="modal fade" id="addPromptModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-chat-dots"></i> AI 프롬프트 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="savePrompt(event)">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">상품 선택 <span class="text-danger">*</span></label>
                            <select class="form-select" name="ai_product_id" id="promptProductSelect" required>
                                <option value="">선택하세요</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">키워드 분류 <span class="text-danger">*</span></label>
                            <select class="form-select" name="keyword_classification" id="promptTypeSelect" onchange="loadTemplatesForType()" required>
                                <option value="">선택하세요</option>
                                <option value="alternative">대안성</option>
                                <option value="informational">정보성</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">템플릿 선택 (선택사항)</label>
                            <select class="form-select" id="templateSelectForPrompt" onchange="loadTemplateContent()">
                                <option value="">직접 입력</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">시스템 프롬프트 <span class="text-danger">*</span></label>
                            <div class="btn-group btn-group-sm">
                                <select class="form-select form-select-sm" id="systemPromptVarSelect" style="width: 180px;">
                                    <option value="">변수 선택</option>
                                    <option value="타겟_키워드">🎯 타겟 키워드</option>
                                    <option value="product_name">1. 우리제품명</option>
                                    <option value="core_value">2. 제품 핵심</option>
                                    <option value="marketing_link">마케팅 링크</option>
                                </select>
                                <button type="button" class="btn btn-primary btn-sm" onclick="insertVariableFromSelect('systemPromptArea', 'systemPromptVarSelect')">
                                    <i class="bi bi-plus-circle"></i> 추가
                                </button>
                            </div>
                        </div>
                        <textarea class="form-control" id="systemPromptArea" name="system_prompt" rows="4" required 
                                  placeholder="AI의 역할과 행동 방식을 정의합니다."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">사용자 프롬프트 <span class="text-danger">*</span></label>
                            <div class="btn-group btn-group-sm">
                                <select class="form-select form-select-sm" id="promptVariableSelect" style="width: 180px;">
                                    <option value="">변수 선택</option>
                                    <option value="타겟_키워드">🎯 타겟 키워드</option>
                                    <option value="product_name">1. 우리제품명</option>
                                    <option value="core_value">2. 제품 핵심</option>
                                    <option value="sub_core_value">3. 서브 핵심</option>
                                    <option value="size_weight">4. 사이즈&무게</option>
                                    <option value="difference">5. 타사 차별점</option>
                                    <option value="famous_brands">6. 유명 브랜드</option>
                                    <option value="market_problem">7. 시장 문제점</option>
                                    <option value="our_price">8. 우리 가격</option>
                                    <option value="market_avg_price">9. 시장 평균가</option>
                                    <option value="target_age">10. 연령대</option>
                                    <option value="target_gender">11. 성별</option>
                                    <option value="additional_info">12. 특이사항</option>
                                    <option value="marketing_link">마케팅 링크</option>
                                </select>
                                <button type="button" class="btn btn-primary btn-sm" onclick="insertVariableFromSelect('userPromptArea', 'promptVariableSelect')">
                                    <i class="bi bi-plus-circle"></i> 추가
                                </button>
                                <button type="button" class="btn btn-success btn-sm" onclick="insertImageGenerationPrompt('userPromptArea')">
                                    <i class="bi bi-image"></i> 이미지 생성
                                </button>
                            </div>
                        </div>
                        <textarea class="form-control" id="userPromptArea" name="user_prompt" rows="10" required 
                                  placeholder="실제 요청 내용을 작성합니다. 변수는 자동으로 치환됩니다."></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Temperature</label>
                            <input type="number" class="form-control" name="temperature" value="0.7" step="0.1" min="0" max="1" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Max Tokens</label>
                            <input type="number" class="form-control" name="max_tokens" value="2000" min="100" max="64000" required>
                            <small class="text-muted">최대 64,000</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">이미지 생성</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="generate_images" id="generateImages">
                                <label class="form-check-label" for="generateImages">
                                    이미지 3장 자동 생성
                                </label>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="apply_cafe_context" id="applyCafeContext">
                                <label class="form-check-label" for="applyCafeContext">
                                    카페 특성 반영
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 키워드 관리 모달 -->
<div class="modal fade" id="manageKeywordsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-key"></i> 키워드 관리</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="keywordProductId">
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">키워드 목록</h6>
                    <button type="button" class="btn btn-success btn-sm" onclick="syncKeywordsFromMarketing()">
                        <i class="bi bi-arrow-repeat"></i> 마케팅에서 동기화
                    </button>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>안내:</strong> 동기화하면 마케팅 상품의 키워드가 추가됩니다. 각 키워드를 대안성/정보성으로 분류하세요.
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 40%;">키워드</th>
                                <th style="width: 30%;">분류</th>
                                <th style="width: 15%;">활성</th>
                                <th style="width: 15%;">관리</th>
                            </tr>
                        </thead>
                        <tbody id="keywordsTableBody">
                            <tr><td colspan="4" class="text-center">로딩 중...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-primary btn-sm" onclick="showAddKeywordForm()">
                        <i class="bi bi-plus-circle"></i> 키워드 추가
                    </button>
                </div>
                
                <!-- 키워드 추가 폼 (숨김) -->
                <div id="addKeywordForm" class="mt-3" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <h6>새 키워드 추가</h6>
                            <form onsubmit="event.preventDefault(); saveNewKeyword();">
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <input type="text" class="form-control" id="newKeywordText" placeholder="키워드 입력" required>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <select class="form-select" id="newKeywordType">
                                            <option value="unclassified">미분류</option>
                                            <option value="alternative">대안성</option>
                                            <option value="informational">정보성</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <button type="submit" class="btn btn-primary w-100">추가</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 레퍼런스 관리 모달 -->
<div class="modal fade" id="manageReferencesModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-book"></i> 레퍼런스 관리</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="referenceProductId">
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">레퍼런스 목록</h6>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary btn-sm" onclick="showAddReferenceForm()">
                            <i class="bi bi-plus-circle"></i> 레퍼런스 추가
                        </button>
                        <button type="button" class="btn btn-success btn-sm" onclick="syncReferencesFromMarketing()">
                            <i class="bi bi-arrow-repeat"></i> 마케팅에서 동기화
                        </button>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>안내:</strong> 동기화는 마케팅 레퍼런스를 가져옵니다(미분류). AI 쪽 수정은 마케팅에 영향 없습니다.
                </div>
                
                <!-- 레퍼런스 추가 폼 (숨김) -->
                <div id="addReferenceForm" class="card mb-3" style="display: none;">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">새 레퍼런스 추가</h6>
                    </div>
                    <div class="card-body">
                        <form onsubmit="event.preventDefault(); saveNewReference();">
                            <div class="mb-3">
                                <label class="form-label">제목 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="newRefTitle" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">분류 <span class="text-danger">*</span></label>
                                <select class="form-select" id="newRefType" required>
                                    <option value="unclassified">미분류</option>
                                    <option value="alternative">대안성</option>
                                    <option value="informational">정보성</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">본문 내용 <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="newRefContent" rows="8" required></textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">저장</button>
                                <button type="button" class="btn btn-secondary" onclick="hideAddReferenceForm()">취소</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 35%;">제목</th>
                                <th style="width: 15%;">AI 분류</th>
                                <th style="width: 10%;">원본 타입</th>
                                <th style="width: 25%;">내용 미리보기</th>
                                <th style="width: 15%;">관리</th>
                            </tr>
                        </thead>
                        <tbody id="referencesTableBody">
                            <tr><td colspan="5" class="text-center">로딩 중...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 레퍼런스 상세 보기 모달 (마케팅 스타일) -->
<div class="modal fade" id="viewReferenceModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-eye"></i> 레퍼런스 상세 보기</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="viewRefId">
                
                <!-- 제목 -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0" id="viewRefTitle"></h5>
                    </div>
                </div>
                
                <!-- 본문 -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-file-text"></i> 본문 내용</h6>
                    </div>
                    <div class="card-body">
                        <div id="viewRefContent" style="white-space: pre-wrap; line-height: 1.8;"></div>
                    </div>
                </div>
                
                <!-- 댓글 -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-chat-dots"></i> 댓글 (<span id="viewRefCommentCount">0</span>개)</h6>
                    </div>
                    <div class="card-body">
                        <div id="viewRefComments"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 레퍼런스 수정 모달 -->
<div class="modal fade" id="editReferenceModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> 레퍼런스 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editRefId">
                <input type="hidden" id="editAiRefId">
                
                <div class="mb-3">
                    <label class="form-label">제목 <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="editRefTitle" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">AI 분류 <span class="text-danger">*</span></label>
                    <select class="form-select" id="editRefType" required>
                        <option value="unclassified">미분류</option>
                        <option value="alternative">대안성 (구매 관련)</option>
                        <option value="informational">정보성 (정보 검색)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">본문 내용 <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="editRefContent" rows="10" required></textarea>
                </div>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>주의:</strong> AI 쪽에서 수정한 내용은 마케팅-카페에 동기화되지 않습니다.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="updateReferenceContent()">저장</button>
            </div>
        </div>
    </div>
</div>

<!-- AI 프롬프트 수정 모달 -->
<div class="modal fade" id="editAIPromptModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> AI 프롬프트 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="event.preventDefault(); updatePrompt();">
                <input type="hidden" id="editPromptId">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">상품 선택 <span class="text-danger">*</span></label>
                            <select class="form-select" id="editPromptProduct" required>
                                <option value="">선택하세요</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">키워드 분류 <span class="text-danger">*</span></label>
                            <select class="form-select" id="editPromptClassification" required>
                                <option value="alternative">대안성</option>
                                <option value="informational">정보성</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">시스템 프롬프트 <span class="text-danger">*</span></label>
                            <div class="btn-group btn-group-sm">
                                <select class="form-select form-select-sm" id="editSystemPromptVarSelect" style="width: 180px;">
                                    <option value="">변수 선택</option>
                                    <option value="타겟_키워드">🎯 타겟 키워드</option>
                                    <option value="product_name">1. 우리제품명</option>
                                    <option value="core_value">2. 제품 핵심</option>
                                    <option value="marketing_link">마케팅 링크</option>
                                </select>
                                <button type="button" class="btn btn-primary btn-sm" onclick="insertVariableFromSelect('editPromptSystem', 'editSystemPromptVarSelect')">
                                    <i class="bi bi-plus-circle"></i> 추가
                                </button>
                            </div>
                        </div>
                        <textarea class="form-control" id="editPromptSystem" rows="4" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">사용자 프롬프트 <span class="text-danger">*</span></label>
                            <div class="btn-group btn-group-sm">
                                <select class="form-select form-select-sm" id="editPromptVarSelect" style="width: 180px;">
                                    <option value="">변수 선택</option>
                                    <option value="타겟_키워드">🎯 타겟 키워드</option>
                                    <option value="product_name">1. 우리제품명</option>
                                    <option value="core_value">2. 제품 핵심</option>
                                    <option value="sub_core_value">3. 서브 핵심</option>
                                    <option value="size_weight">4. 사이즈&무게</option>
                                    <option value="difference">5. 타사 차별점</option>
                                    <option value="famous_brands">6. 유명 브랜드</option>
                                    <option value="market_problem">7. 시장 문제점</option>
                                    <option value="our_price">8. 우리 가격</option>
                                    <option value="market_avg_price">9. 시장 평균가</option>
                                    <option value="target_age">10. 연령대</option>
                                    <option value="target_gender">11. 성별</option>
                                    <option value="additional_info">12. 특이사항</option>
                                    <option value="marketing_link">마케팅 링크</option>
                                </select>
                                <button type="button" class="btn btn-primary btn-sm" onclick="insertVariableFromSelect('editPromptUser', 'editPromptVarSelect')">
                                    <i class="bi bi-plus-circle"></i> 추가
                                </button>
                                <button type="button" class="btn btn-success btn-sm" onclick="insertImageGenerationPrompt('editPromptUser')">
                                    <i class="bi bi-image"></i> 이미지 생성
                                </button>
                            </div>
                        </div>
                        <textarea class="form-control" id="editPromptUser" rows="10" required></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Temperature</label>
                            <input type="number" class="form-control" id="editPromptTemp" step="0.1" min="0" max="1" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Max Tokens</label>
                            <input type="number" class="form-control" id="editPromptTokens" min="100" max="64000" required>
                            <small class="text-muted">최대 64,000</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">옵션</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="editPromptImages">
                                <label class="form-check-label">이미지 3장 생성</label>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="editPromptCafeContext">
                                <label class="form-check-label">카페 특성 반영</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- AI 연동 추가 모달 -->
<div class="modal fade" id="addConnectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-link-45deg"></i> 카페-계정 연동 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="event.preventDefault(); saveConnection();">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>안내:</strong> 카페-계정을 연동하면 AI 자동 발행에 사용됩니다.
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">계정 선택 <span class="text-danger">*</span></label>
                        <select class="form-select" id="connectionAccountSelect" required>
                            <option value="">선택하세요</option>
                        </select>
                        <small class="text-muted">자동화 계정 목록입니다.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">카페 선택 <span class="text-danger">*</span></label>
                        <select class="form-select" id="connectionCafeSelect" required>
                            <option value="">선택하세요</option>
                        </select>
                        <small class="text-muted">자동화 카페 목록입니다.</small>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="connectionIsMember" checked>
                            <label class="form-check-label" for="connectionIsMember">
                                카페 가입 완료
                            </label>
                        </div>
                        <small class="text-muted">가입하지 않았다면 체크 해제하세요.</small>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>다음 단계:</strong><br>
                        1. 연동 추가<br>
                        2. 네이버에서 가입인사글 2개 작성<br>
                        3. URL을 연동 관리에서 등록
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- URL 관리 모달 -->
<div class="modal fade" id="manageDraftPostsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title mb-2"><i class="bi bi-link-45deg"></i> 신규발행 글 URL 관리</h5>
                    <div class="text-muted small">
                        <i class="bi bi-cup-hot"></i> 카페: <strong id="draftCafeNameHeader">-</strong> | 
                        <i class="bi bi-person"></i> 계정: <strong id="draftAccountNameHeader">-</strong>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="draftLinkId">
                
                <div class="alert alert-info">
                    <i class="bi bi-lightbulb"></i>
                    <strong>안내:</strong><br>
                    1. 네이버 카페에서 가입인사글 2개 작성<br>
                    2. 작성한 글의 URL을 여기에 등록<br>
                    3. AI가 나중에 "수정 발행"으로 내용 교체
                </div>
                
                <!-- URL 추가 폼 -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-plus-circle"></i> URL 추가</h6>
                    </div>
                    <div class="card-body">
                        <form onsubmit="event.preventDefault(); addDraftPost();">
                            <div class="mb-3">
                                <label class="form-label">글 URL <span class="text-danger">*</span></label>
                                <input type="url" class="form-control" id="draftPostUrl" 
                                       placeholder="https://cafe.naver.com/카페명/123456" required>
                                <small class="text-muted">가입인사글의 전체 URL을 입력하세요.</small>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> URL 추가
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- URL 목록 -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-list-ul"></i> 등록된 URL 목록</h6>
                    </div>
                    <div class="card-body">
                        <div id="draftPostsList">
                            <p class="text-center text-muted">로딩 중...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- AI 글 생성 테스트 모달 -->
<div class="modal fade" id="testGenerationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-magic"></i> AI 글 생성 테스트</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-lightbulb"></i>
                    <strong>안내:</strong> 상품을 선택하면 해당 템플릿과 프롬프트가 표시됩니다.
                </div>
                
                <div class="mb-3">
                    <label class="form-label">1. 상품 선택 <span class="text-danger">*</span></label>
                    <select class="form-select" id="testProductSelect" onchange="updateTestTemplates()" required>
                        <option value="">상품을 선택하세요</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">2. 템플릿 선택 (선택사항)</label>
                    <select class="form-select" id="testTemplateSelect">
                        <option value="">먼저 상품을 선택하세요</option>
                    </select>
                    <small class="text-muted">템플릿을 참고로만 보고 싶을 때 선택하세요.</small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">3. 프롬프트 선택 <span class="text-danger">*</span></label>
                    <select class="form-select" id="testPromptSelect" onchange="updateTestKeywords()" required>
                        <option value="">먼저 상품을 선택하세요</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">4. 키워드 선택 <span class="text-danger">*</span></label>
                    <select class="form-select" id="testKeywordSelect" required>
                        <option value="">먼저 프롬프트를 선택하세요</option>
                    </select>
                    <small class="text-muted">프롬프트의 분류에 맞는 키워드만 표시됩니다.</small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">5. 카페 선택 <span class="text-danger">*</span></label>
                    <select class="form-select" id="testCafeSelect" onchange="showCafeCharacteristics()" required>
                        <option value="">카페를 선택하세요</option>
                    </select>
                </div>
                
                <!-- 카페 특성 미리보기 -->
                <div id="cafeCharacteristicsPreview" class="alert alert-light" style="display: none;">
                    <h6><i class="bi bi-cup-hot"></i> 카페 특성</h6>
                    <p id="cafeCharacteristicsText" class="mb-0"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-success" onclick="generateTestContent()">
                    <i class="bi bi-magic"></i> AI 생성 시작
                </button>
            </div>
        </div>
    </div>
</div>

<!-- AI 생성 결과 모달 -->
<div class="modal fade" id="testResultModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-check-circle"></i> AI 생성 결과</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="testResultContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">생성 중...</span>
                        </div>
                        <p class="mt-3">AI가 글을 생성하고 있습니다...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 스케줄 추가 모달 -->
<div class="modal fade" id="addScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-calendar-check"></i> AI 스케줄 생성</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="saveSchedule(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">상품 선택 <span class="text-danger">*</span></label>
                        <select class="form-select" name="ai_product_id" id="scheduleProductSelect" onchange="showKeywordCount()" required>
                            <option value="">선택하세요</option>
                        </select>
                        <small id="keywordCountDisplay" class="text-muted"></small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">프롬프트 선택 <span class="text-danger">*</span></label>
                        <select class="form-select" name="prompt_id" id="schedulePromptSelect" required>
                            <option value="">먼저 상품을 선택하세요</option>
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">시작일 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="start_date" id="scheduleStartDate" onchange="calculateTotal()" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">종료일 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="end_date" id="scheduleEndDate" onchange="calculateTotal()" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">하루 작성 개수 <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="daily_post_count" id="dailyPostCount" min="1" onchange="calculateTotal()" required>
                    </div>
                    
                    <div id="totalPostsDisplay" class="alert alert-info" style="display: none;">
                        <i class="bi bi-info-circle"></i> 예상 총 글 발행 수: <strong id="totalPostsCount">0</strong>개
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">생성</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

