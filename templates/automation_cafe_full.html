{% extends "base.html" %}
{% block title %}AI ìë™í™” - ì¹´í˜ ê´€ë¦¬{% endblock %}

{% block head %}
{{ super() }}
<style>
    .automation-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* íƒ­ ìŠ¤íƒ€ì¼ */
    .nav-tabs {
        border-bottom: 2px solid #e1e8ed;
        margin-bottom: 30px;
    }
    
    .nav-tabs .nav-link {
        border: none;
        color: #636e72;
        font-weight: 600;
        padding: 15px 30px;
        transition: all 0.3s;
        position: relative;
    }
    
    .nav-tabs .nav-link:hover {
        color: #4A90E2;
        background: rgba(74, 144, 226, 0.05);
    }
    
    .nav-tabs .nav-link.active {
        color: #4A90E2;
        background: transparent;
    }
    
    .nav-tabs .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 3px;
        background: #4A90E2;
    }
    
    /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .content-card {
        background: white;
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        margin-bottom: 20px;
    }
    
    .card-header-custom {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e1e8ed;
    }
    
    .card-header-custom h4 {
        font-weight: 700;
        color: #2d3436;
        margin: 0;
    }
    
    /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .data-table thead th {
        background: linear-gradient(135deg, rgba(74, 144, 226, 0.1) 0%, rgba(91, 163, 245, 0.1) 100%);
        padding: 12px;
        text-align: left;
        font-weight: 700;
        color: #2d3436;
        font-size: 0.9rem;
        border-bottom: 2px solid #e1e8ed;
    }
    
    .data-table tbody tr {
        transition: all 0.2s;
        border-bottom: 1px solid #f1f3f5;
    }
    
    .data-table tbody tr:hover {
        background: rgba(74, 144, 226, 0.05);
    }
    
    .data-table tbody td {
        padding: 12px;
        color: #495057;
        font-size: 0.9rem;
    }
    
    /* ë°°ì§€ ìŠ¤íƒ€ì¼ */
    .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
    }
    
    .status-badge.online { background: #d4edda; color: #155724; }
    .status-badge.busy { background: #fff3cd; color: #856404; }
    .status-badge.offline { background: #f8d7da; color: #721c24; }
    .status-badge.active { background: #d4edda; color: #155724; }
    .status-badge.suspended { background: #f8d7da; color: #721c24; }
    
    /* ë¹ˆ ìƒíƒœ */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #adb5bd;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="automation-container">
    <h1 style="font-weight: 800; margin-bottom: 30px;">
        <i class="bi bi-robot"></i> ì¹´í˜ ìë™í™” ê´€ë¦¬
    </h1>
    
    <!-- í†µí•© íƒ­ (íœ´ë¨¼ + AI) -->
    <ul class="nav nav-tabs" role="tablist">
        <!-- AI ìë™í™” ë©”ì¸ íƒ­ë“¤ -->
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#ai-product-setup">
                <i class="bi bi-stars"></i> AI ìƒí’ˆ ì„¸íŒ…
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#ai-prompt-templates">
                <i class="bi bi-file-text"></i> AI í…œí”Œë¦¿
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#ai-prompts">
                <i class="bi bi-chat-dots"></i> AI í”„ë¡¬í”„íŠ¸
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#ai-schedules">
                <i class="bi bi-calendar-check"></i> AI ìŠ¤ì¼€ì¤„
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#ai-posts">
                <i class="bi bi-file-earmark-text"></i> AI ì‹ ê·œë°œí–‰
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#ai-connections">
                <i class="bi bi-link-45deg"></i> AI ì—°ë™
            </a>
        </li>
        
        <!-- ê³µí†µ ì„¤ì • íƒ­ë“¤ (ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼) -->
        <li class="nav-item dropdown ms-auto">
            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button">
                <i class="bi bi-gear"></i> ì„¤ì •
            </a>
            <ul class="dropdown-menu">
                <li><a class="nav-link" data-bs-toggle="tab" href="#dashboard">
                    <i class="bi bi-speedometer2"></i> ëŒ€ì‹œë³´ë“œ
                </a></li>
                <li><a class="nav-link" data-bs-toggle="tab" href="#pcs">
                    <i class="bi bi-pc-display"></i> PC ê´€ë¦¬
                </a></li>
                <li><a class="nav-link" data-bs-toggle="tab" href="#accounts">
                    <i class="bi bi-person-badge"></i> ê³„ì • ê´€ë¦¬
                </a></li>
                <li><a class="nav-link" data-bs-toggle="tab" href="#cafes">
                    <i class="bi bi-cup-hot"></i> ì¹´í˜ ê´€ë¦¬
                </a></li>
                <li><a class="nav-link" data-bs-toggle="tab" href="#prompts">
                    <i class="bi bi-chat-square-text"></i> í”„ë¡¬í”„íŠ¸ (íœ´ë¨¼)
                </a></li>
                <li><a class="nav-link" data-bs-toggle="tab" href="#schedules">
                    <i class="bi bi-calendar-week"></i> ìŠ¤ì¼€ì¤„ (íœ´ë¨¼)
                </a></li>
            </ul>
        </li>
    </ul>
    
    <!-- íƒ­ ì»¨í…ì¸  -->
    <div class="tab-content">
        <!-- ëŒ€ì‹œë³´ë“œ íƒ­ -->
        <div class="tab-pane fade" id="dashboard">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-speedometer2"></i> ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ</h4>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadTasks()">
                        <i class="bi bi-arrow-clockwise"></i> ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
                
                <!-- ì‘ì—… í íƒ­ -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#pending-tasks">
                            <i class="bi bi-hourglass-split"></i> ëŒ€ê¸° ì¤‘
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#in-progress-tasks">
                            <i class="bi bi-arrow-repeat"></i> ì§„í–‰ ì¤‘
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#completed-tasks">
                            <i class="bi bi-check-circle"></i> ì™„ë£Œ
                        </a>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- ëŒ€ê¸° ì¤‘ -->
                    <div class="tab-pane fade show active" id="pending-tasks">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>ëª¨ë“œ</th>
                                        <th>íƒ€ì…</th>
                                        <th>ì¹´í˜</th>
                                        <th>ìƒí’ˆ</th>
                                        <th>í‚¤ì›Œë“œ</th>
                                        <th>ìƒíƒœ</th>
                                        <th>PC</th>
                                        <th>ê³„ì •</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingTasksBody">
                                    <tr><td colspan="9" class="text-center text-muted">ë¡œë”© ì¤‘...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- ì§„í–‰ ì¤‘ -->
                    <div class="tab-pane fade" id="in-progress-tasks">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>ëª¨ë“œ</th>
                                        <th>ì¹´í˜</th>
                                        <th>PC</th>
                                        <th>ê³„ì •</th>
                                        <th>ì‹œì‘ ì‹œê°„</th>
                                    </tr>
                                </thead>
                                <tbody id="inProgressTasksBody">
                                    <tr><td colspan="6" class="text-center text-muted">ë¡œë”© ì¤‘...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- ì™„ë£Œ -->
                    <div class="tab-pane fade" id="completed-tasks">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>ëª¨ë“œ</th>
                                        <th>ì¹´í˜</th>
                                        <th>ìƒí’ˆ</th>
                                        <th>ì™„ë£Œ ì‹œê°„</th>
                                        <th>URL</th>
                                    </tr>
                                </thead>
                                <tbody id="completedTasksBody">
                                    <tr><td colspan="6" class="text-center text-muted">ë¡œë”© ì¤‘...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PC ê´€ë¦¬ íƒ­ -->
        <div class="tab-pane fade" id="pcs">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-pc-display"></i> PC ê´€ë¦¬</h4>
                    {% if is_admin %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPCModal">
                        <i class="bi bi-plus-circle"></i> PC ì¶”ê°€
                    </button>
                    {% endif %}
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>PC ë²ˆí˜¸</th>
                                <th>PC ì´ë¦„</th>
                                <th>IP ì£¼ì†Œ</th>
                                <th>ìƒíƒœ</th>
                                <th>CPU</th>
                                <th>ë©”ëª¨ë¦¬</th>
                                <th>ë§ˆì§€ë§‰ í†µì‹ </th>
                                <th>í˜„ì¬ ì‘ì—…</th>
                                {% if is_admin %}<th>ê´€ë¦¬</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody id="pcsTableBody">
                            <tr>
                                <td colspan="9" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split"></i> ë°ì´í„° ë¡œë”© ì¤‘...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ê³„ì • ê´€ë¦¬ íƒ­ -->
        <div class="tab-pane fade" id="accounts">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-person-badge"></i> ê³„ì • ê´€ë¦¬</h4>
                    {% if is_admin %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                        <i class="bi bi-plus-circle"></i> ê³„ì • ì¶”ê°€
                    </button>
                    {% endif %}
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ê³„ì • ID</th>
                                <th>í• ë‹¹ PC</th>
                                <th>ìƒíƒœ</th>
                                <th>ë¡œê·¸ì¸ ìƒíƒœ</th>
                                <th>ì‘ì„± ê¸€</th>
                                <th>ì‘ì„± ëŒ“ê¸€</th>
                                <th>ë§ˆì§€ë§‰ ì‚¬ìš©</th>
                                {% if is_admin %}<th>ê´€ë¦¬</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody id="accountsTableBody">
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split"></i> ë°ì´í„° ë¡œë”© ì¤‘...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ì¹´í˜ ê´€ë¦¬ íƒ­ -->
        <div class="tab-pane fade" id="cafes">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-cup-hot"></i> ì¹´í˜ ê´€ë¦¬</h4>
                    {% if is_admin %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCafeModal">
                        <i class="bi bi-plus-circle"></i> ì¹´í˜ ì¶”ê°€
                    </button>
                    {% endif %}
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ì¹´í˜ëª…</th>
                                <th>URL</th>
                                <th>ìƒíƒœ</th>
                                <th>ë“±ë¡ì¼</th>
                                {% if is_admin %}<th>ê´€ë¦¬</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody id="cafesTableBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split"></i> ë°ì´í„° ë¡œë”© ì¤‘...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ íƒ­ -->
        <div class="tab-pane fade" id="prompts">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-chat-square-text"></i> íœ´ë¨¼ í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ (ê¸°ì¡´)</h4>
                    {% if is_admin %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addHumanPromptModal">
                        <i class="bi bi-plus-circle"></i> í”„ë¡¬í”„íŠ¸ ì¶”ê°€
                    </button>
                    {% endif %}
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ì´ë¦„</th>
                                <th>íƒ€ì…</th>
                                <th>Temperature</th>
                                <th>Max Tokens</th>
                                <th>ìƒíƒœ</th>
                                <th>ë“±ë¡ì¼</th>
                                {% if is_admin %}<th>ê´€ë¦¬</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody id="promptsTableBody">
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split"></i> ë°ì´í„° ë¡œë”© ì¤‘...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ìŠ¤ì¼€ì¤„ ê´€ë¦¬ íƒ­ -->
        <div class="tab-pane fade" id="schedules">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-calendar-week"></i> ìŠ¤ì¼€ì¤„ ê´€ë¦¬</h4>
                    {% if is_admin %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createScheduleModal">
                        <i class="bi bi-plus-circle"></i> ìŠ¤ì¼€ì¤„ ìƒì„±
                    </button>
                    {% endif %}
                </div>
                
                <div class="alert alert-success">
                    <i class="bi bi-lightbulb"></i> 
                    <strong>Tip:</strong> ìŠ¤ì¼€ì¤„ì„ ìƒì„±í•˜ë©´ ìë™ìœ¼ë¡œ ì‘ì—… íì— ì¶”ê°€ë©ë‹ˆë‹¤.
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ë‚ ì§œ</th>
                                <th>ëª¨ë“œ</th>
                                <th>ìƒí’ˆ</th>
                                <th>í‚¤ì›Œë“œ</th>
                                <th>í”„ë¡¬í”„íŠ¸</th>
                                <th>ìƒíƒœ</th>
                                <th>ì‘ì—…</th>
                                {% if is_admin %}<th>ê´€ë¦¬</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody id="schedulesTableBody">
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    <i class="bi bi-hourglass-split"></i> ë°ì´í„° ë¡œë”© ì¤‘...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ============================================ -->
        <!-- AI ìë™í™” íƒ­ë“¤ -->
        <!-- ============================================ -->
        
        <!-- AI ìƒí’ˆ ì„¸íŒ… íƒ­ -->
        <div class="tab-pane fade show active" id="ai-product-setup">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-stars"></i> AI ìƒí’ˆ ì„¸íŒ…</h4>
                    <button class="btn btn-primary" onclick="showAddProductModal()">
                        <i class="bi bi-plus-circle"></i> ìƒí’ˆ ì¶”ê°€
                    </button>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>ì•ˆë‚´:</strong> ë§ˆì¼€íŒ… ìƒí’ˆì„ AI ìë™í™”ì— ì¶”ê°€í•˜ê³  ìƒì„¸ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
                </div>
                
                <div id="aiProductList" class="row">
                    <!-- JavaScriptë¡œ ë¡œë“œ -->
                </div>
            </div>
        </div>
        
        <!-- AI í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ íƒ­ -->
        <div class="tab-pane fade" id="ai-prompt-templates">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-file-text"></i> AI í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿</h4>
                    <button class="btn btn-primary" onclick="showAddTemplateModal()">
                        <i class="bi bi-plus-circle"></i> í…œí”Œë¦¿ ì¶”ê°€
                    </button>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">ë¶„ë¥˜ í•„í„°</label>
                    <select class="form-select" id="templateTypeFilter" style="max-width: 200px;" onchange="loadPromptTemplates()">
                        <option value="all">ì „ì²´</option>
                        <option value="alternative">ëŒ€ì•ˆì„±</option>
                        <option value="informational">ì •ë³´ì„±</option>
                    </select>
                </div>
                
                <div id="promptTemplatesList">
                    <!-- JavaScriptë¡œ ë¡œë“œ -->
                </div>
            </div>
        </div>
        
        <!-- AI í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ íƒ­ -->
        <div class="tab-pane fade" id="ai-prompts">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-chat-dots"></i> AI í”„ë¡¬í”„íŠ¸ ê´€ë¦¬</h4>
                    <button class="btn btn-primary" onclick="showAddPromptModal()">
                        <i class="bi bi-plus-circle"></i> í”„ë¡¬í”„íŠ¸ ì¶”ê°€
                    </button>
                </div>
                
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-4">
                            <select class="form-select" id="promptProductFilter" onchange="loadPrompts()">
                                <option value="">ì „ì²´ ìƒí’ˆ</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="promptTypeFilter" onchange="loadPrompts()">
                                <option value="all">ì „ì²´ ë¶„ë¥˜</option>
                                <option value="alternative">ëŒ€ì•ˆì„±</option>
                                <option value="informational">ì •ë³´ì„±</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="promptsList">
                    <!-- JavaScriptë¡œ ë¡œë“œ -->
                </div>
            </div>
        </div>
        
        <!-- AI ìŠ¤ì¼€ì¤„ ê´€ë¦¬ íƒ­ -->
        <div class="tab-pane fade" id="ai-schedules">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-calendar-check"></i> AI ìŠ¤ì¼€ì¤„ ê´€ë¦¬</h4>
                    <button class="btn btn-primary" onclick="showAddScheduleModal()">
                        <i class="bi bi-plus-circle"></i> ìŠ¤ì¼€ì¤„ ìƒì„±
                    </button>
                </div>
                
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="scheduleProductSearch" 
                                   placeholder="ìƒí’ˆëª… ê²€ìƒ‰..." onkeyup="searchSchedules()">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="scheduleStatusFilter" onchange="searchSchedules()">
                                <option value="all">ì „ì²´ ìƒíƒœ</option>
                                <option value="scheduled">ì§„í–‰ì˜ˆì •</option>
                                <option value="in_progress">ì§„í–‰ì¤‘</option>
                                <option value="completed">ì¢…ë£Œ</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="schedulesList">
                    <!-- JavaScriptë¡œ ë¡œë“œ -->
                </div>
                
                <div id="schedulePagination" class="mt-3">
                    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
                </div>
            </div>
        </div>
        
        <!-- AI ì‹ ê·œ ë°œí–‰ ê´€ë¦¬ íƒ­ -->
        <div class="tab-pane fade" id="ai-posts">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-file-earmark-text"></i> AI ì‹ ê·œ ë°œí–‰ ê´€ë¦¬</h4>
                </div>
                
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-4">
                            <select class="form-select" id="postAccountFilter" onchange="loadGeneratedPosts()">
                                <option value="">ì „ì²´ ê³„ì •</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="postCafeFilter" onchange="loadGeneratedPosts()">
                                <option value="">ì „ì²´ ì¹´í˜</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="generatedPostsList">
                    <!-- JavaScriptë¡œ ë¡œë“œ -->
                </div>
            </div>
        </div>
        
        <!-- AI ì—°ë™ ê´€ë¦¬ íƒ­ -->
        <div class="tab-pane fade" id="ai-connections">
            <div class="content-card">
                <div class="card-header-custom">
                    <h4><i class="bi bi-link-45deg"></i> AI ì—°ë™ ê´€ë¦¬</h4>
                    <button class="btn btn-primary" onclick="showAddConnectionModal()">
                        <i class="bi bi-plus-circle"></i> ì—°ë™ ì¶”ê°€
                    </button>
                </div>
                
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>ì£¼ì˜:</strong> AI ìë™í™” ì „ìš© ì—°ë™ì…ë‹ˆë‹¤. íœ´ë¨¼ ëª¨ë“œ ê³„ì •/ì¹´í˜ì™€ëŠ” ë³„ê°œë¡œ ê´€ë¦¬ë©ë‹ˆë‹¤.
                </div>
                
                <div id="connectionsList">
                    <!-- JavaScriptë¡œ ë¡œë“œ -->
                </div>
            </div>
        </div>
        
    </div>
</div>

<!-- PC ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="addPCModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pc-display"></i> PC ì¶”ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="addPC(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">PC ë²ˆí˜¸ (1-8)</label>
                        <input type="number" class="form-control" name="pc_number" min="1" max="8" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">PC ì´ë¦„</label>
                        <input type="text" class="form-control" name="pc_name" placeholder="Worker PC #1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">IP ì£¼ì†Œ</label>
                        <input type="text" class="form-control" name="ip_address" placeholder="192.168.1.101" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ê³„ì • ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="addAccountModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-person-plus"></i> ê³„ì • ì¶”ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form onsubmit="addAccount(event)" id="addAccountForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ê³„ì • ID</label>
                        <input type="text" class="form-control" name="account_id" id="accountIdInput" required autocomplete="off">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" class="form-control" name="account_pw" id="accountPwInput" required autocomplete="new-password">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">í• ë‹¹ PC</label>
                        <select class="form-select" name="assigned_pc_id" id="accountPcSelect">
                            <option value="">ë‚˜ì¤‘ì— í• ë‹¹</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> ë“±ë¡
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ì¹´í˜ ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="addCafeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-cup-hot"></i> ì¹´í˜ ì¶”ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="addCafe(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ì¹´í˜ëª…</label>
                        <input type="text" class="form-control" name="cafe_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì¹´í˜ URL</label>
                        <input type="url" class="form-control" name="cafe_url" 
                               placeholder="https://cafe.naver.com/example" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ìŠ¤ì¼€ì¤„ ìƒì„± ëª¨ë‹¬ -->
<div class="modal fade" id="createScheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-calendar-plus"></i> ìŠ¤ì¼€ì¤„ ìë™ ìƒì„±</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="createSchedule(event)">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        <strong>ì•ˆë‚´:</strong> ì„¤ì •í•œ ê¸°ê°„ ë™ì•ˆ ìë™ìœ¼ë¡œ ìŠ¤ì¼€ì¤„ì„ ìƒì„±í•©ë‹ˆë‹¤. (ì£¼ë§ í¬í•¨)
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">ëª¨ë“œ ì„ íƒ</label>
                        <select class="form-select" name="mode" id="scheduleMode" required onchange="toggleModeFields()">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="human">íœ´ë¨¼ ëª¨ë“œ (ì‚¬ëŒì´ ì‘ì„±í•œ ê¸€)</option>
                            <option value="ai">AI ëª¨ë“œ (Claude ìë™ ìƒì„±)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">ìƒí’ˆ ì„ íƒ</label>
                        <select class="form-select" name="product_id" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <!-- JavaScriptë¡œ ë™ì  ë¡œë“œ -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">ì¹´í˜ ì„ íƒ</label>
                        <select class="form-select" name="cafe_id" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <!-- JavaScriptë¡œ ë™ì  ë¡œë“œ -->
                        </select>
                    </div>
                    
                    <div class="mb-3" id="promptField" style="display: none;">
                        <label class="form-label">í”„ë¡¬í”„íŠ¸ ì„ íƒ (AI ëª¨ë“œ)</label>
                        <select class="form-select" name="prompt_id">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <!-- JavaScriptë¡œ ë™ì  ë¡œë“œ -->
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ì‹œì‘ì¼</label>
                            <input type="date" class="form-control" name="start_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ì¢…ë£Œì¼</label>
                            <input type="date" class="form-control" name="end_date" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">í•˜ë£¨ ì‘ì„± ê°œìˆ˜</label>
                        <input type="number" class="form-control" name="daily_count" 
                               value="3" min="1" max="10" required>
                        <small class="text-muted">í•˜ë£¨ì— ì‘ì„±í•  ê¸€ ê°œìˆ˜ (1~10ê°œ, ì£¼ë§ í¬í•¨)</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-calendar-check"></i> ìŠ¤ì¼€ì¤„ ìƒì„±
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- íœ´ë¨¼ í”„ë¡¬í”„íŠ¸ ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="addHumanPromptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-chat-square-text"></i> íœ´ë¨¼ í”„ë¡¬í”„íŠ¸ ì¶”ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="addPrompt(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">í”„ë¡¬í”„íŠ¸ ì´ë¦„</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">íƒ€ì…</label>
                        <select class="form-select" name="prompt_type" required>
                            <option value="post">ê¸€ ì‘ì„±</option>
                            <option value="comment">ëŒ“ê¸€ ì‘ì„±</option>
                            <option value="reply">ëŒ€ëŒ“ê¸€ ì‘ì„±</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸</label>
                        <textarea class="form-control" name="system_prompt" rows="4" required
                                  placeholder="AIì˜ ì—­í• ê³¼ ì„±ê²©ì„ ì •ì˜í•˜ì„¸ìš”"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿</label>
                        <textarea class="form-control" name="user_prompt_template" rows="6" required
                                  placeholder="{product_name}, {keyword} ë³€ìˆ˜ ì‚¬ìš© ê°€ëŠ¥"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Temperature (0.0~1.0)</label>
                            <input type="number" class="form-control" name="temperature" 
                                   value="0.7" step="0.1" min="0" max="1" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Max Tokens</label>
                            <input type="number" class="form-control" name="max_tokens" 
                                   value="1000" min="100" max="4000" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ëŒ“ê¸€ ì›ê³  ê´€ë¦¬ ëª¨ë‹¬ -->
<div class="modal fade" id="commentScriptModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-chat-dots"></i> ëŒ“ê¸€ ì›ê³  ê´€ë¦¬</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form onsubmit="saveCommentScript(event)">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-lightbulb"></i> 
                        <strong>ëŒ“ê¸€ ì›ê³  í˜•ì‹:</strong><br>
                        <code>ê·¸ë£¹-ìˆœì„œ: PCë²ˆí˜¸ "ë‚´ìš©"</code><br><br>
                        <strong>ì˜ˆì‹œ:</strong><br>
                        <code>1-1: PC1 ë„ì™€ì£¼ì„¸ìš”ã… ã…œã… ã… ã… </code><br>
                        <code>1-2: PC2 ì €ë„ ê¶ê¸ˆí•˜ë„¤ìš”</code><br>
                        <code>1-3: PC1 ì˜¤ ëŒ€ë°•...</code><br><br>
                        <code>2-1: PC3 ë‹¤ë“¤ ê³ ë¯¼ì´... (ìƒˆ ëŒ“ê¸€)</code><br>
                        <code>2-2: PC1 ì™€ í— ëŒ€ë°•... (2-1ì— ëŒ€í•œ ëŒ€ëŒ“ê¸€)</code><br>
                    </div>
                    
                    <div id="scriptStats"></div>
                    
                    <input type="hidden" name="post_task_id" id="postTaskIdInput">
                    
                    <div class="mb-3">
                        <label class="form-label">ëŒ“ê¸€ ì›ê³  ì…ë ¥</label>
                        <textarea class="form-control" name="script_text" id="commentScriptText" 
                                  rows="15" required
                                  placeholder="1-1: PC1 ë„ì™€ì£¼ì„¸ìš”ã… ã…œã… ã… ã… 
1-2: PC2 ì €ë„ ê¶ê¸ˆí•˜ë„¤ìš”
1-3: PC1 ì˜¤ ëŒ€ë°•...

2-1: PC3 ë‹¤ë“¤ ê³ ë¯¼ì´...
2-2: PC1 ì™€ í— ëŒ€ë°•..."
                                  style="font-family: monospace;"></textarea>
                        <small class="text-muted">
                            ê·¸ë£¹ ë²ˆí˜¸ê°€ ë°”ë€Œë©´ ìƒˆ ëŒ“ê¸€, ê°™ì€ ê·¸ë£¹ì€ ëŒ€ëŒ“ê¸€ì…ë‹ˆë‹¤.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> ì €ì¥
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// ============================================
// ì„¤ì • ëª¨ë‹¬ í•¨ìˆ˜
// ============================================
function showSettings(tab) {
    const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
    modal.show();
    
    // í•´ë‹¹ íƒ­ í™œì„±í™”
    const tabLinks = {
        'dashboard': '#settings-dashboard',
        'pcs': '#settings-pcs',
        'accounts': '#settings-accounts',
        'cafes': '#settings-cafes'
    };
    
    // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
    document.querySelectorAll('#settingsModal .nav-link').forEach(link => {
        link.classList.remove('active');
    });
    document.querySelectorAll('#settingsModal .tab-pane').forEach(pane => {
        pane.classList.remove('show', 'active');
    });
    
    // ì„ íƒí•œ íƒ­ í™œì„±í™”
    const targetTab = tabLinks[tab];
    document.querySelector(`#settingsModal a[href="${targetTab}"]`)?.classList.add('active');
    document.querySelector(targetTab)?.classList.add('show', 'active');
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
document.addEventListener('DOMContentLoaded', function() {
    // AI í˜ì´ì§€ì—ì„œëŠ” íœ´ë¨¼ íƒ­ ì œê±°í–ˆìœ¼ë¯€ë¡œ loadAllData ìˆ˜ì • í•„ìš”
    // loadAllData();
    
    // 30ì´ˆë§ˆë‹¤ PC ìƒíƒœ ê°±ì‹ 
    setInterval(loadPCs, 30000);
    
    // ëª¨ë‹¬ ì—´ë¦´ ë•Œ ë°ì´í„° ë¡œë“œ ë° ì´ˆê¸°í™”
    const addAccountModal = document.getElementById('addAccountModal');
    if (addAccountModal) {
        addAccountModal.addEventListener('show.bs.modal', function() {
            // í¼ ë¦¬ì…‹
            const form = document.getElementById('addAccountForm');
            if (form) form.reset();
            
            // PC ëª©ë¡ ë¡œë“œ
            loadPCsForDropdown();
        });
        
        // ëª¨ë‹¬ ë‹«í ë•Œ í¼ ë¦¬ì…‹
        addAccountModal.addEventListener('hidden.bs.modal', function() {
            const form = document.getElementById('addAccountForm');
            if (form) form.reset();
        });
    }
    
    const createScheduleModal = document.getElementById('createScheduleModal');
    if (createScheduleModal) {
        createScheduleModal.addEventListener('show.bs.modal', function() {
            loadProductsForSchedule();
            loadPromptsForSchedule();
            loadCafesForSchedule();
        });
    }
});

// PC ë“œë¡­ë‹¤ìš´ ë¡œë“œ
async function loadPCsForDropdown() {
    try {
        const response = await fetch('/automation/api/pcs/list');
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('accountPcSelect');
            
            if (!select) {
                console.error('accountPcSelect ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // ê¸°ì¡´ ì˜µì…˜ ìœ ì§€í•˜ê³  PC ì¶”ê°€
            let html = '<option value="">ë‚˜ì¤‘ì— í• ë‹¹</option>';
            
            data.pcs.forEach(pc => {
                const statusIcon = pc.status === 'online' ? 'ğŸŸ¢' : 'ğŸ”´';
                html += `<option value="${pc.id}">${statusIcon} PC #${pc.pc_number} - ${pc.pc_name}</option>`;
            });
            
            select.innerHTML = html;
            console.log('âœ… PC ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', data.pcs.length);
        }
    } catch (error) {
        console.error('PC ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

async function loadAllData() {
    await loadPCs();
    await loadAccounts();
    await loadCafes();
    await loadPrompts();
    await loadSchedules();
    await loadTasks();
}

async function loadTasks() {
    await loadTasksByStatus('pending', 'pendingTasksBody');
    await loadTasksByStatus('in_progress', 'inProgressTasksBody');
    await loadTasksByStatus('completed', 'completedTasksBody');
}

async function loadTasksByStatus(status, tbodyId) {
    try {
        const response = await fetch(`/automation/api/tasks/list?status=${status}`);
        const data = await response.json();
        
        if (data.success) {
            displayTasks(data.tasks, tbodyId, status);
        }
    } catch (error) {
        console.error(`Task ë¡œë“œ ì˜¤ë¥˜ (${status}):`, error);
    }
}

function displayTasks(tasks, tbodyId, status) {
    const tbody = document.getElementById(tbodyId);
    
    if (tasks.length === 0) {
        const colSpan = status === 'completed' ? 6 : status === 'in_progress' ? 6 : 9;
        tbody.innerHTML = `
            <tr>
                <td colspan="${colSpan}" class="text-center text-muted">
                    ${status === 'pending' ? 'ëŒ€ê¸° ì¤‘ì¸' : status === 'in_progress' ? 'ì§„í–‰ ì¤‘ì¸' : 'ì™„ë£Œëœ'} ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    
    tasks.forEach(task => {
        const modeIcon = task.mode === 'human' ? 'ğŸ‘¤' : 'ğŸ¤–';
        const typeIcon = task.task_type === 'post' ? 'ğŸ“' : 'ğŸ’¬';
        
        if (status === 'pending') {
            const commentBtn = task.task_type === 'post' ? 
                `<button class="btn btn-sm btn-info" onclick="showCommentScriptModal(${task.id})" title="ëŒ“ê¸€ ì›ê³  ê´€ë¦¬">
                    <i class="bi bi-chat-dots"></i>
                </button>` : '';
            
            html += `
                <tr>
                    <td><strong>#${task.id}</strong></td>
                    <td><span class="task-badge ${task.mode}">${modeIcon} ${task.mode}</span></td>
                    <td>${typeIcon} ${task.task_type}</td>
                    <td>${task.cafe_name || '-'}</td>
                    <td>${task.product_name || '-'}</td>
                    <td><span class="badge bg-primary">${task.keyword_text || '-'}</span></td>
                    <td><span class="status-badge ${task.status}">${task.status}</span></td>
                    <td>${task.assigned_pc ? 'PC #' + task.assigned_pc : '-'}</td>
                    <td>${task.assigned_account || '-'} ${commentBtn}</td>
                </tr>
            `;
        } else if (status === 'in_progress') {
            html += `
                <tr>
                    <td><strong>#${task.id}</strong></td>
                    <td><span class="task-badge ${task.mode}">${modeIcon}</span></td>
                    <td>${task.cafe_name || '-'}</td>
                    <td>PC #${task.assigned_pc || '-'}</td>
                    <td>${task.assigned_account || '-'}</td>
                    <td>${task.started_at || '-'}</td>
                </tr>
            `;
        } else if (status === 'completed') {
            const commentBtn = task.task_type === 'post' && task.post_url ? 
                `<button class="btn btn-sm btn-success" onclick="createCommentTasks(${task.id})" title="ëŒ“ê¸€ Task ìƒì„±">
                    <i class="bi bi-plus-circle"></i> ëŒ“ê¸€
                </button>` : '';
            
            html += `
                <tr>
                    <td><strong>#${task.id}</strong></td>
                    <td><span class="task-badge ${task.mode}">${modeIcon}</span></td>
                    <td>${task.cafe_name || '-'}</td>
                    <td>${task.product_name || '-'}</td>
                    <td>${task.completed_at || '-'}</td>
                    <td>
                        ${task.post_url ? `<a href="${task.post_url}" target="_blank">ë³´ê¸°</a>` : '-'}
                        ${commentBtn}
                    </td>
                </tr>
            `;
        }
    });
    
    tbody.innerHTML = html;
}

async function loadPCs() {
    try {
        const response = await fetch('/automation/api/pcs/list');
        const data = await response.json();
        
        if (data.success) {
            displayPCs(data.pcs);
        }
    } catch (error) {
        console.error('PC ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

function displayPCs(pcs) {
    const tbody = document.getElementById('pcsTableBody');
    
    if (pcs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-muted">
                    <div class="empty-state">
                        <i class="bi bi-pc-display"></i>
                        <p>ë“±ë¡ëœ PCê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        <p>Worker Agentë¥¼ ì‹¤í–‰í•˜ë©´ ìë™ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    const html = pcs.map(pc => `
        <tr>
            <td><strong>#${pc.pc_number}</strong></td>
            <td>${pc.pc_name}</td>
            <td><code>${pc.ip_address}</code></td>
            <td><span class="status-badge ${pc.status}">${pc.status}</span></td>
            <td>${pc.cpu_usage ? pc.cpu_usage.toFixed(1) + '%' : '-'}</td>
            <td>${pc.memory_usage ? pc.memory_usage.toFixed(1) + '%' : '-'}</td>
            <td>${pc.last_heartbeat || '-'}</td>
            <td>${pc.current_task_id ? 'Task #' + pc.current_task_id : '-'}</td>
            ${window.is_admin ? `
            <td>
                <button class="btn btn-sm btn-danger" onclick="deletePC(${pc.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
            ` : ''}
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
}

async function loadAccounts() {
    try {
        const response = await fetch('/automation/api/accounts/list');
        const data = await response.json();
        
        if (data.success) {
            displayAccounts(data.accounts);
        }
    } catch (error) {
        console.error('ê³„ì • ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

function displayAccounts(accounts) {
    const tbody = document.getElementById('accountsTableBody');
    
    if (accounts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted">
                    ë“±ë¡ëœ ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤
                </td>
            </tr>
        `;
        return;
    }
    
    const html = accounts.map(acc => `
        <tr>
            <td><code>${acc.account_id}</code></td>
            <td>${acc.assigned_pc ? 'PC #' + acc.assigned_pc.pc_number : '-'}</td>
            <td><span class="status-badge ${acc.status}">${acc.status}</span></td>
            <td>${acc.login_status}</td>
            <td>${acc.total_posts}</td>
            <td>${acc.total_comments}</td>
            <td>${acc.last_used_at || '-'}</td>
            ${window.is_admin ? `
            <td>
                <button class="btn btn-sm btn-warning" onclick="editAccount(${acc.id})">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteAccount(${acc.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
            ` : ''}
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
}

async function loadCafes() {
    try {
        const response = await fetch('/automation/api/cafes/list');
        const data = await response.json();
        
        if (data.success) {
            displayCafes(data.cafes);
        }
    } catch (error) {
        console.error('ì¹´í˜ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

async function loadHumanPrompts() {
    try {
        const response = await fetch('/automation/api/prompts/list');
        const data = await response.json();
        
        if (data.success) {
            displayHumanPrompts(data.prompts);
        }
    } catch (error) {
        console.error('íœ´ë¨¼ í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

function displayHumanPrompts(prompts) {
    const tbody = document.getElementById('promptsTableBody');
    
    if (!tbody) return;
    
    if (prompts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">ë“±ë¡ëœ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
    }
    
    tbody.innerHTML = prompts.map(p => `
        <tr>
            <td>${p.name}</td>
            <td><span class="badge bg-info">${p.prompt_type}</span></td>
            <td>${p.temperature}</td>
            <td>${p.max_tokens}</td>
            <td><span class="badge ${p.is_active ? 'bg-success' : 'bg-secondary'}">${p.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}</span></td>
            <td>
                <button class="btn btn-sm btn-warning" onclick="editHumanPrompt(${p.id})"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-danger" onclick="deleteHumanPrompt(${p.id})"><i class="bi bi-trash"></i></button>
            </td>
        </tr>
    `).join('');
}

async function loadHumanSchedules() {
    // íœ´ë¨¼ ìŠ¤ì¼€ì¤„ ë¡œë“œ (ì¶”í›„ êµ¬í˜„)
    console.log('íœ´ë¨¼ ìŠ¤ì¼€ì¤„ ë¡œë“œ');
}

function displayCafes(cafes) {
    const tbody = document.getElementById('cafesTableBody');
    
    if (cafes.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">
                    ë“±ë¡ëœ ì¹´í˜ê°€ ì—†ìŠµë‹ˆë‹¤
                </td>
            </tr>
        `;
        return;
    }
    
    const html = cafes.map(cafe => `
        <tr>
            <td><strong>${cafe.name}</strong></td>
            <td><a href="${cafe.url}" target="_blank">${cafe.url}</a></td>
            <td><span class="status-badge ${cafe.status}">${cafe.status}</span></td>
            <td>${cafe.created_at}</td>
            ${window.is_admin ? `
            <td>
                <button class="btn btn-sm btn-danger" onclick="deleteCafe(${cafe.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
            ` : ''}
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
}

async function loadPrompts() {
    try {
        const response = await fetch('/automation/api/prompts/list');
        const data = await response.json();
        
        if (data.success) {
            displayPrompts(data.prompts);
        }
    } catch (error) {
        console.error('í”„ë¡¬í”„íŠ¸ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

function displayPrompts(prompts) {
    const tbody = document.getElementById('promptsTableBody');
    
    if (prompts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    ë“±ë¡ëœ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤
                </td>
            </tr>
        `;
        return;
    }
    
    const html = prompts.map(prompt => `
        <tr>
            <td><strong>${prompt.name}</strong></td>
            <td><span class="badge bg-primary">${prompt.prompt_type}</span></td>
            <td>${prompt.temperature}</td>
            <td>${prompt.max_tokens}</td>
            <td>${prompt.is_active ? 'ğŸŸ¢ í™œì„±' : 'ğŸ”´ ë¹„í™œì„±'}</td>
            <td>${prompt.created_at}</td>
            ${window.is_admin ? `
            <td>
                <button class="btn btn-sm btn-info" onclick="viewPrompt(${prompt.id})">
                    <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-sm btn-warning" onclick="editPrompt(${prompt.id})">
                    <i class="bi bi-pencil"></i>
                </button>
            </td>
            ` : ''}
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
}

// ê´€ë¦¬ì ê¶Œí•œ ì „ì—­ ë³€ìˆ˜
window.is_admin = {{ 'true' if is_admin else 'false' }};

// ===== ê³µí†µ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ =====

function closeModalCompletely(modalId) {
    // ëª¨ë‹¬ ì™„ì „íˆ ë‹«ê¸°
    const modalElement = document.getElementById(modalId);
    if (!modalElement) return;
    
    // Bootstrap ëª¨ë‹¬ ì¸ìŠ¤í„´ìŠ¤ ë‹«ê¸°
    const modal = bootstrap.Modal.getInstance(modalElement);
    if (modal) {
        modal.hide();
    }
    
    // ê°•ì œ ì •ë¦¬
    modalElement.classList.remove('show');
    modalElement.style.display = 'none';
    modalElement.setAttribute('aria-hidden', 'true');
    modalElement.removeAttribute('aria-modal');
    
    // backdrop ì œê±°
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(backdrop => backdrop.remove());
    
    // body í´ë˜ìŠ¤ ì •ë¦¬
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
}

// ===== ê´€ë¦¬ API í•¨ìˆ˜ë“¤ =====

async function addPC(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        const response = await fetch('/automation/api/pcs/register', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('âœ… PCê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
            bootstrap.Modal.getInstance(document.getElementById('addPCModal')).hide();
            loadPCs();
        } else {
            alert('âŒ ' + result.message);
        }
    } catch (error) {
        alert('âŒ PC ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        console.error(error);
    }
}

async function addAccount(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    // ë¡œë”© í‘œì‹œ
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ë“±ë¡ ì¤‘...';
    
    try {
        const response = await fetch('/automation/api/accounts/add', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        // ë²„íŠ¼ ë³µì›
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        
        if (result.success) {
            // ëª¨ë‹¬ ë‹«ê¸°
            closeModalCompletely('addAccountModal');
            
            // í¼ ë¦¬ì…‹
            form.reset();
            
            // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            loadAccounts();
            
            // ì„±ê³µ ë©”ì‹œì§€
            alert('âœ… ê³„ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        } else {
            alert('âŒ ' + result.message);
        }
    } catch (error) {
        // ë²„íŠ¼ ë³µì›
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        
        alert('âŒ ê³„ì • ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        console.error('ê³„ì • ì¶”ê°€ ì˜¤ë¥˜:', error);
    }
}

async function addCafe(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    try {
        const response = await fetch('/automation/api/cafes/add', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // ëª¨ë‹¬ ë‹«ê¸°
            closeModalCompletely('addCafeModal');
            
            form.reset();
            loadCafes();
            
            alert('âœ… ì¹´í˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        } else {
            alert('âŒ ' + result.message);
        }
    } catch (error) {
        alert('âŒ ì¹´í˜ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        console.error(error);
    }
}

async function addPrompt(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    try {
        const response = await fetch('/automation/api/prompts/add', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // ëª¨ë‹¬ ê°•ì œ ë‹«ê¸°
            closeModalCompletely('addPromptModal');
            
            form.reset();
            loadPrompts();
            
            alert('âœ… í”„ë¡¬í”„íŠ¸ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        } else {
            alert('âŒ ' + result.message);
        }
    } catch (error) {
        alert('âŒ í”„ë¡¬í”„íŠ¸ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        console.error(error);
    }
}

async function deletePC(id) {
    if (!confirm('ì •ë§ ì´ PCë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const response = await fetch(`/automation/api/pcs/${id}/delete`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('âœ… PCê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            loadPCs();
        } else {
            alert('âŒ ' + result.message);
        }
    } catch (error) {
        alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
}

async function deleteAccount(id) {
    if (!confirm('ì •ë§ ì´ ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const response = await fetch(`/automation/api/accounts/${id}/delete`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('âœ… ê³„ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            loadAccounts();
        } else {
            alert('âŒ ' + result.message);
        }
    } catch (error) {
        alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
}

async function deleteCafe(id) {
    if (!confirm('ì •ë§ ì´ ì¹´í˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const response = await fetch(`/automation/api/cafes/${id}/delete`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('âœ… ì¹´í˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            loadCafes();
        } else {
            alert('âŒ ' + result.message);
        }
    } catch (error) {
        alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
}

function editAccount(id) {
    alert('ê³„ì • ìˆ˜ì • ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.\n\ní˜„ì¬ëŠ” ì‚­ì œ í›„ ë‹¤ì‹œ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
}

// í”„ë¡¬í”„íŠ¸ ë³´ê¸°
async function viewPrompt(id) {
    try {
        const response = await fetch(`/automation/api/prompts/list`);
        const data = await response.json();
        
        if (data.success) {
            const prompt = data.prompts.find(p => p.id === id);
            
            if (!prompt) {
                alert('í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // ì„ì‹œ ëª¨ë‹¬ ìƒì„±
            const modalHtml = `
                <div class="modal fade" id="viewPromptModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="bi bi-eye"></i> í”„ë¡¬í”„íŠ¸ ë³´ê¸°</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">ì´ë¦„</label>
                                    <input type="text" class="form-control" value="${prompt.name}" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">íƒ€ì…</label>
                                    <input type="text" class="form-control" value="${prompt.prompt_type}" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Temperature</label>
                                    <input type="text" class="form-control" value="${prompt.temperature}" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Max Tokens</label>
                                    <input type="text" class="form-control" value="${prompt.max_tokens}" readonly>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" onclick="editPrompt(${id})">
                                    <i class="bi bi-pencil"></i> ìˆ˜ì •
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
            const existingModal = document.getElementById('viewPromptModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // ìƒˆ ëª¨ë‹¬ ì¶”ê°€
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // ëª¨ë‹¬ í‘œì‹œ
            const modal = new bootstrap.Modal(document.getElementById('viewPromptModal'));
            modal.show();
            
            // ëª¨ë‹¬ ë‹«í ë•Œ ì œê±°
            document.getElementById('viewPromptModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }
    } catch (error) {
        alert('í”„ë¡¬í”„íŠ¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        console.error(error);
    }
}

// í”„ë¡¬í”„íŠ¸ ìˆ˜ì •
async function editPrompt(id) {
    // viewPrompt ëª¨ë‹¬ ë‹«ê¸°
    const viewModal = document.getElementById('viewPromptModal');
    if (viewModal) {
        bootstrap.Modal.getInstance(viewModal)?.hide();
        viewModal.remove();
    }
    
    try {
        const response = await fetch(`/automation/api/prompts/list`);
        const data = await response.json();
        
        if (data.success) {
            const prompt = data.prompts.find(p => p.id === id);
            
            if (!prompt) {
                alert('í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // ìˆ˜ì • ëª¨ë‹¬ HTML
            const modalHtml = `
                <div class="modal fade" id="editPromptModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="bi bi-pencil"></i> í”„ë¡¬í”„íŠ¸ ìˆ˜ì •</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form id="editPromptForm">
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">í”„ë¡¬í”„íŠ¸ ì´ë¦„</label>
                                        <input type="text" class="form-control" name="name" value="${prompt.name}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">íƒ€ì…</label>
                                        <select class="form-select" name="prompt_type" required>
                                            <option value="post" ${prompt.prompt_type === 'post' ? 'selected' : ''}>ê¸€ ì‘ì„±</option>
                                            <option value="comment" ${prompt.prompt_type === 'comment' ? 'selected' : ''}>ëŒ“ê¸€ ì‘ì„±</option>
                                            <option value="reply" ${prompt.prompt_type === 'reply' ? 'selected' : ''}>ëŒ€ëŒ“ê¸€ ì‘ì„±</option>
                                        </select>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Temperature</label>
                                            <input type="number" class="form-control" name="temperature" value="${prompt.temperature}" step="0.1" min="0" max="1" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Max Tokens</label>
                                            <input type="number" class="form-control" name="max_tokens" value="${prompt.max_tokens}" min="100" max="4000" required>
                                        </div>
                                    </div>
                                    <div class="alert alert-info">
                                        <i class="bi bi-lightbulb"></i> ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì™€ ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ëŠ” ë³´ì•ˆìƒ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ì¶”ê°€í•´ì£¼ì„¸ìš”.
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-lg"></i> ì €ì¥
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
            const existingModal = document.getElementById('editPromptModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // ìƒˆ ëª¨ë‹¬ ì¶”ê°€
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // ëª¨ë‹¬ í‘œì‹œ
            const modal = new bootstrap.Modal(document.getElementById('editPromptModal'));
            modal.show();
            
            // form submit ì´ë²¤íŠ¸
            document.getElementById('editPromptForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                
                try {
                    const updateResponse = await fetch(`/automation/api/prompts/${id}/update`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await updateResponse.json();
                    
                    if (result.success) {
                        modal.hide();
                        loadPrompts();
                        alert('âœ… í”„ë¡¬í”„íŠ¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    } else {
                        alert('âŒ ' + result.message);
                    }
                } catch (error) {
                    alert('âŒ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                    console.error(error);
                }
            });
            
            // ëª¨ë‹¬ ë‹«í ë•Œ ì œê±°
            document.getElementById('editPromptModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }
    } catch (error) {
        alert('í”„ë¡¬í”„íŠ¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        console.error(error);
    }
}

// ===== ìŠ¤ì¼€ì¤„ ìƒì„± ê´€ë ¨ í•¨ìˆ˜ =====

async function loadProductsForSchedule() {
    try {
        const response = await fetch('/automation/api/products/list');
        const data = await response.json();
        
        if (data.success) {
            const select = document.querySelector('#createScheduleModal select[name="product_id"]');
            
            let html = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            
            data.products.forEach(product => {
                html += `<option value="${product.id}">${product.name}</option>`;
            });
            
            select.innerHTML = html;
        }
    } catch (error) {
        console.error('ìƒí’ˆ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

async function loadPromptsForSchedule() {
    try {
        const response = await fetch('/automation/api/prompts/list');
        const data = await response.json();
        
        if (data.success) {
            const select = document.querySelector('#createScheduleModal select[name="prompt_id"]');
            
            let html = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            
            data.prompts.filter(p => p.is_active && p.prompt_type === 'post').forEach(prompt => {
                html += `<option value="${prompt.id}">${prompt.name}</option>`;
            });
            
            select.innerHTML = html;
        }
    } catch (error) {
        console.error('í”„ë¡¬í”„íŠ¸ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

async function loadCafesForSchedule() {
    try {
        const response = await fetch('/automation/api/cafes/list');
        const data = await response.json();
        
        if (data.success) {
            const select = document.querySelector('#createScheduleModal select[name="cafe_id"]');
            
            let html = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            
            data.cafes.filter(c => c.status === 'active').forEach(cafe => {
                html += `<option value="${cafe.id}">${cafe.name}</option>`;
            });
            
            select.innerHTML = html;
        }
    } catch (error) {
        console.error('ì¹´í˜ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

function toggleModeFields() {
    const mode = document.getElementById('scheduleMode').value;
    const promptField = document.getElementById('promptField');
    
    if (mode === 'ai') {
        promptField.style.display = 'block';
        promptField.querySelector('select').required = true;
    } else {
        promptField.style.display = 'none';
        promptField.querySelector('select').required = false;
    }
}

async function loadSchedules() {
    try {
        const response = await fetch('/automation/api/schedules/list');
        const data = await response.json();
        
        if (data.success) {
            displaySchedules(data.schedules);
        }
    } catch (error) {
        console.error('ìŠ¤ì¼€ì¤„ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

function displaySchedules(schedules) {
    const tbody = document.getElementById('schedulesTableBody');
    
    if (schedules.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted">
                    ë“±ë¡ëœ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤
                </td>
            </tr>
        `;
        return;
    }
    
    const html = schedules.map(schedule => `
        <tr>
            <td>${schedule.scheduled_date}</td>
            <td><span class="task-badge ${schedule.mode}">${schedule.mode === 'human' ? 'ğŸ‘¤ íœ´ë¨¼' : 'ğŸ¤– AI'}</span></td>
            <td>${schedule.product_name || '-'}</td>
            <td><span class="badge bg-primary">${schedule.keyword_text}</span></td>
            <td>${schedule.prompt_name || '-'}</td>
            <td><span class="status-badge ${schedule.status}">${schedule.status}</span></td>
            <td>${schedule.task_count || 0}ê°œ</td>
            ${window.is_admin ? `
            <td>
                <button class="btn btn-sm btn-danger" onclick="deleteSchedule(${schedule.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
            ` : ''}
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
}

async function createSchedule(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    // ë¡œë”© í‘œì‹œ
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ìƒì„± ì¤‘...';
    
    try {
        const response = await fetch('/automation/api/schedules/create-auto', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        // ë²„íŠ¼ ë³µì›
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        
        if (result.success) {
            // ëª¨ë‹¬ ë‹«ê¸°
            closeModalCompletely('createScheduleModal');
            
            form.reset();
            loadSchedules();
            loadTasks();  // Task ëª©ë¡ë„ ìƒˆë¡œê³ ì¹¨
            
            alert('âœ… ìŠ¤ì¼€ì¤„ ' + result.count + 'ê°œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
        } else {
            alert('âŒ ' + result.message);
        }
    } catch (error) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        
        alert('âŒ ìŠ¤ì¼€ì¤„ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        console.error(error);
    }
}

async function deleteSchedule(id) {
    if (!confirm('ì •ë§ ì´ ìŠ¤ì¼€ì¤„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const response = await fetch(`/automation/api/schedules/${id}/delete`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('âœ… ìŠ¤ì¼€ì¤„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            loadSchedules();
        } else {
            alert('âŒ ' + result.message);
        }
    } catch (error) {
        alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
}

// ============================================
// ëŒ“ê¸€ ì›ê³  ê´€ë¦¬ í•¨ìˆ˜
// ============================================

async function showCommentScriptModal(taskId) {
    const modal = document.getElementById('commentScriptModal');
    document.getElementById('postTaskIdInput').value = taskId;
    
    // ê¸°ì¡´ ëŒ“ê¸€ ì›ê³  ë¡œë“œ
    try {
        const response = await fetch(`/automation/api/comment-scripts/list?post_task_id=${taskId}`);
        const data = await response.json();
        
        if (data.success && data.scripts && data.scripts.length > 0) {
            // ì›ê³  í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
            let scriptText = '';
            data.scripts.forEach(script => {
                scriptText += `${script.group_number}-${script.sequence_number}: PC${script.pc_number} ${script.content}\n`;
            });
            document.getElementById('commentScriptText').value = scriptText;
            
            // í†µê³„ í‘œì‹œ
            document.getElementById('scriptStats').innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    ì €ì¥ëœ ëŒ“ê¸€: <strong>${data.total_count}ê°œ</strong> 
                    / ê·¸ë£¹: <strong>${data.total_groups}ê°œ</strong>
                </div>
            `;
        } else {
            document.getElementById('commentScriptText').value = '';
            document.getElementById('scriptStats').innerHTML = '';
        }
    } catch (error) {
        console.error('ëŒ“ê¸€ ì›ê³  ë¡œë“œ ì˜¤ë¥˜:', error);
    }
    
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

async function saveCommentScript(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    
    try {
        const response = await fetch('/automation/api/comment-scripts/parse', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`âœ… ${data.message}`);
            bootstrap.Modal.getInstance(document.getElementById('commentScriptModal')).hide();
            loadTasks();
        } else {
            let errorMsg = data.message || 'ëŒ“ê¸€ ì›ê³  ì €ì¥ ì‹¤íŒ¨';
            if (data.errors && data.errors.length > 0) {
                errorMsg += '\n\nì˜¤ë¥˜:\n' + data.errors.join('\n');
            }
            alert('âŒ ' + errorMsg);
        }
    } catch (error) {
        console.error('ëŒ“ê¸€ ì›ê³  ì €ì¥ ì˜¤ë¥˜:', error);
        alert('âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
}

async function createCommentTasks(taskId) {
    if (!confirm('ë³¸ë¬¸ ê¸€ ì‘ì„± ì™„ë£Œ í›„ ëŒ“ê¸€ Taskë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('post_task_id', taskId);
    
    try {
        const response = await fetch('/automation/api/comment-scripts/create-tasks', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`âœ… ${data.message}`);
            loadTasks();
        } else {
            alert('âŒ ' + data.message);
        }
    } catch (error) {
        console.error('ëŒ“ê¸€ Task ìƒì„± ì˜¤ë¥˜:', error);
        alert('âŒ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
}

// ============================================
// AI ìë™í™” ê´€ë ¨ í•¨ìˆ˜ë“¤
// ============================================

// AI ìƒí’ˆ ëª©ë¡ ë¡œë“œ
async function loadAIProducts() {
    try {
        const response = await fetch('/ai-automation/api/products');
        const data = await response.json();
        
        if (data.success) {
            const container = document.getElementById('aiProductList');
            container.innerHTML = '';
            
            if (data.products.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="bi bi-box-seam"></i>
                            <p>ë“±ë¡ëœ AI ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.<br>ìƒí’ˆì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            data.products.forEach(product => {
                const card = `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <img src="${product.thumbnail || '/static/images/no-image.png'}" 
                                         class="img-thumbnail me-3" style="width: 80px; height: 80px; object-fit: cover;">
                                    <div>
                                        <h5 class="card-title mb-1">${product.product_name}</h5>
                                        <small class="text-muted">${product.product_code}</small>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <span class="badge ${product.use_for_cafe ? 'bg-primary' : 'bg-secondary'}">ì¹´í˜</span>
                                    <span class="badge ${product.use_for_blog ? 'bg-success' : 'bg-secondary'}">ë¸”ë¡œê·¸</span>
                                </div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-primary" onclick="editAIProduct(${product.id})">
                                        <i class="bi bi-pencil"></i> ìƒì„¸ì •ë³´ ìˆ˜ì •
                                    </button>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-info" onclick="manageKeywords(${product.id})">
                                            <i class="bi bi-key"></i> í‚¤ì›Œë“œ
                                        </button>
                                        <button class="btn btn-sm btn-success" onclick="manageReferences(${product.id})">
                                            <i class="bi bi-book"></i> ë ˆí¼ëŸ°ìŠ¤
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        }
    } catch (error) {
        console.error('AI ìƒí’ˆ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

// íƒ­ ì „í™˜ ì‹œ ë°ì´í„° ë¡œë“œ
document.addEventListener('DOMContentLoaded', function() {
    // íƒ­ í´ë¦­ ì´ë²¤íŠ¸
    const tabLinks = document.querySelectorAll('[data-bs-toggle="tab"]');
    tabLinks.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (event) {
            const targetId = event.target.getAttribute('href').substring(1);
            
            switch(targetId) {
                // ì„¤ì • íƒ­ë“¤
                case 'dashboard':
                    loadTasks();
                    loadPCs();
                    break;
                case 'pcs':
                    loadPCs();
                    break;
                case 'accounts':
                    loadAccounts();
                    break;
                case 'cafes':
                    loadCafes();
                    break;
                case 'prompts':
                    loadHumanPrompts();
                    break;
                case 'schedules':
                    loadHumanSchedules();
                    break;
                // AI íƒ­ë“¤
                case 'ai-product-setup':
                    loadAIProducts();
                    break;
                case 'ai-prompt-templates':
                    loadPromptTemplates();
                    break;
                case 'ai-prompts':
                    loadPromptProductFilter();
                    loadPrompts();
                    break;
                case 'ai-schedules':
                    loadSchedules();
                    break;
                case 'ai-posts':
                    loadPostFilters();
                    loadGeneratedPosts();
                    break;
                case 'ai-connections':
                    loadConnections();
                    break;
            }
        });
    });
});

// í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ë¡œë“œ
async function loadPromptTemplates() {
    try {
        // í•„í„° ê°’ ê°€ì ¸ì˜¤ê¸°
        const typeFilter = document.getElementById('templateTypeFilter')?.value || 'all';
        
        const url = typeFilter === 'all' 
            ? '/ai-automation/api/prompt-templates' 
            : `/ai-automation/api/prompt-templates?type=${typeFilter}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            const container = document.getElementById('promptTemplatesList');
            container.innerHTML = '';
            
            if (data.templates.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-file-text"></i>
                        <p>ë“±ë¡ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }
            
            const table = `
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>í…œí”Œë¦¿ëª…</th>
                                <th>ë¶„ë¥˜</th>
                                <th style="width: 40%;">í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸°</th>
                                <th>ìƒì„±ì¼</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.templates.map(t => `
                                <tr>
                                    <td><strong>${t.template_name}</strong></td>
                                    <td>
                                        <span class="badge ${t.template_type === 'alternative' ? 'bg-success' : 'bg-info'}">
                                            ${t.template_type === 'alternative' ? 'ëŒ€ì•ˆì„±' : 'ì •ë³´ì„±'}
                                        </span>
                                    </td>
                                    <td>
                                        <small style="line-height: 1.8;">
                                            ${renderVariablesAsBadges(t.user_prompt_template?.substring(0, 150) + '...')}
                                        </small>
                                    </td>
                                    <td>${new Date(t.created_at).toLocaleDateString()}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="editTemplate(${t.id})" title="ìˆ˜ì •">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-secondary" onclick="duplicateTemplate(${t.id})" title="ë³µì œ">
                                            <i class="bi bi-files"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteTemplate(${t.id})" title="ì‚­ì œ">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = table;
        }
    } catch (error) {
        console.error('í…œí”Œë¦¿ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

// í”„ë¡¬í”„íŠ¸ ë¡œë“œ
// í”„ë¡¬í”„íŠ¸ ìƒí’ˆ í•„í„° ë¡œë“œ
async function loadPromptProductFilter() {
    try {
        const response = await fetch('/ai-automation/api/products');
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('promptProductFilter');
            select.innerHTML = '<option value="">ì „ì²´ ìƒí’ˆ</option>';
            
            data.products.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.product_name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('ìƒí’ˆ í•„í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

async function loadPrompts() {
    const productFilter = document.getElementById('promptProductFilter')?.value || '';
    const typeFilter = document.getElementById('promptTypeFilter')?.value || 'all';
    
    try {
        const response = await fetch(`/ai-automation/api/prompts?product=${productFilter}&type=${typeFilter}`);
        const data = await response.json();
        
        if (data.success) {
            const container = document.getElementById('promptsList');
            container.innerHTML = '';
            
            if (data.prompts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-chat-dots"></i>
                        <p>ë“±ë¡ëœ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }
            
            const table = `
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ìƒí’ˆëª…</th>
                                <th>ë¶„ë¥˜</th>
                                <th>Temperature</th>
                                <th>Max Tokens</th>
                                <th>ì´ë¯¸ì§€ ìƒì„±</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.prompts.map(p => `
                                <tr>
                                    <td><strong>${p.product_name}</strong></td>
                                    <td>
                                        <span class="badge ${p.keyword_classification === 'alternative' ? 'bg-success' : 'bg-info'}">
                                            ${p.keyword_classification === 'alternative' ? 'ëŒ€ì•ˆì„±' : 'ì •ë³´ì„±'}
                                        </span>
                                    </td>
                                    <td>${p.temperature}</td>
                                    <td>${p.max_tokens}</td>
                                    <td>${p.generate_images ? 'âœ…' : 'âŒ'}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="editPrompt(${p.id})">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deletePrompt(${p.id})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = table;
        }
    } catch (error) {
        console.error('í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

// ìŠ¤ì¼€ì¤„ ë¡œë“œ
async function loadSchedules(page = 1) {
    const productSearch = document.getElementById('scheduleProductSearch')?.value || '';
    const statusFilter = document.getElementById('scheduleStatusFilter')?.value || 'all';
    
    try {
        const response = await fetch(`/ai-automation/api/schedules?page=${page}&search=${productSearch}&status=${statusFilter}`);
        const data = await response.json();
        
        if (data.success) {
            const container = document.getElementById('schedulesList');
            container.innerHTML = '';
            
            if (data.schedules.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-calendar-check"></i>
                        <p>ë“±ë¡ëœ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }
            
            const table = `
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ìƒí’ˆëª…</th>
                                <th>í”„ë¡¬í”„íŠ¸ ë¶„ë¥˜</th>
                                <th>ì‹œì‘ì¼</th>
                                <th>ì¢…ë£Œì¼</th>
                                <th>ì¼ì¼ ê°œìˆ˜</th>
                                <th>ì˜ˆìƒ ì´ ë°œí–‰</th>
                                <th>ìƒíƒœ</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.schedules.map(s => `
                                <tr>
                                    <td><strong>${s.product_name}</strong></td>
                                    <td>
                                        <span class="badge ${s.keyword_classification === 'alternative' ? 'bg-success' : 'bg-info'}">
                                            ${s.keyword_classification === 'alternative' ? 'ëŒ€ì•ˆì„±' : 'ì •ë³´ì„±'}
                                        </span>
                                    </td>
                                    <td>${s.start_date}</td>
                                    <td>${s.end_date}</td>
                                    <td>${s.daily_post_count}ê°œ</td>
                                    <td><strong>${s.expected_total_posts}ê°œ</strong></td>
                                    <td>
                                        <span class="badge ${s.status === 'scheduled' ? 'bg-warning' : s.status === 'in_progress' ? 'bg-primary' : 'bg-success'}">
                                            ${s.status === 'scheduled' ? 'ì§„í–‰ì˜ˆì •' : s.status === 'in_progress' ? 'ì§„í–‰ì¤‘' : 'ì¢…ë£Œ'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" onclick="deleteSchedule(${s.id})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = table;
            
            // í˜ì´ì§€ë„¤ì´ì…˜
            if (data.total_pages > 1) {
                let pagination = '<nav><ul class="pagination justify-content-center">';
                for (let i = 1; i <= data.total_pages; i++) {
                    pagination += `
                        <li class="page-item ${i === page ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="loadSchedules(${i}); return false;">${i}</a>
                        </li>
                    `;
                }
                pagination += '</ul></nav>';
                document.getElementById('schedulePagination').innerHTML = pagination;
            }
        }
    } catch (error) {
        console.error('ìŠ¤ì¼€ì¤„ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

// ê²€ìƒ‰ í•¨ìˆ˜
function searchSchedules() {
    loadSchedules(1);
}

// ì‹ ê·œ ë°œí–‰ ê¸€ í•„í„° ë¡œë“œ
async function loadPostFilters() {
    try {
        // ê³„ì • ëª©ë¡
        const accountsResponse = await fetch('/automation/api/accounts/list');
        const accountsData = await accountsResponse.json();
        
        if (accountsData.success) {
            const accountSelect = document.getElementById('postAccountFilter');
            accountSelect.innerHTML = '<option value="">ì „ì²´ ê³„ì •</option>';
            
            accountsData.accounts.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.id;
                option.textContent = acc.account_id;
                accountSelect.appendChild(option);
            });
        }
        
        // ì¹´í˜ ëª©ë¡
        const cafesResponse = await fetch('/automation/api/cafes/list');
        const cafesData = await cafesResponse.json();
        
        if (cafesData.success) {
            const cafeSelect = document.getElementById('postCafeFilter');
            cafeSelect.innerHTML = '<option value="">ì „ì²´ ì¹´í˜</option>';
            
            cafesData.cafes.forEach(cafe => {
                const option = document.createElement('option');
                option.value = cafe.id;
                option.textContent = cafe.name;
                cafeSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('í•„í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

// ì‹ ê·œ ë°œí–‰ ê¸€ ë¡œë“œ
async function loadGeneratedPosts() {
    const accountFilter = document.getElementById('postAccountFilter')?.value || '';
    const cafeFilter = document.getElementById('postCafeFilter')?.value || '';
    
    try {
        const response = await fetch(`/ai-automation/api/generated-posts?account=${accountFilter}&cafe=${cafeFilter}`);
        const data = await response.json();
        
        if (data.success) {
            const container = document.getElementById('generatedPostsList');
            container.innerHTML = '';
            
            if (data.posts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-file-earmark-text"></i>
                        <p>ìƒì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }
            
            const table = `
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ìƒí’ˆëª…</th>
                                <th>ê³„ì •</th>
                                <th>ì¹´í˜</th>
                                <th>ì œëª©</th>
                                <th>ìƒíƒœ</th>
                                <th>ìƒì„±ì¼</th>
                                <th>ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.posts.map(p => `
                                <tr>
                                    <td>${p.product_name}</td>
                                    <td>${p.account_name}</td>
                                    <td>${p.cafe_name}</td>
                                    <td><strong>${p.post_title}</strong></td>
                                    <td>
                                        <span class="badge ${p.status === 'published' ? 'bg-success' : 'bg-secondary'}">
                                            ${p.status === 'published' ? 'ë°œí–‰ì™„ë£Œ' : 'ì´ˆì•ˆ'}
                                        </span>
                                    </td>
                                    <td>${new Date(p.created_at).toLocaleString('ko-KR')}</td>
                                    <td>
                                        ${p.post_url ? `<a href="${p.post_url}" target="_blank" class="btn btn-sm btn-info"><i class="bi bi-box-arrow-up-right"></i></a>` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = table;
        }
    } catch (error) {
        console.error('ë°œí–‰ ê¸€ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

// ì—°ë™ ê´€ë¦¬ ë¡œë“œ
async function loadConnections() {
    try {
        const response = await fetch('/ai-automation/api/connections');
        const data = await response.json();
        
        if (data.success) {
            const container = document.getElementById('connectionsList');
            container.innerHTML = '';
            
            if (data.connections.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-link-45deg"></i>
                        <p>ì—°ë™ëœ ì¹´í˜-ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }
            
            const table = `
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ì¹´í˜</th>
                                <th>ê³„ì •</th>
                                <th>ê°€ì… ì—¬ë¶€</th>
                                <th>ìƒíƒœ</th>
                                <th>ì‹ ê·œë°œí–‰ ê¸€</th>
                                <th>ì‚¬ìš©ëœ ê¸€</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.connections.map(c => `
                                <tr>
                                    <td><strong>${c.cafe_name}</strong></td>
                                    <td>${c.account_name}</td>
                                    <td>
                                        <span class="badge ${c.is_member ? 'bg-success' : 'bg-secondary'}">
                                            ${c.is_member ? 'ê°€ì…ì™„ë£Œ' : 'ë¯¸ê°€ì…'}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge ${c.status === 'active' ? 'bg-success' : 'bg-danger'}">
                                            ${c.status === 'active' ? 'í™œì„±' : 'ì •ì§€'}
                                        </span>
                                    </td>
                                    <td><span class="badge bg-primary">${c.draft_post_count}ê°œ</span></td>
                                    <td><span class="badge bg-info">${c.used_post_count}ê°œ</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = table;
            // êµ¬í˜„ í•„ìš”
            container.innerHTML = '<div class="empty-state"><i class="bi bi-link-45deg"></i><p>ê¸°ëŠ¥ êµ¬í˜„ ì¤‘...</p></div>';
        }
    } catch (error) {
        console.error('ì—°ë™ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

// ============================================
// AI ëª¨ë‹¬ ê´€ë¦¬ í•¨ìˆ˜ë“¤
// ============================================

// ìƒí’ˆ ì¶”ê°€ ëª¨ë‹¬
async function showAddProductModal() {
    try {
        const response = await fetch('/ai-automation/api/available-products');
        const data = await response.json();
        
        if (!data.success || data.products.length === 0) {
            alert('ì¶”ê°€ ê°€ëŠ¥í•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('addAIProductModal'));
        
        // ìƒí’ˆ ëª©ë¡ ì±„ìš°ê¸°
        const container = document.getElementById('availableProductsList');
        container.innerHTML = data.products.map(p => `
            <div class="col-md-6 mb-2">
                <div class="card cursor-pointer" onclick="addAIProduct(${p.id})">
                    <div class="card-body d-flex align-items-center p-2">
                        <img src="${p.thumbnail || '/static/images/no-image.png'}" 
                             class="img-thumbnail me-2" style="width: 50px; height: 50px;">
                        <div>
                            <small><strong>${p.name}</strong></small><br>
                            <small class="text-muted">${p.product_code}</small>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        modal.show();
    } catch (error) {
        console.error('ìƒí’ˆ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
        alert('ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
}

async function addAIProduct(marketingProductId) {
    try {
        const response = await fetch(`/ai-automation/api/products/add/${marketingProductId}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            alert('ìƒí’ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            bootstrap.Modal.getInstance(document.getElementById('addAIProductModal')).hide();
            loadAIProducts();
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    } catch (error) {
        alert('ìƒí’ˆ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ìƒí’ˆ ìˆ˜ì • ëª¨ë‹¬
async function editAIProduct(id) {
    try {
        const response = await fetch(`/ai-automation/api/products/${id}`);
        const data = await response.json();
        
        if (!data.success) {
            alert('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const product = data.product;
        
        // í¼ ì±„ìš°ê¸°
        document.getElementById('editProductId').value = id;
        document.getElementById('editUseCafe').checked = product.use_for_cafe;
        document.getElementById('editUseBlog').checked = product.use_for_blog;
        document.getElementById('editProductName').value = product.product_name || '';
        document.getElementById('editCoreValue').value = product.core_value || '';
        document.getElementById('editSubCoreValue').value = product.sub_core_value || '';
        document.getElementById('editSizeWeight').value = product.size_weight || '';
        document.getElementById('editDifference').value = product.difference || '';
        document.getElementById('editFamousBrands').value = product.famous_brands || '';
        document.getElementById('editMarketProblem').value = product.market_problem || '';
        document.getElementById('editOurPrice').value = product.our_price || '';
        document.getElementById('editMarketAvgPrice').value = product.market_avg_price || '';
        document.getElementById('editTargetAge').value = product.target_age || '';
        document.getElementById('editTargetGender').value = product.target_gender || '';
        document.getElementById('editAdditionalInfo').value = product.additional_info || '';
        document.getElementById('editMarketingLink').value = product.marketing_link || '';
        
        const modal = new bootstrap.Modal(document.getElementById('editAIProductModal'));
        modal.show();
    } catch (error) {
        console.error('ìƒí’ˆ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
        alert('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
}

async function saveAIProduct() {
    const form = document.getElementById('editAIProductForm');
    const formData = new FormData(form);
    const id = document.getElementById('editProductId').value;
    
    try {
        const response = await fetch(`/ai-automation/api/products/update/${id}`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            bootstrap.Modal.getInstance(document.getElementById('editAIProductModal')).hide();
            loadAIProducts();
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    } catch (error) {
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ============================================
// í‚¤ì›Œë“œ ê´€ë¦¬
// ============================================

async function manageKeywords(productId) {
    document.getElementById('keywordProductId').value = productId;
    
    const modal = new bootstrap.Modal(document.getElementById('manageKeywordsModal'));
    modal.show();
    
    await loadKeywords(productId);
}

async function loadKeywords(productId) {
    try {
        const response = await fetch(`/ai-automation/api/products/${productId}/keywords`);
        const data = await response.json();
        
        if (data.success) {
            const tbody = document.getElementById('keywordsTableBody');
            tbody.innerHTML = '';
            
            if (data.keywords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤. ë™ê¸°í™” ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>';
                return;
            }
            
            data.keywords.forEach(kw => {
                const typeClass = kw.keyword_type === 'alternative' ? 'success' : 
                                 kw.keyword_type === 'informational' ? 'info' : 'secondary';
                const typeName = kw.keyword_type === 'alternative' ? 'ëŒ€ì•ˆì„±' :
                                kw.keyword_type === 'informational' ? 'ì •ë³´ì„±' : 'ë¯¸ë¶„ë¥˜';
                
                const row = `
                    <tr>
                        <td><strong>${kw.keyword_text}</strong></td>
                        <td>
                            <select class="form-select form-select-sm" onchange="updateKeywordType(${kw.id}, this.value)">
                                <option value="unclassified" ${kw.keyword_type === 'unclassified' ? 'selected' : ''}>ë¯¸ë¶„ë¥˜</option>
                                <option value="alternative" ${kw.keyword_type === 'alternative' ? 'selected' : ''}>ëŒ€ì•ˆì„±</option>
                                <option value="informational" ${kw.keyword_type === 'informational' ? 'selected' : ''}>ì •ë³´ì„±</option>
                            </select>
                        </td>
                        <td>
                            <span class="badge ${kw.is_active ? 'bg-success' : 'bg-secondary'}">
                                ${kw.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteKeyword(${kw.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
    } catch (error) {
        console.error('í‚¤ì›Œë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

async function syncKeywordsFromMarketing() {
    const productId = document.getElementById('keywordProductId').value;
    
    if (!confirm('ë§ˆì¼€íŒ… ìƒí’ˆì˜ í‚¤ì›Œë“œë¥¼ ë™ê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    try {
        const response = await fetch(`/ai-automation/keywords/sync/${productId}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            alert(`${data.added_count}ê°œì˜ í‚¤ì›Œë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            await loadKeywords(productId);
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    } catch (error) {
        alert('ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

async function updateKeywordType(keywordId, newType) {
    try {
        const formData = new FormData();
        formData.append('keyword_type', newType);
        
        const response = await fetch(`/ai-automation/keywords/update/${keywordId}`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            // ì„±ê³µ ë©”ì‹œì§€ (ì¡°ìš©íˆ)
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
            // ì‹¤íŒ¨ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            const productId = document.getElementById('keywordProductId').value;
            await loadKeywords(productId);
        }
    } catch (error) {
        alert('ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

function showAddKeywordForm() {
    const form = document.getElementById('addKeywordForm');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

async function saveNewKeyword() {
    const productId = document.getElementById('keywordProductId').value;
    const keywordText = document.getElementById('newKeywordText').value.trim();
    const keywordType = document.getElementById('newKeywordType').value;
    
    if (!keywordText) {
        alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('keyword_text', keywordText);
        formData.append('keyword_type', keywordType);
        
        const response = await fetch(`/ai-automation/keywords/add/${productId}`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            alert('í‚¤ì›Œë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            document.getElementById('newKeywordText').value = '';
            document.getElementById('newKeywordType').value = 'unclassified';
            document.getElementById('addKeywordForm').style.display = 'none';
            await loadKeywords(productId);
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    } catch (error) {
        alert('ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

async function deleteKeyword(keywordId) {
    if (!confirm('ì´ í‚¤ì›Œë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    try {
        const response = await fetch(`/ai-automation/keywords/delete/${keywordId}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            const productId = document.getElementById('keywordProductId').value;
            await loadKeywords(productId);
        } else {
            alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
}
    } catch (error) {
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ============================================
// ë ˆí¼ëŸ°ìŠ¤ ê´€ë¦¬
// ============================================

async function manageReferences(productId) {
    document.getElementById('referenceProductId').value = productId;
    
    const modal = new bootstrap.Modal(document.getElementById('manageReferencesModal'));
    modal.show();
    
    await loadReferences(productId);
}

async function loadReferences(productId) {
    try {
        const response = await fetch(`/ai-automation/api/products/${productId}/references`);
        const data = await response.json();
        
        if (data.success) {
            const tbody = document.getElementById('referencesTableBody');
            tbody.innerHTML = '';
            
            if (data.references.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ë ˆí¼ëŸ°ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ë™ê¸°í™” ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>';
                return;
            }
            
            data.references.forEach(ref => {
                const typeClass = ref.reference_type === 'alternative' ? 'success' : 
                                 ref.reference_type === 'informational' ? 'info' : 'secondary';
                const typeName = ref.reference_type === 'alternative' ? 'ëŒ€ì•ˆì„±' :
                                ref.reference_type === 'informational' ? 'ì •ë³´ì„±' : 'ë¯¸ë¶„ë¥˜';
                
                const refTypeBadge = ref.ref_type ? `<span class="badge bg-secondary">${ref.ref_type}</span>` : '';
                const contentPreview = ref.content ? ref.content.substring(0, 80) + '...' : '';
                
                const row = `
                    <tr>
                        <td>
                            <strong>${ref.title}</strong>
                            <br><small class="text-muted">ID: ${ref.reference_id}</small>
                        </td>
                        <td>
                            <select class="form-select form-select-sm" onchange="updateReferenceType(${ref.id}, this.value)">
                                <option value="unclassified" ${ref.reference_type === 'unclassified' ? 'selected' : ''}>ë¯¸ë¶„ë¥˜</option>
                                <option value="alternative" ${ref.reference_type === 'alternative' ? 'selected' : ''}>ëŒ€ì•ˆì„±</option>
                                <option value="informational" ${ref.reference_type === 'informational' ? 'selected' : ''}>ì •ë³´ì„±</option>
                            </select>
                        </td>
                        <td>${refTypeBadge || '<span class="badge bg-light text-dark">ì—†ìŒ</span>'}</td>
                        <td><small class="text-muted">${contentPreview}</small></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-info" onclick="viewReferenceDetailFull(${ref.reference_id})" title="ìƒì„¸ë³´ê¸°">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-warning" onclick="editReference(${ref.id}, ${ref.reference_id})" title="ìˆ˜ì •">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-danger" onclick="deleteAIReference(${ref.id})" title="ì‚­ì œ">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
    } catch (error) {
        console.error('ë ˆí¼ëŸ°ìŠ¤ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

async function syncReferencesFromMarketing() {
    const productId = document.getElementById('referenceProductId').value;
    
    if (!confirm('ë§ˆì¼€íŒ… ë ˆí¼ëŸ°ìŠ¤ë¥¼ ë™ê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    try {
        const response = await fetch(`/ai-automation/references/sync/${productId}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            alert(`${data.added_count}ê°œì˜ ë ˆí¼ëŸ°ìŠ¤ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            await loadReferences(productId);
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    } catch (error) {
        alert('ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

async function updateReferenceType(aiRefId, newType) {
    try {
        const formData = new FormData();
        formData.append('reference_type', newType);
        
        const response = await fetch(`/ai-automation/references/update/${aiRefId}`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (!data.success) {
            alert('ì˜¤ë¥˜: ' + data.error);
            const productId = document.getElementById('referenceProductId').value;
            await loadReferences(productId);
        }
    } catch (error) {
        alert('ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ë ˆí¼ëŸ°ìŠ¤ ìƒì„¸ ë³´ê¸° (ë³¸ë¬¸+ëŒ“ê¸€)
async function viewReferenceDetailFull(referenceId) {
    try {
        // ë ˆí¼ëŸ°ìŠ¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ë³¸ë¬¸ + ëŒ“ê¸€)
        const response = await fetch(`/marketing/reference/${referenceId}/content`);
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('viewRefId').value = referenceId;
            document.getElementById('viewRefTitle').textContent = data.title;
            document.getElementById('viewRefContent').textContent = data.body || 'ë‚´ìš© ì—†ìŒ';
            
            // ëŒ“ê¸€ í‘œì‹œ (ë³¸ë¬¸ + ëŒ“ê¸€ ëª¨ë‘ í‘œì‹œ)
            const commentsDiv = document.getElementById('viewRefComments');
            const comments = data.comments || [];
            
            document.getElementById('viewRefCommentCount').textContent = comments.length;
            
            if (comments.length === 0) {
                commentsDiv.innerHTML = '<p class="text-muted text-center">ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                commentsDiv.innerHTML = comments.map((comment, idx) => {
                    // ëŒ€ëŒ“ê¸€ì€ ë“¤ì—¬ì“°ê¸°
                    const marginLeft = comment.is_reply ? 'margin-left: 40px;' : '';
                    const replyBadge = comment.is_reply ? '<span class="badge bg-info me-2">â†ª ëŒ€ëŒ“ê¸€</span>' : '';
                    
                    return `
                    <div class="card mb-2" style="${marginLeft}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    ${replyBadge}
                                    <strong>${comment.commenter_name}</strong>
                                </div>
                                <small class="text-muted">ê³„ì • ìˆœì„œ: ${comment.account_sequence}</small>
                            </div>
                            <p class="mb-0" style="white-space: pre-wrap;">${comment.comment_text || comment.text}</p>
                        </div>
                    </div>
                `;
                }).join('');
            }
            
            const modal = new bootstrap.Modal(document.getElementById('viewReferenceModal'));
            modal.show();
        } else {
            alert('ë ˆí¼ëŸ°ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('ë ˆí¼ëŸ°ìŠ¤ ìƒì„¸ ë¡œë“œ ì˜¤ë¥˜:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ë ˆí¼ëŸ°ìŠ¤ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
async function editReference(aiRefId, referenceId) {
    try {
        const response = await fetch(`/marketing/reference/${referenceId}/content`);
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('editRefId').value = referenceId;
            document.getElementById('editAiRefId').value = aiRefId;
            document.getElementById('editRefTitle').value = data.title;
            document.getElementById('editRefContent').value = data.body || '';
            
            // í˜„ì¬ AI ë¶„ë¥˜ ê°€ì ¸ì˜¤ê¸°
            const productId = document.getElementById('referenceProductId').value;
            const refsResponse = await fetch(`/ai-automation/api/products/${productId}/references`);
            const refsData = await refsResponse.json();
            
            if (refsData.success) {
                const aiRef = refsData.references.find(r => r.id === aiRefId);
                if (aiRef) {
                    document.getElementById('editRefType').value = aiRef.reference_type;
                }
            }
            
            const modal = new bootstrap.Modal(document.getElementById('editReferenceModal'));
            modal.show();
        }
    } catch (error) {
        console.error('ë ˆí¼ëŸ°ìŠ¤ ë¡œë“œ ì˜¤ë¥˜:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ë ˆí¼ëŸ°ìŠ¤ ìˆ˜ì • ì €ì¥
async function updateReferenceContent() {
    const aiRefId = document.getElementById('editAiRefId').value;
    const refType = document.getElementById('editRefType').value;
    
    try {
        const formData = new FormData();
        formData.append('reference_type', refType);
        
        const response = await fetch(`/ai-automation/references/update/${aiRefId}`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            alert('ë¶„ë¥˜ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
            bootstrap.Modal.getInstance(document.getElementById('editReferenceModal')).hide();
            
            const productId = document.getElementById('referenceProductId').value;
            await loadReferences(productId);
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    } catch (error) {
        alert('ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ë ˆí¼ëŸ°ìŠ¤ ì¶”ê°€ í¼ í‘œì‹œ/ìˆ¨ê¹€
function showAddReferenceForm() {
    document.getElementById('addReferenceForm').style.display = 'block';
}

function hideAddReferenceForm() {
    document.getElementById('addReferenceForm').style.display = 'none';
    document.getElementById('newRefTitle').value = '';
    document.getElementById('newRefContent').value = '';
    document.getElementById('newRefType').value = 'unclassified';
}

// ìƒˆ ë ˆí¼ëŸ°ìŠ¤ ì €ì¥
async function saveNewReference() {
    const productId = document.getElementById('referenceProductId').value;
    const title = document.getElementById('newRefTitle').value.trim();
    const content = document.getElementById('newRefContent').value.trim();
    const refType = document.getElementById('newRefType').value;
    
    if (!title || !content) {
        alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    try {
        // ë¨¼ì € Reference ìƒì„± (ë§ˆì¼€íŒ…)
        const refResponse = await fetch('/marketing/api/reference/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                title: title,
                content: content,
                ref_type: 'ê¸°íƒ€'
            })
        });
        const refData = await refResponse.json();
        
        if (refData.success) {
            // AIProductReferenceì— ì¶”ê°€
            const formData = new FormData();
            formData.append('reference_id', refData.id);
            formData.append('reference_type', refType);
            
            const aiRefResponse = await fetch(`/ai-automation/references/add/${productId}`, {
                method: 'POST',
                body: formData
            });
            const aiRefData = await aiRefResponse.json();
            
            if (aiRefData.success) {
                alert('ë ˆí¼ëŸ°ìŠ¤ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                hideAddReferenceForm();
                await loadReferences(productId);
            } else {
                alert('AI ë ˆí¼ëŸ°ìŠ¤ ì—°ê²° ì‹¤íŒ¨: ' + aiRefData.error);
            }
        } else {
            alert('ë ˆí¼ëŸ°ìŠ¤ ìƒì„± ì‹¤íŒ¨: ' + refData.error);
        }
    } catch (error) {
        console.error('ë ˆí¼ëŸ°ìŠ¤ ì¶”ê°€ ì˜¤ë¥˜:', error);
        alert('ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// AI ë ˆí¼ëŸ°ìŠ¤ ì‚­ì œ (ì—°ê²°ë§Œ ëŠê¸°)
async function deleteAIReference(aiRefId) {
    if (!confirm('ì´ ë ˆí¼ëŸ°ìŠ¤ ì—°ê²°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì›ë³¸ ë ˆí¼ëŸ°ìŠ¤ëŠ” ë§ˆì¼€íŒ…ì— ë‚¨ì•„ìˆìŠµë‹ˆë‹¤)')) {
        return;
    }
    
    try {
        const response = await fetch(`/ai-automation/references/delete/${aiRefId}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            const productId = document.getElementById('referenceProductId').value;
            await loadReferences(productId);
        } else {
            alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ëª¨ë‹¬
function showAddTemplateModal() {
    const modal = new bootstrap.Modal(document.getElementById('addTemplateModal'));
    modal.show();
}

async function saveTemplate(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        const response = await fetch('/ai-automation/api/prompt-templates/add', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            alert('í…œí”Œë¦¿ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            bootstrap.Modal.getInstance(document.getElementById('addTemplateModal')).hide();
            event.target.reset();
            loadPromptTemplates();
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    } catch (error) {
        alert('í…œí”Œë¦¿ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

async function editTemplate(id) {
    try {
        const response = await fetch(`/ai-automation/api/prompt-templates/${id}`);
        const data = await response.json();
        
        if (!data.success) {
            alert('í…œí”Œë¦¿ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const template = data.template;
        
        document.getElementById('editTemplateId').value = id;
        document.getElementById('editTemplateName').value = template.template_name;
        document.getElementById('editTemplateType').value = template.template_type;
        document.getElementById('editTemplatePrompt').value = template.user_prompt_template;
        
        const modal = new bootstrap.Modal(document.getElementById('editTemplateModal'));
        modal.show();
    } catch (error) {
        alert('í…œí”Œë¦¿ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
}

async function updateTemplate() {
    const id = document.getElementById('editTemplateId').value;
    const formData = new FormData();
    formData.append('template_name', document.getElementById('editTemplateName').value);
    formData.append('template_type', document.getElementById('editTemplateType').value);
    formData.append('user_prompt_template', document.getElementById('editTemplatePrompt').value);
    
    try {
        const response = await fetch(`/ai-automation/api/prompt-templates/update/${id}`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            alert('í…œí”Œë¦¿ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            bootstrap.Modal.getInstance(document.getElementById('editTemplateModal')).hide();
            loadPromptTemplates();
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    } catch (error) {
        alert('í…œí”Œë¦¿ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

async function duplicateTemplate(id) {
    if (!confirm('ì´ í…œí”Œë¦¿ì„ ë³µì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const response = await fetch(`/ai-automation/api/prompt-templates/duplicate/${id}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            alert('í…œí”Œë¦¿ì´ ë³µì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadPromptTemplates();
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    } catch (error) {
        alert('í…œí”Œë¦¿ ë³µì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

async function deleteTemplate(id) {
    if (!confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const response = await fetch(`/ai-automation/api/prompt-templates/delete/${id}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            alert('í…œí”Œë¦¿ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadPromptTemplates();
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    } catch (error) {
        alert('í…œí”Œë¦¿ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ ëª¨ë‹¬
function showAddPromptModal() {
    const modal = new bootstrap.Modal(document.getElementById('addPromptModal'));
    modal.show();
}

async function savePrompt(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        const response = await fetch('/ai-automation/api/prompts/add', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            alert('í”„ë¡¬í”„íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            bootstrap.Modal.getInstance(document.getElementById('addPromptModal')).hide();
            event.target.reset();
            loadPrompts();
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    } catch (error) {
        alert('í”„ë¡¬í”„íŠ¸ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

async function editPrompt(id) {
    // í”„ë¡¬í”„íŠ¸ ìˆ˜ì • ëª¨ë‹¬
    alert('í”„ë¡¬í”„íŠ¸ ìˆ˜ì • ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
}

async function deletePrompt(id) {
    if (!confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const response = await fetch(`/ai-automation/api/prompts/delete/${id}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            alert('í”„ë¡¬í”„íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadPrompts();
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    } catch (error) {
        alert('í”„ë¡¬í”„íŠ¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ìŠ¤ì¼€ì¤„ ëª¨ë‹¬
function showAddScheduleModal() {
    const modal = new bootstrap.Modal(document.getElementById('addScheduleModal'));
    modal.show();
}

async function saveSchedule(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        const response = await fetch('/ai-automation/api/schedules/add', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            alert('ìŠ¤ì¼€ì¤„ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
            bootstrap.Modal.getInstance(document.getElementById('addScheduleModal')).hide();
            event.target.reset();
            loadSchedules();
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    } catch (error) {
        alert('ìŠ¤ì¼€ì¤„ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

async function deleteSchedule(id) {
    if (!confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const response = await fetch(`/ai-automation/api/schedules/delete/${id}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            alert('ìŠ¤ì¼€ì¤„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadSchedules();
        } else {
            alert('ì˜¤ë¥˜: ' + data.error);
        }
    } catch (error) {
        alert('ìŠ¤ì¼€ì¤„ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ì—°ë™ ê´€ë¦¬ ëª¨ë‹¬
function showAddConnectionModal() {
    alert('ì—°ë™ ê´€ë¦¬ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
}

// ============================================
// ë³€ìˆ˜ ì‹œìŠ¤í…œ (í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ìš©)
// ============================================

// ë³€ìˆ˜ ì‚½ì… í•¨ìˆ˜
function insertVariable(textareaId, variableName) {
    const textarea = document.getElementById(textareaId);
    const cursorPos = textarea.selectionStart;
    const textBefore = textarea.value.substring(0, cursorPos);
    const textAfter = textarea.value.substring(cursorPos);
    
    const variableText = `{${variableName}}`;
    textarea.value = textBefore + variableText + textAfter;
    
    // ì»¤ì„œ ìœ„ì¹˜ ì¡°ì •
    const newCursorPos = cursorPos + variableText.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    textarea.focus();
}

// ë“œë¡­ë°•ìŠ¤ì—ì„œ ë³€ìˆ˜ ì„ íƒ í›„ ì‚½ì…
function insertVariableFromSelect(textareaId, selectId) {
    const select = document.getElementById(selectId);
    const variableName = select.value;
    
    if (!variableName) {
        alert('ë³€ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    insertVariable(textareaId, variableName);
    
    // ì„ íƒ ì´ˆê¸°í™”
    select.value = '';
}

// ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸ ì¶”ê°€
function insertImageGenerationPrompt(textareaId) {
    const textarea = document.getElementById(textareaId);
    const imagePrompt = '\n\nìœ„ ë‚´ìš©ì„ ì •í™•í•˜ê²Œ ì°¸ì¡°í•´ì„œ\n1. ì œí’ˆ íŒŒì†, ë¶ˆëŸ‰ ë“± ë¶€ì •ì ì¸ ì‹¤ì œ ì‚¬ì§„ê°™ì€ ì´ë¯¸ì§€\n2. ì‹¤ì œ í•œêµ­ì‚¬ëŒì´ ê³ í†µìŠ¤ëŸ¬ì›Œ í•˜ê³ ìˆëŠ” ì‹¤ì œ ì‚¬ì§„ê°™ì€ ì´ë¯¸ì§€\n3. í•´ë‹¹ ì œí’ˆì˜ ì‹¤ì œ ì‚¬ìš©í•˜ëŠ” ê²ƒ ê°™ì€ ì´ë¯¸ì§€\nì´ë ‡ê²Œ ì´ 3ì¥ì„ ë§Œë“¤ì–´ì¤˜';
    
    // ë§¨ ëì— ì¶”ê°€
    textarea.value = textarea.value.trim() + imagePrompt;
    
    // ì»¤ì„œë¥¼ ë§¨ ëìœ¼ë¡œ
    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
    textarea.focus();
    
    alert('ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// í…œí”Œë¦¿ í…ìŠ¤íŠ¸ì—ì„œ ë³€ìˆ˜ë¥¼ ë±ƒì§€ë¡œ ë³€í™˜
function renderVariablesAsBadges(text) {
    if (!text) return '';
    
    // {ë³€ìˆ˜ëª…} íŒ¨í„´ì„ ì°¾ì•„ì„œ ë±ƒì§€ë¡œ ë³€í™˜
    return text.replace(/\{([a-z_]+)\}/g, (match, varName) => {
        return `<span class="badge bg-primary">{${varName}}</span>`;
    });
}

// ëª¨ë“  ë³€ìˆ˜ ëª©ë¡
const AVAILABLE_VARIABLES = {
    'product_name': 'ìš°ë¦¬ì œí’ˆëª…',
    'core_value': 'ìš°ë¦¬ ì œí’ˆì˜ í•µì‹¬',
    'sub_core_value': 'ìš°ë¦¬ ì œí’ˆì˜ ì„œë¸Œ í•µì‹¬',
    'size_weight': 'ìš°ë¦¬ ì œí’ˆ ì‚¬ì´ì¦ˆ & ë¬´ê²Œ',
    'difference': 'íƒ€ì‚¬ ì œí’ˆê³¼ ì°¨ë³„ì ',
    'famous_brands': 'í•´ë‹¹ ì œí’ˆì˜ ìœ ëª… ë¸Œëœë“œë“¤',
    'market_problem': 'ê¸°ì¡´ ì‹œì¥ì˜ ë¬¸ì œì ',
    'our_price': 'ìš°ë¦¬ ì œí’ˆì˜ ê°€ê²©',
    'market_avg_price': 'ê¸°ì¡´ ì‹œì¥ì˜ í‰ê·  ê°€ê²©',
    'target_age': 'ê³ ê°ì˜ ì˜ˆìƒ ì—°ë ¹ëŒ€',
    'target_gender': 'ê³ ê°ì˜ ì˜ˆìƒ ì„±ë³„',
    'additional_info': 'ê¸°íƒ€ ì¶”ê°€ íŠ¹ì´ì‚¬í•­',
    'marketing_link': 'ë§ˆì¼€íŒ… ë§í¬'
};

// í…œí”Œë¦¿ ë‚´ìš© ë¡œë“œ (í”„ë¡¬í”„íŠ¸ ìƒì„± ì‹œ)
async function loadTemplatesForType() {
    const type = document.getElementById('promptTypeSelect').value;
    if (!type) return;
    
    try {
        const response = await fetch(`/ai-automation/api/prompt-templates?type=${type}`);
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('templateSelectForPrompt');
            select.innerHTML = '<option value="">ì§ì ‘ ì…ë ¥</option>';
            
            data.templates.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = t.template_name;
                option.dataset.content = t.user_prompt_template;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('í…œí”Œë¦¿ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

function loadTemplateContent() {
    const select = document.getElementById('templateSelectForPrompt');
    const selectedOption = select.options[select.selectedIndex];
    
    if (selectedOption.value && selectedOption.dataset.content) {
        document.getElementById('userPromptArea').value = selectedOption.dataset.content;
    }
}

// í‚¤ì›Œë“œ ê°œìˆ˜ í‘œì‹œ
async function showKeywordCount() {
    const productId = document.getElementById('scheduleProductSelect').value;
    if (!productId) {
        document.getElementById('keywordCountDisplay').textContent = '';
        document.getElementById('schedulePromptSelect').innerHTML = '<option value="">ë¨¼ì € ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”</option>';
        return;
    }
    
    try {
        // í‚¤ì›Œë“œ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°
        const keywordResponse = await fetch(`/ai-automation/api/products/${productId}/keywords`);
        const keywordData = await keywordResponse.json();
        
        if (keywordData.success) {
            document.getElementById('keywordCountDisplay').textContent = 
                `í•´ë‹¹ ìƒí’ˆì˜ í™œì„± í‚¤ì›Œë“œ: ${keywordData.count}ê°œ`;
        }
        
        // í•´ë‹¹ ìƒí’ˆì˜ í”„ë¡¬í”„íŠ¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const promptResponse = await fetch(`/ai-automation/api/prompts?product=${productId}`);
        const promptData = await promptResponse.json();
        
        if (promptData.success) {
            const select = document.getElementById('schedulePromptSelect');
            select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            
            promptData.prompts.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.keyword_classification === 'alternative' ? 'ëŒ€ì•ˆì„±' : 'ì •ë³´ì„±'} í”„ë¡¬í”„íŠ¸`;
                option.dataset.classification = p.keyword_classification;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

// ì´ ë°œí–‰ ìˆ˜ ê³„ì‚°
function calculateTotal() {
    const startDate = document.getElementById('scheduleStartDate').value;
    const endDate = document.getElementById('scheduleEndDate').value;
    const dailyCount = parseInt(document.getElementById('dailyPostCount').value) || 0;
    
    if (!startDate || !endDate || !dailyCount) {
        document.getElementById('totalPostsDisplay').style.display = 'none';
        return;
    }
    
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    if (start > end) {
        alert('ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ë³´ë‹¤ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }
    
    // ì£¼ë§ ì œì™¸í•œ ì¼ìˆ˜ ê³„ì‚°
    let workDays = 0;
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        if (d.getDay() !== 0 && d.getDay() !== 6) { // ì¼ìš”ì¼(0), í† ìš”ì¼(6) ì œì™¸
            workDays++;
        }
    }
    
    const totalPosts = workDays * dailyCount;
    document.getElementById('totalPostsCount').textContent = totalPosts;
    document.getElementById('totalPostsDisplay').style.display = 'block';
}

// ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ìƒí’ˆ ëª©ë¡ ë¡œë“œ
document.addEventListener('DOMContentLoaded', function() {
    // í”„ë¡¬í”„íŠ¸ ì¶”ê°€ ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ
    const addPromptModal = document.getElementById('addPromptModal');
    if (addPromptModal) {
        addPromptModal.addEventListener('show.bs.modal', async function() {
            try {
                const response = await fetch('/ai-automation/api/products');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('promptProductSelect');
                    select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
                    
                    data.products.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = p.product_name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('ìƒí’ˆ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        });
    }
    
    // ìŠ¤ì¼€ì¤„ ì¶”ê°€ ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ
    const addScheduleModal = document.getElementById('addScheduleModal');
    if (addScheduleModal) {
        addScheduleModal.addEventListener('show.bs.modal', async function() {
            try {
                const response = await fetch('/ai-automation/api/products');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('scheduleProductSelect');
                    select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
                    
                    data.products.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = p.product_name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('ìƒí’ˆ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        });
    }
});

</script>

<!-- ============================================ -->
<!-- AI ìë™í™” ëª¨ë‹¬ë“¤ -->
<!-- ============================================ -->

<!-- ìƒí’ˆ ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="addAIProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-stars"></i> AI ìƒí’ˆ ì¶”ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="availableProductsList" class="row">
                    <!-- JavaScriptë¡œ ë¡œë“œ -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ìƒí’ˆ ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal fade" id="editAIProductModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> ìƒí’ˆ ìƒì„¸ ì •ë³´ ìˆ˜ì •</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editAIProductForm" onsubmit="event.preventDefault(); saveAIProduct();">
                <input type="hidden" id="editProductId">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6>í”Œë«í¼ ì‚¬ìš© ê¶Œí•œ</h6>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="editUseCafe" name="use_for_cafe">
                                <label class="form-check-label" for="editUseCafe">ì¹´í˜</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="editUseBlog" name="use_for_blog">
                                <label class="form-check-label" for="editUseBlog">ë¸”ë¡œê·¸</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">1. ìš°ë¦¬ì œí’ˆëª… <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editProductName" name="product_name" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">8. ìš°ë¦¬ ì œí’ˆì˜ ê°€ê²© <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editOurPrice" name="our_price" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">9. ê¸°ì¡´ ì‹œì¥ í‰ê·  ê°€ê²© <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editMarketAvgPrice" name="market_avg_price" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">10. ê³ ê°ì˜ ì˜ˆìƒ ì—°ë ¹ëŒ€ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editTargetAge" name="target_age" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">11. ê³ ê°ì˜ ì˜ˆìƒ ì„±ë³„ <span class="text-danger">*</span></label>
                            <select class="form-select" id="editTargetGender" name="target_gender" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ë‚¨ì„±">ë‚¨ì„±</option>
                                <option value="ì—¬ì„±">ì—¬ì„±</option>
                                <option value="ë‚¨ë…€ê³µìš©">ë‚¨ë…€ê³µìš©</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">2. ìš°ë¦¬ ì œí’ˆì˜ í•µì‹¬ <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="editCoreValue" name="core_value" rows="4" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">3. ìš°ë¦¬ ì œí’ˆì˜ ì„œë¸Œ í•µì‹¬ <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="editSubCoreValue" name="sub_core_value" rows="3" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">5. íƒ€ì‚¬ ì œí’ˆê³¼ ì°¨ë³„ì  <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="editDifference" name="difference" rows="4" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">7. ê¸°ì¡´ ì‹œì¥ì˜ ë¬¸ì œì  <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="editMarketProblem" name="market_problem" rows="4" required></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">4. ìš°ë¦¬ ì œí’ˆ ì‚¬ì´ì¦ˆ & ë¬´ê²Œ <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="editSizeWeight" name="size_weight" rows="2" required></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">6. í•´ë‹¹ ì œí’ˆì˜ ìœ ëª… ë¸Œëœë“œë“¤ <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="editFamousBrands" name="famous_brands" rows="2" required></textarea>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">12. ê¸°íƒ€ ì¶”ê°€ íŠ¹ì´ì‚¬í•­ (ì„ íƒ)</label>
                        <textarea class="form-control" id="editAdditionalInfo" name="additional_info" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">ë§ˆì¼€íŒ… ë§í¬ <span class="text-danger">*</span></label>
                        <input type="url" class="form-control" id="editMarketingLink" name="marketing_link" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- í…œí”Œë¦¿ ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="addTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-file-text"></i> í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì¶”ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="saveTemplate(event)">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">í…œí”Œë¦¿ ì´ë¦„ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="template_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ë¶„ë¥˜ <span class="text-danger">*</span></label>
                            <select class="form-select" name="template_type" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="alternative">ëŒ€ì•ˆì„±</option>
                                <option value="informational">ì •ë³´ì„±</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ <span class="text-danger">*</span></label>
                            <div class="input-group input-group-sm" style="width: auto;">
                                <select class="form-select" id="addTemplateVariableSelect" style="width: 200px;">
                                    <option value="">ë³€ìˆ˜ ì„ íƒ</option>
                                    <option value="product_name">1. ìš°ë¦¬ì œí’ˆëª…</option>
                                    <option value="core_value">2. ìš°ë¦¬ ì œí’ˆì˜ í•µì‹¬</option>
                                    <option value="sub_core_value">3. ì„œë¸Œ í•µì‹¬</option>
                                    <option value="size_weight">4. ì‚¬ì´ì¦ˆ & ë¬´ê²Œ</option>
                                    <option value="difference">5. íƒ€ì‚¬ ì°¨ë³„ì </option>
                                    <option value="famous_brands">6. ìœ ëª… ë¸Œëœë“œë“¤</option>
                                    <option value="market_problem">7. ì‹œì¥ ë¬¸ì œì </option>
                                    <option value="our_price">8. ìš°ë¦¬ ê°€ê²©</option>
                                    <option value="market_avg_price">9. ì‹œì¥ í‰ê·  ê°€ê²©</option>
                                    <option value="target_age">10. ì˜ˆìƒ ì—°ë ¹ëŒ€</option>
                                    <option value="target_gender">11. ì˜ˆìƒ ì„±ë³„</option>
                                    <option value="additional_info">12. ê¸°íƒ€ íŠ¹ì´ì‚¬í•­</option>
                                    <option value="marketing_link">ë§ˆì¼€íŒ… ë§í¬</option>
                                </select>
                                <button type="button" class="btn btn-primary" onclick="insertVariableFromSelect('addTemplatePrompt', 'addTemplateVariableSelect')">
                                    <i class="bi bi-plus-circle"></i> ë³€ìˆ˜ ì¶”ê°€
                                </button>
                            </div>
                        </div>
                        <textarea class="form-control" id="addTemplatePrompt" name="user_prompt_template" rows="10" required 
                                  placeholder="ìœ„ì—ì„œ ë³€ìˆ˜ë¥¼ ì„ íƒí•˜ê³  ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ í…œí”Œë¦¿ì— ì‚½ì…í•˜ì„¸ìš”."></textarea>
                        <small class="text-muted">ë³€ìˆ˜ëŠ” ì‹¤ì œ ìƒí’ˆ ì •ë³´ë¡œ ìë™ ì¹˜í™˜ë©ë‹ˆë‹¤.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- í…œí”Œë¦¿ ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal fade" id="editTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ìˆ˜ì •</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editTemplateId">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">í…œí”Œë¦¿ ì´ë¦„ <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editTemplateName" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">ë¶„ë¥˜ <span class="text-danger">*</span></label>
                        <select class="form-select" id="editTemplateType" required>
                            <option value="alternative">ëŒ€ì•ˆì„±</option>
                            <option value="informational">ì •ë³´ì„±</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0">ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ <span class="text-danger">*</span></label>
                        <div class="input-group input-group-sm" style="width: auto;">
                            <select class="form-select" id="editTemplateVariableSelect" style="width: 200px;">
                                <option value="">ë³€ìˆ˜ ì„ íƒ</option>
                                <option value="product_name">1. ìš°ë¦¬ì œí’ˆëª…</option>
                                <option value="core_value">2. ìš°ë¦¬ ì œí’ˆì˜ í•µì‹¬</option>
                                <option value="sub_core_value">3. ì„œë¸Œ í•µì‹¬</option>
                                <option value="size_weight">4. ì‚¬ì´ì¦ˆ & ë¬´ê²Œ</option>
                                <option value="difference">5. íƒ€ì‚¬ ì°¨ë³„ì </option>
                                <option value="famous_brands">6. ìœ ëª… ë¸Œëœë“œë“¤</option>
                                <option value="market_problem">7. ì‹œì¥ ë¬¸ì œì </option>
                                <option value="our_price">8. ìš°ë¦¬ ê°€ê²©</option>
                                <option value="market_avg_price">9. ì‹œì¥ í‰ê·  ê°€ê²©</option>
                                <option value="target_age">10. ì˜ˆìƒ ì—°ë ¹ëŒ€</option>
                                <option value="target_gender">11. ì˜ˆìƒ ì„±ë³„</option>
                                <option value="additional_info">12. ê¸°íƒ€ íŠ¹ì´ì‚¬í•­</option>
                                <option value="marketing_link">ë§ˆì¼€íŒ… ë§í¬</option>
                            </select>
                            <button type="button" class="btn btn-primary" onclick="insertVariableFromSelect('editTemplatePrompt', 'editTemplateVariableSelect')">
                                <i class="bi bi-plus-circle"></i> ë³€ìˆ˜ ì¶”ê°€
                            </button>
                        </div>
                    </div>
                    <textarea class="form-control" id="editTemplatePrompt" rows="10" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="updateTemplate()">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<!-- í”„ë¡¬í”„íŠ¸ ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="addPromptModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-chat-dots"></i> AI í”„ë¡¬í”„íŠ¸ ì¶”ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="savePrompt(event)">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ìƒí’ˆ ì„ íƒ <span class="text-danger">*</span></label>
                            <select class="form-select" name="ai_product_id" id="promptProductSelect" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">í‚¤ì›Œë“œ ë¶„ë¥˜ <span class="text-danger">*</span></label>
                            <select class="form-select" name="keyword_classification" id="promptTypeSelect" onchange="loadTemplatesForType()" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="alternative">ëŒ€ì•ˆì„±</option>
                                <option value="informational">ì •ë³´ì„±</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">í…œí”Œë¦¿ ì„ íƒ (ì„ íƒì‚¬í•­)</label>
                            <select class="form-select" id="templateSelectForPrompt" onchange="loadTemplateContent()">
                                <option value="">ì§ì ‘ ì…ë ¥</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="system_prompt" rows="4" required 
                                  placeholder="AIì˜ ì—­í• ê³¼ í–‰ë™ ë°©ì‹ì„ ì •ì˜í•©ë‹ˆë‹¤."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ <span class="text-danger">*</span></label>
                            <div class="btn-group btn-group-sm">
                                <select class="form-select form-select-sm" id="promptVariableSelect" style="width: 180px;">
                                    <option value="">ë³€ìˆ˜ ì„ íƒ</option>
                                    <option value="product_name">1. ìš°ë¦¬ì œí’ˆëª…</option>
                                    <option value="core_value">2. ì œí’ˆ í•µì‹¬</option>
                                    <option value="sub_core_value">3. ì„œë¸Œ í•µì‹¬</option>
                                    <option value="size_weight">4. ì‚¬ì´ì¦ˆ&ë¬´ê²Œ</option>
                                    <option value="difference">5. íƒ€ì‚¬ ì°¨ë³„ì </option>
                                    <option value="famous_brands">6. ìœ ëª… ë¸Œëœë“œ</option>
                                    <option value="market_problem">7. ì‹œì¥ ë¬¸ì œì </option>
                                    <option value="our_price">8. ìš°ë¦¬ ê°€ê²©</option>
                                    <option value="market_avg_price">9. ì‹œì¥ í‰ê· ê°€</option>
                                    <option value="target_age">10. ì—°ë ¹ëŒ€</option>
                                    <option value="target_gender">11. ì„±ë³„</option>
                                    <option value="additional_info">12. íŠ¹ì´ì‚¬í•­</option>
                                    <option value="marketing_link">ë§ˆì¼€íŒ… ë§í¬</option>
                                </select>
                                <button type="button" class="btn btn-primary btn-sm" onclick="insertVariableFromSelect('userPromptArea', 'promptVariableSelect')">
                                    <i class="bi bi-plus-circle"></i> ì¶”ê°€
                                </button>
                                <button type="button" class="btn btn-success btn-sm" onclick="insertImageGenerationPrompt('userPromptArea')">
                                    <i class="bi bi-image"></i> ì´ë¯¸ì§€ ìƒì„±
                                </button>
                            </div>
                        </div>
                        <textarea class="form-control" id="userPromptArea" name="user_prompt" rows="10" required 
                                  placeholder="ì‹¤ì œ ìš”ì²­ ë‚´ìš©ì„ ì‘ì„±í•©ë‹ˆë‹¤. ë³€ìˆ˜ëŠ” ìë™ìœ¼ë¡œ ì¹˜í™˜ë©ë‹ˆë‹¤."></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Temperature</label>
                            <input type="number" class="form-control" name="temperature" value="0.7" step="0.1" min="0" max="1" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Max Tokens</label>
                            <input type="number" class="form-control" name="max_tokens" value="2000" min="100" max="4000" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">ì´ë¯¸ì§€ ìƒì„±</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="generate_images" id="generateImages">
                                <label class="form-check-label" for="generateImages">
                                    ì´ë¯¸ì§€ 3ì¥ ìë™ ìƒì„±
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- í‚¤ì›Œë“œ ê´€ë¦¬ ëª¨ë‹¬ -->
<div class="modal fade" id="manageKeywordsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-key"></i> í‚¤ì›Œë“œ ê´€ë¦¬</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="keywordProductId">
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">í‚¤ì›Œë“œ ëª©ë¡</h6>
                    <button type="button" class="btn btn-success btn-sm" onclick="syncKeywordsFromMarketing()">
                        <i class="bi bi-arrow-repeat"></i> ë§ˆì¼€íŒ…ì—ì„œ ë™ê¸°í™”
                    </button>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>ì•ˆë‚´:</strong> ë™ê¸°í™”í•˜ë©´ ë§ˆì¼€íŒ… ìƒí’ˆì˜ í‚¤ì›Œë“œê°€ ì¶”ê°€ë©ë‹ˆë‹¤. ê° í‚¤ì›Œë“œë¥¼ ëŒ€ì•ˆì„±/ì •ë³´ì„±ìœ¼ë¡œ ë¶„ë¥˜í•˜ì„¸ìš”.
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 40%;">í‚¤ì›Œë“œ</th>
                                <th style="width: 30%;">ë¶„ë¥˜</th>
                                <th style="width: 15%;">í™œì„±</th>
                                <th style="width: 15%;">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="keywordsTableBody">
                            <tr><td colspan="4" class="text-center">ë¡œë”© ì¤‘...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-primary btn-sm" onclick="showAddKeywordForm()">
                        <i class="bi bi-plus-circle"></i> í‚¤ì›Œë“œ ì¶”ê°€
                    </button>
                </div>
                
                <!-- í‚¤ì›Œë“œ ì¶”ê°€ í¼ (ìˆ¨ê¹€) -->
                <div id="addKeywordForm" class="mt-3" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <h6>ìƒˆ í‚¤ì›Œë“œ ì¶”ê°€</h6>
                            <form onsubmit="event.preventDefault(); saveNewKeyword();">
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <input type="text" class="form-control" id="newKeywordText" placeholder="í‚¤ì›Œë“œ ì…ë ¥" required>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <select class="form-select" id="newKeywordType">
                                            <option value="unclassified">ë¯¸ë¶„ë¥˜</option>
                                            <option value="alternative">ëŒ€ì•ˆì„±</option>
                                            <option value="informational">ì •ë³´ì„±</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <button type="submit" class="btn btn-primary w-100">ì¶”ê°€</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- ë ˆí¼ëŸ°ìŠ¤ ê´€ë¦¬ ëª¨ë‹¬ -->
<div class="modal fade" id="manageReferencesModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-book"></i> ë ˆí¼ëŸ°ìŠ¤ ê´€ë¦¬</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="referenceProductId">
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">ë ˆí¼ëŸ°ìŠ¤ ëª©ë¡</h6>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary btn-sm" onclick="showAddReferenceForm()">
                            <i class="bi bi-plus-circle"></i> ë ˆí¼ëŸ°ìŠ¤ ì¶”ê°€
                        </button>
                        <button type="button" class="btn btn-success btn-sm" onclick="syncReferencesFromMarketing()">
                            <i class="bi bi-arrow-repeat"></i> ë§ˆì¼€íŒ…ì—ì„œ ë™ê¸°í™”
                        </button>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>ì•ˆë‚´:</strong> ë™ê¸°í™”ëŠ” ë§ˆì¼€íŒ… ë ˆí¼ëŸ°ìŠ¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤(ë¯¸ë¶„ë¥˜). AI ìª½ ìˆ˜ì •ì€ ë§ˆì¼€íŒ…ì— ì˜í–¥ ì—†ìŠµë‹ˆë‹¤.
                </div>
                
                <!-- ë ˆí¼ëŸ°ìŠ¤ ì¶”ê°€ í¼ (ìˆ¨ê¹€) -->
                <div id="addReferenceForm" class="card mb-3" style="display: none;">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">ìƒˆ ë ˆí¼ëŸ°ìŠ¤ ì¶”ê°€</h6>
                    </div>
                    <div class="card-body">
                        <form onsubmit="event.preventDefault(); saveNewReference();">
                            <div class="mb-3">
                                <label class="form-label">ì œëª© <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="newRefTitle" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ë¶„ë¥˜ <span class="text-danger">*</span></label>
                                <select class="form-select" id="newRefType" required>
                                    <option value="unclassified">ë¯¸ë¶„ë¥˜</option>
                                    <option value="alternative">ëŒ€ì•ˆì„±</option>
                                    <option value="informational">ì •ë³´ì„±</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ë³¸ë¬¸ ë‚´ìš© <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="newRefContent" rows="8" required></textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">ì €ì¥</button>
                                <button type="button" class="btn btn-secondary" onclick="hideAddReferenceForm()">ì·¨ì†Œ</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 35%;">ì œëª©</th>
                                <th style="width: 15%;">AI ë¶„ë¥˜</th>
                                <th style="width: 10%;">ì›ë³¸ íƒ€ì…</th>
                                <th style="width: 25%;">ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°</th>
                                <th style="width: 15%;">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="referencesTableBody">
                            <tr><td colspan="5" class="text-center">ë¡œë”© ì¤‘...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- ë ˆí¼ëŸ°ìŠ¤ ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ (ë§ˆì¼€íŒ… ìŠ¤íƒ€ì¼) -->
<div class="modal fade" id="viewReferenceModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-eye"></i> ë ˆí¼ëŸ°ìŠ¤ ìƒì„¸ ë³´ê¸°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="viewRefId">
                
                <!-- ì œëª© -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0" id="viewRefTitle"></h5>
                    </div>
                </div>
                
                <!-- ë³¸ë¬¸ -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-file-text"></i> ë³¸ë¬¸ ë‚´ìš©</h6>
                    </div>
                    <div class="card-body">
                        <div id="viewRefContent" style="white-space: pre-wrap; line-height: 1.8;"></div>
                    </div>
                </div>
                
                <!-- ëŒ“ê¸€ -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-chat-dots"></i> ëŒ“ê¸€ (<span id="viewRefCommentCount">0</span>ê°œ)</h6>
                    </div>
                    <div class="card-body">
                        <div id="viewRefComments"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- ë ˆí¼ëŸ°ìŠ¤ ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal fade" id="editReferenceModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> ë ˆí¼ëŸ°ìŠ¤ ìˆ˜ì •</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editRefId">
                <input type="hidden" id="editAiRefId">
                
                <div class="mb-3">
                    <label class="form-label">ì œëª© <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="editRefTitle" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">AI ë¶„ë¥˜ <span class="text-danger">*</span></label>
                    <select class="form-select" id="editRefType" required>
                        <option value="unclassified">ë¯¸ë¶„ë¥˜</option>
                        <option value="alternative">ëŒ€ì•ˆì„± (êµ¬ë§¤ ê´€ë ¨)</option>
                        <option value="informational">ì •ë³´ì„± (ì •ë³´ ê²€ìƒ‰)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">ë³¸ë¬¸ ë‚´ìš© <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="editRefContent" rows="10" required></textarea>
                </div>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>ì£¼ì˜:</strong> AI ìª½ì—ì„œ ìˆ˜ì •í•œ ë‚´ìš©ì€ ë§ˆì¼€íŒ…-ì¹´í˜ì— ë™ê¸°í™”ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="updateReferenceContent()">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<!-- ìŠ¤ì¼€ì¤„ ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="addScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-calendar-check"></i> AI ìŠ¤ì¼€ì¤„ ìƒì„±</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="saveSchedule(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ìƒí’ˆ ì„ íƒ <span class="text-danger">*</span></label>
                        <select class="form-select" name="ai_product_id" id="scheduleProductSelect" onchange="showKeywordCount()" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                        <small id="keywordCountDisplay" class="text-muted"></small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">í”„ë¡¬í”„íŠ¸ ì„ íƒ <span class="text-danger">*</span></label>
                        <select class="form-select" name="prompt_id" id="schedulePromptSelect" required>
                            <option value="">ë¨¼ì € ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ì‹œì‘ì¼ <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="start_date" id="scheduleStartDate" onchange="calculateTotal()" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ì¢…ë£Œì¼ <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="end_date" id="scheduleEndDate" onchange="calculateTotal()" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">í•˜ë£¨ ì‘ì„± ê°œìˆ˜ <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="daily_post_count" id="dailyPostCount" min="1" onchange="calculateTotal()" required>
                    </div>
                    
                    <div id="totalPostsDisplay" class="alert alert-info" style="display: none;">
                        <i class="bi bi-info-circle"></i> ì˜ˆìƒ ì´ ê¸€ ë°œí–‰ ìˆ˜: <strong id="totalPostsCount">0</strong>ê°œ
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ìƒì„±</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

