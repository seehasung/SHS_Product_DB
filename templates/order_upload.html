{% extends "base.html" %}
{% block title %}ë°ì´í„° ì—…ë¡œë“œ - ì£¼ë¬¸ì¡°íšŒ{% endblock %}

{% block head %}
{{ super() }}
<style>
    .upload-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .upload-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        margin-bottom: 20px;
    }
    
    .upload-header {
        border-bottom: 2px solid #4A90E2;
        padding-bottom: 15px;
        margin-bottom: 25px;
    }
    
    .upload-header h2 {
        font-size: 1.8rem;
        font-weight: 800;
        color: #2d3436;
        margin: 0;
    }
    
    .upload-area {
        border: 3px dashed #4A90E2;
        border-radius: 16px;
        padding: 50px;
        text-align: center;
        background: linear-gradient(135deg, rgba(74, 144, 226, 0.05) 0%, rgba(91, 163, 245, 0.05) 100%);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .upload-area:hover {
        border-color: #5BA3F5;
        background: linear-gradient(135deg, rgba(74, 144, 226, 0.1) 0%, rgba(91, 163, 245, 0.1) 100%);
        transform: translateY(-2px);
    }
    
    .upload-area.dragging {
        border-color: #00b894;
        background: linear-gradient(135deg, rgba(0, 184, 148, 0.1) 0%, rgba(85, 239, 196, 0.1) 100%);
    }
    
    .upload-icon {
        font-size: 4rem;
        color: #4A90E2;
        margin-bottom: 20px;
    }
    
    .file-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2d3436;
        margin-top: 15px;
        padding: 10px 20px;
        background: white;
        border-radius: 10px;
        display: inline-block;
    }
    
    .mode-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 25px;
    }
    
    .mode-option {
        position: relative;
    }
    
    .mode-option input[type="radio"] {
        position: absolute;
        opacity: 0;
    }
    
    .mode-label {
        display: block;
        padding: 20px;
        border: 2px solid #e1e8ed;
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }
    
    .mode-option input[type="radio"]:checked + .mode-label {
        border-color: #4A90E2;
        background: linear-gradient(135deg, rgba(74, 144, 226, 0.1) 0%, rgba(91, 163, 245, 0.1) 100%);
        font-weight: 600;
    }
    
    .mode-label:hover {
        border-color: #4A90E2;
    }
    
    .mode-label i {
        font-size: 2rem;
        color: #4A90E2;
        margin-bottom: 10px;
        display: block;
    }
    
    .result-area {
        margin-top: 20px;
        padding: 20px;
        border-radius: 12px;
        display: none;
    }
    
    .result-area.success {
        background: linear-gradient(135deg, rgba(0, 184, 148, 0.1) 0%, rgba(85, 239, 196, 0.1) 100%);
        border: 2px solid #00b894;
    }
    
    .result-area.error {
        background: linear-gradient(135deg, rgba(235, 51, 73, 0.1) 0%, rgba(244, 92, 67, 0.1) 100%);
        border: 2px solid #eb3349;
    }
    
    .instruction-list {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        margin-top: 20px;
    }
    
    .instruction-list h4 {
        font-weight: 700;
        color: #2d3436;
        margin-bottom: 15px;
    }
    
    .instruction-list ul {
        padding-left: 25px;
        margin: 0;
    }
    
    .instruction-list li {
        margin-bottom: 10px;
        color: #636e72;
        line-height: 1.6;
    }
    
    .btn-upload {
        background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1.1rem;
        box-shadow: 0 4px 16px rgba(74, 144, 226, 0.35);
        transition: all 0.3s ease;
    }
    
    .btn-upload:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(74, 144, 226, 0.45);
        color: white;
    }
    
    .btn-upload:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.15rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 style="font-weight: 800; color: #2d3436;">
            <i class="bi bi-cloud-upload-fill"></i> ë°ì´í„° ì—…ë¡œë“œ
        </h1>
        <a href="/orders/dashboard" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> ì „ì²´ í˜„í™©ìœ¼ë¡œ
        </a>
    </div>
    
    <!-- ì—…ë¡œë“œ ì¹´ë“œ -->
    <div class="upload-card">
        <div class="upload-header">
            <h2><i class="bi bi-file-earmark-excel"></i> ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h2>
        </div>
        
        <!-- íŒŒì¼ ì„ íƒ ì˜ì—­ -->
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <i class="bi bi-cloud-upload upload-icon"></i>
            <h3>í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</h3>
            <p style="color: #636e72; margin-top: 10px;">Excel íŒŒì¼ (.xlsx, .xls) ì§€ì›</p>
            <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;" onchange="handleFileSelect(event)">
            <div id="fileName" class="file-name" style="display: none;"></div>
        </div>
        
        <!-- ì—…ë¡œë“œ ëª¨ë“œ ì„ íƒ -->
        <div class="mode-selector">
            <div class="mode-option">
                <input type="radio" id="mode_append" name="update_mode" value="append" checked>
                <label for="mode_append" class="mode-label">
                    <i class="bi bi-plus-circle"></i>
                    <div>ìƒˆë¡œ ì¶”ê°€</div>
                    <small style="color: #636e72;">ê¸°ì¡´ ë°ì´í„° ìœ ì§€</small>
                </label>
            </div>
            
            <div class="mode-option">
                <input type="radio" id="mode_update" name="update_mode" value="update">
                <label for="mode_update" class="mode-label">
                    <i class="bi bi-arrow-repeat"></i>
                    <div>ì¤‘ë³µ ì‹œ ì—…ë°ì´íŠ¸</div>
                    <small style="color: #636e72;">ê°™ì€ ì£¼ë¬¸ë²ˆí˜¸ ë®ì–´ì“°ê¸°</small>
                </label>
            </div>
            
            <div class="mode-option">
                <input type="radio" id="mode_skip" name="update_mode" value="skip">
                <label for="mode_skip" class="mode-label">
                    <i class="bi bi-skip-forward"></i>
                    <div>ì¤‘ë³µ ì‹œ ê±´ë„ˆë›°ê¸°</div>
                    <small style="color: #636e72;">ì¤‘ë³µ ë°ì´í„° ë¬´ì‹œ</small>
                </label>
            </div>
            
            <div class="mode-option">
                <input type="radio" id="mode_replace" name="update_mode" value="replace">
                <label for="mode_replace" class="mode-label">
                    <i class="bi bi-arrow-clockwise"></i>
                    <div>ì „ì²´ êµì²´</div>
                    <small style="color: #636e72; font-weight: 600; color: #eb3349;">ê¸°ì¡´ ë°ì´í„° ì‚­ì œ</small>
                </label>
            </div>
        </div>
        
        <!-- ì—…ë¡œë“œ ë²„íŠ¼ -->
        <div class="text-center mt-4">
            <button id="uploadBtn" class="btn-upload" onclick="uploadFile()" disabled>
                <i class="bi bi-upload"></i> ì—…ë¡œë“œ ì‹œì‘
            </button>
        </div>
        
        <!-- ê²°ê³¼ ì˜ì—­ -->
        <div id="resultArea" class="result-area"></div>
    </div>
    
    <!-- ì‚¬ìš© ì•ˆë‚´ -->
    <div class="upload-card">
        <div class="instruction-list">
            <h4><i class="bi bi-info-circle"></i> ì‚¬ìš© ì•ˆë‚´</h4>
            <ul>
                <li><strong>ì—‘ì…€ íŒŒì¼ í˜•ì‹:</strong> .xlsx ë˜ëŠ” .xls íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                <li><strong>í•„ìˆ˜ ì»¬ëŸ¼:</strong> ì£¼ë¬¸ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤. ì£¼ë¬¸ë²ˆí˜¸ê°€ ì—†ëŠ” í–‰ì€ ì—…ë¡œë“œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
                <li><strong>ì»¬ëŸ¼ ìˆœì„œ:</strong> ì£¼ë¬¸ìƒíƒœ, ì£¼ë¬¸ì¼ì, í´ë ˆì„ì¼ì, í´ë ˆì„ì‚¬ìœ , íŒë§¤ì²˜ï¼ê³„ì •, ì£¼ë¬¸ë²ˆí˜¸, êµ¬ë§¤ì, ìˆ˜ë ¹ì, íƒë°°ì‚¬, ì†¡ì¥ë²ˆí˜¸, ì œí’ˆëª…, ì˜µì…˜, ìˆ˜ëŸ‰, ì—°ë½ì²˜, í†µê´€ë²ˆí˜¸, ìš°í¸ë²ˆí˜¸, ì£¼ì†Œ, ê²°ì œê¸ˆì•¡, ë°°ì†¡ë¹„ï¼ˆê³ ê°ï¼‰, ë§ˆì¼“ìˆ˜ìˆ˜ë£Œ, ì •ì‚°ì˜ˆì •ê¸ˆ, íƒ€ë°”ï¼ì£¼ë¬¸ë²ˆí˜¸, íƒ€ë°”ï¼ìœ„ì•ˆ, ì£¼ë¬¸ì²˜ë¦¬ì¼, í™˜ìœ¨, ê´€ì„¸ëŒ€ë‚©, í™”ë¬¼ëŒ€ë‚©, ë°°ëŒ€ì§€, ë§ˆì§„, ë§ˆì§„ìœ¨</li>
                <li><strong>ì£¼ë¬¸ì²˜ë¦¬ì¼ â†’ í™˜ìœ¨ ìë™ íŒŒì‹±:</strong> ì£¼ë¬¸ì²˜ë¦¬ì¼ ì»¬ëŸ¼ì—ì„œ "-" ë’¤ì˜ ê°’ì„ ìë™ìœ¼ë¡œ í™˜ìœ¨ë¡œ ì¶”ì¶œí•©ë‹ˆë‹¤. (ì˜ˆ: "2024-01-15-190.5" â†’ í™˜ìœ¨ 190.5)</li>
                <li><strong>ì—…ë°ì´íŠ¸ ëª¨ë“œ:</strong>
                    <ul>
                        <li><strong>ìƒˆë¡œ ì¶”ê°€:</strong> ê¸°ì¡´ ë°ì´í„°ë¥¼ ìœ ì§€í•˜ê³  ìƒˆë¡œìš´ ë°ì´í„°ë§Œ ì¶”ê°€</li>
                        <li><strong>ì¤‘ë³µ ì‹œ ì—…ë°ì´íŠ¸:</strong> ê°™ì€ ì£¼ë¬¸ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ ë®ì–´ì“°ê¸°</li>
                        <li><strong>ì¤‘ë³µ ì‹œ ê±´ë„ˆë›°ê¸°:</strong> ê°™ì€ ì£¼ë¬¸ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ ë¬´ì‹œ</li>
                        <li><strong>ì „ì²´ êµì²´:</strong> ê¸°ì¡´ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ìƒˆë¡œ ì—…ë¡œë“œ (âš ï¸ ì£¼ì˜)</li>
                    </ul>
                </li>
                <li><strong>ëŒ€ìš©ëŸ‰ íŒŒì¼:</strong> ìˆ˜ì²œ ê±´ ì´ìƒì˜ ë°ì´í„°ë„ ì²˜ë¦¬ ê°€ëŠ¥í•˜ì§€ë§Œ, ì‹œê°„ì´ ë‹¤ì†Œ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
            </ul>
        </div>
    </div>
</div>

<script>
let selectedFile = null;

// íŒŒì¼ ì„ íƒ ì²˜ë¦¬
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // íŒŒì¼ í™•ì¥ì ì²´í¬
    const fileName = file.name;
    const fileExt = fileName.split('.').pop().toLowerCase();
    
    if (!['xlsx', 'xls'].includes(fileExt)) {
        alert('âš ï¸ Excel íŒŒì¼(.xlsx, .xls)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
    }
    
    selectedFile = file;
    
    // íŒŒì¼ëª… í‘œì‹œ
    const fileNameDiv = document.getElementById('fileName');
    fileNameDiv.textContent = `ğŸ“„ ${fileName}`;
    fileNameDiv.style.display = 'inline-block';
    
    // ì—…ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
    document.getElementById('uploadBtn').disabled = false;
}

// ë“œë˜ê·¸ ì•¤ ë“œë¡­
const uploadArea = document.getElementById('uploadArea');

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragging');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragging');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragging');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        document.getElementById('fileInput').files = files;
        handleFileSelect({ target: { files } });
    }
});

// íŒŒì¼ ì—…ë¡œë“œ
async function uploadFile() {
    if (!selectedFile) {
        alert('âš ï¸ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const updateMode = document.querySelector('input[name="update_mode"]:checked').value;
    
    // ì „ì²´ êµì²´ í™•ì¸
    if (updateMode === 'replace') {
        if (!confirm('âš ï¸ ê¸°ì¡´ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }
    }
    
    const uploadBtn = document.getElementById('uploadBtn');
    const resultArea = document.getElementById('resultArea');
    
    // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ì—…ë¡œë“œ ì¤‘...';
    
    // FormData ìƒì„±
    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('update_mode', updateMode);
    
    try {
        const response = await fetch('/orders/api/upload', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        // ê²°ê³¼ í‘œì‹œ
        resultArea.style.display = 'block';
        
        if (result.success) {
            resultArea.className = 'result-area success';
            resultArea.innerHTML = `
                <h4 style="color: #00b894; margin-bottom: 15px;">
                    <i class="bi bi-check-circle-fill"></i> ${result.message}
                </h4>
                <div style="font-size: 1.1rem; margin-bottom: 10px;">
                    âœ… ì„±ê³µ: <strong>${result.success_count}ê±´</strong>
                    ${result.error_count > 0 ? `<br>âŒ ì‹¤íŒ¨: <strong>${result.error_count}ê±´</strong>` : ''}
                </div>
                ${result.errors && result.errors.length > 0 ? `
                    <div style="margin-top: 15px;">
                        <strong>ì˜¤ë¥˜ ë‚´ì—­:</strong>
                        <ul style="margin-top: 10px; text-align: left;">
                            ${result.errors.map(err => `<li>${err}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                <div style="margin-top: 20px;">
                    <a href="/orders/dashboard" class="btn btn-primary">
                        <i class="bi bi-bar-chart"></i> ì „ì²´ í˜„í™© ë³´ê¸°
                    </a>
                </div>
            `;
        } else {
            resultArea.className = 'result-area error';
            resultArea.innerHTML = `
                <h4 style="color: #eb3349; margin-bottom: 15px;">
                    <i class="bi bi-x-circle-fill"></i> ì—…ë¡œë“œ ì‹¤íŒ¨
                </h4>
                <p>${result.message}</p>
            `;
        }
        
    } catch (error) {
        resultArea.style.display = 'block';
        resultArea.className = 'result-area error';
        resultArea.innerHTML = `
            <h4 style="color: #eb3349; margin-bottom: 15px;">
                <i class="bi bi-x-circle-fill"></i> ì—…ë¡œë“œ ì‹¤íŒ¨
            </h4>
            <p>ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>
        `;
    } finally {
        // ë²„íŠ¼ ë³µêµ¬
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="bi bi-upload"></i> ì—…ë¡œë“œ ì‹œì‘';
    }
}
</script>
{% endblock %}