{% extends "base.html" %}
{% block title %}전체 현황 - 주문조회{% endblock %}

{% block head %}
{{ super() }}
<style>
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* 통계 카드 */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--stat-gradient);
        border-radius: 16px 16px 0 0;
    }
    
    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        margin-bottom: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 800;
        color: #2d3436;
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: #636e72;
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    /* 테이블 카드 */
    .table-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
    }
    
    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e1e8ed;
    }
    
    .table-header h3 {
        font-size: 1.5rem;
        font-weight: 800;
        color: #2d3436;
        margin: 0;
    }
    
    /* 검색 바 */
    .search-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .search-input {
        flex: 1;
        padding: 12px 20px;
        border: 2px solid #e1e8ed;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .search-input:focus {
        outline: none;
        border-color: #4A90E2;
        box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1);
    }
    
    .btn-search {
        padding: 12px 30px;
        background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-search:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
    }
    
    /* 테이블 */
    .order-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .order-table thead th {
        background: linear-gradient(135deg, rgba(74, 144, 226, 0.1) 0%, rgba(91, 163, 245, 0.1) 100%);
        padding: 15px;
        text-align: left;
        font-weight: 700;
        color: #2d3436;
        font-size: 0.9rem;
        border-bottom: 2px solid #e1e8ed;
    }
    
    .order-table thead th:first-child {
        border-radius: 10px 0 0 0;
    }
    
    .order-table thead th:last-child {
        border-radius: 0 10px 0 0;
    }
    
    .order-table tbody tr {
        transition: all 0.2s;
        background: white;
    }
    
    .order-table tbody tr:hover {
        background: rgba(74, 144, 226, 0.05);
        transform: scale(1.01);
    }
    
    .order-table tbody td {
        padding: 15px;
        border-bottom: 1px solid #f1f3f5;
        color: #495057;
        font-size: 0.9rem;
    }
    
    /* 상태 배지 */
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
    }
    
    .status-badge.completed {
        background: #d4edda;
        color: #155724;
    }
    
    .status-badge.shipping {
        background: #cce5ff;
        color: #004085;
    }
    
    .status-badge.pending {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-badge.cancelled {
        background: #f8d7da;
        color: #721c24;
    }
    
    /* 액션 버튼 */
    .btn-action {
        padding: 6px 12px;
        border: none;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-right: 5px;
    }
    
    .btn-view {
        background: #4A90E2;
        color: white;
    }
    
    .btn-view:hover {
        background: #3a7bc8;
    }
    
    .btn-delete {
        background: #eb3349;
        color: white;
    }
    
    .btn-delete:hover {
        background: #d62839;
    }
    
    /* 페이지네이션 */
    .pagination {
        display: flex;
        justify-content: center;
        gap: 5px;
        margin-top: 30px;
    }
    
    .page-btn {
        padding: 10px 15px;
        border: 2px solid #e1e8ed;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 600;
        color: #636e72;
    }
    
    .page-btn:hover {
        border-color: #4A90E2;
        color: #4A90E2;
    }
    
    .page-btn.active {
        background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
        color: white;
        border-color: transparent;
    }
    
    .no-data {
        text-align: center;
        padding: 60px 20px;
        color: #adb5bd;
    }
    
    .no-data i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }
    
    /* 필터 */
    .filter-group {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .filter-btn {
        padding: 8px 16px;
        border: 2px solid #e1e8ed;
        background: white;
        border-radius: 20px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
    }
    
    .filter-btn:hover {
        border-color: #4A90E2;
        color: #4A90E2;
    }
    
    .filter-btn.active {
        background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
        color: white;
        border-color: transparent;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- 페이지 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 style="font-weight: 800; color: #2d3436;">
            <i class="bi bi-speedometer2"></i> 전체 현황
        </h1>
        <div>
            <a href="/orders/upload" class="btn btn-primary me-2">
                <i class="bi bi-cloud-upload"></i> 데이터 업로드
            </a>
            <a href="/orders/search" class="btn btn-success">
                <i class="bi bi-search"></i> 주문조회
            </a>
        </div>
    </div>
    
    <!-- 통계 카드 -->
    <div class="stats-grid">
        <!-- 1. 가송장 사용 건 -->
        <div class="stat-card" style="--stat-gradient: linear-gradient(90deg, #fd79a8 0%, #fdcb6e 100%);">
            <div class="stat-icon" style="background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%); color: white;">
                <i class="bi bi-receipt-cutoff"></i>
            </div>
            <div class="stat-value">{{ "{:,}".format(fake_tracking_count) }}</div>
            <div class="stat-label">가송장 사용 건</div>
        </div>
        
        <!-- 2. 네이버 송장 흐름 -->
        <div class="stat-card" style="--stat-gradient: linear-gradient(90deg, #00b894 0%, #55efc4 100%);">
            <div class="stat-icon" style="background: linear-gradient(135deg, #00b894 0%, #55efc4 100%); color: white;">
                <i class="bi bi-truck"></i>
            </div>
            <div class="stat-value">{{ "{:,}".format(naver_delivery_count) }}</div>
            <div class="stat-label">네이버 송장 흐름</div>
        </div>
        
        <!-- 3. 경동 이관 -->
        <div class="stat-card" style="--stat-gradient: linear-gradient(90deg, #6c5ce7 0%, #a29bfe 100%);">
            <div class="stat-icon" style="background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); color: white;">
                <i class="bi bi-arrow-left-right"></i>
            </div>
            <div class="stat-value">{{ "{:,}".format(kyungdong_count) }}</div>
            <div class="stat-label">경동 이관</div>
        </div>
        
        <!-- 4. 통관 절차 이상 -->
        <div class="stat-card" style="--stat-gradient: linear-gradient(90deg, #e17055 0%, #fab1a0 100%);">
            <div class="stat-icon" style="background: linear-gradient(135deg, #e17055 0%, #fab1a0 100%); color: white;">
                <i class="bi bi-exclamation-triangle"></i>
            </div>
            <div class="stat-value">{{ "{:,}".format(customs_issue_count) }}</div>
            <div class="stat-label">통관 절차 이상</div>
        </div>
        
        <!-- 5. 장기 미배송 -->
        <div class="stat-card" style="--stat-gradient: linear-gradient(90deg, #d63031 0%, #ff7675 100%);">
            <div class="stat-icon" style="background: linear-gradient(135deg, #d63031 0%, #ff7675 100%); color: white;">
                <i class="bi bi-clock-history"></i>
            </div>
            <div class="stat-value">{{ "{:,}".format(long_undelivered_count) }}</div>
            <div class="stat-label">장기 미배송 (2주+)</div>
        </div>
    </div>
    
    <!-- 상태별 통계 -->
    {% if status_stats %}
    <div class="table-card">
        <h3 style="font-weight: 800; color: #2d3436; margin-bottom: 20px;">
            <i class="bi bi-pie-chart"></i> 상태별 현황
        </h3>
        <div class="filter-group">
            {% for stat in status_stats %}
            <div class="filter-btn">
                <strong>{{ stat.order_status or '미분류' }}:</strong> {{ "{:,}".format(stat.count) }}건
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- 최근 주문 테이블 -->
    <div class="table-card">
        <div class="table-header">
            <h3><i class="bi bi-clock-history"></i> 최근 주문 내역</h3>
        </div>
        
        {% if recent_orders %}
        <div style="overflow-x: auto;">
            <table class="order-table">
                <thead>
                    <tr>
                        <th>주문번호</th>
                        <th>주문상태</th>
                        <th>주문일자</th>
                        <th>구매자</th>
                        <th>수령자</th>
                        <th>제품명</th>
                        <th>결제금액</th>
                        <th>액션</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in recent_orders %}
                    <tr>
                        <td><strong>{{ order.order_number }}</strong></td>
                        <td>
                            {% if order.order_status %}
                                {% if '완료' in order.order_status or '배송' in order.order_status %}
                                    <span class="status-badge completed">{{ order.order_status }}</span>
                                {% elif '취소' in order.order_status or '반품' in order.order_status %}
                                    <span class="status-badge cancelled">{{ order.order_status }}</span>
                                {% elif '대기' in order.order_status or '준비' in order.order_status %}
                                    <span class="status-badge pending">{{ order.order_status }}</span>
                                {% else %}
                                    <span class="status-badge shipping">{{ order.order_status }}</span>
                                {% endif %}
                            {% else %}
                                <span class="status-badge pending">미확인</span>
                            {% endif %}
                        </td>
                        <!-- ⭐ 수정: strftime() 제거 -->
                        <td>{{ order.order_date[:10] if order.order_date else '-' }}</td>
                        <td>{{ order.buyer_name or '-' }}</td>
                        <td>{{ order.recipient_name or '-' }}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            {{ order.product_name or '-' }}
                        </td>
                        <!-- ⭐ 수정: float 변환 제거 -->
                        <td><strong>{{ order.payment_amount or '-' }}원</strong></td>
                        <td>
                            <button class="btn-action btn-view" onclick="viewOrder({{ order.id }})">
                                <i class="bi bi-eye"></i> 상세
                            </button>
                            {% if is_admin %}
                            <button class="btn-action btn-delete" onclick="deleteOrder({{ order.id }})">
                                <i class="bi bi-trash"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="no-data">
            <i class="bi bi-inbox"></i>
            <p style="font-size: 1.1rem; margin-top: 10px;">주문 데이터가 없습니다</p>
            <p style="color: #636e72;">엑셀 파일을 업로드하여 데이터를 등록하세요</p>
            <a href="/orders/upload" class="btn btn-primary mt-3">
                <i class="bi bi-cloud-upload"></i> 데이터 업로드하기
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- 주문 상세 모달 -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-file-text"></i> 주문 상세 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailContent">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">로딩 중...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 주문 상세보기
async function viewOrder(orderId) {
    const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
    modal.show();
    
    try {
        const response = await fetch(`/orders/api/${orderId}/detail`);
        const order = await response.json();
        
        document.getElementById('orderDetailContent').innerHTML = `
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">주문번호</label>
                    <input type="text" class="form-control" value="${order.order_number || '-'}" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">주문상태</label>
                    <input type="text" class="form-control" value="${order.order_status || '-'}" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">주문일자</label>
                    <input type="text" class="form-control" value="${order.order_date || '-'}" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">구매자</label>
                    <input type="text" class="form-control" value="${order.buyer_name || '-'}" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">수령자</label>
                    <input type="text" class="form-control" value="${order.recipient_name || '-'}" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">연락처</label>
                    <input type="text" class="form-control" value="${order.contact_number || '-'}" readonly>
                </div>
                <div class="col-12 mb-3">
                    <label class="form-label fw-bold">제품명</label>
                    <input type="text" class="form-control" value="${order.product_name || '-'}" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">옵션</label>
                    <input type="text" class="form-control" value="${order.product_option || '-'}" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">수량</label>
                    <input type="text" class="form-control" value="${order.quantity || '-'}" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">송장번호</label>
                    <input type="text" class="form-control" value="${order.tracking_number || '-'}" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">통관번호</label>
                    <input type="text" class="form-control" value="${order.customs_number || '-'}" readonly>
                </div>
                <div class="col-12 mb-3">
                    <label class="form-label fw-bold">주소</label>
                    <textarea class="form-control" rows="2" readonly>${order.address || '-'}</textarea>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">결제금액</label>
                    <input type="text" class="form-control" value="${order.payment_amount || '-'}원" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">환율</label>
                    <input type="text" class="form-control" value="${order.exchange_rate || '-'}" readonly>
                </div>
            </div>
        `;
    } catch (error) {
        document.getElementById('orderDetailContent').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> 주문 정보를 불러오는데 실패했습니다.
            </div>
        `;
    }
}

// 주문 삭제
async function deleteOrder(orderId) {
    if (!confirm('정말로 이 주문을 삭제하시겠습니까?')) return;
    
    try {
        const response = await fetch(`/orders/api/${orderId}/delete`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('삭제되었습니다.'); 
            location.reload();
        } else {
            alert('삭제 실패: ' + result.message);
        }
    } catch (error) {
        alert('삭제 중 오류가 발생했습니다.');
    }
}
</script>
{% endblock %}